<div>
  <h3>Obras Sociales</h3>
  <button class="btn" id="btn-agregar">Agregar Obra Social</button>
  <table class="os-table" id="tabla-obras-sociales">
    <thead>
      <tr>
        <th>Obra Social</th>
        <th>Condición Copago</th>
        <th>Valor Copago</th>
        <th>Cantidad de Turnos</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filas dinámicas -->
    </tbody>
  </table>
</div>

<!-- Modal para agregar obra social -->
<div id="modal-agregar" style="display:none; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -30%); background: #fff; border: 1px solid #ccc; padding: 20px; z-index:1000;">
  <h4>Agregar Obra Social</h4>
  <form id="form-agregar">
    <label>Nombre Obra Social:<br>
      <input type="text" name="obra_social" required />
    </label><br><br>
    <label>Condición Copago:<br>
      <select name="condicion_copago">
        <option value="true">Sí</option>
        <option value="false">No</option>
      </select>
    </label><br><br>
    <label>Valor Copago:<br>
      <input type="number" name="valor_copago" min="0" />
    </label><br><br>
    <label>Cantidad de Turnos:<br>
      <input type="number" name="cantidad_turnos" min="0" />
    </label><br><br>
    <button type="submit" class="btn">Guardar</button>
    <button type="button" class="btn" id="btn-cancelar">Cancelar</button>
  </form>
</div>

<script type="module">
import supabase from './supabaseClient.js';

function getIdProfesionalLogueado() {
  return localStorage.getItem('id_profesional') || '092fa577-d353-47d1-b30c-d819fac0df64';
}

let obrasSociales = [];
let todasObrasSociales = [];

async function cargarObrasSociales() {
  const id_profesional = getIdProfesionalLogueado();
  const { data: todasOS, error: errorOS } = await supabase
    .from('obras_sociales')
    .select('id, obra_social');
  if (errorOS) {
    alert('Error al cargar obras sociales: ' + errorOS.message);
    return;
  }
  todasObrasSociales = todasOS;

  const { data: vinculos, error: errorV } = await supabase
    .from('medico_obras_sociales')
    .select('id, obra_social_id, condicion_copago, valor_copago, cantidad_turnos')
    .eq('medico_id', id_profesional);

  obrasSociales = todasObrasSociales.map(os => {
    const vinculo = vinculos?.find(v => v.obra_social_id === os.id);
    return {
      id: vinculo?.id || null,
      obra_social_id: os.id,
      obra_social: os.obra_social,
      condicion_copago: vinculo?.condicion_copago ?? false,
      valor_copago: vinculo?.valor_copago ?? '',
      cantidad_turnos: vinculo?.cantidad_turnos ?? '',
      configurado: !!vinculo
    };
  });

  renderTabla();
}

function renderTabla() {
  const tbody = document.querySelector('#tabla-obras-sociales tbody');
  tbody.innerHTML = '';
  obrasSociales.forEach((fila, idx) => {
    tbody.innerHTML += `
      <tr>
        <td>${fila.obra_social}</td>
        <td>
          <select data-idx="${idx}" data-campo="condicion_copago">
            <option value="true" ${fila.condicion_copago?'selected':''}>Sí</option>
            <option value="false" ${!fila.condicion_copago?'selected':''}>No</option>
          </select>
        </td>
        <td><input type="number" data-idx="${idx}" data-campo="valor_copago" value="${fila.valor_copago ?? ''}" /></td>
        <td><input type="number" data-idx="${idx}" data-campo="cantidad_turnos" value="${fila.cantidad_turnos ?? ''}" /></td>
        <td>
          ${fila.configurado
            ? `<button class="btn" data-accion="eliminar" data-idx="${idx}">Eliminar</button>
               <button class="btn" data-accion="guardar" data-idx="${idx}">Guardar</button>`
            : `<button class="btn" data-accion="agregar" data-idx="${idx}">Agregar</button>`
          }
        </td>
      </tr>
    `;
  });
  agregarEventListeners();
}

function agregarEventListeners() {
  document.querySelectorAll('#tabla-obras-sociales input, #tabla-obras-sociales select').forEach(el => {
    el.addEventListener('change', (e) => {
      const idx = Number(el.dataset.idx);
      obrasSociales[idx][el.dataset.campo] = el.type === 'select-one'
        ? (el.value === 'true')
        : el.value;
    });
  });
  document.querySelectorAll('#tabla-obras-sociales button').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const idx = Number(btn.dataset.idx);
      const accion = btn.dataset.accion;
      if (accion === 'guardar') await guardarFila(idx);
      if (accion === 'eliminar') await eliminarFila(idx);
      if (accion === 'agregar') await agregarFila(idx);
    });
  });
}

async function guardarFila(idx) {
  const fila = obrasSociales[idx];
  if (!fila.id) return;
  const { error } = await supabase
    .from('medico_obras_sociales')
    .update({
      condicion_copago: fila.condicion_copago,
      valor_copago: fila.valor_copago,
      cantidad_turnos: fila.cantidad_turnos
    })
    .eq('id', fila.id);
  if (error) {
    alert('Error al guardar: ' + error.message);
  } else {
    alert('Guardado!');
    cargarObrasSociales();
  }
}

async function eliminarFila(idx) {
  const fila = obrasSociales[idx];
  if (!fila.id) return;
  const { error } = await supabase
    .from('medico_obras_sociales')
    .delete()
    .eq('id', fila.id);
  if (error) {
    alert('Error al eliminar: ' + error.message);
  } else {
    alert('Eliminado!');
    cargarObrasSociales();
  }
}

async function agregarFila(idx) {
  const fila = obrasSociales[idx];
  const id_profesional = getIdProfesionalLogueado();
  const { error } = await supabase
    .from('medico_obras_sociales')
    .insert([{
      medico_id: id_profesional,
      obra_social_id: fila.obra_social_id,
      condicion_copago: fila.condicion_copago,
      valor_copago: fila.valor_copago,
      cantidad_turnos: fila.cantidad_turnos
    }]);
  if (error) {
    alert('Error al agregar: ' + error.message);
  } else {
    alert('Agregado!');
    cargarObrasSociales();
  }
}

// --- Modal para agregar nueva obra social ---
const modal = document.getElementById('modal-agregar');
const btnAgregar = document.getElementById('btn-agregar');
const btnCancelar = document.getElementById('btn-cancelar');
const formAgregar = document.getElementById('form-agregar');

btnAgregar.addEventListener('click', () => {
  modal.style.display = 'block';
});

btnCancelar.addEventListener('click', () => {
  modal.style.display = 'none';
});

// Al enviar el formulario del modal
formAgregar.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(formAgregar);
  const obra_social = fd.get('obra_social');
  const condicion_copago = fd.get('condicion_copago') === 'true';
  const valor_copago = fd.get('valor_copago') || null;
  const cantidad_turnos = fd.get('cantidad_turnos') || null;
  const id_profesional = getIdProfesionalLogueado();

  // 1) Crear la obra social general
  const { data: nuevaOS, error: errorOS } = await supabase
    .from('obras_sociales')
    .insert([{ obra_social }])
    .select()
    .single();

  if (errorOS) {
    alert('Error al crear obra social: ' + errorOS.message);
    return;
  }

  // 2) Vincular al profesional con la obra social y config
  const { error: errorV } = await supabase
    .from('medico_obras_sociales')
    .insert([{
      medico_id: id_profesional,
      obra_social_id: nuevaOS.id,
      condicion_copago,
      valor_copago,
      cantidad_turnos
    }]);

  if (errorV) {
    alert('Error al vincular: ' + errorV.message);
    return;
  }

  alert('Obra social agregada y vinculada!');
  modal.style.display = 'none';
  formAgregar.reset();
  cargarObrasSociales();
});

// Inicializa la tabla al cargar
cargarObrasSociales();
</script>
