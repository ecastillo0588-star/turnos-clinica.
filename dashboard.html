<script type="module">
  import supabase from "./supabaseClient.js";

  // ------------ Labels de rol
  const roleLabels = {
    propietario: "Propietario",
    medico: "Médico",
    amp: "Asistente Médico Personal",
    amc: "Asistente de Centro Médico",
  };

  // ------------ Utils (sin \p{...})
  const strip = (s='') => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const norm  = (s='') => strip(s).toLowerCase().trim();

  function isRoleLikeName(name) {
    const n = norm(name);
    if (!n) return true;
    const tokens = [
      'propietario','medico',
      'asistente medico personal','asistente medico pers',
      'asistente de centro medico','asistente de centro me'
    ];
    return tokens.some(t => n === t || n.startsWith(t));
  }

  async function getSafeDisplayName() {
    try {
      const email = localStorage.getItem('email') || '';
      const badStored = localStorage.getItem('user_name') || '';

      if (isRoleLikeName(badStored)) {
        const profId = localStorage.getItem('profesional_id');

        if (profId) {
          const { data: p } = await supabase
            .from('profesionales')
            .select('nombre, apellido, email')
            .eq('id', profId)
            .maybeSingle();
          const full = [p?.nombre, p?.apellido].filter(Boolean).join(' ').trim();
          if (full) return full;
          if (p?.email) return p.email;
        }

        const { data: userResp } = await supabase.auth.getUser();
        const uid = userResp?.user?.id;
        if (uid) {
          const { data: prof } = await supabase
            .from('profiles')
            .select('display_name, email')
            .eq('id', uid)
            .maybeSingle();
          if (prof?.display_name && !isRoleLikeName(prof.display_name)) return prof.display_name;
          if (prof?.email) return prof.email;
        }
        return email || 'Usuario';
      }
      return badStored || 'Usuario';
    } catch {
      return localStorage.getItem('email') || 'Usuario';
    }
  }

  // ------------ Estado base
  const userRolRaw   = (localStorage.getItem('user_role') || '').toLowerCase();
  const userRolLabel = roleLabels[userRolRaw] || userRolRaw || '—';
  let   centroId     = localStorage.getItem('centro_medico_id');
  const profesionalId= localStorage.getItem('profesional_id');

  // Pinta header
  const safeName = await getSafeDisplayName();
  document.getElementById('user-name').textContent = safeName;
  document.getElementById('user-rol').textContent  = userRolLabel;
  localStorage.setItem('user_name', safeName);

  // ------------ Permisos de Configuración
  const btnConfig   = document.getElementById('btn-config');
  const puedeConfig = ['medico','propietario','amp'].includes(userRolRaw);
  if (!puedeConfig) btnConfig.style.display = 'none';

  // ------------ Cargar centros del profesional
  async function cargarCentroDashboard() {
    const centroSelect = document.getElementById('centro-select');
    centroSelect.innerHTML = '<option disabled selected>Cargando...</option>';

    let centros = [];
    if (profesionalId) {
      const { data, error } = await supabase
        .from('profesional_centro')
        .select('centro_id, centros_medicos(id, nombre)')
        .eq('profesional_id', profesionalId)
        .eq('activo', true);

      if (!error && data?.length) {
        centros = data
          .filter(r => r.centros_medicos)
          .map(r => ({ id: r.centros_medicos.id, nombre: r.centros_medicos.nombre }));
      }
    }

    centroSelect.innerHTML = '';
    if (!centros.length) {
      centroSelect.innerHTML = '<option disabled selected>No hay centros</option>';
      localStorage.removeItem('centro_medico_id');
      localStorage.removeItem('centro_medico_nombre');
      return;
    }

    for (const c of centros) {
      const opt = document.createElement('option');
      opt.value = String(c.id);
      opt.textContent = c.nombre;
      centroSelect.appendChild(opt);
    }

    centroSelect.value = String(centroId || centros[0].id);
    {
      const sel = centros.find(c => String(c.id) === String(centroSelect.value));
      if (sel) {
        localStorage.setItem('centro_medico_id', sel.id);
        localStorage.setItem('centro_medico_nombre', sel.nombre);
        centroId = String(sel.id);
      }
    }

    centroSelect.onchange = function() {
      const seleccionado = centros.find(c => String(c.id) === String(this.value));
      localStorage.setItem('centro_medico_id', seleccionado?.id ?? '');
      localStorage.setItem('centro_medico_nombre', seleccionado?.nombre ?? '');
      centroId = String(this.value);
    };
  }
  await cargarCentroDashboard();

  // ------------ Carga dinámica de paneles
  let _panelLoader = { reqId: 0, abort: null };

  async function cargarPanelHtml(url) {
    const main = document.getElementById('main-content');
    if (!main) throw new Error('#main-content no encontrado');

    _panelLoader.abort?.abort();
    const abort = new AbortController();
    _panelLoader.abort = abort;

    const myReqId = ++_panelLoader.reqId;

    main.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;height:180px;color:#6b6480">
        Cargando...
      </div>
    `;

    try {
      const resp = await fetch(url, { signal: abort.signal });
      if (!resp.ok) throw new Error('HTTP ' + resp.status + ' al cargar ' + url);
      const html = await resp.text();

      if (myReqId !== _panelLoader.reqId) return;

      main.innerHTML = html;
      main.scrollTop = 0;

      const file = url.split('#')[0].split('?')[0].split('/').pop() || '';

      if (file === 'inicio.html') {
        const mod = await import('./inicio.js');
        if (typeof mod.initInicio === 'function') await mod.initInicio(main);
      } else if (file === 'turnos.html') {
        const mod = await import('./turnos.js');
        if (typeof mod.initTurnos === 'function') await mod.initTurnos(main);
      } else if (file === 'pacientes.html') {
        try {
          const mod = await import('./pacientes.js');
          if (typeof mod.initPacientes === 'function') await mod.initPacientes(main);
        } catch (e) {
          console.warn('pacientes.js no disponible:', e);
        }
      }
    } catch (err) {
      if (err.name === 'AbortError') return;
      console.error(err);
      main.innerHTML = `
        <div style="padding:18px">
          <div style="background:#fff0f0;border:1px solid #f3c2c2;color:#8e0c2f;border-radius:8px;padding:14px">
            <strong>Error al cargar el panel:</strong><br>
            <code>${(err && err.message) || err}</code>
          </div>
        </div>
      `;
    } finally {
      if (myReqId === _panelLoader.reqId) {
        _panelLoader.abort = null;
      }
    }
  }

  // ------------ Auxiliares
  function setActiveMenu(btn) {
    document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
  }

  async function cargarPanelConfiguracion() {
    const panel = document.getElementById('configuracion-panel');
    panel.innerHTML = `
      <div class="card">
        <h2>Configuración</h2>
        <p>Próximamente...</p>
      </div>
    `;
  }

  // ------------ Carga inicial + Navegación
  await cargarPanelHtml('inicio.html');

  const mainEl = document.getElementById('main-content');
  const cfgEl  = document.getElementById('configuracion-panel');

  document.getElementById('btn-inicio').addEventListener('click', async function () {
    setActiveMenu(this);
    mainEl.classList.remove('hidden');
    cfgEl.classList.add('hidden');
    await cargarPanelHtml('inicio.html');
  });

  document.getElementById('btn-turnos').addEventListener('click', async function () {
    setActiveMenu(this);
    mainEl.classList.remove('hidden');
    cfgEl.classList.add('hidden');
    await cargarPanelHtml('turnos.html');
  });

  document.getElementById('btn-pacientes').addEventListener('click', async function () {
    setActiveMenu(this);
    mainEl.classList.remove('hidden');
    cfgEl.classList.add('hidden');
    await cargarPanelHtml('pacientes.html');
  });

  document.getElementById('btn-config').addEventListener('click', async function () {
    if (!['medico','propietario','amp'].includes((localStorage.getItem('user_role')||'').toLowerCase())) return;
    setActiveMenu(null);
    mainEl.classList.add('hidden');
    cfgEl.classList.remove('hidden');
    await cargarPanelConfiguracion();
  });

  document.getElementById('btn-logout').addEventListener('click', () => {
    localStorage.clear();
    window.location.href = 'index.html';
  });
</script>
