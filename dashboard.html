<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel - EG Health Solutions</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="app.css">
  <style>
    .power-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      margin: 0;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.18s;
      position: relative;
    }
    .power-btn:hover {
      background: rgba(220,0,40,0.08);
    }
    .power-btn svg {
      width: 30px;
      height: 30px;
      stroke: #b00020;
      transition: stroke 0.18s;
    }
    .power-btn:hover svg {
      stroke: #8e0c2f;
    }
    .power-btn .tooltip {
      display: none;
      position: absolute;
      left: 44px;
      top: 50%;
      transform: translateY(-50%);
      background: #381e60;
      color: #fff;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 14px;
      white-space: nowrap;
      z-index: 999;
    }
    .power-btn:hover .tooltip {
      display: block;
    }
    .sidebar {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      height: 100vh;
    }
    .sidebar .settings-slot {
      margin-top: auto;
      margin-bottom: 8px;
    }
    .sidebar .logout-slot {
      margin-bottom: 18px;
      margin-top: 8px;
      display: flex;
      justify-content: center;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      margin-bottom: 18px;
      padding: 8px 0 10px 0;
      border-bottom: 1px solid #ece5fc;
      background: #f7f9fb;
    }
    .user-info {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 18px;
      font-size: 16px;
      color: #381e60;
    }
    .user-info .user-name { font-weight: 500; }
    .user-info .user-rol { background: #7656b0; color: #fff; border-radius: 6px; padding: 2px 10px; font-size: 14px;}
    #centro-select { border: 1px solid #e3d8f6; border-radius: 6px; padding: 2px 8px; font-size: 15px; background: #fff;}
    #centro-nombre-top { font-weight: 500; }
    .brand-title { font-weight: bold; font-size: 21px; color: #381e60; margin-top: 18px; margin-bottom: 8px;}
    .brand-sub { font-size: 15px; color: #6b6480; margin-bottom: 12px;}
    .separator { border-bottom: 1px solid #ece5fc; margin: 10px 0; }
    .menu { display: flex; flex-direction: column; gap: 6px; }
    .menu button { background: #f7f9fb; border: none; padding: 10px 16px; border-radius: 6px; font-size: 15px; color: #381e60; cursor: pointer; transition: background 0.12s; }
    .menu button.active, .menu-subitem.active { background: #e7e2fa; color: #7656b0; }
    .menu button:hover, .menu-subitem:hover { background: #ece5fc; }
    .submenu-toggle { display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 7px 16px; font-weight: 500; color: #381e60; }
    .submenu-toggle.open .caret { transform: rotate(90deg); }
    .submenu-items { display: none; flex-direction: column; gap: 6px; margin-left: 18px; }
    .submenu-items.show { display: flex; }
    .menu-subitem { background: #f7f9fb; border: none; padding: 8px 12px; border-radius: 6px; font-size: 14px; color: #381e60; cursor: pointer; text-align: left; }
    .settings-btn { background: #7656b0; color: #fff; border: none; border-radius: 6px; padding: 7px 18px; font-size: 15px; cursor:pointer; font-weight: 500;}
    .settings-btn:hover { background: #7f62b6; }
    .main { padding: 32px 20px; min-height: 100vh; background: #f7f9fb;}
    .card { background: #fff; padding: 28px 22px; border-radius: 14px; box-shadow: 0 2px 12px rgba(80,60,160,0.10); max-width: 700px; margin: 0 auto; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div>
        <div class="brand-title">EG Health</div>
        <div class="brand-sub">
          Centro:
          <select id="centro-select" style="margin-left:4px; min-width:90px;"></select>
        </div>
      </div>
      <nav class="menu">
        <button id="btn-dashboard" class="active">Inicio</button>
        <button id="btn-pacientes">Pacientes</button>
        <button id="btn-profesionales">Profesionales</button>
        <div class="separator"></div>
        <div class="submenu-toggle" id="submenu-toggle">
          <span>Reportes</span>
          <span class="caret">&#9654;</span>
        </div>
        <div class="submenu-items" id="submenu-items">
          <button class="menu-subitem" id="btn-reporte-1">Turnos</button>
          <button class="menu-subitem" id="btn-reporte-2">Facturación</button>
        </div>
      </nav>
      <div class="settings-slot">
        <button class="settings-btn btn" id="btn-config">Configuración</button>
      </div>
      <div class="logout-slot">
        <button class="power-btn" id="btn-logout" tabindex="0">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M12 2v10" stroke-width="2" stroke-linecap="round"/>
            <circle cx="12" cy="12" r="9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="tooltip">Cerrar sesión</span>
        </button>
      </div>
    </aside>
    <main class="main">
      <div class="topbar">
        <div class="user-info">
          <span class="user-name" id="user-name"></span>
          <span class="user-rol" id="user-rol"></span>
        </div>
      </div>
      <div id="main-content" class="card">
        <h2>Bienvenido</h2>
        <img src="https://i.postimg.cc/ZY8mGGf2/Chat-GPT-Image-30-ago-2025-17-14-28.png" alt="EG Health Solutions Logo" style="max-width:140px;margin-bottom:18px;display:block;">
        <p>Selecciona una opción del menú lateral.</p>
      </div>
      <div id="configuracion-panel" class="hidden"></div>
    </main>
  </div>
  <script type="module">
    // Datos de usuario y centros
    const userName = localStorage.getItem('user_name') || 'Sin usuario';
    const userRol = localStorage.getItem('user_role') || '';
    const centroId = localStorage.getItem('centro_medico_id');
    const profesionalId = localStorage.getItem('profesional_id');

    // Ocultar botón configuración para asistentes
    if (userRol === "asistente") {
      document.getElementById('btn-config').style.display = 'none';
    }

    // Carga centros médicos asociados (usando Supabase)
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const supabaseUrl = 'https://vwkszvdvswznlgxlfdtz.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3a3N6dmR2c3d6bmxneGxmZHR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NDM4NDQsImV4cCI6MjA3MTExOTg0NH0.TnDGheCSTUqGwTCMiHZ_CUgcAztCqVTc1cINkMud8p0';
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    // Mostrar datos en la barra superior
    document.getElementById('user-name').textContent = userName;
    document.getElementById('user-rol').textContent = userRol;

    // Manejo de centros médicos
    async function cargarCentrosUsuario() {
      let centros = [];
      if (profesionalId) {
        let { data, error } = await supabase
          .from('profesional_centro')
          .select('centro_id, centros_medicos(id, nombre)')
          .eq('profesional_id', profesionalId)
          .eq('activo', true);
        if (!error && data) {
          centros = data.filter(row=>row.centros_medicos).map(row=>({
            id: row.centros_medicos.id,
            nombre: row.centros_medicos.nombre
          }));
        }
      }
      return centros;
    }

    async function inicializarCentros() {
      const centros = await cargarCentrosUsuario();
      const centroSelect = document.getElementById('centro-select');
      centroSelect.innerHTML = '';
      centros.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.nombre;
        centroSelect.appendChild(opt);
      });
      centroSelect.value = centroId || centros[0]?.id || '';
      centroSelect.onchange = function() {
        const seleccionado = centros.find(c=>c.id === this.value);
        localStorage.setItem('centro_medico_id', seleccionado.id);
        localStorage.setItem('centro_medico_nombre', seleccionado.nombre);
        // Aquí podrías recargar paneles o datos según el nuevo centro
      }
    }

    await inicializarCentros();

    // Sidebar submenu toggle
    const submenuToggle = document.getElementById('submenu-toggle');
    const submenuItems = document.getElementById('submenu-items');
    submenuToggle.addEventListener('click', function() {
      submenuItems.classList.toggle('show');
      submenuToggle.classList.toggle('open');
    });

    // Mostrar y ocultar paneles
    function showPanel(panel) {
      document.getElementById('main-content').classList.add('hidden');
      document.getElementById('configuracion-panel').classList.add('hidden');
      if(panel === 'dashboard') document.getElementById('main-content').classList.remove('hidden');
      if(panel === 'config') document.getElementById('configuracion-panel').classList.remove('hidden');
    }

    document.getElementById('btn-dashboard').addEventListener('click', function() {
      setActiveMenu(this);
      showPanel('dashboard');
      document.getElementById('main-content').innerHTML = `<h2>Bienvenido</h2>
        <img src="https://i.postimg.cc/ZY8mGGf2/Chat-GPT-Image-30-ago-2025-17-14-28.png" alt="EG Health Solutions Logo" style="max-width:140px;margin-bottom:18px;display:block;">
        <p>Selecciona una opción del menú lateral.</p>`;
    });
    document.getElementById('btn-pacientes').addEventListener('click', function() {
      setActiveMenu(this);
      showPanel('dashboard');
      document.getElementById('main-content').innerHTML = `<h2>Pacientes</h2><p>Aquí irá la gestión de pacientes...</p>`;
    });
    document.getElementById('btn-profesionales').addEventListener('click', function() {
      setActiveMenu(this);
      showPanel('dashboard');
      document.getElementById('main-content').innerHTML = `<h2>Profesionales</h2><p>Aquí irá la gestión de profesionales...</p>`;
    });
    document.getElementById('btn-reporte-1').addEventListener('click', function() {
      setActiveSubMenu(this);
      showPanel('dashboard');
      document.getElementById('main-content').innerHTML = `<h2>Reporte de turnos</h2><p>Gráficos e información de turnos.</p>`;
    });
    document.getElementById('btn-reporte-2').addEventListener('click', function() {
      setActiveSubMenu(this);
      showPanel('dashboard');
      document.getElementById('main-content').innerHTML = `<h2>Reporte de facturación</h2><p>Gráficos e información de facturación.</p>`;
    });
    document.getElementById('btn-config').addEventListener('click', async function() {
      setActiveMenu(this);
      showPanel('config');
      await cargarPanelConfiguracion();
    });

    document.getElementById('btn-logout').addEventListener('click', function() {
      localStorage.clear();
      window.location.href = "index.html";
    });

    function setActiveMenu(btn) {
      document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      document.querySelectorAll('.menu-subitem').forEach(b => b.classList.remove('active'));
    }
    function setActiveSubMenu(btn) {
      setActiveMenu(null);
      document.querySelectorAll('.menu-subitem').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    // Panel de configuración: carga el archivo configuracion.html y lo inserta en el div
    async function cargarPanelConfiguracion() {
      const resp = await fetch('configuracion.html');
      let html = await resp.text();
      document.getElementById('configuracion-panel').innerHTML = html;
      const panel = document.getElementById('configuracion-panel');
      Array.from(panel.querySelectorAll('script[type="module"]')).forEach(oldScript => {
        const newScript = document.createElement('script');
        newScript.type = 'module';
        if (oldScript.src) newScript.src = oldScript.src;
        else newScript.textContent = oldScript.textContent;
        document.body.appendChild(newScript);
      });
    }
  </script>
</body>
</html>
