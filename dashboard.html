<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel - EG Health Solutions</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- CSS global de la app -->
  <link rel="stylesheet" href="app.css">
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div>
        <div class="brand-title">EG Health</div>
        <div class="brand-sub" id="user-name">—</div>
        <div class="badge" id="user-rol">—</div>
      </div>

      <div class="separator"></div>

      <label style="gap:6px;font-size:14px">
        <span class="muted" style="font-size:12px">Centro</span>
        <select id="centro-select"></select>
      </label>

      <nav class="menu" style="margin-top:8px">
        <button id="btn-inicio" class="active">Inicio</button>
        <button id="btn-turnos">Turnos</button>
        <button id="btn-pacientes">Pacientes</button>
      </nav>

      <div class="settings-slot">
        <button class="settings-btn btn" id="btn-config">Configuración</button>
      </div>

      <div class="logout-slot" style="text-align:center">
        <button class="btn danger" id="btn-logout">Cerrar sesión</button>
      </div>
    </aside>

    <!-- Contenido principal -->
    <main class="main">
      <!-- OJO: por defecto SIN .card para que Inicio pueda ser full width -->
      <div id="main-content"></div>
      <div id="configuracion-panel" class="hidden"></div>
      <div id="modal-root"></div>
    </main>
  </div>

  <script type="module">
    import supabase from "./supabaseClient.js";

    /* =============================
       Utilidades de estilos/paneles
       ============================= */
    function ensureStylesheet(href, id) {
      if (!href) return;
      const linkId = id || ('css-' + href.replace(/[^\w]/g, '-'));
      let link = document.getElementById(linkId);
      if (link) return; // ya cargado
      link = document.createElement('link');
      link.id = linkId;
      link.rel = 'stylesheet';
      // cache-bust para evitar usar versión vieja del panel
      link.href = href + (href.includes('?') ? '&' : '?') + 'v=' + Date.now();
      document.head.appendChild(link);
    }

    function setActiveMenu(btn) {
      document.querySelectorAll(".menu button").forEach(b => b.classList.remove("active"));
      if (btn) btn.classList.add("active");
    }

    /* =============================
       Mapeo de paneles
       ============================= */
    const PANELS = {
      inicio:   { html: "inicio.html",   js: "./inicio.js",   init: "initInicio",   css: "inicio.css",   full: true  },
      turnos:   { html: "turnos.html",   js: "./turnos.js",   init: "initTurnos",   css: "turnos.css",   full: false },
      pacientes:{ html: "pacientes.html",js: "./pacientes.js",init: "initPacientes",css: "pacientes.css",full: false },
    };

    let _panelLoader = { reqId: 0, abort: null };

    async function cargarPanel(key) {
      const meta = PANELS[key];
      if (!meta) throw new Error("Panel no definido: " + key);

      const main = document.getElementById("main-content");
      const cfg  = document.getElementById("configuracion-panel");
      main.classList.remove("hidden");
      cfg.classList.add("hidden");

      // cancelar carga anterior si existía
      _panelLoader.abort?.abort();
      const abort = new AbortController();
      _panelLoader.abort = abort;
      const myReqId = ++_panelLoader.reqId;

      // loader
      main.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;height:180px;color:#6b6480">
          Cargando...
        </div>
      `;

      try {
        // 1) Traer HTML del panel
        const resp = await fetch(meta.html, { signal: abort.signal });
        if (!resp.ok) throw new Error("HTTP " + resp.status + " al cargar " + meta.html);
        const html = await resp.text();
        if (myReqId !== _panelLoader.reqId) return;

        // 2) Inyectar HTML
        main.innerHTML = html;
        main.scrollTop = 0;

        // 3) Asegurar CSS del panel
        if (meta.css) ensureStylesheet(meta.css, "css-" + key);

        // 4) Control de ancho: Inicio es full (sin .card); otros, en card
        if (meta.full) main.classList.remove("card");
        else           main.classList.add("card");

        // 5) Import dinámico del JS del panel y llamar init(...)
        if (meta.js && meta.init) {
          const mod = await import(meta.js);
          const fn  = mod?.[meta.init];
          if (typeof fn === "function") await fn(main);
        }
      } catch (err) {
        if (err?.name === "AbortError") return;
        console.error(err);
        main.classList.add("card"); // el error lo mostramos como card
        main.innerHTML = `
          <div style="background:#fff0f0;border:1px solid #f3c2c2;color:#8e0c2f;border-radius:8px;padding:14px">
            <strong>Error al cargar el panel:</strong><br>
            <code>${(err && err.message) || err}</code>
          </div>
        `;
      } finally {
        if (myReqId === _panelLoader.reqId) _panelLoader.abort = null;
      }
    }

    /* =============================
       Usuario / Rol / Nombre seguro
       ============================= */
    const roleLabels = {
      propietario: "Propietario",
      medico: "Médico",
      amp: "Asistente Médico Personal",
      amc: "Asistente de Centro Médico",
    };

    const norm = (s="") => s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
    function isRoleLikeName(name) {
      const n = norm(name);
      if (!n) return true;
      const tokens = [
        "propietario", "medico",
        "asistente medico personal", "asistente medico pers",
        "asistente de centro medico", "asistente de centro me"
      ];
      return tokens.some(t => n === t || n.startsWith(t));
    }

    async function getSafeDisplayName() {
      try {
        const email     = localStorage.getItem("email") || "";
        const badStored = localStorage.getItem("user_name") || "";
        if (!isRoleLikeName(badStored)) return badStored || email || "Usuario";

        const profId = localStorage.getItem("profesional_id");
        if (profId) {
          const { data: p } = await supabase
            .from("profesionales")
            .select("nombre, apellido, email")
            .eq("id", profId)
            .maybeSingle();
          const full = [p?.nombre, p?.apellido].filter(Boolean).join(" ").trim();
          if (full) return full;
          if (p?.email) return p.email;
        }

        const { data: userResp } = await supabase.auth.getUser();
        const uid = userResp?.user?.id;
        if (uid) {
          const { data: prof } = await supabase
            .from("profiles")
            .select("display_name, email")
            .eq("id", uid)
            .maybeSingle();
          if (prof?.display_name && !isRoleLikeName(prof.display_name)) return prof.display_name;
          if (prof?.email) return prof.email;
        }

        return email || "Usuario";
      } catch {
        return localStorage.getItem("email") || "Usuario";
      }
    }

    const userRolRaw   = (localStorage.getItem("user_role") || "").toLowerCase();
    const userRolLabel = roleLabels[userRolRaw] || userRolRaw || "—";
    document.getElementById("user-rol").textContent  = userRolLabel;

    const safeName = await getSafeDisplayName();
    document.getElementById("user-name").textContent = safeName;
    localStorage.setItem("user_name", safeName);

    // mostrar/ocultar Config
    const btnConfig   = document.getElementById("btn-config");
    const puedeConfig = ["medico","propietario","amp"].includes(userRolRaw);
    if (!puedeConfig) btnConfig.style.display = "none";

    /* =============================
       Centros (sidebar)
       ============================= */
    let centroId = localStorage.getItem("centro_medico_id");
    const profesionalId = localStorage.getItem("profesional_id");

    async function cargarCentros() {
      const centroSelect = document.getElementById("centro-select");
      centroSelect.innerHTML = '<option disabled selected>Cargando...</option>';

      let centros = [];
      if (profesionalId) {
        const { data, error } = await supabase
          .from("profesional_centro")
          .select("centro_id, centros_medicos(id, nombre)")
          .eq("profesional_id", profesionalId)
          .eq("activo", true);

        if (!error && data?.length) {
          centros = data
            .filter(r => r.centros_medicos)
            .map(r => ({ id: r.centros_medicos.id, nombre: r.centros_medicos.nombre }));
        }
      }

      centroSelect.innerHTML = "";
      if (!centros.length) {
        centroSelect.innerHTML = '<option disabled selected>No hay centros</option>';
        localStorage.removeItem("centro_medico_id");
        localStorage.removeItem("centro_medico_nombre");
        return;
      }

      for (const c of centros) {
        const opt = document.createElement("option");
        opt.value = String(c.id);
        opt.textContent = c.nombre;
        centroSelect.appendChild(opt);
      }

      centroSelect.value = String(centroId || centros[0].id);
      {
        const sel = centros.find(c => String(c.id) === String(centroSelect.value));
        if (sel) {
          localStorage.setItem("centro_medico_id", sel.id);
          localStorage.setItem("centro_medico_nombre", sel.nombre);
          centroId = String(sel.id);
        }
      }

      centroSelect.onchange = function () {
        const sel = centros.find(c => String(c.id) === String(this.value));
        localStorage.setItem("centro_medico_id", sel?.id ?? "");
        localStorage.setItem("centro_medico_nombre", sel?.nombre ?? "");
        centroId = String(this.value);
        // si el panel actual depende del centro, que lo refresque él mismo
      };
    }
    await cargarCentros();

    /* =============================
       Configuración (stub)
       ============================= */
    async function cargarPanelConfiguracion() {
      const panel = document.getElementById("configuracion-panel");
      panel.innerHTML = `
        <div class="card">
          <h2>Configuración</h2>
          <p class="muted">Próximamente…</p>
        </div>
      `;
    }

    /* =============================
       Navegación
       ============================= */
    await cargarPanel("inicio"); // carga inicial

    document.getElementById("btn-inicio").addEventListener("click", async function () {
      setActiveMenu(this);
      await cargarPanel("inicio");
    });

    document.getElementById("btn-turnos").addEventListener("click", async function () {
      setActiveMenu(this);
      await cargarPanel("turnos");
    });

    document.getElementById("btn-pacientes").addEventListener("click", async function () {
      setActiveMenu(this);
      await cargarPanel("pacientes");
    });

    document.getElementById("btn-config").addEventListener("click", async function () {
      if (!["medico","propietario","amp"].includes((localStorage.getItem("user_role") || "").toLowerCase())) return;
      setActiveMenu(null);
      document.getElementById("main-content").classList.add("hidden");
      const cfg = document.getElementById("configuracion-panel");
      cfg.classList.remove("hidden");
      await cargarPanelConfiguracion();
    });

    document.getElementById("btn-logout").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
