<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Turnos — EG Health Solutions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box}
    :root{
      --brand:#7656b0; --brand-2:#a490d7; --ink:#381e60; --muted:#6b6480;
      --bg:#f7f9fb; --card:#fff; --line:#ece5fc; --accent:#0b5394;
      --ok:#0a7d38; --okbg:#e8fff0; --danger:#b00020; --dangerbg:#fde7eb;
    }
    body{margin:0;background:var(--bg);font-family:'Segoe UI',Arial,sans-serif;color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}

    /* Contenedor superior */
    .toolbar{display:grid;grid-template-columns: 1.1fr 1.1fr 1.4fr 1fr auto;gap:12px;align-items:end;margin-bottom:14px;
      background:var(--card);border-radius:16px;box-shadow:0 2px 12px rgba(80,60,160,.10);padding:14px}
    .field{display:flex;flex-direction:column;gap:6px;position:relative}
    .field label{font-size:12px;color:var(--muted)}
    .inp,.sel{background:#f7f9fb;border:1.5px solid var(--line);border-radius:7px;padding:9px 10px;font-size:14px;color:var(--ink);outline:none;width:100%}
    .inp:focus,.sel:focus{border-color:var(--brand-2)}
    .btn{appearance:none;border:none;background:var(--brand);color:#fff;border-radius:8px;padding:10px 12px;font-weight:600;cursor:pointer;transition:filter .15s}
    .btn.secondary{background:#e7e2fa;color:#5a3e9a}
    .btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
    .btn.ok{background:var(--ok)} .btn.danger{background:var(--danger)}
    .btn:hover{filter:brightness(.98)}

    /* Chip paciente seleccionado */
    .chip{position:absolute;right:8px;top:-18px;background:#e7e2fa;color:#5a3e9a;border-radius:999px;padding:2px 8px;font-size:12px;display:flex;gap:6px;align-items:center;z-index:3}
    .chip button{all:unset;cursor:pointer}

    /* Typeahead */
    .suggest{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:10px;margin-top:6px;box-shadow:0 6px 18px rgba(0,0,0,.08);z-index:20;max-height:260px;overflow:auto}
    .s-item{padding:10px 12px;display:flex;justify-content:space-between;gap:10px;border-bottom:1px solid var(--line);cursor:pointer}
    .s-item:last-child{border-bottom:none}
    .s-title{font-weight:600}
    .s-meta{font-size:12px;color:var(--muted)}
    .s-create{background:#faf7ff}

    /* Encabezado calendario */
    .head{display:flex;align-items:center;justify-content:space-between;margin:12px 0 6px}
    .head h2{margin:0;font-size:20px}
    .legend{display:flex;gap:12px;align-items:center;margin-top:10px;color:var(--muted);font-size:13px}
    .legend .dot{width:10px;height:10px;border-radius:50%}
    .dot.free{background:#9ee6b7}.dot.busy{background:#ffd8a9}.dot.none{background:#d9d2e9}

    /* Calendario */
    .cal{background:var(--card);border-radius:16px;box-shadow:0 2px 12px rgba(80,60,160,.10);padding:14px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .dow{font-size:12px;color:var(--muted);text-align:center;margin-bottom:6px}
    .day{background:#faf9ff;border:1px solid var(--line);border-radius:12px;min-height:110px;padding:8px;display:flex;flex-direction:column;gap:6px}
    .day .num{font-weight:600}
    .day .badge{margin-top:auto;align-self:flex-start;font-size:12px;border-radius:999px;padding:2px 8px}
    .day.free .badge{background:#e8fff0;color:#045c2b}
    .day.busy .badge{background:#fff4e6;color:#8a5800}
    .day.empty{opacity:.55}
    .day.clickable{cursor:pointer;transition:transform .05s}
    .day.clickable:hover{transform:translateY(-1px)}
    .footer-mini{margin-top:8px;font-size:12px;color:var(--muted)}

    /* Backdrops + modales */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.22);display:none;align-items:center;justify-content:center;z-index:1000;overscroll-behavior:contain}
    .modal{
      width:min(900px,96vw);
      background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.22);padding:18px;border:1px solid var(--line);
      max-height:92vh; overflow:auto; overflow-x:auto;  /* ← scroll total siempre */
    }
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal h3{margin:0;font-size:18px}
    .close{background:transparent;border:none;font-size:24px;color:var(--brand);cursor:pointer}

    .slots{border:1px solid var(--line);border-radius:10px;padding:10px;max-height:60vh;overflow:auto}
    .slot{display:flex;align-items:center;gap:10px;justify-content:space-between;border:1px solid var(--line);border-radius:10px;padding:10px 12px;margin:6px 0;background:#faf9ff}
    .slot.unavailable{opacity:.45}
    .slot .time{font-weight:700;color:var(--accent)}
    .slot .mini{font-size:12px;color:var(--muted)}
    .slot button{padding:6px 10px}

    /* Tabla turnos del día */
    .tlist{width:100%;border-collapse:separate;border-spacing:0 6px}
    .trow{background:#faf9ff;border:1px solid var(--line);border-radius:10px}
    .tcell{padding:8px 10px}
    .actions{display:flex;gap:8px;justify-content:flex-end;align-items:center}
    .icon-btn{border:none;background:#f4f1ff;border:1px solid var(--line);width:34px;height:34px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;position:relative}
    .icon-btn:hover{filter:brightness(.98)}
    .icon-btn[data-tip]::after{
      content:attr(data-tip); position:absolute; bottom:110%; left:50%; transform:translateX(-50%);
      background:#381e60;color:#fff;padding:4px 8px;border-radius:8px;font-size:12px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .12s;
    }
    .icon-btn:hover::after{opacity:1}

    /* Modal OK */
    .modal-ok{width:min(640px,96vw);background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.22);padding:18px;border:2px solid var(--okbg);
      max-height:92vh; overflow:auto}
    .ok-head{display:flex;gap:10px;align-items:center}
    .ok-badge{background:var(--okbg);color:var(--ok);border-radius:999px;padding:4px 10px;font-weight:700;font-size:13px}
    .ok-list{margin:12px 0 6px;padding-left:18px}
    .ok-list li{margin:6px 0}

    /* Modal Paciente (3 columnas + scroll X si no entra) */
    .grid3{display:grid;grid-template-columns:1.1fr 1fr 1fr;gap:12px; min-width:980px}
    .col-card{border:1px solid var(--line);border-radius:12px;padding:12px;background:#faf9ff}
    .col-card h4{margin:0 0 8px;color:var(--ink)}
    .span3{grid-column:1/4}
    @media (max-width:980px){ .grid3{ min-width:auto; grid-template-columns:1fr } .span3{ grid-column:auto } }
    .uploadzone{background:#fff;border:2px dashed var(--line);border-radius:12px;padding:12px;text-align:center}
    .uploadthumb{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:8px}
    .uploadthumb img{width:56px;height:56px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    .badge-req{color:#b00020;margin-left:4px}

    /* scrollbars bonitos */
    .modal::-webkit-scrollbar{ height:10px; width:10px }
    .modal::-webkit-scrollbar-thumb{ background:#d8cfff; border-radius:8px }
  </style>
</head>
<body>
<div class="wrap">

  <!-- Toolbar -->
  <div class="toolbar">
    <!-- Centro -->
    <div class="field" id="centro-field">
      <label>Centro médico</label>
      <select id="turnos-centro-select" class="sel" style="display:none;"></select>
      <input id="turnos-centro-nombre" class="inp" type="text" readonly style="display:none;"/>
    </div>

    <!-- Profesional -->
    <div class="field">
      <label>Profesional</label>
      <select id="turnos-profesional-select" class="sel"><option>Profesional</option></select>
    </div>

    <!-- Paciente -->
    <div class="field" id="turnos-paciente-field">
      <label>Paciente</label>
      <input id="turnos-paciente-input" class="inp" placeholder="Apellido Nombre o DNI" autocomplete="off"/>
      <div id="turnos-paciente-suggest" class="suggest" style="display:none;"></div>
      <div id="turnos-paciente-chip" class="chip" style="display:none;">
        <span id="turnos-paciente-chip-text"></span>
        <button id="turnos-paciente-clear">✕</button>
      </div>
    </div>

    <!-- Tipo turno -->
    <div class="field">
      <label>Tipo de turno</label>
      <select id="turnos-tipo" class="sel">
        <option value="nueva_consulta">Nueva consulta</option>
        <option value="recurrente">Recurrente</option>
        <option value="sobreturno">Sobreturno</option>
      </select>
    </div>

    <!-- Hoy -->
    <div class="field" style="align-items:flex-end">
      <button id="turnos-btn-hoy" class="btn ghost">Hoy</button>
    </div>
  </div>

  <!-- Header calendario -->
  <div class="head">
    <div style="display:flex;gap:8px;align-items:center">
      <button id="turnos-prev-month" class="btn secondary">◀</button>
      <h2 id="turnos-cal-title">Calendario</h2>
      <button id="turnos-next-month" class="btn secondary">▶</button>
    </div>
    <div class="legend">
      <span class="dot free"></span> con disponibilidad
      <span class="dot busy"></span> sin hueco para este tipo
      <span class="dot none"></span> sin agenda
    </div>
  </div>

  <!-- Calendario -->
  <div class="cal">
    <div class="cal-grid" id="turnos-cal-dow"></div>
    <div class="cal-grid" id="turnos-cal-grid"></div>
  </div>
  <div class="footer-mini" id="turnos-status"></div>
</div>

<!-- Modal Día -->
<div class="modal-backdrop" id="turnos-modal">
  <div class="modal">
    <header>
      <h3 id="turnos-modal-title">Turnos del día</h3>
      <button class="close" id="turnos-modal-close">&times;</button>
    </header>

    <section class="slots">
      <h4 style="margin:0 0 8px">Horarios disponibles</h4>
      <div id="turnos-slots-list"></div>

      <div style="height:1px;background:var(--line);margin:12px 0"></div>

      <h4 style="margin:0 0 8px">Turnos del día</h4>
      <div id="turnos-dia-list"></div>
    </section>
  </div>
</div>

<!-- Modal OK (confirmación de turno asignado) -->
<div class="modal-backdrop" id="turnos-modal-ok" style="display:none;">
  <div class="modal-ok">
    <header style="display:flex;justify-content:space-between;align-items:center">
      <div class="ok-head">
        <div class="ok-badge">✔ Turno asignado</div>
        <div id="ok-title" style="font-weight:700"></div>
      </div>
      <button class="close" id="ok-close">&times;</button>
    </header>
    <ul class="ok-list">
      <li><b>Paciente:</b> <span id="ok-paciente"></span></li>
      <li><b>DNI:</b> <span id="ok-dni"></span></li>
      <li><b>Fecha y hora:</b> <span id="ok-fecha-hora"></span></li>
      <li><b>Profesional:</b> <span id="ok-prof"></span></li>
      <li><b>Centro:</b> <span id="ok-centro"></span></li>
      <li><b>Dirección:</b> <span id="ok-direccion"></span></li>
    </ul>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <a id="ok-wa-link" class="btn ok" target="_blank" rel="noopener">Enviar por WhatsApp</a>
      <button id="ok-copy" class="btn ghost">Copiar link</button>
      <span id="ok-msg" class="footer-mini"></span>
    </div>
  </div>
</div>

<!-- Modal Crear Paciente (3 columnas) -->
<div class="modal-backdrop" id="turnos-modal-paciente" style="display:none;">
  <div class="modal">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 style="margin:0">Crear nuevo paciente</h3>
      <button class="close" id="turnos-modal-paciente-close">&times;</button>
    </header>

    <div class="grid3">
      <!-- Col 1 -->
      <div class="col-card">
        <h4>Datos del paciente</h4>
        <label>DNI <span class="badge-req">*</span></label>
        <input id="np-dni" class="inp" required />
        <label>Nombre <span class="badge-req">*</span></label>
        <input id="np-nombre" class="inp" required />
        <label>Apellido <span class="badge-req">*</span></label>
        <input id="np-apellido" class="inp" required />
        <label>Fecha de nacimiento <span class="badge-req">*</span></label>
        <input id="np-fecha-nac" class="inp" type="date" required />
        <label>Teléfono <span class="badge-req">*</span></label>
        <input id="np-telefono" class="inp" required />
        <label>Email</label>
        <input id="np-email" class="inp" type="email" />
      </div>

      <!-- Col 2 -->
      <div class="col-card">
        <h4>Obra social</h4>
        <label>Obra social</label>
        <select id="np-obra" class="sel">
          <option value="">(Sin obra social)</option>
        </select>
        <div id="np-obra-info" class="footer-mini" style="min-height:18px;margin-top:6px;"></div>

        <label>N° afiliado</label>
        <input id="np-afiliado" class="inp" />

        <label>Credencial (imagen)</label>
        <div class="uploadzone">
          <input type="file" id="np-cred-file" accept="image/*,.pdf" style="display:none" />
          <button type="button" id="np-cred-select" class="btn ghost">Seleccionar archivo</button>
          <div id="np-cred-preview" class="uploadthumb" style="display:none"></div>
        </div>
      </div>

      <!-- Col 3 -->
      <div class="col-card">
        <h4>Contacto de emergencia</h4>
        <label>Contacto - Nombre</label>
        <input id="np-contacto-nombre" class="inp" />
        <label>Contacto - Apellido</label>
        <input id="np-contacto-apellido" class="inp" />
        <label>Contacto - Celular</label>
        <input id="np-contacto-cel" class="inp" />
        <label>Vínculo</label>
        <input id="np-vinculo" class="inp" />
      </div>

      <!-- Historia clínica URL -->
      <div class="col-card span3">
        <h4>Historia clínica</h4>
        <label>URL (Google Docs)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="np-historia" class="inp" type="url" placeholder="https://docs.google.com/..." style="flex:1" />
          <a id="np-historia-open" class="btn ghost" target="_blank" rel="noopener">Abrir</a>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <button class="btn" id="turnos-guardar-paciente">Guardar paciente</button>
      <span id="turnos-np-msg" class="footer-mini"></span>
    </div>
  </div>
</div>

<script type="module">
import supabase from './supabaseClient.js';
import { isValidHourRange } from './validators.js';

/* ====== UI refs ====== */
const UI = {
  centroSelect: document.getElementById('turnos-centro-select'),
  centroNombre: document.getElementById('turnos-centro-nombre'),
  profesionalSelect: document.getElementById('turnos-profesional-select'),
  tipoTurno: document.getElementById('turnos-tipo'),
  btnHoy: document.getElementById('turnos-btn-hoy'),
  prevMonth: document.getElementById('turnos-prev-month'),
  nextMonth: document.getElementById('turnos-next-month'),
  calTitle: document.getElementById('turnos-cal-title'),
  calGrid: document.getElementById('turnos-cal-grid'),
  calDow: document.getElementById('turnos-cal-dow'),
  status: document.getElementById('turnos-status'),
  modal: document.getElementById('turnos-modal'),
  modalClose: document.getElementById('turnos-modal-close'),
  modalTitle: document.getElementById('turnos-modal-title'),
  slotsList: document.getElementById('turnos-slots-list'),
  turnosDiaList: document.getElementById('turnos-dia-list'),
  // Typeahead
  pacInput: document.getElementById('turnos-paciente-input'),
  pacSuggest: document.getElementById('turnos-paciente-suggest'),
  pacChip: document.getElementById('turnos-paciente-chip'),
  pacChipText: document.getElementById('turnos-paciente-chip-text'),
  pacClear: document.getElementById('turnos-paciente-clear'),
  // OK modal
  okBackdrop: document.getElementById('turnos-modal-ok'),
  okClose: document.getElementById('ok-close'),
  okTitle: document.getElementById('ok-title'),
  okPaciente: document.getElementById('ok-paciente'),
  okDni: document.getElementById('ok-dni'),
  okFechaHora: document.getElementById('ok-fecha-hora'),
  okProf: document.getElementById('ok-prof'),
  okCentro: document.getElementById('ok-centro'),
  okDir: document.getElementById('ok-direccion'),
  okWa: document.getElementById('ok-wa-link'),
  okCopy: document.getElementById('ok-copy'),
  okMsg: document.getElementById('ok-msg'),
  // Modal Paciente
  modalPac: document.getElementById('turnos-modal-paciente'),
  modalPacClose: document.getElementById('turnos-modal-paciente-close'),
  npDni: document.getElementById('np-dni'),
  npFechaNac: document.getElementById('np-fecha-nac'),
  npNombre: document.getElementById('np-nombre'),
  npApellido: document.getElementById('np-apellido'),
  npTel: document.getElementById('np-telefono'),
  npEmail: document.getElementById('np-email'),
  npObra: document.getElementById('np-obra'),
  npObraInfo: document.getElementById('np-obra-info'),
  npAfiliado: document.getElementById('np-afiliado'),
  npConNom: document.getElementById('np-contacto-nombre'),
  npConApe: document.getElementById('np-contacto-apellido'),
  npConCel: document.getElementById('np-contacto-cel'),
  npVinculo: document.getElementById('np-vinculo'),
  npHistoria: document.getElementById('np-historia'),
  npHistoriaOpen: document.getElementById('np-historia-open'),
  npCredFile: document.getElementById('np-cred-file'),
  npCredSelect: document.getElementById('np-cred-select'),
  npCredPreview: document.getElementById('np-cred-preview'),
  npGuardar: document.getElementById('turnos-guardar-paciente'),
  npMsg: document.getElementById('turnos-np-msg'),
};

/* ====== Sesión ====== */
let currentCentroId = localStorage.getItem('centro_medico_id');
let currentCentroNombre = localStorage.getItem('centro_medico_nombre') || '';
let currentCentroDireccion = '';
const userRole = localStorage.getItem('user_role');     // 'medico' | 'asistente' | 'propietario'
const loggedProfesionalId = localStorage.getItem('profesional_id');
if (!currentCentroId) { alert('No hay centro seleccionado. Volviendo al login.'); window.location.href='index.html'; }

/* ====== Fecha & helpers ====== */
function todayInfo(){ const d=new Date(); return { y:d.getFullYear(), m:d.getMonth(), d:d.getDate() }; }
function pad(n){ return n<10 ? '0'+n : ''+n; }
function toISODate(y,m,d){ return `${y}-${pad(m+1)}-${pad(d)}`; }
function addMinutes(hhmm, minutes){ const [h,m]=hhmm.split(':').map(Number); const base=new Date(2000,0,1,h,m,0); base.setMinutes(base.getMinutes()+minutes); return `${pad(base.getHours())}:${pad(base.getMinutes())}`; }
function cmpTime(a,b){ if(a===b) return 0; return a<b ? -1 : 1; }
function monthRange(y,m){ const first=new Date(y,m,1); const last=new Date(y,m+1,0); return { start: toISODate(y,m,1), end: toISODate(y,m,last.getDate()) }; }
const DOW = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
function nativeFirstDow(date){ const js=date.getDay(); return (js===0)?6:js-1; }
function groupByFecha(arr){ const map=new Map(); for(const x of arr){ const k=x.fecha; if(!map.has(k)) map.set(k,[]); map.get(k).push(x); } return map; }
function toHM(t){ return (t ?? '').toString().slice(0,5); }
function overlaps(aStart,aEnd,bStart,bEnd){ return (aStart < bEnd) && (bStart < aEnd); }
function fmtDateLong(iso){ return new Date(iso+'T12:00:00').toLocaleDateString('es-AR',{weekday:'long', day:'numeric', month:'long', year:'numeric'}) }
function minutesDiff(start,end){ const [h1,m1]=start.split(':').map(Number), [h2,m2]=end.split(':').map(Number); return (h2*60+m2)-(h1*60+m1); }
function normalizePhoneForWA(phoneRaw){
  if (!phoneRaw) return '';
  let p = String(phoneRaw).replace(/[^\d]/g,'');
  if (p.startsWith('0')) p = p.slice(1);
  if (!p.startsWith('54')) p = '54' + p; // ajustar si usás otro prefijo país
  return p;
}
function buildWhatsAppMessage({pac, fechaISO, start, end, prof, centro, dir}){
  const fecha = fmtDateLong(fechaISO);
  const hora = `${start} a ${end}`;
  return `Hola ${pac.apellido}, ${pac.nombre}! Te confirmamos tu turno el ${fecha} de ${hora} con ${prof} en ${centro} (${dir}). Si no podés asistir, por favor avisá. ¡Gracias!`;
}

/* ====== Estado ====== */
let view = todayInfo();
let currentProfesional = null;
let duracionCfg = { nueva_consulta:15, recurrente:15, sobreturno:15 };
let modalDateISO = null;
let pacienteSeleccionado = null;
let obrasSocialesCache = [];
let reprogramState = null; // { turno, durMin }

/* ====== Centros ====== */
async function fetchCentroById(id){
  const { data } = await supabase.from('centros_medicos').select('nombre,direccion').eq('id', id).single();
  return { nombre: data?.nombre || '', direccion: data?.direccion || '' };
}
async function getCentrosDeProfesional(profesionalId){
  const { data, error } = await supabase
    .from('profesional_centro')
    .select('centro_id, activo, centros_medicos(id, nombre)')
    .eq('profesional_id', profesionalId)
    .eq('activo', true);
  if (error || !data) return [];
  return data.filter(r=>r.centros_medicos).map(r=>({ id:r.centros_medicos.id, nombre:r.centros_medicos.nombre }));
}
async function ensureCentroWidgets(){
  if (userRole === 'asistente'){
    UI.centroNombre.style.display = '';
    UI.centroSelect.style.display = 'none';
    const c = await fetchCentroById(currentCentroId);
    currentCentroNombre = c.nombre || currentCentroNombre;
    currentCentroDireccion = c.direccion || '';
    UI.centroNombre.value = currentCentroNombre || '(sin nombre)';
  } else {
    UI.centroSelect.style.display = '';
    UI.centroNombre.style.display = 'none';
    const centros = await getCentrosDeProfesional(loggedProfesionalId);
    const sel = UI.centroSelect;
    if (!centros.length){ sel.innerHTML = '<option value="">Sin centros</option>'; return; }
    sel.innerHTML = centros.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join('');
    if (currentCentroId && centros.some(c=>c.id===currentCentroId)) sel.value = currentCentroId; else { currentCentroId = centros[0].id; sel.value = currentCentroId; }
    const c = await fetchCentroById(currentCentroId);
    currentCentroNombre = c.nombre || sel.options[sel.selectedIndex]?.textContent || '';
    currentCentroDireccion = c.direccion || '';
    sel.addEventListener('change', async ()=>{
      currentCentroId = sel.value;
      const c2 = await fetchCentroById(currentCentroId);
      currentCentroNombre = c2.nombre || sel.options[sel.selectedIndex]?.textContent || '';
      currentCentroDireccion = c2.direccion || '';
      localStorage.setItem('centro_medico_id', currentCentroId);
      localStorage.setItem('centro_medico_nombre', currentCentroNombre);
      await loadProfesionales();
      await loadDuracionConfig(currentProfesional);
      await renderCalendar();
    });
  }
}

/* ====== Profesionales ====== */
async function loadProfesionales(){
  const sel = UI.profesionalSelect;

  // Médico: fija su propia opción
  if (userRole === 'medico' && loggedProfesionalId) {
    let label = null;
    try {
      const { data } = await supabase
        .from('profesionales')
        .select('id, nombre, apellido, display_name')
        .eq('id', loggedProfesionalId)
        .single();
      if (data) {
        label = data.display_name
             || [data.apellido, data.nombre].filter(Boolean).join(', ')
             || data.nombre || data.apellido || null;
      }
    } catch (_) {}
    if (!label) {
      label = localStorage.getItem('user_name')
           || localStorage.getItem('email')
           || 'Mi agenda';
    }
    sel.innerHTML = `<option value="${loggedProfesionalId}">${label}</option>`;
    sel.value = loggedProfesionalId;
    sel.disabled = true;
    currentProfesional = loggedProfesionalId;
    return;
  }

  // Asistente/propietario: listar profesionales del centro
  sel.disabled = false;

  const { data: map, error: mapErr } = await supabase
    .from('profesional_centro')
    .select('profesional_id')
    .eq('centro_id', currentCentroId)
    .eq('activo', true);

  if (mapErr) {
    sel.innerHTML = '<option value="">(error al cargar)</option>';
    currentProfesional = null;
    return;
  }

  const ids = [...new Set((map||[]).map(r=>r.profesional_id).filter(Boolean))];
  if (!ids.length){
    sel.innerHTML = '<option value="">Sin profesionales</option>';
    currentProfesional = null;
    return;
  }

  const { data: profs } = await supabase
    .from('profesionales')
    .select('id, nombre, apellido, display_name')
    .in('id', ids)
    .order('apellido', { ascending:true });

  sel.innerHTML = (profs||[]).map(p=>{
    const nombre = p.display_name
                || [p.apellido, p.nombre].filter(Boolean).join(', ')
                || p.nombre || p.apellido || p.id;
    return `<option value="${p.id}">${nombre}</option>`;
  }).join('');

  currentProfesional = (profs && profs[0]) ? profs[0].id : null;
  if (currentProfesional) sel.value = currentProfesional;
}

/* ====== Duraciones ====== */
async function loadDuracionConfig(profesionalId){
  duracionCfg = { nueva_consulta:15, recurrente:15, sobreturno:15 };
  if (!profesionalId) return;
  const { data } = await supabase
    .from('config_duracion_turnos')
    .select('tipo_turno, minutos')
    .eq('profesional_id', profesionalId)
    .eq('centro_id', currentCentroId);
  (data||[]).forEach(r=>{ if (r.tipo_turno && r.minutos) duracionCfg[r.tipo_turno] = r.minutos; });
}

/* ====== Obras sociales (select por label) ====== */
async function loadObrasSociales() {
  const { data } = await supabase
    .from('obras_sociales')
    .select('id, obra_social, condicion_copago, valor_copago')
    .order('obra_social', { ascending: true });

  obrasSocialesCache = data || [];
  UI.npObra.innerHTML =
    '<option value="">(Sin obra social)</option>' +
    obrasSocialesCache.map(o => `<option value="${o.obra_social}">${o.obra_social}</option>`).join('');
}
UI.npObra.addEventListener('change', () => {
  const sel = obrasSocialesCache.find(o => o.obra_social === UI.npObra.value);
  if (!sel) { UI.npObraInfo.textContent = ''; return; }
  const cond = sel.condicion_copago ? `Condición: ${sel.condicion_copago}` : '';
  const val  = (sel.valor_copago != null) ? ` · Copago: ${sel.valor_copago}` : '';
  UI.npObraInfo.textContent = (cond || val) ? (cond + val) : '';
});

/* ====== Pacientes (typeahead + crear) ====== */
let suggestTimer = null;
function hideSuggest(){ UI.pacSuggest.style.display='none'; UI.pacSuggest.innerHTML=''; }
function showSuggest(){ UI.pacSuggest.style.display='block'; }

UI.pacInput.addEventListener('input', ()=>{
  clearTimeout(suggestTimer);
  const q = UI.pacInput.value.trim();
  if (!q){ hideSuggest(); return; }
  suggestTimer = setTimeout(()=> fetchSuggestions(q), 180);
});
window.addEventListener('click', (e)=>{ if(!UI.pacSuggest.contains(e.target) && e.target!==UI.pacInput){ hideSuggest(); }});

async function fetchSuggestions(q){
  let result = [];
  if (/^\d{6,}$/.test(q)) {
    const { data } = await supabase
      .from('pacientes')
      .select('id, dni, apellido, nombre, telefono, email')
      .eq('dni', q)
      .limit(10);
    result = data || [];
  } else {
    const parts = q.toLowerCase().split(/\s+/).filter(Boolean);
    let query = supabase.from('pacientes')
      .select('id, dni, apellido, nombre, telefono, email')
      .eq('activo', true)
      .limit(10)
      .order('apellido', { ascending:true });
    if (parts[0]) query = query.ilike('apellido', `%${parts[0]}%`);
    if (parts[1]) query = query.ilike('nombre', `%${parts[1]}%`);
    const { data } = await query;
    result = data || [];
  }

  if (!result.length){
    UI.pacSuggest.innerHTML = `
      <div class="s-item s-create" data-act="create">
        <div>
          <div class="s-title">+ Crear nuevo paciente</div>
          <div class="s-meta">No se encontraron coincidencias para “${q}”.</div>
        </div>
      </div>`;
    showSuggest(); bindSuggestHandlers(q, []); return;
  }

  UI.pacSuggest.innerHTML = result.map(p=>`
    <div class="s-item" data-act="select" data-id="${p.id}">
      <div>
        <div class="s-title">${p.apellido}, ${p.nombre}</div>
        <div class="s-meta">DNI ${p.dni}${p.telefono ? ' · '+p.telefono : ''}${p.email ? ' · '+p.email : ''}</div>
      </div>
    </div>
  `).join('')
  + `
    <div class="s-item s-create" data-act="create">
      <div>
        <div class="s-title">+ Crear nuevo paciente</div>
        <div class="s-meta">Agregar con los datos completos.</div>
      </div>
    </div>`;
  showSuggest(); bindSuggestHandlers(q, result);
}

function bindSuggestHandlers(q, result){
  UI.pacSuggest.querySelectorAll('.s-item').forEach(el=>{
    el.addEventListener('click', async ()=>{
      const act = el.getAttribute('data-act');
      if (act === 'select'){
        const id = el.getAttribute('data-id');
        const p = result.find(x=>x.id===id);
        if (p) selectPaciente(p);
      } else if (act === 'create'){
        await openPacienteModalPrefilled(q);
      }
    });
  });
}

function selectPaciente(p){
  pacienteSeleccionado = { id:p.id, nombre:p.nombre, apellido:p.apellido, dni:p.dni, telefono:p.telefono || '' };
  UI.pacChipText.textContent = `${p.apellido}, ${p.nombre} · DNI ${p.dni}`;
  UI.pacChip.style.display = 'flex';
  hideSuggest();
  enforceTipoTurnoByPaciente(p.id);
}
UI.pacClear.addEventListener('click', ()=>{
  pacienteSeleccionado=null; UI.pacChip.style.display='none';
  enforceTipoTurnoByPaciente(null);
});

/* Nueva política: bloquear "Nueva consulta" si ya tuvo turnos */
async function enforceTipoTurnoByPaciente(pacienteId){
  const optNueva = UI.tipoTurno.querySelector('option[value="nueva_consulta"]');
  if (!optNueva) return;
  if (!pacienteId){ optNueva.disabled = false; return; } // sin paciente => no bloquear

  const { count } = await supabase
    .from('turnos')
    .select('id', { count: 'exact', head: true })
    .eq('paciente_id', pacienteId);

  if ((count ?? 0) > 0){
    optNueva.disabled = true;
    if (UI.tipoTurno.value === 'nueva_consulta'){ UI.tipoTurno.value = 'recurrente'; }
  } else {
    // El paciente existe pero sin turnos previos: si querés bloquear igual,
    // dejá disabled=true; si querés permitir, ponelo en false:
    optNueva.disabled = true; // <- según lo pedido: SOLO al crear un paciente se habilita.
  }
}

/* Modal Paciente */
async function openPacienteModalPrefilled(q){
  if (!obrasSocialesCache.length) await loadObrasSociales();

  UI.npDni.value = /^\d{6,}$/.test(q) ? q : '';
  const parts = q.split(/\s+/).filter(Boolean);
  UI.npApellido.value = parts[0] || '';
  UI.npNombre.value = parts[1] || '';
  UI.npFechaNac.value = '';
  UI.npTel.value = ''; UI.npEmail.value = '';
  UI.npObra.value = ''; UI.npObraInfo.textContent='';
  UI.npAfiliado.value = '';
  UI.npConNom.value=''; UI.npConApe.value=''; UI.npConCel.value=''; UI.npVinculo.value='';
  UI.npHistoria.value=''; UI.npCredFile.value=''; UI.npCredPreview.style.display='none'; UI.npCredPreview.innerHTML='';
  UI.npMsg.textContent='';
  UI.modalPac.style.display='flex';
}
UI.modalPacClose.addEventListener('click', ()=> UI.modalPac.style.display='none');
window.addEventListener('click', (e)=>{ if (e.target===UI.modalPac) UI.modalPac.style.display='none'; });
UI.npHistoriaOpen.addEventListener('click', (e)=>{ if(!UI.npHistoria.value){ e.preventDefault(); } });
UI.npCredSelect.addEventListener('click', ()=> UI.npCredFile.click());
UI.npCredFile.addEventListener('change', ()=>{
  const f = UI.npCredFile.files?.[0];
  UI.npCredPreview.innerHTML = '';
  if (!f){ UI.npCredPreview.style.display='none'; return; }
  const isImg = /^image\//.test(f.type);
  if (isImg){
    const img = document.createElement('img');
    img.alt = 'credencial';
    img.src = URL.createObjectURL(f);
    UI.npCredPreview.appendChild(img);
  }
  const meta = document.createElement('div');
  meta.innerHTML = `<div class="footer-mini">${f.name} · ${(f.size/1024).toFixed(0)} KB 
    &nbsp; <a href="#" id="np-cred-remove">Quitar</a></div>`;
  UI.npCredPreview.appendChild(meta);
  UI.npCredPreview.style.display = 'flex';
  meta.querySelector('#np-cred-remove').addEventListener('click', (e)=>{
    e.preventDefault(); UI.npCredFile.value=''; UI.npCredPreview.style.display='none'; UI.npCredPreview.innerHTML='';
  });
});

/* Guardar paciente (sube credencial a Storage) */
UI.npGuardar.addEventListener('click', async ()=>{
  const dni = UI.npDni.value.trim();
  const nombre = UI.npNombre.value.trim();
  const apellido = UI.npApellido.value.trim();
  const fecha_nacimiento = UI.npFechaNac.value || '';
  const telefono = UI.npTel.value.trim();
  if (!dni || !nombre || !apellido || !fecha_nacimiento || !telefono){
    UI.npMsg.textContent = 'Completá los campos obligatorios (*)';
    return;
  }
  UI.npMsg.textContent = 'Guardando...';

  // subir credencial si hay
  let credencialUrl = null;
  const file = UI.npCredFile.files?.[0];
  if (file){
    const ext = (file.name.split('.').pop() || 'bin').toLowerCase();
    const path = `${dni}_${Date.now()}.${ext}`;
    const { data: up, error: upErr } = await supabase.storage
      .from('credenciales')
      .upload(path, file, { cacheControl: '3600', upsert: false, contentType: file.type });
    if (upErr){ UI.npMsg.textContent = 'No se pudo subir la credencial: ' + (upErr.message || ''); return; }
    const { data: pub } = supabase.storage.from('credenciales').getPublicUrl(up.path);
    credencialUrl = pub?.publicUrl || null;
  }

  const payload = {
    dni, nombre, apellido, fecha_nacimiento, telefono,
    email: UI.npEmail.value.trim() || null,
    obra_social: UI.npObra.value || null,               // ← texto (FK textual)
    numero_afiliado: UI.npAfiliado.value.trim() || null,
    contacto_nombre: UI.npConNom.value.trim() || null,
    contacto_apellido: UI.npConApe.value.trim() || null,
    contacto_celular: UI.npConCel.value.trim() || null,
    vinculo: UI.npVinculo.value.trim() || null,
    credencial: credencialUrl,
    historia_clinica: UI.npHistoria.value.trim() || null,
    activo: true
  };

  const { data, error } = await supabase
    .from('pacientes')
    .insert([payload])
    .select('id, dni, nombre, apellido, telefono')
    .single();

  if (error){ UI.npMsg.textContent = 'Error: ' + (error.message || 'no se pudo crear'); return; }

  UI.modalPac.style.display='none';
  selectPaciente(data);

  // Paciente recién creado ⇒ permitir "Nueva consulta" y setearla
  const optNueva = UI.tipoTurno.querySelector('option[value="nueva_consulta"]');
  if (optNueva) { optNueva.disabled = false; }
  UI.tipoTurno.value = 'nueva_consulta';
});

/* ====== Agenda & Turnos ====== */
function renderDowTurnos(){ UI.calDow.innerHTML = DOW.map(d=>`<div class="dow">${d}</div>`).join(''); }

async function fetchAgendaYTurnos(profesionalId, y, m){
  const first = new Date(y,m,1), last = new Date(y,m+1,0);
  const start = toISODate(y,m,1), end = toISODate(y,m,last.getDate());
  const [agendaRes, turnosRes] = await Promise.all([
    supabase.from('agenda')
      .select('id, fecha, hora_inicio, hora_fin')
      .eq('centro_id', currentCentroId).eq('profesional_id', profesionalId)
      .gte('fecha', start).lte('fecha', end).order('fecha',{ascending:true}),
    supabase.from('turnos')
      .select('id, fecha, hora_inicio, hora_fin, estado, paciente_id, agenda_id, pacientes(id, apellido, nombre, dni, telefono)')
      .eq('centro_id', currentCentroId).eq('profesional_id', profesionalId)
      .gte('fecha', start).lte('fecha', end).order('hora_inicio',{ascending:true})
  ]);
  return { agenda: agendaRes.data || [], turnos: turnosRes.data || [] };
}

function generarSlotsDeDia(agendaDelDia, turnosDelDia, tipo){
  const dur = Number(duracionCfg[tipo] || 15);
  if (!dur || isNaN(dur) || dur<=0) return [];
  const reservas = (turnosDelDia||[])
    .filter(t => (t.estado||'').toLowerCase() !== 'cancelado')
    .map(t => ({ start: toHM(t.hora_inicio), end: toHM(t.hora_fin) || addMinutes(toHM(t.hora_inicio), dur) }));
  const slots = [];
  for (const bloque of (agendaDelDia||[])) {
    const bStart = toHM(bloque.hora_inicio);
    const bEnd   = toHM(bloque.hora_fin);
    let t = bStart;
    while ( (addMinutes(t,dur) <= bEnd) ) {
      const start = t, end = addMinutes(t,dur);
      const choca = reservas.some(r => overlaps(start,end,r.start,r.end));
      slots.push({ start, end, agenda_id: bloque.id, disponible: !choca });
      t = end;
    }
  }
  return slots;
}

/* Render calendario */
async function renderCalendar(){
  const grid = UI.calGrid, title = UI.calTitle;
  if (!currentProfesional){ UI.status.textContent='No hay profesional seleccionado.'; grid.innerHTML=''; return; }
  UI.status.textContent = 'Cargando agenda...';

  const { agenda, turnos } = await fetchAgendaYTurnos(currentProfesional, view.y, view.m);
  const byFechaAgenda = groupByFecha(agenda);
  const byFechaTurnos = groupByFecha(turnos);
  const tipo = UI.tipoTurno.value;

  grid.innerHTML = '';
  const first = new Date(view.y, view.m, 1);
  const last  = new Date(view.y, view.m+1, 0);
  title.textContent = first.toLocaleString('es-AR', { month: 'long', year: 'numeric' });

  const startOffset = nativeFirstDow(first);
  const totalCells = startOffset + last.getDate();
  const rows = Math.ceil(totalCells / 7);
  let dayNum = 1;

  for (let r=0; r<rows*7; r++){
    const cell = document.createElement('div');
    if (r < startOffset || dayNum>last.getDate()){
      cell.className = 'day empty'; grid.appendChild(cell); continue;
    }
    const iso = toISODate(view.y, view.m, dayNum);
    const agendaDia = byFechaAgenda.get(iso) || [];
    const turnosDia = byFechaTurnos.get(iso) || [];
    const slotsPreview = generarSlotsDeDia(agendaDia, turnosDia, tipo);
    const libres = slotsPreview.filter(s=>s.disponible).length;

    let classNames = ['day'];
    let badgeText = 'sin agenda';
    if (agendaDia.length === 0){ classNames.push('empty'); }
    else if (libres>0){ classNames.push('free','clickable'); badgeText = `${libres} libres`; }
    else { classNames.push('busy','clickable'); badgeText = 'sin huecos'; }

    cell.className = classNames.join(' ');
    cell.innerHTML = `<div class="num">${dayNum}</div><div class="badge">${badgeText}</div>`;
    if (classNames.includes('clickable')){
      cell.addEventListener('click', ()=> openDayModal(iso, agendaDia, turnosDia));
    }
    grid.appendChild(cell);
    dayNum++;
  }

  UI.status.textContent = (agenda.length===0) ? 'No hay agenda cargada para este mes en el centro seleccionado.' : '';
}

/* Modal día */
async function openDayModal(isoDate, agendaDia, turnosDiaRaw){
  reprogramState = null;
  modalDateISO = isoDate;
  UI.modalTitle.textContent = `Turnos del ${new Date(isoDate).toLocaleDateString('es-AR')}`;
  UI.modal.style.display = 'flex';

  const slots = generarSlotsDeDia(agendaDia, turnosDiaRaw, UI.tipoTurno.value);
  renderSlots(slots);
  renderTurnosDelDia(turnosDiaRaw);
}
UI.modalClose.addEventListener('click', ()=> UI.modal.style.display='none');
window.addEventListener('click', (e)=>{ if(e.target===UI.modal) UI.modal.style.display='none' });

function renderTurnosDelDia(turnosDia){
  if (!turnosDia?.length){ UI.turnosDiaList.innerHTML = '<div class="footer-mini">No hay turnos en esta fecha.</div>'; return; }

  const rows = turnosDia.map(t=>{
    const pac = t.pacientes ? `${t.pacientes.apellido}, ${t.pacientes.nombre}` : `Paciente ${t.paciente_id.slice(0,6)}`;
    const dni = t.pacientes?.dni || '—';
    const tel = t.pacientes?.telefono || '—';
    const dur = t.hora_fin ? minutesDiff(toHM(t.hora_inicio), toHM(t.hora_fin)) : (duracionCfg[UI.tipoTurno.value]||15);
    return `
      <div class="trow" style="display:grid;grid-template-columns:140px 1fr 120px 170px;gap:6px;align-items:center">
        <div class="tcell"><b>${toHM(t.hora_inicio)}</b> — ${toHM(t.hora_fin) || ''}</div>
        <div class="tcell">${pac} <span class="footer-mini">DNI ${dni} · ${tel}</span></div>
        <div class="tcell"><span class="footer-mini">${t.estado}</span></div>
        <div class="tcell actions">
          <button class="icon-btn" data-id="${t.id}" data-dur="${dur}" data-tip="↪ Reprogramar" id="rep-${t.id}">↪️</button>
          <button class="icon-btn" data-id="${t.id}" data-tip="🗑 Anular" id="del-${t.id}">🗑️</button>
        </div>
      </div>`;
  }).join('');

  UI.turnosDiaList.innerHTML = rows;

  // bind acciones
  turnosDia.forEach(t=>{
    document.getElementById(`del-${t.id}`).addEventListener('click', ()=> cancelarTurno(t));
    document.getElementById(`rep-${t.id}`).addEventListener('click', ()=> startReprogram(t));
  });
}

function renderSlots(slots){
  if (!slots.length){ UI.slotsList.innerHTML = '<div class="footer-mini">No hay horarios disponibles para el tipo seleccionado.</div>'; return; }
  UI.slotsList.innerHTML = '';
  for (const s of slots){
    const row = document.createElement('div');
    const dur = minutesDiff(s.start, s.end);
    const reprogramando = !!reprogramState;
    const sameDur = reprogramando ? (dur === reprogramState.durMin) : true;
    const habil = s.disponible && (!reprogramando || sameDur);

    row.className = 'slot' + (habil ? '' : ' unavailable');
    row.innerHTML = `
      <div>
        <div class="time">${s.start} — ${s.end}</div>
        <div class="mini">${s.agenda_id ? 'Agenda' : 'Libre'}${reprogramando && !sameDur ? ' · duración distinta' : ''}</div>
      </div>
      <div>
        ${habil
          ? `<button class="icon-btn" data-tip="${reprogramando ? 'Confirmar reprogramación' : 'Agendar turno'}" data-start="${s.start}" data-end="${s.end}" data-agenda="${s.agenda_id||''}">➕</button>`
          : `<button class="icon-btn" disabled data-tip="No disponible">✖</button>`}
      </div>`;
    if (habil){
      row.querySelector('button').addEventListener('click', () => reprogramando ? confirmReprogram(s) : tryAgendar(s));
    }
    UI.slotsList.appendChild(row);
  }
}

/* Confirmación OK */
function openOkModal({pac, fechaISO, start, end, profLabel}){
  UI.okTitle.textContent = `${pac.apellido}, ${pac.nombre}`;
  UI.okPaciente.textContent = `${pac.apellido}, ${pac.nombre}`;
  UI.okDni.textContent = pac.dni || '—';
  UI.okFechaHora.textContent = `${fmtDateLong(fechaISO)} · ${start}–${end}`;
  UI.okProf.textContent = profLabel;
  UI.okCentro.textContent = currentCentroNombre || '—';
  UI.okDir.textContent = currentCentroDireccion || '—';

  const msg = buildWhatsAppMessage({ pac, fechaISO, start, end, prof: profLabel, centro: currentCentroNombre||'', dir: currentCentroDireccion||'' });
  const to = normalizePhoneForWA(pac.telefono || '');
  const href = to ? `https://wa.me/${to}?text=${encodeURIComponent(msg)}` : 'javascript:void(0)';
  UI.okWa.setAttribute('href', href);
  UI.okWa.classList.toggle('ok', !!to);
  UI.okWa.textContent = to ? 'Enviar por WhatsApp' : 'WhatsApp (falta teléfono)';
  UI.okWa.style.pointerEvents = to ? 'auto' : 'none';
  UI.okMsg.textContent = '';

  UI.okCopy.onclick = ()=>{
    const link = to ? href : msg;
    navigator.clipboard.writeText(link).then(()=> UI.okMsg.textContent='Copiado').catch(()=> UI.okMsg.textContent='No se pudo copiar');
  };

  UI.okBackdrop.style.display = 'flex';
}
UI.okClose.addEventListener('click', ()=> UI.okBackdrop.style.display='none');
window.addEventListener('click', (e)=>{ if (e.target===UI.okBackdrop) UI.okBackdrop.style.display='none'; });

/* Agendar */
async function tryAgendar(slot){
  if (!pacienteSeleccionado){ alert('Seleccioná un paciente arriba antes de agendar.'); return; }
  if (!isValidHourRange(slot.start, slot.end)){ alert('Rango horario inválido.'); return; }

  const { error } = await supabase
    .from('turnos')
    .insert([{
      agenda_id: slot.agenda_id || null,
      centro_id: currentCentroId,
      profesional_id: currentProfesional,
      paciente_id: pacienteSeleccionado.id,
      fecha: modalDateISO,
      hora_inicio: slot.start,
      hora_fin: slot.end,
      estado: 'asignado',
      notas: (UI.tipoTurno.value === 'sobreturno') ? 'Sobreturno' : null
    }]);

  if (error){
    const msg = (error.message||'').toLowerCase().includes('solap') ? 'Ese horario se ocupó recién por otro usuario.' : (error.message || 'No se pudo agendar.');
    alert(msg);
  } else {
    const profLabel = UI.profesionalSelect.options[UI.profesionalSelect.selectedIndex]?.textContent || 'Profesional';
    openOkModal({ pac: pacienteSeleccionado, fechaISO: modalDateISO, start: slot.start, end: slot.end, profLabel });
  }
  await refreshDayModal();
}

/* Anular turno */
async function cancelarTurno(t){
  if (!confirm('¿Anular este turno?')) return;
  const { error } = await supabase.from('turnos').update({ estado:'cancelado' }).eq('id', t.id);
  if (error) alert('No se pudo anular: ' + (error.message||'')); else await refreshDayModal();
}

/* Reprogramar turno: seleccionar duración y habilitar sólo slots compatibles */
function startReprogram(t){
  const start = toHM(t.hora_inicio), end = toHM(t.hora_fin);
  const durMin = end ? minutesDiff(start,end) : (duracionCfg[UI.tipoTurno.value]||15);
  reprogramState = { turno: t, durMin };
  UI.status.textContent = `Reprogramando turno de ${durMin} min. Elegí un nuevo horario en la lista.`;
  // Re-render slots para bloquear duraciones distintas
  refreshSlotsOnly();
}
async function confirmReprogram(slot){
  const t = reprogramState?.turno; if (!t) return;
  const upd = {
    fecha: modalDateISO,
    hora_inicio: slot.start,
    hora_fin: slot.end,
    agenda_id: slot.agenda_id || null,
    updated_at: new Date().toISOString()
  };
  const { error } = await supabase.from('turnos').update(upd).eq('id', t.id);
  if (error){
    const msg = (error.message||'').toLowerCase().includes('solap') ? 'El horario elegido se ocupó.' : (error.message || 'No se pudo reprogramar.');
    alert(msg);
  } else {
    reprogramState = null;
  }
  UI.status.textContent = '';
  await refreshDayModal();
}

async function refreshDayModal(){
  // volver a consultar datos del día y refrescar
  const { agenda, turnos } = await fetchAgendaYTurnos(currentProfesional, view.y, view.m);
  const agendaDia = (agenda||[]).filter(a=>a.fecha===modalDateISO);
  const turnosDia = (turnos||[]).filter(t=>t.fecha===modalDateISO);
  renderSlots(generarSlotsDeDia(agendaDia, turnosDia, UI.tipoTurno.value));
  renderTurnosDelDia(turnosDia);
  await renderCalendar();
}
async function refreshSlotsOnly(){
  const { agenda, turnos } = await fetchAgendaYTurnos(currentProfesional, view.y, view.m);
  const agendaDia = (agenda||[]).filter(a=>a.fecha===modalDateISO);
  const turnosDia = (turnos||[]).filter(t=>t.fecha===modalDateISO);
  renderSlots(generarSlotsDeDia(agendaDia, turnosDia, UI.tipoTurno.value));
}

/* Eventos generales */
UI.profesionalSelect.addEventListener('change', async ()=>{
  currentProfesional = UI.profesionalSelect.value || null;
  await loadDuracionConfig(currentProfesional);
  await renderCalendar();
});
UI.tipoTurno.addEventListener('change', async ()=>{
  await renderCalendar();
  if (UI.modal.style.display==='flex') await refreshSlotsOnly();
});
UI.prevMonth.addEventListener('click', async ()=>{ if (view.m===0){ view.m=11; view.y--; } else view.m--; await renderCalendar(); });
UI.nextMonth.addEventListener('click', async ()=>{ if (view.m===11){ view.m=0; view.y++; } else view.m++; await renderCalendar(); });
UI.btnHoy.addEventListener('click', async ()=>{ const t=todayInfo(); view={ y:t.y, m:t.m, d:t.d }; await renderCalendar(); });

/* Init */
function renderDow(){ UI.calDow.innerHTML = DOW.map(d=>`<div class="dow">${d}</div>`).join(''); }
async function initTurnos(){
  renderDow();
  await ensureCentroWidgets();
  await loadProfesionales();
  if (!currentProfesional){ UI.status.textContent='No hay profesional seleccionado.'; return; }
  await loadDuracionConfig(currentProfesional);
  if (!currentCentroDireccion){
    const c = await fetchCentroById(currentCentroId);
    currentCentroNombre = c.nombre || currentCentroNombre;
    currentCentroDireccion = c.direccion || '';
  }
  await renderCalendar();
}
await initTurnos();
</script>
</body>
</html>
