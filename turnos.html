<!-- Vista TURNOS (partial) - se inyecta dentro de #main-content -->
<div id="turnos-view" data-view="turnos">
  <style>
    :root {
      --tw-brand:#7656b0; --tw-brand2:#a490d7; --tw-ink:#381e60; --tw-muted:#6b6480;
      --tw-card:#fff; --tw-line:#ece5fc; --tw-accent:#0b5394;
      --tw-ok:#0a7d38; --tw-okbg:#e8fff0; --tw-danger:#b00020;
      --tw-warn:#8a5800; --tw-warnbg:#fff4e6;
    }
    #turnos-view{font-family:'Segoe UI',Arial,sans-serif;color:var(--tw-ink);}
    .tw-toolbar{display:grid;grid-template-columns:1.1fr 1.1fr 1.5fr 1fr auto;gap:12px;align-items:end;margin-bottom:18px;background:var(--tw-card);border:1px solid var(--tw-line);border-radius:16px;padding:16px 30px 16px 26px;box-shadow:0 2px 10px rgba(80,60,160,.08);}
    .tw-toolbar .tw-btn.ghost{box-shadow:none;} 
    .tw-field{display:flex;flex-direction:column;gap:6px;position:relative}
    .tw-field label{font-size:12px;font-weight:600;color:var(--tw-muted);letter-spacing:.3px}
    .tw-inp,.tw-sel{background:#f8f9fc;border:1.5px solid var(--tw-line);border-radius:8px;padding:8px 10px;font-size:14px;color:var(--tw-ink);outline:none;transition:border-color .15s,background .15s;font-family:inherit;}
    .tw-inp:focus,.tw-sel:focus{border-color:var(--tw-brand2);background:#fff}
    .tw-btn{appearance:none;border:none;border-radius:9px;padding:10px 14px;font-size:14px;font-weight:600;font-family:inherit;cursor:pointer;background:var(--tw-brand);color:#fff;display:inline-flex;align-items:center;gap:6px;box-shadow:0 2px 4px rgba(0,0,0,.12);transition:filter .15s;}
    .tw-btn:hover{filter:brightness(.97)} .tw-btn.secondary{background:#e8e1fc;color:#5a3e9a;box-shadow:none} .tw-btn.ghost{background:#fff;color:var(--tw-ink);border:1px solid var(--tw-line);box-shadow:none}
    .tw-chip{position:absolute;right:8px;top:-20px;background:#e8e1fc;color:#5a3e9a;border-radius:999px;padding:2px 8px;font-size:12px;display:flex;gap:6px;align-items:center;box-shadow:0 2px 6px -2px rgba(0,0,0,.25);}
    .tw-chip button{all:unset;cursor:pointer;font-weight:600;}
    .tw-suggest{position:absolute;top:100%;left:0;right:0;z-index:50;background:#fff;border:1px solid var(--tw-line);border-radius:12px;margin-top:6px;box-shadow:0 10px 26px -4px rgba(0,0,0,.20);max-height:260px;overflow:auto}
    .tw-s-item{padding:10px 12px;border-bottom:1px solid var(--tw-line);cursor:pointer;display:flex;justify-content:space-between;gap:10px}
    .tw-s-item:last-child{border-bottom:none} .tw-s-item:hover{background:#faf7ff}
    .tw-s-title{font-weight:600;font-size:14px} .tw-s-meta{font-size:12px;color:var(--tw-muted)}
    .tw-head{display:flex;justify-content:space-between;align-items:center;margin:6px 0 14px;}
    .tw-head-left{display:flex;align-items:center;gap:8px} .tw-head h2{margin:0;font-size:21px;font-weight:600}
    .tw-legend{display:flex;gap:14px;align-items:center;font-size:13px;color:var(--tw-muted);flex-wrap:wrap}
    .tw-dot{width:11px;height:11px;border-radius:50%;display:inline-block}
    .tw-dot.free{background:#9ee6b7} .tw-dot.busy{background:#ffc888} .tw-dot.none{background:#d2c7eb}
    .tw-cal{background:var(--tw-card);border:1px solid var(--tw-line);border-radius:18px;padding:20px 24px 24px;box-shadow:0 2px 12px rgba(80,60,160,.08);}
    .tw-dow,.tw-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
    .tw-dow div{font-size:12px;text-align:center;color:var(--tw-muted);font-weight:600;letter-spacing:.5px}
    .tw-day{background:#faf9ff;border:1px solid var(--tw-line);border-radius:14px;min-height:110px;padding:8px;display:flex;flex-direction:column;gap:6px;transition:transform .08s,box-shadow .15s}
    .tw-day .num{font-weight:600;font-size:14px} .tw-day .badge{margin-top:auto;align-self:flex-start;font-size:11px;font-weight:600;padding:4px 8px;border-radius:999px;letter-spacing:.3px}
    .tw-day.free .badge{background:#e9fff1;color:#0f6c36} .tw-day.busy .badge{background:#fff4e6;color:var(--tw-warn)} .tw-day.empty{opacity:.5}
    .tw-day.clickable{cursor:pointer} .tw-day.clickable:hover{transform:translateY(-3px);box-shadow:0 6px 18px -6px rgba(0,0,0,.30)}
    .tw-status{margin-top:10px;font-size:12.5px;color:var(--tw-muted);min-height:18px}
    .tw-backdrop{position:fixed;inset:0;background:rgba(31,17,56,.40);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:1500}
    .tw-modal,.tw-modal-ok{width:min(900px,96vw);background:#fff;border-radius:20px;padding:20px 20px 26px;border:1px solid var(--tw-line);box-shadow:0 14px 40px -8px rgba(0,0,0,.35);max-height:92vh;overflow:auto;position:relative}
    .tw-modal-wide{width:min(1120px,96vw)}
    .tw-modal-header{display:flex;align-items:center;gap:12px;margin:0 0 14px}
    .tw-modal-title{margin:0;font-size:19px;font-weight:700}
    .tw-close{background:transparent;border:none;font-size:30px;color:var(--tw-brand);cursor:pointer;margin-left:auto;line-height:1;padding:0 4px}
    .tw-day-nav{display:flex;align-items:center;gap:6px}
    .tw-date{width:155px;padding:5px 8px;height:36px;font-size:13px}
    .tw-slots{border:1px solid var(--tw-line);border-radius:16px;padding:12px 12px 6px;max-height:60vh;overflow:auto;background:#faf9ff}
    .tw-slot{display:flex;align-items:center;justify-content:space-between;gap:14px;border:1px solid var(--tw-line);border-radius:12px;padding:10px 14px;margin:6px 0;background:#fff;font-size:14px;transition:background .12s,border-color .12s}
    .tw-slot:hover{background:#fcfbff} .tw-slot.ocupado{background:#f4f0ff} .tw-slot.unavailable{opacity:.55}
    .tw-slot .time{font-weight:700;color:var(--tw-accent);letter-spacing:.5px} .tw-slot .mini{font-size:12px;color:var(--tw-muted);margin-top:2px}
    .tw-icon-btn{border:none;background:#f4f1ff;border:1px solid var(--tw-line);width:38px;height:38px;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;color:#4a3870;transition:background .15s,border-color .15s}
    .tw-icon-btn:hover{background:#efe8ff} .tw-icon-btn[disabled]{opacity:.4;cursor:not-allowed}
    .tw-icon-btn[data-tip]{position:relative}
    .tw-icon-btn[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:110%;left:50%;transform:translateX(-50%);background:#381e60;color:#fff;padding:5px 8px;border-radius:8px;font-size:11px;white-space:nowrap;box-shadow:0 4px 16px -6px rgba(0,0,0,.35)}
    .tw-banner-rep{background:var(--tw-warnbg);border:1px solid #ffd197;padding:10px 12px;border-radius:12px;font-size:13px;color:var(--tw-warn);display:flex;align-items:center;justify-content:space-between;gap:10px;margin:2px 0 10px;font-weight:500}
    .tw-linklike{background:none;border:none;color:var(--tw-danger);cursor:pointer;font-size:12px;text-decoration:underline;font-weight:600}
    .tw-modal-ok{border:2px solid var(--tw-okbg)} .tw-ok-head{display:flex;align-items:center;gap:10px}
    .tw-ok-badge{background:var(--tw-okbg);color:var(--tw-ok);border-radius:999px;padding:5px 10px;font-weight:700;font-size:13px}
    .tw-ok-title{font-weight:600;font-size:16px}
    .tw-ok-list{margin:14px 0 8px;padding-left:22px} .tw-ok-list li{margin:6px 0;font-size:14px}
    .tw-ok-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px} .tw-hint{font-size:12px;color:var(--tw-muted)}
    .tw-grid3{display:grid;grid-template-columns:1.1fr 1fr 1fr;gap:16px;min-width:980px}
    @media (max-width:1040px){ .tw-grid3{grid-template-columns:1fr;min-width:auto} .tw-span3{grid-column:auto} }
    .tw-col{background:#faf9ff;border:1px solid var(--tw-line);border-radius:16px;padding:14px 14px 16px;display:flex;flex-direction:column;gap:6px}
    .tw-col h4{margin:0 0 8px;font-size:15px} .tw-req{color:var(--tw-danger);margin-left:3px}
    .tw-inline{display:flex;gap:10px;align-items:center}
    .tw-upload-zone{background:#fff;border:2px dashed var(--tw-line);border-radius:14px;padding:14px;text-align:center}
    .tw-upload-preview{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;align-items:center}
    .tw-upload-preview img{width:62px;height:62px;object-fit:cover;border-radius:14px;border:1px solid var(--tw-line)}
    .tw-actions{margin-top:16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    @media (max-width:900px){ .tw-toolbar{grid-template-columns:1fr 1fr;row-gap:14px} .tw-toolbar .tw-field:nth-child(5){grid-column:1/3} }

    /* Mini-calendario dentro del modal */
    .tw-mini{display:grid;grid-template-columns:repeat(7,18px);gap:4px;margin-left:8px;align-items:center}
    .tw-mini .dot{width:14px;height:14px;border-radius:4px;border:1px solid var(--tw-line);background:#faf9ff}
    .tw-mini .dot.none{background:#f1effa;opacity:.7}
    .tw-mini .dot.busy{background:#fff4e6}
    .tw-mini .dot.free{background:#e9fff1}
    .tw-mini .dot.clickable{cursor:pointer}
    .tw-mini .dot.today{outline:2px solid var(--tw-brand2)}
    .tw-mini .dot.selected{box-shadow:0 0 0 2px var(--tw-accent) inset}

    /* Modal Cupo Agotado - Estilos */
.modal-cupo-agotado {
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.35);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.2s;
}

.modal-cupo-agotado .modal-content {
  background: #fffbe6;
  border: 2px solid #faad14;
  border-radius: 10px;
  max-width: 370px;
  width: 90vw;
  padding: 24px 16px 16px 16px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.18);
  animation: shake-modal 0.3s;
}

@keyframes shake-modal {
  0% { transform: translateX(-6px);}
  25%{ transform: translateX(6px);}
  50%{ transform: translateX(-2px);}
  75%{ transform: translateX(2px);}
  100%{ transform: translateX(0);}
}

.modal-header-alert {
  display: flex;
  align-items: center;
  margin-bottom: 12px;
}
.icon-alert {
  font-size: 2em;
  margin-right: 8px;
  color: #d46b08;
}
.modal-title {
  font-weight: bold;
  font-size: 1.2em;
  color: #d46b08;
}
.modal-body {
  font-size: 1em;
  color: #333;
  margin-bottom: 18px;
}
.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}
.btn-accept {
  background: #52c41a;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 20px;
  font-weight: bold;
  font-size: 1em;
  cursor: pointer;
}
.btn-cancel {
  background: #bbb;
  color: #222;
  border: none;
  border-radius: 6px;
  padding: 8px 20px;
  font-size: 1em;
  cursor: pointer;
}
.btn-accept:hover { background: #389e0d; }
.btn-cancel:hover { background: #888; }
  </style>

  <div class="tw-toolbar">
    <div class="tw-field">
      <label>Centro médico</label>
      <select id="turnos-centro-select" class="tw-sel" style="display:none;"></select>
      <input id="turnos-centro-nombre" class="tw-inp" type="text" readonly style="display:none;">
    </div>
    <div class="tw-field">
      <label>Profesional</label>
      <select id="turnos-profesional-select" class="tw-sel"><option>Cargando...</option></select>
    </div>
    <div class="tw-field">
      <label>Paciente</label>
      <input id="turnos-paciente-input" class="tw-inp" placeholder="Apellido Nombre o DNI" autocomplete="off">
      <div id="turnos-paciente-suggest" class="tw-suggest" style="display:none;"></div>
      <div id="turnos-paciente-chip" class="tw-chip" style="display:none;">
        <span id="turnos-paciente-chip-text"></span>
        <button id="turnos-paciente-clear" title="Quitar">✕</button>
      </div>
    </div>
    <div class="tw-field">
      <label>Tipo de turno</label>
      <select id="turnos-tipo" class="tw-sel">
        <option value="nueva_consulta">Nueva consulta</option>
        <option value="recurrente">Recurrente</option>
        <option value="sobreturno">Sobreturno</option>
      </select>
    </div>
    <div class="tw-field" style="align-items:flex-end">
      <button id="turnos-btn-hoy" class="tw-btn ghost">Hoy</button>
    </div>
  </div>

  <div class="tw-head">
    <div class="tw-head-left">
      <button id="turnos-prev-month" class="tw-btn secondary" title="Mes anterior">◀</button>
      <h2 id="turnos-cal-title">Calendario</h2>
      <button id="turnos-next-month" class="tw-btn secondary" title="Mes siguiente">▶</button>
    </div>
    <div class="tw-legend">
      <span class="tw-dot free"></span> con disponibilidad
      <span class="tw-dot busy"></span> sin hueco
      <span class="tw-dot none"></span> sin agenda
    </div>
  </div>
  <div class="tw-cal">
    <div class="tw-dow" id="turnos-cal-dow"></div>
    <div class="tw-grid" id="turnos-cal-grid"></div>
  </div>
  <div class="tw-status" id="turnos-status"></div>
</div>

<!-- Modales -->
<div class="tw-backdrop" id="turnos-modal">
  <div class="tw-modal">
    <div class="tw-modal-header">
      <h3 id="turnos-modal-title" class="tw-modal-title">Turnos del día</h3>
      <div class="tw-day-nav">
        <button class="tw-icon-btn" id="turnos-modal-prev-day" data-tip="Día anterior">◀</button>
        <input type="date" id="turnos-modal-date" class="tw-inp tw-date">
        <button class="tw-icon-btn" id="turnos-modal-next-day" data-tip="Día siguiente">▶</button>
        <!-- Mini calendario mensual dentro del modal -->
        <div id="turnos-mini-cal" class="tw-mini" aria-label="Disponibilidad del mes"></div>
      </div>
      <button class="tw-close" id="turnos-modal-close">×</button>
    </div>
    <section class="tw-slots">
      <h4>Horarios</h4>
      <div id="turnos-slots-list"></div>
    </section>
  </div>
</div>

<div class="tw-backdrop" id="turnos-modal-ok" style="display:none;">
  <div class="tw-modal-ok">
    <div class="tw-modal-header">
      <div class="tw-ok-head">
        <div class="tw-ok-badge">✔ Turno asignado</div>
        <div id="ok-title" class="tw-ok-title"></div>
      </div>
      <button class="tw-close" id="ok-close">×</button>
    </div>
    <ul class="tw-ok-list">
      <li><b>Paciente:</b> <span id="ok-paciente"></span></li>
      <li><b>DNI:</b> <span id="ok-dni"></span></li>
      <li><b>Fecha y hora:</b> <span id="ok-fecha-hora"></span></li>
      <li><b>Profesional:</b> <span id="ok-prof"></span></li>
      <li><b>Centro:</b> <span id="ok-centro"></span></li>
      <li><b>Dirección:</b> <span id="ok-direccion"></span></li>
    </ul>
    <div class="tw-ok-actions">
      <a id="ok-wa-link" class="tw-btn ok" target="_blank" rel="noopener">Enviar por WhatsApp</a>
      <button id="ok-copy" class="tw-btn ghost">Copiar link</button>
      <span id="ok-msg" class="tw-hint"></span>
    </div>
  </div>
</div>

<div class="tw-backdrop" id="turnos-modal-paciente" style="display:none;">
  <div class="tw-modal tw-modal-wide">
    <div class="tw-modal-header">
      <h3 class="tw-modal-title">Crear nuevo paciente</h3>
      <button class="tw-close" id="turnos-modal-paciente-close">×</button>
    </div>
    <div class="tw-grid3">
      <div class="tw-col">
        <h4>Datos del paciente</h4>
        <label>DNI <span class="tw-req">*</span></label><input id="np-dni" class="tw-inp">
        <label>Nombre <span class="tw-req">*</span></label><input id="np-nombre" class="tw-inp">
        <label>Apellido <span class="tw-req">*</span></label><input id="np-apellido" class="tw-inp">
        <label>Fecha de nacimiento <span class="tw-req">*</span></label><input id="np-fecha-nac" class="tw-inp" type="date">
        <label>Teléfono <span class="tw-req">*</span></label><input id="np-telefono" class="tw-inp">
        <label>Email</label><input id="np-email" class="tw-inp" type="email">
      </div>
      <div class="tw-col">
        <h4>Obra social</h4>
        <label>Obra social</label><select id="np-obra" class="tw-sel"><option value="">(Sin obra social)</option></select>
        <div id="np-obra-info" class="tw-hint" style="min-height:18px;margin-top:6px;"></div>
        <label>N° afiliado</label><input id="np-afiliado" class="tw-inp">
        <label>Credencial (imagen)</label>
        <div class="tw-upload-zone">
          <input type="file" id="np-cred-file" accept="image/*,.pdf" style="display:none;">
          <button type="button" id="np-cred-select" class="tw-btn ghost">Seleccionar archivo</button>
          <div id="np-cred-preview" class="tw-upload-preview" style="display:none"></div>
        </div>
      </div>
      <div class="tw-col">
        <h4>Contacto de emergencia</h4>
        <label>Nombre</label><input id="np-contacto-nombre" class="tw-inp">
        <label>Apellido</label><input id="np-contacto-apellido" class="tw-inp">
        <label>Celular</label><input id="np-contacto-cel" class="tw-inp">
        <label>Vínculo</label><input id="np-vinculo" class="tw-inp">
      </div>
      <div class="tw-col tw-span3">
        <h4>Historia clínica</h4>
        <label>URL (Google Docs)</label>
        <div class="tw-inline">
          <input id="np-historia" class="tw-inp" type="url" placeholder="https://docs.google.com/..." style="flex:1">
          <a id="np-historia-open" class="tw-btn ghost" target="_blank" rel="noopener">Abrir</a>
        </div>
      </div>
    </div>
    <div class="tw-actions">
      <button class="tw-btn" id="turnos-guardar-paciente">Guardar paciente</button>
      <span id="turnos-np-msg" class="tw-hint"></span>
    </div>
  </div>
</div>

<div id="modal-cupo-agotado" class="modal-cupo-agotado" style="display:none;">
  <div class="modal-content">
    <div class="modal-header-alert">
      <span class="icon-alert">⚠️</span>
      <span class="modal-title">Cupo agotado para obra social</span>
    </div>
    <div class="modal-body">
      <p id="modal-cupo-msg">
        No quedan cupos disponibles para la obra social seleccionada.<br>
        ¿Desea reservar el turno de forma <b>particular</b>?<br>
        El mismo tiene un costo de <b id="modal-cupo-copago">$0</b>.
      </p>
    </div>
    <div class="modal-actions">
      <button id="modal-cupo-aceptar" class="btn-accept">Aceptar</button>
      <button id="modal-cupo-cancelar" class="btn-cancel">Cancelar</button>
    </div>
  </div>
</div>

<script type="module">
import supabase from './supabaseClient.js';
import { isValidHourRange } from './validators.js';

/* ====== UI refs ====== */
const UI = {
  centroSelect: document.getElementById('turnos-centro-select'),
  centroNombre: document.getElementById('turnos-centro-nombre'),
  profesionalSelect: document.getElementById('turnos-profesional-select'),
  tipoTurno: document.getElementById('turnos-tipo'),
  btnHoy: document.getElementById('turnos-btn-hoy'),
  pacInput: document.getElementById('turnos-paciente-input'),
  pacSuggest: document.getElementById('turnos-paciente-suggest'),
  pacChip: document.getElementById('turnos-paciente-chip'),
  pacChipText: document.getElementById('turnos-paciente-chip-text'),
  pacClear: document.getElementById('turnos-paciente-clear'),
  calDow: document.getElementById('turnos-cal-dow'),
  calGrid: document.getElementById('turnos-cal-grid'),
  calTitle: document.getElementById('turnos-cal-title'),
  status: document.getElementById('turnos-status'),
  prevMonth: document.getElementById('turnos-prev-month'),
  nextMonth: document.getElementById('turnos-next-month'),
  modal: document.getElementById('turnos-modal'),
  modalTitle: document.getElementById('turnos-modal-title'),
  modalClose: document.getElementById('turnos-modal-close'),
  modalDateInput: document.getElementById('turnos-modal-date'),
  modalPrevDay: document.getElementById('turnos-modal-prev-day'),
  modalNextDay: document.getElementById('turnos-modal-next-day'),
  slotsList: document.getElementById('turnos-slots-list'),
  okBackdrop: document.getElementById('turnos-modal-ok'),
  okClose: document.getElementById('ok-close'),
  okTitle: document.getElementById('ok-title'),
  okPaciente: document.getElementById('ok-paciente'),
  okDni: document.getElementById('ok-dni'),
  okFechaHora: document.getElementById('ok-fecha-hora'),
  okProf: document.getElementById('ok-prof'),
  okCentro: document.getElementById('ok-centro'),
  okDir: document.getElementById('ok-direccion'),
  okWa: document.getElementById('ok-wa-link'),
  okCopy: document.getElementById('ok-copy'),
  okMsg: document.getElementById('ok-msg'),
  modalPac: document.getElementById('turnos-modal-paciente'),
  modalPacClose: document.getElementById('turnos-modal-paciente-close'),
  npDni: document.getElementById('np-dni'),
  npNombre: document.getElementById('np-nombre'),
  npApellido: document.getElementById('np-apellido'),
  npFechaNac: document.getElementById('np-fecha-nac'),
  npTel: document.getElementById('np-telefono'),
  npEmail: document.getElementById('np-email'),
  npObra: document.getElementById('np-obra'),
  npObraInfo: document.getElementById('np-obra-info'),
  npAfiliado: document.getElementById('np-afiliado'),
  npConNom: document.getElementById('np-contacto-nombre'),
  npConApe: document.getElementById('np-contacto-apellido'),
  npConCel: document.getElementById('np-contacto-cel'),
  npVinculo: document.getElementById('np-vinculo'),
  npHistoria: document.getElementById('np-historia'),
  npHistoriaOpen: document.getElementById('np-historia-open'),
  npCredFile: document.getElementById('np-cred-file'),
  npCredSelect: document.getElementById('np-cred-select'),
  npCredPreview: document.getElementById('np-cred-preview'),
  npGuardar: document.getElementById('turnos-guardar-paciente'),
  npMsg: document.getElementById('turnos-np-msg'),
  miniCal: document.getElementById('turnos-mini-cal'),
};

/* ====== State ====== */
let currentCentroId = localStorage.getItem('centro_medico_id');
let currentCentroNombre = localStorage.getItem('centro_medico_nombre') || '';
let currentCentroDireccion = '';
const userRole = localStorage.getItem('user_role');
const loggedProfesionalId = localStorage.getItem('profesional_id');
let view = todayInfo();
let currentProfesional = null;
let duracionCfg = { nueva_consulta:15, recurrente:15, sobreturno:15 };
let modalDateISO = null;
let pacienteSeleccionado = null;
let obrasSocialesCache = [];
let reprogramState = null; // { turno, durMin }
let bookingBusy = false;
let reprogramBusy = false;

/* ====== Helpers Fecha / Formato ====== */
function todayInfo(){const d=new Date();return{y:d.getFullYear(),m:d.getMonth(),d:d.getDate()};}
function pad(n){return n<10?'0'+n:''+n;}
function toISODate(y,m,d){return `${y}-${pad(m+1)}-${pad(d)}`;}
function addMinutes(hhmm,mm){const[h,m]=hhmm.split(':').map(Number);const base=new Date(2000,0,1,h,m);base.setMinutes(base.getMinutes()+mm);return `${pad(base.getHours())}:${pad(base.getMinutes())}`;}
function groupByFecha(arr){const map=new Map();for(const x of arr){if(!map.has(x.fecha)) map.set(x.fecha,[]);map.get(x.fecha).push(x);}return map;}
function toHM(t){return (t||'').substring(0,5);}
function overlaps(aS,aE,bS,bE){return(aS<bE)&&(bS<aE);}
function fmtDateLong(iso){
  // iso = 'YYYY-MM-DD'
  // Split y arma fecha local
  const [y,m,d]=iso.split('-').map(Number);
  return new Date(y, m-1, d).toLocaleDateString('es-AR',{
    weekday:'long', day:'numeric', month:'long', year:'numeric'
  });
}
function minutesDiff(a,b){const[h1,m1]=a.split(':').map(Number);const[h2,m2]=b.split(':').map(Number);return(h2*60+m2)-(h1*60+m1);}
function normalizePhoneForWA(raw){
  if(!raw) return '';
  let p = String(raw).replace(/[^\d]/g,'');
  if(p.startsWith('0')) p = p.slice(1);
  // Si no empieza con 54, agregar
  if(!p.startsWith('54')) p = '549' + p;
  // Si empieza con 54 pero no con 549, agregar el 9 después del 54
  else if(p.startsWith('54') && !p.startsWith('549')) p = '549' + p.slice(2);
  return p;
}
function buildWA({pac,fechaISO,start,end,prof,centro,dir}){return`Hola ${pac.apellido}, ${pac.nombre}! Te confirmamos tu turno el ${fmtDateLong(fechaISO)} de ${start} a ${end} con ${prof} en ${centro} (${dir}). Si no podés asistir, por favor avisá. ¡Gracias!`;}
function dateToISO(d){return d.toISOString().slice(0,10);}
const DOW=['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
function nativeFirstDow(d){const g=d.getDay();return g===0?6:g-1;}
function getProfLabel(){return UI.profesionalSelect.options[UI.profesionalSelect.selectedIndex]?.textContent||'Profesional';}
function pacFromTurno(t){const p=t?.pacientes||null; if(!p && pacienteSeleccionado) return pacienteSeleccionado; return p ? {id:p.id,nombre:p.nombre,apellido:p.apellido,dni:p.dni,telefono:p.telefono} : null;}
function buildModalTitle(iso){
  const fecha=new Date(iso).toLocaleDateString('es-AR');
  const badge=pacienteSeleccionado
    ? ` <span class="tw-ok-badge">Paciente: ${pacienteSeleccionado.apellido}, ${pacienteSeleccionado.nombre}${pacienteSeleccionado.dni?(' · DNI '+pacienteSeleccionado.dni):''}</span>`
    : '';
  return `Turnos del ${fecha}${badge}`;
}
function refreshModalTitle(){ if(modalDateISO) UI.modalTitle.innerHTML=buildModalTitle(modalDateISO); }
function setSlotsDisabled(disabled){ UI.slotsList.querySelectorAll('.tw-icon-btn').forEach(b=>{ b.disabled=disabled; }); }

/* ====== Centros / Profesionales ====== */
async function fetchCentroById(id){
  const { data } = await supabase.from('centros_medicos').select('nombre,direccion').eq('id',id).single();
  return { nombre:data?.nombre||'', direccion:data?.direccion||'' };
}
async function getCentrosDeProfesional(pid){
  const { data, error } = await supabase
    .from('profesional_centro')
    .select('centro_id,activo,centros_medicos(id,nombre)')
    .eq('profesional_id',pid).eq('activo',true);
  if(error||!data) return [];
  return data.filter(r=>r.centros_medicos).map(r=>({id:r.centros_medicos.id,nombre:r.centros_medicos.nombre}));
}
async function ensureCentro(){
  if(userRole==='asistente'){
    UI.centroNombre.style.display='';
    UI.centroSelect.style.display='none';
    const c=await fetchCentroById(currentCentroId);
    currentCentroNombre=c.nombre||currentCentroNombre;
    currentCentroDireccion=c.direccion||'';
    UI.centroNombre.value=currentCentroNombre;
  }else{
    UI.centroSelect.style.display='';
    UI.centroNombre.style.display='none';
    const centros=await getCentrosDeProfesional(loggedProfesionalId);
    if(!centros.length){UI.centroSelect.innerHTML='<option value="">Sin centros</option>';return;}
    UI.centroSelect.innerHTML=centros.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join('');
    if(currentCentroId && centros.some(c=>c.id===currentCentroId)){UI.centroSelect.value=currentCentroId;}else{currentCentroId=centros[0].id;UI.centroSelect.value=currentCentroId;}
    const c=await fetchCentroById(currentCentroId);
    currentCentroNombre=c.nombre||UI.centroSelect.options[UI.centroSelect.selectedIndex]?.textContent||'';
    currentCentroDireccion=c.direccion||'';
    UI.centroSelect.addEventListener('change',async()=>{
      currentCentroId=UI.centroSelect.value;
      const c2=await fetchCentroById(currentCentroId);
      currentCentroNombre=c2.nombre||UI.centroSelect.options[UI.centroSelect.selectedIndex]?.textContent||'';
      currentCentroDireccion=c2.direccion||'';
      localStorage.setItem('centro_medico_id',currentCentroId);
      localStorage.setItem('centro_medico_nombre',currentCentroNombre);
      await loadProfesionales();
      await loadDuraciones(currentProfesional);
      await renderCalendar();
      if(UI.modal.style.display==='flex') await renderMiniCalFor(modalDateISO);
    });
  }
}
async function loadProfesionales(){
  const sel=UI.profesionalSelect;
  if(userRole==='medico' && loggedProfesionalId){
    let label=null;
    try{
      const { data } = await supabase.from('profesionales')
        .select('id,nombre,apellido,display_name')
        .eq('id',loggedProfesionalId).single();
      if(data){
        label=data.display_name||[data.apellido,data.nombre].filter(Boolean).join(', ')||data.nombre||data.apellido;
      }
    }catch(_){}
    if(!label) label=localStorage.getItem('user_name')||localStorage.getItem('email')||'Mi agenda';
    sel.innerHTML=`<option value="${loggedProfesionalId}">${label}</option>`;
    sel.disabled=true;
    currentProfesional=loggedProfesionalId;
    return;
  }
  sel.disabled=false;
  const { data: map } = await supabase
    .from('profesional_centro')
    .select('profesional_id')
    .eq('centro_id',currentCentroId)
    .eq('activo',true);
  const ids=[...new Set((map||[]).map(r=>r.profesional_id).filter(Boolean))];
  if(!ids.length){sel.innerHTML='<option value="">Sin profesionales</option>';currentProfesional=null;return;}
  const { data: profs } = await supabase.from('profesionales')
    .select('id,nombre,apellido,display_name')
    .in('id',ids)
    .order('apellido',{ascending:true});
  sel.innerHTML=(profs||[]).map(p=>{
    const nombre=p.display_name||[p.apellido,p.nombre].filter(Boolean).join(', ')||p.nombre||p.apellido||p.id;
    return `<option value="${p.id}">${nombre}</option>`;
  }).join('');
  currentProfesional=profs?.[0]?.id||null;
  if(currentProfesional) sel.value=currentProfesional;
}
async function loadDuraciones(pid){
  duracionCfg={nueva_consulta:15,recurrente:15,sobreturno:15};
  if(!pid)return;
  const { data } = await supabase
    .from('config_duracion_turnos')
    .select('tipo_turno,minutos')
    .eq('profesional_id',pid)
    .eq('centro_id',currentCentroId);
  (data||[]).forEach(r=>{ if(r.tipo_turno && r.minutos) duracionCfg[r.tipo_turno]=r.minutos; });
}

/* ====== Obras Sociales ====== */
async function loadObrasSociales(){
  const { data } = await supabase.from('obras_sociales')
    .select('id,obra_social,condicion_copago,valor_copago')
    .order('obra_social',{ascending:true});
  obrasSocialesCache=data||[];
  UI.npObra.innerHTML='<option value="">(Sin obra social)</option>' +
    obrasSocialesCache.map(o=>`<option value="${o.obra_social}">${o.obra_social}</option>`).join('');
}
UI.npObra?.addEventListener('change',()=>{
  const sel=obrasSocialesCache.find(o=>o.obra_social===UI.npObra.value);
  if(!sel){UI.npObraInfo.textContent='';return;}
  const cond=sel.condicion_copago?`Condición: ${sel.condicion_copago}`:''; const val=(sel.valor_copago!=null)?` · Copago: ${sel.valor_copago}`:'';
  UI.npObraInfo.textContent=cond||val?cond+val:'';
});

/* ====== Pacientes (typeahead) ====== */
let suggestTimer=null;
function hideSuggest(){UI.pacSuggest.style.display='none';UI.pacSuggest.innerHTML='';}
function showSuggest(){UI.pacSuggest.style.display='block';}
UI.pacInput.addEventListener('input',()=>{
  clearTimeout(suggestTimer);
  const q=UI.pacInput.value.trim();
  if(!q){hideSuggest();return;}
  suggestTimer=setTimeout(()=>fetchSuggestions(q),180);
});
window.addEventListener('click',e=>{
  if(!UI.pacSuggest.contains(e.target)&&e.target!==UI.pacInput){hideSuggest();}
});

async function fetchSuggestions(q){
  let result = [];
  if (/^\d{6,}$/.test(q)) {
    // Buscar por DNI
    const { data } = await supabase.from('pacientes')
      .select('id,dni,apellido,nombre,telefono,email,obra_social_id')
      .eq('dni', q).limit(10);
    result = data || [];
  } else {
    // Buscar por apellido y nombre
    const parts = q.toLowerCase().split(/\s+/).filter(Boolean);
    let query = supabase.from('pacientes')
      .select('id,dni,apellido,nombre,telefono,email,obra_social_id')
      .eq('activo', true)
      .limit(10)
      .order('apellido', { ascending: true });
    if (parts[0]) query = query.ilike('apellido', `%${parts[0]}%`);
    if (parts[1]) query = query.ilike('nombre', `%${parts[1]}%`);
    const { data } = await query;
    result = data || [];
  }
  if (!result.length) {
    UI.pacSuggest.innerHTML = `
      <div class="tw-s-item" data-act="create">
        <div>
          <div class="tw-s-title">+ Crear nuevo paciente</div>
          <div class="tw-s-meta">No se encontraron coincidencias para “${q}”.</div>
        </div>
      </div>`;
    showSuggest(); bindSuggestHandlers(q, []);
    return;
  }
  UI.pacSuggest.innerHTML =
    result.map(p => `
      <div class="tw-s-item" data-act="select" data-id="${p.id}">
        <div>
          <div class="tw-s-title">${p.apellido}, ${p.nombre}</div>
          <div class="tw-s-meta">DNI ${p.dni}${p.telefono ? ' · ' + p.telefono : ''}${p.email ? ' · ' + p.email : ''}</div>
        </div>
      </div>`).join('') +
    `<div class="tw-s-item" data-act="create">
      <div>
        <div class="tw-s-title">+ Crear nuevo paciente</div>
        <div class="tw-s-meta">Agregar manualmente.</div>
      </div>
    </div>`;
  showSuggest(); bindSuggestHandlers(q, result);
}

function bindSuggestHandlers(q,result){
  UI.pacSuggest.querySelectorAll('.tw-s-item').forEach(el=>{
    el.addEventListener('click',async()=>{
      const act=el.getAttribute('data-act');
      if(act==='select'){
        const id=el.getAttribute('data-id');
        const p=result.find(r=>String(r.id)===id);
        if(p) selectPaciente(p);
      } else if(act==='create'){
        await openPacienteModalPrefilled(q);
      }
    });
  });
}
function selectPaciente(p){
  pacienteSeleccionado = {
    id: p.id,
    nombre: p.nombre,
    apellido: p.apellido,
    dni: p.dni,
    telefono: p.telefono || '',
    obra_social_id: p.obra_social_id || null // <--- esta línea agregada correctamente
  };
  UI.pacChipText.textContent = `${p.apellido}, ${p.nombre} · DNI ${p.dni}`;
  UI.pacChip.style.display = 'flex';
  hideSuggest();
  enforceTipoTurnoByPaciente(p.id);
  if (UI.modal.style.display === 'flex') refreshModalTitle();
}
UI.pacClear.addEventListener('click',()=>{
  pacienteSeleccionado=null;UI.pacChip.style.display='none';
  enforceTipoTurnoByPaciente(null);
  if(UI.modal.style.display==='flex') refreshModalTitle();
});
async function enforceTipoTurnoByPaciente(pacienteId){
  const optNueva=UI.tipoTurno.querySelector('option[value="nueva_consulta"]');
  if(!optNueva)return;
  if(!pacienteId){optNueva.disabled=false;return;}
  const { count } = await supabase.from('turnos')
    .select('id',{count:'exact',head:true})
    .eq('paciente_id',pacienteId);
  if((count??0)>0){
    optNueva.disabled=true;
    if(UI.tipoTurno.value==='nueva_consulta') UI.tipoTurno.value='recurrente';
  } else {
    optNueva.disabled=false; // FIX
  }
}

/* ====== Modal Paciente ====== */
async function openPacienteModalPrefilled(q){
  if(!obrasSocialesCache.length) await loadObrasSociales();
  UI.npDni.value=/^\d{6,}$/.test(q)?q:''; const parts=q.split(/\s+/).filter(Boolean);
  UI.npApellido.value=parts[0]||''; UI.npNombre.value=parts[1]||'';
  UI.npFechaNac.value=''; UI.npTel.value=''; UI.npEmail.value='';
  UI.npObra.value=''; UI.npObraInfo.textContent=''; UI.npAfiliado.value='';
  UI.npConNom.value=UI.npConApe.value=UI.npConCel.value=UI.npVinculo.value='';
  UI.npHistoria.value=''; UI.npCredFile.value=''; UI.npCredPreview.style.display='none'; UI.npCredPreview.innerHTML='';
  UI.npMsg.textContent=''; UI.modalPac.style.display='flex';
}
UI.modalPacClose.addEventListener('click',()=>UI.modalPac.style.display='none');
window.addEventListener('click',e=>{if(e.target===UI.modalPac)UI.modalPac.style.display='none';});
UI.npHistoriaOpen.addEventListener('click',e=>{if(!UI.npHistoria.value){e.preventDefault();}});
UI.npCredSelect.addEventListener('click',()=>UI.npCredFile.click());
UI.npCredFile.addEventListener('change',()=>{
  const f=UI.npCredFile.files?.[0];
  UI.npCredPreview.innerHTML='';
  if(!f){UI.npCredPreview.style.display='none';return;}
  if(/^image\//.test(f.type)){
    const img=document.createElement('img'); img.src=URL.createObjectURL(f); img.alt='credencial';
    UI.npCredPreview.appendChild(img);
  }
  const meta=document.createElement('div'); meta.className='tw-hint';
  meta.innerHTML=`${f.name} · ${(f.size/1024).toFixed(0)} KB <a href="#" id="np-cred-remove">Quitar</a>`;
  UI.npCredPreview.appendChild(meta); UI.npCredPreview.style.display='flex';
  meta.querySelector('#np-cred-remove').addEventListener('click',ev=>{
    ev.preventDefault();UI.npCredFile.value='';UI.npCredPreview.style.display='none';UI.npCredPreview.innerHTML='';
  });
});
UI.npGuardar.addEventListener('click',async()=>{
  const dni=UI.npDni.value.trim(), nombre=UI.npNombre.value.trim(), apellido=UI.npApellido.value.trim(), fecha_nacimiento=UI.npFechaNac.value||'', telefono=UI.npTel.value.trim();
  if(!dni||!nombre||!apellido||!fecha_nacimiento||!telefono){ UI.npMsg.textContent='Completá los campos obligatorios (*)';return; }
  UI.npMsg.textContent='Guardando...';
  let credencialUrl=null;
  const file=UI.npCredFile.files?.[0];
  if(file){
    const ext=(file.name.split('.').pop()||'bin').toLowerCase();
    const path=`${dni}_${Date.now()}.${ext}`;
    const { data: up, error: upErr } = await supabase.storage.from('credenciales').upload(path,file,{cacheControl:'3600',upsert:false,contentType:file.type});
    if(upErr){UI.npMsg.textContent='No se pudo subir credencial: '+(upErr.message||'');return;}
    const { data: pub } = supabase.storage.from('credenciales').getPublicUrl(up.path);
    credencialUrl=pub?.publicUrl||null;
  }
  const payload={
    dni,nombre,apellido,fecha_nacimiento,telefono,
    email:UI.npEmail.value.trim()||null, obra_social:UI.npObra.value||null, numero_afiliado:UI.npAfiliado.value.trim()||null,
    contacto_nombre:UI.npConNom.value.trim()||null, contacto_apellido:UI.npConApe.value.trim()||null, contacto_celular:UI.npConCel.value.trim()||null,
    vinculo:UI.npVinculo.value.trim()||null, credencial:credencialUrl, historia_clinica:UI.npHistoria.value.trim()||null, activo:true
  };
  const { data, error } = await supabase.from('pacientes').insert([payload]).select('id,dni,nombre,apellido,telefono').single();
  if(error){UI.npMsg.textContent='Error: '+(error.message||'no se pudo crear');return;}
  UI.modalPac.style.display='none'; selectPaciente(data);
  const optNueva=UI.tipoTurno.querySelector('option[value="nueva_consulta"]'); if(optNueva) optNueva.disabled=false; UI.tipoTurno.value='nueva_consulta';
});

/* ====== Agenda / Turnos ====== */
async function fetchAgendaYTurnos(pid,y,m){
  const last=new Date(y,m+1,0); const start=toISODate(y,m,1), end=toISODate(y,m,last.getDate());
  const [agendaRes, turnosRes] = await Promise.all([
    supabase.from('agenda')
      .select('id,fecha,hora_inicio,hora_fin')
      .eq('centro_id',currentCentroId).eq('profesional_id',pid)
      .gte('fecha',start).lte('fecha',end).order('fecha',{ascending:true}),
    supabase.from('turnos')
      .select('id,fecha,hora_inicio,hora_fin,estado,paciente_id,agenda_id,pacientes(id,apellido,nombre,dni,telefono)')
      .eq('centro_id',currentCentroId).eq('profesional_id',pid)
      .gte('fecha',start).lte('fecha',end).order('hora_inicio',{ascending:true})
  ]);
  return { agenda:agendaRes.data||[], turnos:turnosRes.data||[] };
}
function generarSlots(agendaDia,turnosDia,tipo,excludeId){
  const dur=Number(duracionCfg[tipo]||15); if(!dur||dur<=0)return[];
  const out=[]; const vivos=(turnosDia||[]).filter(t=>(t.estado||'').toLowerCase()!=='cancelado'&&t.id!==excludeId);
  for(const bloque of (agendaDia||[])){
    const bStart=toHM(bloque.hora_inicio), bEnd=toHM(bloque.hora_fin); let t=bStart;
    while(addMinutes(t,dur)<=bEnd){
      const start=t,end=addMinutes(t,dur);
      const oc=vivos.find(tr=>{const s=toHM(tr.hora_inicio),e=toHM(tr.hora_fin);return overlaps(start,end,s,e);});
      out.push({start,end,agenda_id:bloque.id,disponible:!oc,turno:oc||null}); t=end;
    }
  }
  return out;
}
function renderDow(){UI.calDow.innerHTML=DOW.map(d=>`<div>${d}</div>`).join('');}
async function renderCalendar(){
  if(!currentProfesional){ UI.status.textContent='No hay profesional seleccionado.'; UI.calGrid.innerHTML=''; return; }
  UI.status.textContent='Cargando agenda...';
  const { agenda, turnos } = await fetchAgendaYTurnos(currentProfesional,view.y,view.m);
  const gA=groupByFecha(agenda), gT=groupByFecha(turnos); const tipo=UI.tipoTurno.value;
  UI.calGrid.innerHTML=''; const first=new Date(view.y,view.m,1), last=new Date(view.y,view.m+1,0);
  UI.calTitle.textContent=first.toLocaleString('es-AR',{month:'long',year:'numeric'});
  const offset=nativeFirstDow(first); const total=offset+last.getDate(); const rows=Math.ceil(total/7); let day=1;
  for(let i=0;i<rows*7;i++){
    const cell=document.createElement('div');
    if(i<offset||day>last.getDate()){cell.className='tw-day empty';UI.calGrid.appendChild(cell);continue;}
    const iso=toISODate(view.y,view.m,day);
    const agendaDia=gA.get(iso)||[]; const turnosDia=gT.get(iso)||[];
    const preview=generarSlots(agendaDia,turnosDia,tipo,null); const libres=preview.filter(s=>s.disponible).length;
    let cls='tw-day';let badge='sin agenda';
    if(!agendaDia.length){cls+=' empty';}
    else if(libres>0){cls+=' free clickable';badge=`${libres} libres`;}
    else{cls+=' busy clickable';badge='sin huecos';}
    cell.className=cls; cell.innerHTML=`<div class="num">${day}</div><div class="badge">${badge}</div>`;
    if(cls.includes('clickable')){ cell.addEventListener('click',()=>openDayModal(iso,agendaDia,turnosDia,{preserveReprogram:!!reprogramState})); }
    UI.calGrid.appendChild(cell); day++;
  }
  UI.status.textContent=agenda.length?'':'No hay agenda cargada para este mes.';
}

/* ====== Mini-calendario en modal ====== */
async function renderMiniCalFor(isoDate){
  if(!currentProfesional || !isoDate || !UI.miniCal) return;
  const d=new Date(isoDate+'T00:00:00'); const y=d.getFullYear(), m=d.getMonth();
  UI.miniCal.innerHTML='';
  const { agenda, turnos } = await fetchAgendaYTurnos(currentProfesional, y, m);
  const gA=groupByFecha(agenda||[]), gT=groupByFecha(turnos||[]);
  const first=new Date(y,m,1), last=new Date(y,m+1,0); const offset=nativeFirstDow(first);
  const selectedDay=d.getDate(); const today=todayInfo(); const tipo=UI.tipoTurno.value;
  for(let i=0;i<offset;i++){ const dot=document.createElement('div'); dot.className='dot none'; UI.miniCal.appendChild(dot); }
  for(let day=1;day<=last.getDate();day++){
    const iso=toISODate(y,m,day);
    const agendaDia=gA.get(iso)||[]; const turnosDia=gT.get(iso)||[];
    const preview=generarSlots(agendaDia,turnosDia,tipo,reprogramState?.turno?.id||null);
    const libres=preview.filter(s=>s.disponible).length;
    let cls='dot '; let title=''; let clickable=false;
    if(!agendaDia.length){ cls+='none'; title='Sin agenda'; }
    else if(libres>0){ cls+='free'; title=`${libres} libres`; clickable=true; }
    else { cls+='busy'; title='Sin huecos'; clickable=true; }
    const dot=document.createElement('div'); dot.className=cls+(clickable?' clickable':''); if(title) dot.title=`${day}/${m+1} · ${title}`;
    if(day===selectedDay) dot.classList.add('selected'); if(y===today.y&&m===today.m&&day===today.d) dot.classList.add('today');
    if(clickable){ dot.addEventListener('click', async ()=>{ const newISO=toISODate(y,m,day); await loadModalDate(newISO); await renderMiniCalFor(newISO); }); }
    UI.miniCal.appendChild(dot);
  }
}

/* ====== Modal día ====== */
async function openDayModal(isoDate,agendaDia,turnosDiaRaw,{preserveReprogram=false}={}){
  if(!preserveReprogram)reprogramState=null;
  modalDateISO=isoDate;
  UI.modalTitle.innerHTML=buildModalTitle(isoDate);
  UI.modalDateInput.value=isoDate;
  UI.modal.style.display='flex';
  const exclude=reprogramState?.turno.id||null;
  const slots=generarSlots(agendaDia,turnosDiaRaw,UI.tipoTurno.value,exclude);
  renderSlots(slots);
  await renderMiniCalFor(isoDate);
}
UI.modalClose.addEventListener('click',()=>UI.modal.style.display='none');
window.addEventListener('click',e=>{
  if(e.target===UI.modal) UI.modal.style.display='none';
  if(e.target===UI.okBackdrop) UI.okBackdrop.style.display='none';
  if(e.target===UI.modalPac) UI.modalPac.style.display='none';
});
async function refreshDayModal(){
  if(!modalDateISO)return;
  const { data:agendaDia } = await supabase.from('agenda')
    .select('id,fecha,hora_inicio,hora_fin')
    .eq('centro_id',currentCentroId).eq('profesional_id',currentProfesional).eq('fecha',modalDateISO)
    .order('hora_inicio',{ascending:true});
  const { data:turnosDiaRaw } = await supabase.from('turnos')
    .select('id,fecha,hora_inicio,hora_fin,estado,paciente_id,agenda_id,pacientes(id,apellido,nombre,dni,telefono)')
    .eq('centro_id',currentCentroId).eq('profesional_id',currentProfesional).eq('fecha',modalDateISO)
    .order('hora_inicio',{ascending:true});
  const slots=generarSlots(agendaDia||[],turnosDiaRaw||[],UI.tipoTurno.value,reprogramState?.turno.id||null);
  renderSlots(slots);
}
// Simulación de consulta de cupo por obra social
async function getCupoObraSocial(obraSocialId, centroId, profesionalId, fechaISO) {
  // Aquí deberías consultar tu base de datos o backend
  // Simulación: 2 cupos por obra social por día
  const { data: turnos } = await supabase.from('turnos')
    .select('id')
    .eq('obra_social_id', obraSocialId)
    .eq('centro_id', centroId)
    .eq('profesional_id', profesionalId)
    .eq('fecha', fechaISO);
  return turnos.length < 2; // cambia "2" por el cupo real
}

// Simulación de consulta de copago particular
async function getCopagoParticular(centroId, profesionalId, fechaISO) {
  // Aquí deberías consultar tu base de datos o backend
  // Simulación: $1000 fijo
  return 1000;
}

// Modifica tryAgendar para usar los chequeos al intentar reservar
async function tryAgendar(slot) {
  if (bookingBusy) return;
  bookingBusy = true;
  setSlotsDisabled(true);

  try {
    if (!pacienteSeleccionado) {
      alert('Seleccioná un paciente primero.');
      return;
    }
    if (!isValidHourRange(slot.start, slot.end)) {
      alert('Rango horario inválido.');
      return;
    }

    let cupoDisponible = true;
    let copagoParticular = 0;
    let obraSocialId = pacienteSeleccionado.obra_social_id || null;

    if (obraSocialId) {
      cupoDisponible = await getCupoObraSocial(obraSocialId, currentCentroId, currentProfesional, modalDateISO);

      if (!cupoDisponible) {
        copagoParticular = await getCopagoParticular(currentCentroId, currentProfesional, modalDateISO);

        abrirModalCupoAgotado(copagoParticular);

        const resultado = await new Promise(resolve => {
          document.getElementById('modal-cupo-aceptar').onclick = function() {
            cerrarModalCupoAgotado();
            resolve('aceptar');
          };
          document.getElementById('modal-cupo-cancelar').onclick = function() {
            cerrarModalCupoAgotado();
            resolve('cancelar');
          };
        });

        if (resultado !== 'aceptar') {
          return; // Canceló, no agenda
        }

        obraSocialId = null; // agenda como particular
      }
    }

    // Arma el payload con obra social (o null si es particular)
    const payload = {
      agenda_id: slot.agenda_id || null,
      centro_id: currentCentroId,
      profesional_id: currentProfesional,
      paciente_id: pacienteSeleccionado.id,
      fecha: modalDateISO,
      hora_inicio: slot.start,
      hora_fin: slot.end,
      estado: 'asignado',
      notas: (UI.tipoTurno.value === 'sobreturno') ? 'Sobreturno' : null,
      obra_social_id: obraSocialId,
      copago: obraSocialId === null ? copagoParticular : null
    };

    const { data: inserted, error } = await supabase.from('turnos').insert([payload]).select('id').single();
    // ... resto igual a tu versión actual ...
  } finally {
    bookingBusy = false;
    setSlotsDisabled(false);
    await refreshDayModal();
    await renderCalendar();
    refreshModalTitle();
  }
}
/* ====== OK Modal ====== */
function openOkModal({pac,fechaISO,start,end,profLabel}){
  UI.okTitle.textContent=`${pac.apellido}, ${pac.nombre}`;
  UI.okPaciente.textContent=`${pac.apellido}, ${pac.nombre}`;
  UI.okDni.textContent=pac.dni||'—';
  UI.okFechaHora.textContent=`${fmtDateLong(fechaISO)} · ${start}–${end}`;
  UI.okProf.textContent=profLabel;
  UI.okCentro.textContent=currentCentroNombre||'—';
  UI.okDir.textContent=currentCentroDireccion||'—';
  const msg=buildWA({pac,fechaISO,start,end,prof:profLabel,centro:currentCentroNombre||'',dir:currentCentroDireccion||''});
  const to=normalizePhoneForWA(pac.telefono||'');
  const href=to?`https://wa.me/${to}?text=${encodeURIComponent(msg)}`:'javascript:void(0)';
  UI.okWa.href=href; UI.okWa.textContent=to?'Enviar por WhatsApp':'WhatsApp (falta teléfono)'; UI.okWa.style.pointerEvents=to?'auto':'none';
  UI.okMsg.textContent=''; UI.okCopy.onclick=()=>{ const link=to?href:msg; navigator.clipboard.writeText(link).then(()=>UI.okMsg.textContent='Copiado').catch(()=>UI.okMsg.textContent='No se pudo copiar'); };
  UI.okBackdrop.style.display='flex';
}
UI.okClose.addEventListener('click',()=>UI.okBackdrop.style.display='none');

/* ====== Acciones Turnos ====== */
async function tryAgendar(slot) {
  if (bookingBusy) return;
  bookingBusy = true;
  setSlotsDisabled(true);

  try {
    if (!pacienteSeleccionado) {
      alert('Seleccioná un paciente primero.');
      return;
    }
    if (!isValidHourRange(slot.start, slot.end)) {
      alert('Rango horario inválido.');
      return;
    }

    // --- NUEVO: Chequeo de cupo obra social ---
    let cupoDisponible = true;
    let copagoParticular = 0;
    let obraSocialId = pacienteSeleccionado.obra_social_id || null;

    if (obraSocialId) {
      // Reemplaza esta función con tu lógica real
      cupoDisponible = await getCupoObraSocial(obraSocialId, currentCentroId, currentProfesional, modalDateISO);

      if (!cupoDisponible) {
        // Reemplaza con lógica real para obtener el copago particular
        copagoParticular = await getCopagoParticular(currentCentroId, currentProfesional, modalDateISO);

        // Mostrar modal de cupo agotado y esperar la respuesta
        abrirModalCupoAgotado(copagoParticular);

        // Espera la respuesta del modal (aceptar o cancelar)
        const resultado = await new Promise(resolve => {
          document.getElementById('modal-cupo-aceptar').onclick = function() {
            cerrarModalCupoAgotado();
            resolve('aceptar');
          };
          document.getElementById('modal-cupo-cancelar').onclick = function() {
            cerrarModalCupoAgotado();
            resolve('cancelar');
          };
        });

        if (resultado !== 'aceptar') {
          return; // Canceló, no agenda
        }

        // Si acepta, agenda como particular (obra social null y copago seteado)
        obraSocialId = null;
      }
    }

    // Arma el payload con obra social (o null si es particular)
    const payload = {
      agenda_id: slot.agenda_id || null,
      centro_id: currentCentroId,
      profesional_id: currentProfesional,
      paciente_id: pacienteSeleccionado.id,
      fecha: modalDateISO,
      hora_inicio: slot.start,
      hora_fin: slot.end,
      estado: 'asignado',
      notas: (UI.tipoTurno.value === 'sobreturno') ? 'Sobreturno' : null,
      obra_social_id: obraSocialId,
      copago: obraSocialId === null ? copagoParticular : null // <-- NUEVO: agrega copago si es particular
    };

    const { data: inserted, error } = await supabase.from('turnos').insert([payload]).select('id').single();
    if (error) {
      const msg = (error.message || '').toLowerCase();
      if (error.code === '23505') { // unique violation
        await refreshDayModal();
        const { data: exists } = await supabase.from('turnos')
          .select('id')
          .eq('centro_id', currentCentroId).eq('profesional_id', currentProfesional)
          .eq('fecha', modalDateISO).eq('hora_inicio', slot.start).eq('hora_fin', slot.end)
          .eq('paciente_id', pacienteSeleccionado.id).limit(1);
        if (exists && exists.length) {
          openOkModal({ pac: pacienteSeleccionado, fechaISO: modalDateISO, start: slot.start, end: slot.end, profLabel: getProfLabel() });
        } else {
          alert('Ese horario se ocupó recién.');
        }
      } else if (msg.includes('solap')) {
        await refreshDayModal();
        alert('Ese horario se ocupó recién.');
      } else {
        alert(error.message || 'No se pudo agendar.');
      }
    } else {
      openOkModal({ pac: pacienteSeleccionado, fechaISO: modalDateISO, start: slot.start, end: slot.end, profLabel: getProfLabel() });
    }
  } finally {
    bookingBusy = false;
    setSlotsDisabled(false);
    await refreshDayModal();
    await renderCalendar();
    refreshModalTitle();
  }
}
// 1. Reprogramar turno
async function confirmReprogram(slot) {
  if (!reprogramState) return;
  if (reprogramBusy) return;
  reprogramBusy = true;
  try {
    const t = reprogramState.turno;
    if (!isValidHourRange(slot.start, slot.end)) {
      alert('Rango horario inválido.');
      return;
    }
    // 1: Crear nuevo turno con los nuevos datos y copiar todo lo relevante
    const nuevoTurno = {
      ...t,
      fecha: modalDateISO,
      hora_inicio: slot.start,
      hora_fin: slot.end,
      agenda_id: slot.agenda_id || null,
      reprogramado_desde: `${t.fecha} ${t.hora_inicio}-${t.hora_fin}`
    };
    delete nuevoTurno.id; // Para que se cree como nueva fila

    const { error: errorInsert } = await supabase.from('turnos').insert([nuevoTurno]);
    if (errorInsert) {
      alert(errorInsert.message || 'No se pudo reprogramar (insert).');
      return;
    }

    // 2: Eliminar el turno original
    const { error: errorDelete } = await supabase.from('turnos').delete().eq('id', t.id);
    if (errorDelete) {
      alert(errorDelete.message || 'No se pudo eliminar el turno original.');
      return;
    }

    // 3: UI y estado
    const pac = pacFromTurno(t);
    if (pac) {
      openOkModal({
        pac,
        fechaISO: modalDateISO,
        start: slot.start,
        end: slot.end,
        profLabel: getProfLabel()
      });
    }
    reprogramState = null;
  } finally {
    reprogramBusy = false;
    await refreshDayModal();
    await renderCalendar();
  }
}
// 2. Cancelar turno
async function cancelarTurno(t) {
  if (!confirm('¿Anular este turno?')) return;
  const { error } = await supabase.from('turnos').delete().eq('id', t.id);
  if (error) {
    alert(error.message || 'No se pudo cancelar el turno.');
  } else if (reprogramState?.turno.id === t.id) {
    reprogramState = null;
  }
  await refreshDayModal();
  await renderCalendar();
}

// Marca turnos como 'vencido' si ya terminó hace más de una hora
async function marcarTurnosVencidos() {
  const now = new Date();
  // Buscar turnos asignados
  const { data: turnos, error } = await supabase
    .from('turnos')
    .select('id, fecha, hora_inicio, hora_fin, estado, paciente_id')
    .eq('estado', 'asignado');

  if (error || !turnos) return;

  for (const turno of turnos) {
    // Calcular fecha/hora de fin + 1 hora
    const finTurno = new Date(`${turno.fecha}T${turno.hora_fin}:00`);
    finTurno.setHours(finTurno.getHours() + 1);

    if (now > finTurno) {
      // Marcar como vencido
      await supabase
        .from('turnos')
        .update({ estado: 'vencido' })
        .eq('id', turno.id);

      // Buscar datos del paciente para la notificación
      const { data: paciente, error: errorPaciente } = await supabase
        .from('pacientes')
        .select('nombre, dni')
        .eq('id', turno.paciente_id)
        .single();

      if (!errorPaciente && paciente) {
        // Notificación emergente con nombre, DNI, fecha y hora
        alert(
          `Turno vencido\nPaciente: ${paciente.nombre}\nDNI: ${paciente.dni}\nFecha: ${turno.fecha}\nHorario: ${turno.hora_inicio} - ${turno.hora_fin}`
        );
      }
    }
  }
}

// Ejecutar cada 15 minutos automáticamente
setInterval(marcarTurnosVencidos, 15 * 60 * 1000);
// (Opcional) Ejecutar una vez al cargar
marcarTurnosVencidos();

/* ====== Navegación Modal Día ====== */
async function loadModalDate(newISO){
  modalDateISO=newISO;
  UI.modalDateInput.value=newISO;
  UI.modalTitle.innerHTML=buildModalTitle(newISO);
  await refreshDayModal();
  await renderMiniCalFor(newISO);
}
UI.modalPrevDay.addEventListener('click',async()=>{
  if(!modalDateISO)return; const d=new Date(modalDateISO+'T00:00:00'); d.setDate(d.getDate()-1);
  await loadModalDate(dateToISO(d));
});
UI.modalNextDay.addEventListener('click',async()=>{
  if(!modalDateISO)return; const d=new Date(modalDateISO+'T00:00:00'); d.setDate(d.getDate()+1);
  await loadModalDate(dateToISO(d));
});
UI.modalDateInput.addEventListener('change',async()=>{
  if(UI.modalDateInput.value){ await loadModalDate(UI.modalDateInput.value); }
});

/* ====== Eventos globales ====== */
UI.tipoTurno.addEventListener('change',async()=>{
  await renderCalendar();
  if(UI.modal.style.display==='flex'){ await refreshDayModal(); await renderMiniCalFor(modalDateISO); }
});
UI.profesionalSelect.addEventListener('change',async()=>{
  currentProfesional=UI.profesionalSelect.value||null;
  await loadDuraciones(currentProfesional);
  await renderCalendar();
  if(UI.modal.style.display==='flex'){ await refreshDayModal(); await renderMiniCalFor(modalDateISO); }
});
UI.btnHoy.addEventListener('click',async()=>{ view=todayInfo(); await renderCalendar(); });
UI.prevMonth.addEventListener('click',async()=>{ if(--view.m<0){view.m=11;view.y--;} await renderCalendar(); });
UI.nextMonth.addEventListener('click',async()=>{ if(++view.m>11){view.m=0;view.y++;} await renderCalendar(); });

/* ====== Init ====== */
(async function init(){
  if(!currentCentroId){
    UI.status.textContent='Seleccioná un centro para ver turnos.'; return;
  }
  renderDow();
  await ensureCentro();
  await loadProfesionales();
  await loadDuraciones(currentProfesional);
  await renderCalendar();
})();
</script>
