<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Turnos — EG Health Solutions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#7656b0; --brand-2:#a490d7; --ink:#381e60; --muted:#6b6480;
      --bg:#f7f9fb; --card:#fff; --line:#ece5fc; --accent:#0b5394;
    }
    body{margin:0;background:var(--bg);font-family:'Segoe UI',Arial,sans-serif;color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:6px}

    /* Toolbar */
    .toolbar{display:grid;grid-template-columns: 1.1fr 1.1fr 1.4fr 1fr auto;gap:12px;align-items:end;margin-bottom:14px;
      background:var(--card);border-radius:16px;box-shadow:0 2px 12px rgba(80,60,160,.10);padding:14px}
    .field{display:flex;flex-direction:column;gap:6px;position:relative}
    .field label{font-size:12px;color:var(--muted)}
    .inp,.sel{background:#f7f9fb;border:1.5px solid var(--line);border-radius:7px;padding:9px 10px;font-size:14px;color:var(--ink);outline:none;width:100%}
    .inp:focus,.sel:focus{border-color:var(--brand-2)}
    .btn{appearance:none;border:none;background:var(--brand);color:#fff;border-radius:8px;padding:10px 12px;font-weight:600;cursor:pointer;transition:filter .15s}
    .btn.secondary{background:#e7e2fa;color:#5a3e9a}
    .btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
    .btn:hover{filter:brightness(.98)}

    /* chip paciente seleccionado */
    .chip{position:absolute;right:8px;top:-18px;background:#e7e2fa;color:#5a3e9a;border-radius:999px;padding:2px 8px;font-size:12px;display:flex;gap:6px;align-items:center}
    .chip button{all:unset;cursor:pointer}

    /* typeahead */
    .suggest{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:10px;margin-top:6px;box-shadow:0 6px 18px rgba(0,0,0,.08);z-index:20;max-height:260px;overflow:auto}
    .s-item{padding:10px 12px;display:flex;justify-content:space-between;gap:10px;border-bottom:1px solid var(--line);cursor:pointer}
    .s-item:last-child{border-bottom:none}
    .s-title{font-weight:600}
    .s-meta{font-size:12px;color:var(--muted)}
    .s-create{background:#faf7ff}

    /* Header calendario */
    .head{display:flex;align-items:center;justify-content:space-between;margin:12px 0 6px}
    .head h2{margin:0;font-size:20px}
    .legend{display:flex;gap:12px;align-items:center;margin-top:10px;color:var(--muted);font-size:13px}
    .legend .dot{width:10px;height:10px;border-radius:50%}
    .dot.free{background:#9ee6b7}.dot.busy{background:#ffd8a9}.dot.none{background:#d9d2e9}

    /* Calendario */
    .cal{background:var(--card);border-radius:16px;box-shadow:0 2px 12px rgba(80,60,160,.10);padding:14px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .dow{font-size:12px;color:var(--muted);text-align:center;margin-bottom:6px}
    .day{background:#faf9ff;border:1px solid var(--line);border-radius:12px;min-height:110px;padding:8px;display:flex;flex-direction:column;gap:6px}
    .day .num{font-weight:600}
    .day .badge{margin-top:auto;align-self:flex-start;font-size:12px;border-radius:999px;padding:2px 8px}
    .day.free .badge{background:#e8fff0;color:#045c2b}
    .day.busy .badge{background:#fff4e6;color:#8a5800}
    .day.empty{opacity:.55}
    .day.clickable{cursor:pointer;transition:transform .05s}
    .day.clickable:hover{transform:translateY(-1px)}
    .footer-mini{margin-top:8px;font-size:12px;color:var(--muted)}

    /* Modal Día */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.22);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{width:min(900px,95vw);background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.22);padding:18px}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal h3{margin:0;font-size:18px}
    .close{background:transparent;border:none;font-size:24px;color:var(--brand);cursor:pointer}
    .slots{border:1px solid var(--line);border-radius:10px;padding:10px;max-height:60vh;overflow:auto}
    .slot{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:10px;padding:10px 12px;margin:6px 0;background:#faf9ff}
    .slot.unavailable{opacity:.45}
    .slot .time{font-weight:700;color:var(--accent)}
    .slot button{padding:6px 10px}

    /* Modal Crear Paciente (todos los campos) */
    .modal2{width:min(700px,95vw);background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.22);padding:18px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid2 label{font-size:12px;color:var(--muted)}
    .grid2 input,.grid2 textarea,.grid2 select{background:#f7f9fb;border:1.5px solid var(--line);border-radius:7px;padding:9px 10px;font-size:14px;width:100%}
    .grid2 textarea{min-height:70px}
    .grid2 .span2{grid-column:1/3}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Toolbar -->
  <div class="toolbar">
    <!-- Centro: select para médico/propietario, readonly para asistente -->
    <div class="field" id="centro-field">
      <label>Centro médico</label>
      <select id="turnos-centro-select" class="sel" style="display:none;"></select>
      <input id="turnos-centro-nombre" class="inp" type="text" readonly style="display:none;"/>
    </div>

    <!-- Profesional -->
    <div class="field">
      <label>Profesional</label>
      <select id="turnos-profesional-select" class="sel"></select>
    </div>

    <!-- Paciente (typeahead) -->
    <div class="field" id="turnos-paciente-field">
      <label>Paciente</label>
      <input id="turnos-paciente-input" class="inp" placeholder="Apellido Nombre o DNI" autocomplete="off"/>
      <div id="turnos-paciente-suggest" class="suggest" style="display:none;"></div>
      <div id="turnos-paciente-chip" class="chip" style="display:none;">
        <span id="turnos-paciente-chip-text"></span>
        <button id="turnos-paciente-clear">✕</button>
      </div>
    </div>

    <!-- Tipo turno -->
    <div class="field">
      <label>Tipo de turno</label>
      <select id="turnos-tipo" class="sel">
        <option value="nueva_consulta">Nueva consulta</option>
        <option value="recurrente">Recurrente</option>
        <option value="sobreturno">Sobreturno</option>
      </select>
    </div>

    <!-- Hoy (adentro del cuadro) -->
    <div class="field" style="align-items:flex-end">
      <button id="turnos-btn-hoy" class="btn ghost">Hoy</button>
    </div>
  </div>

  <!-- Header calendario -->
  <div class="head">
    <div style="display:flex;gap:8px;align-items:center">
      <button id="turnos-prev-month" class="btn secondary">◀</button>
      <h2 id="turnos-cal-title">Calendario</h2>
      <button id="turnos-next-month" class="btn secondary">▶</button>
    </div>
    <div class="legend">
      <span class="dot free"></span> con disponibilidad
      <span class="dot busy"></span> sin hueco para este tipo
      <span class="dot none"></span> sin agenda
    </div>
  </div>

  <!-- Calendario -->
  <div class="cal">
    <div class="cal-grid" id="turnos-cal-dow"></div>
    <div class="cal-grid" id="turnos-cal-grid"></div>
  </div>
  <div class="footer-mini" id="turnos-status"></div>
</div>

<!-- Modal Día -->
<div class="modal-backdrop" id="turnos-modal">
  <div class="modal">
    <header>
      <h3 id="turnos-modal-title">Turnos del día</h3>
      <button class="close" id="turnos-modal-close">&times;</button>
    </header>
    <section class="slots">
      <div id="turnos-slots-list"></div>
      <div style="height:1px;background:var(--line);margin:10px 0"></div>
      <h4 style="margin:0 0 8px">Turnos del día</h4>
      <div id="turnos-dia-list"></div>
    </section>
  </div>
</div>

<!-- Modal Crear Paciente (todos los campos de la tabla) -->
<div class="modal-backdrop" id="turnos-modal-paciente" style="display:none;">
  <div class="modal2">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 style="margin:0">Crear nuevo paciente</h3>
      <button class="close" id="turnos-modal-paciente-close">&times;</button>
    </header>

    <div class="grid2">
      <div>
        <label>DNI *</label>
        <input id="np-dni" />
      </div>
      <div>
        <label>Fecha de nacimiento</label>
        <input id="np-fecha-nac" type="date" />
      </div>

      <div>
        <label>Nombre *</label>
        <input id="np-nombre" />
      </div>
      <div>
        <label>Apellido *</label>
        <input id="np-apellido" />
      </div>

      <div>
        <label>Teléfono</label>
        <input id="np-telefono" />
      </div>
      <div>
        <label>Email</label>
        <input id="np-email" type="email" />
      </div>

      <div>
        <label>Obra social</label>
        <input id="np-obra" />
      </div>
      <div>
        <label>N° afiliado</label>
        <input id="np-afiliado" />
      </div>

      <div>
        <label>Contacto - Nombre</label>
        <input id="np-contacto-nombre" />
      </div>
      <div>
        <label>Contacto - Apellido</label>
        <input id="np-contacto-apellido" />
      </div>
      <div>
        <label>Contacto - Celular</label>
        <input id="np-contacto-cel" />
      </div>
      <div>
        <label>Vínculo</label>
        <input id="np-vinculo" />
      </div>

      <div>
        <label>Credencial</label>
        <input id="np-credencial" />
      </div>
      <div>
        <label>Próximo control</label>
        <input id="np-prox-control" type="date" />
      </div>

      <div>
        <label>Renovación de receta</label>
        <input id="np-renovacion" type="date" />
      </div>
      <div class="span2">
        <label>Historia clínica</label>
        <textarea id="np-historia"></textarea>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <button class="btn" id="turnos-guardar-paciente">Guardar paciente</button>
      <span id="turnos-np-msg" class="footer-mini"></span>
    </div>
  </div>
</div>

<script type="module">
import supabase from './supabaseClient.js';
import { isValidHourRange } from './validators.js';

/* ========== UI refs ========== */
const UI = {
  centroSelect: document.getElementById('turnos-centro-select'),
  centroNombre: document.getElementById('turnos-centro-nombre'),
  centroField: document.getElementById('centro-field'),
  profesionalSelect: document.getElementById('turnos-profesional-select'),
  tipoTurno: document.getElementById('turnos-tipo'),
  btnHoy: document.getElementById('turnos-btn-hoy'),
  prevMonth: document.getElementById('turnos-prev-month'),
  nextMonth: document.getElementById('turnos-next-month'),
  calTitle: document.getElementById('turnos-cal-title'),
  calGrid: document.getElementById('turnos-cal-grid'),
  calDow: document.getElementById('turnos-cal-dow'),
  status: document.getElementById('turnos-status'),
  modal: document.getElementById('turnos-modal'),
  modalClose: document.getElementById('turnos-modal-close'),
  modalTitle: document.getElementById('turnos-modal-title'),
  slotsList: document.getElementById('turnos-slots-list'),
  turnosDiaList: document.getElementById('turnos-dia-list'),
  // Typeahead
  pacInput: document.getElementById('turnos-paciente-input'),
  pacSuggest: document.getElementById('turnos-paciente-suggest'),
  pacChip: document.getElementById('turnos-paciente-chip'),
  pacChipText: document.getElementById('turnos-paciente-chip-text'),
  pacClear: document.getElementById('turnos-paciente-clear'),
  // Modal paciente
  modalPac: document.getElementById('turnos-modal-paciente'),
  modalPacClose: document.getElementById('turnos-modal-paciente-close'),
  npDni: document.getElementById('np-dni'),
  npFechaNac: document.getElementById('np-fecha-nac'),
  npNombre: document.getElementById('np-nombre'),
  npApellido: document.getElementById('np-apellido'),
  npTel: document.getElementById('np-telefono'),
  npEmail: document.getElementById('np-email'),
  npObra: document.getElementById('np-obra'),
  npAfiliado: document.getElementById('np-afiliado'),
  npConNom: document.getElementById('np-contacto-nombre'),
  npConApe: document.getElementById('np-contacto-apellido'),
  npConCel: document.getElementById('np-contacto-cel'),
  npVinculo: document.getElementById('np-vinculo'),
  npCredencial: document.getElementById('np-credencial'),
  npHistoria: document.getElementById('np-historia'),
  npProx: document.getElementById('np-prox-control'),
  npRenov: document.getElementById('np-renovacion'),
  npGuardar: document.getElementById('turnos-guardar-paciente'),
  npMsg: document.getElementById('turnos-np-msg'),
};

/* ========== Sesión ========== */
let currentCentroId = localStorage.getItem('centro_medico_id');
let currentCentroNombre = localStorage.getItem('centro_medico_nombre') || '';
const userRole = localStorage.getItem('user_role');                 // 'medico' | 'asistente' | 'propietario'
const loggedProfesionalId = localStorage.getItem('profesional_id');

if (!currentCentroId) { alert('No hay centro seleccionado. Volviendo al login.'); window.location.href='index.html'; }

/* ========== Fecha & helpers ========== */
function todayInfo(){ const d=new Date(); return { y:d.getFullYear(), m:d.getMonth(), d:d.getDate() }; }
function pad(n){ return n<10 ? '0'+n : ''+n; }
function toISODate(y,m,d){ return `${y}-${pad(m+1)}-${pad(d)}`; }
function addMinutes(hhmm, minutes){ const [h,m]=hhmm.split(':').map(Number); const base=new Date(2000,0,1,h,m,0); base.setMinutes(base.getMinutes()+minutes); return `${pad(base.getHours())}:${pad(base.getMinutes())}`; }
function cmpTime(a,b){ if(a===b) return 0; return a<b ? -1 : 1; }
function monthRange(y,m){ const first=new Date(y,m,1); const last=new Date(y,m+1,0); return { start: toISODate(y,m,1), end: toISODate(y,m,last.getDate()) }; }
const DOW = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
function nativeFirstDow(date){ const js=date.getDay(); return (js===0)?6:js-1; }
function groupByFecha(arr){ const map=new Map(); for(const x of arr){ const k=x.fecha; if(!map.has(k)) map.set(k,[]); map.get(k).push(x); } return map; }
function toHM(t){ return (t ?? '').toString().slice(0,5); }
function overlaps(aStart,aEnd,bStart,bEnd){ return (aStart < bEnd) && (bStart < aEnd); }
function isoToday(){ return new Date().toISOString().slice(0,10); }
function renderDOW(){ UI.calDow.innerHTML = DOW.map(d=>`<div class="dow">${d}</div>`).join(''); }

/* ========== Estado ========== */
let view = todayInfo();
let currentProfesional = null;
let duracionCfg = { nueva_consulta:15, recurrente:15, sobreturno:15 };
let modalDateISO = null;
let pacienteSeleccionado = null;

/* ========== Centro (select / readonly) ========== */
async function getCentrosDeProfesional(profesionalId){
  const { data, error } = await supabase
    .from('profesional_centro')
    .select('centro_id, activo, centros_medicos(id, nombre)')
    .eq('profesional_id', profesionalId)
    .eq('activo', true);
  if (error || !data) return [];
  return data.filter(r=>r.centros_medicos).map(r=>({ id:r.centros_medicos.id, nombre:r.centros_medicos.nombre }));
}

async function ensureCentroWidgets(){
  if (userRole === 'asistente'){
    // readonly
    UI.centroNombre.style.display = '';
    UI.centroSelect.style.display = 'none';
    if (!currentCentroNombre){
      const { data } = await supabase.from('centros_medicos').select('nombre').eq('id', currentCentroId).single();
      currentCentroNombre = data?.nombre || '';
    }
    UI.centroNombre.value = currentCentroNombre || '(sin nombre)';
  } else {
    // médico/propietario: select de sus centros
    UI.centroSelect.style.display = '';
    UI.centroNombre.style.display = 'none';
    const centros = await getCentrosDeProfesional(loggedProfesionalId);
    if (!centros.length){
      UI.centroSelect.innerHTML = '<option value="">Sin centros</option>';
      return;
    }
    UI.centroSelect.innerHTML = centros.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join('');
    if (currentCentroId && centros.some(c=>c.id===currentCentroId)) {
      UI.centroSelect.value = currentCentroId;
    } else {
      currentCentroId = centros[0].id;
      UI.centroSelect.value = currentCentroId;
    }
    UI.centroSelect.addEventListener('change', async ()=>{
      currentCentroId = UI.centroSelect.value;
      localStorage.setItem('centro_medico_id', currentCentroId);
      const selName = UI.centroSelect.options[UI.centroSelect.selectedIndex]?.textContent || '';
      localStorage.setItem('centro_medico_nombre', selName);
      await loadDuracionConfig(currentProfesional);
      await loadProfesionales(); // para asistente/propietario se refresca lista
      await renderCalendar();
    });
  }
}

/* ========== Profesionales ========== */
async function loadProfesionales(){
  if (userRole === 'medico' && loggedProfesionalId) {
    const { data } = await supabase.from('profesionales').select('id, nombre, apellido, display_name').eq('id', loggedProfesionalId).single();
    const label = data ? (data.display_name || [data.apellido, data.nombre].filter(Boolean).join(', ') || data.nombre || data.apellido || data.id) : 'Profesional';
    UI.profesionalSelect.innerHTML = `<option value="${loggedProfesionalId}">${label}</option>`;
    UI.profesionalSelect.disabled = true;
    currentProfesional = loggedProfesionalId;
    return;
  }

  // asistente/propietario -> profesionales del centro actual
  UI.profesionalSelect.disabled = false;
  const { data: map } = await supabase
    .from('profesional_centro')
    .select('profesional_id')
    .eq('centro_id', currentCentroId)
    .eq('activo', true);

  const ids = [...new Set((map||[]).map(r=>r.profesional_id).filter(Boolean))];
  if (!ids.length){ UI.profesionalSelect.innerHTML='<option value="">Sin profesionales</option>'; currentProfesional=null; return; }

  const { data: profs } = await supabase
    .from('profesionales')
    .select('id, nombre, apellido, display_name')
    .in('id', ids)
    .order('apellido', { ascending:true });

  UI.profesionalSelect.innerHTML = (profs||[]).map(p=>{
    const nombre = p.display_name || [p.apellido,p.nombre].filter(Boolean).join(', ') || p.nombre || p.apellido || p.id;
    return `<option value="${p.id}">${nombre}</option>`;
  }).join('');
  currentProfesional = (profs&&profs[0]) ? profs[0].id : null;
  if (currentProfesional) UI.profesionalSelect.value = currentProfesional;
}

/* ========== Duración por tipo ========== */
async function loadDuracionConfig(profesionalId){
  duracionCfg = { nueva_consulta:15, recurrente:15, sobreturno:15 };
  if (!profesionalId) return;
  const { data } = await supabase
    .from('config_duracion_turnos')
    .select('tipo_turno, minutos')
    .eq('profesional_id', profesionalId)
    .eq('centro_id', currentCentroId);
  (data||[]).forEach(r=>{ if (r.tipo_turno && r.minutos) duracionCfg[r.tipo_turno] = r.minutos; });
}

/* ========== Pacientes: typeahead + crear ========== */
let suggestTimer = null;
function hideSuggest(){ UI.pacSuggest.style.display='none'; UI.pacSuggest.innerHTML=''; }
function showSuggest(){ UI.pacSuggest.style.display='block'; }

UI.pacInput.addEventListener('input', ()=>{
  clearTimeout(suggestTimer);
  const q = UI.pacInput.value.trim();
  if (!q){ hideSuggest(); return; }
  suggestTimer = setTimeout(()=> fetchSuggestions(q), 180);
});
window.addEventListener('click', (e)=>{ if(!UI.pacSuggest.contains(e.target) && e.target!==UI.pacInput){ hideSuggest(); }});

async function fetchSuggestions(q){
  let result = [];
  if (/^\d{6,}$/.test(q)) {
    const { data } = await supabase
      .from('pacientes')
      .select('id, dni, apellido, nombre, telefono, email')
      .eq('dni', q)
      .limit(10);
    result = data || [];
  } else {
    const parts = q.toLowerCase().split(/\s+/).filter(Boolean);
    let query = supabase.from('pacientes')
      .select('id, dni, apellido, nombre, telefono, email')
      .eq('activo', true)
      .limit(10)
      .order('apellido', { ascending:true });
    if (parts[0]) query = query.ilike('apellido', `%${parts[0]}%`);
    if (parts[1]) query = query.ilike('nombre', `%${parts[1]}%`);
    const { data } = await query;
    result = data || [];
  }

  if (!result.length){
    UI.pacSuggest.innerHTML = `
      <div class="s-item s-create" data-act="create">
        <div>
          <div class="s-title">+ Crear nuevo paciente</div>
          <div class="s-meta">No se encontraron coincidencias para “${q}”.</div>
        </div>
      </div>`;
    showSuggest();
    bindSuggestHandlers(q, []);
    return;
  }

  UI.pacSuggest.innerHTML = result.map(p=>`
    <div class="s-item" data-act="select" data-id="${p.id}">
      <div>
        <div class="s-title">${p.apellido}, ${p.nombre}</div>
        <div class="s-meta">DNI ${p.dni}${p.telefono ? ' · '+p.telefono : ''}${p.email ? ' · '+p.email : ''}</div>
      </div>
    </div>
  `).join('')
  + `
    <div class="s-item s-create" data-act="create">
      <div>
        <div class="s-title">+ Crear nuevo paciente</div>
        <div class="s-meta">Agregar con los datos completos.</div>
      </div>
    </div>`;
  showSuggest();
  bindSuggestHandlers(q, result);
}

function bindSuggestHandlers(q, result){
  UI.pacSuggest.querySelectorAll('.s-item').forEach(el=>{
    el.addEventListener('click', ()=>{
      const act = el.getAttribute('data-act');
      if (act === 'select'){
        const id = el.getAttribute('data-id');
        const p = result.find(x=>x.id===id);
        if (p) selectPaciente(p);
      } else if (act === 'create'){
        openPacienteModalPrefilled(q);
      }
    });
  });
}

function selectPaciente(p){
  pacienteSeleccionado = { id:p.id, nombre:p.nombre, apellido:p.apellido, dni:p.dni };
  UI.pacChipText.textContent = `${p.apellido}, ${p.nombre} · DNI ${p.dni}`;
  UI.pacChip.style.display = 'flex';
  hideSuggest();
}
UI.pacClear.addEventListener('click', ()=>{ pacienteSeleccionado=null; UI.pacChip.style.display='none'; });

function openPacienteModalPrefilled(q){
  UI.npDni.value = /^\d{6,}$/.test(q) ? q : '';
  const parts = q.split(/\s+/).filter(Boolean);
  UI.npApellido.value = parts[0] || '';
  UI.npNombre.value = parts[1] || '';
  UI.npFechaNac.value = '';
  UI.npTel.value = ''; UI.npEmail.value = '';
  UI.npObra.value=''; UI.npAfiliado.value='';
  UI.npConNom.value=''; UI.npConApe.value=''; UI.npConCel.value=''; UI.npVinculo.value='';
  UI.npCredencial.value=''; UI.npHistoria.value=''; UI.npProx.value=''; UI.npRenov.value='';
  UI.npMsg.textContent='';
  UI.modalPac.style.display='flex';
}
UI.modalPacClose.addEventListener('click', ()=> UI.modalPac.style.display='none');
window.addEventListener('click', (e)=>{ if (e.target===UI.modalPac) UI.modalPac.style.display='none'; });

UI.npGuardar.addEventListener('click', async ()=>{
  const dni = UI.npDni.value.trim();
  const nombre = UI.npNombre.value.trim();
  const apellido = UI.npApellido.value.trim();
  if (!dni || !nombre || !apellido){ UI.npMsg.textContent='DNI, Nombre y Apellido son obligatorios.'; return; }
  UI.npMsg.textContent='Guardando...';

  const payload = {
    dni, nombre, apellido,
    fecha_nacimiento: UI.npFechaNac.value || null,
    telefono: UI.npTel.value.trim() || null,
    email: UI.npEmail.value.trim() || null,
    obra_social: UI.npObra.value.trim() || null,
    numero_afiliado: UI.npAfiliado.value.trim() || null,
    contacto_nombre: UI.npConNom.value.trim() || null,
    contacto_apellido: UI.npConApe.value.trim() || null,
    contacto_celular: UI.npConCel.value.trim() || null,
    vinculo: UI.npVinculo.value.trim() || null,
    credencial: UI.npCredencial.value.trim() || null,
    historia_clinica: UI.npHistoria.value.trim() || null,
    proximo_control: UI.npProx.value || null,
    renovacion_receta: UI.npRenov.value || null,
    activo: true
  };

  const { data, error } = await supabase
    .from('pacientes')
    .insert([payload])
    .select('id, dni, nombre, apellido')
    .single();

  if (error){ UI.npMsg.textContent = 'Error: ' + (error.message || 'no se pudo crear'); return; }
  UI.modalPac.style.display='none';
  selectPaciente(data);
  UI.pacInput.value = `${data.apellido} ${data.nombre}`;
  // paciente nuevo => tipo por defecto "Nueva consulta"
  UI.tipoTurno.value = 'nueva_consulta';
});

/* ========== Agenda & Turnos ========== */
async function fetchAgendaYTurnos(profesionalId, y, m){
  const { start, end } = monthRange(y,m);
  const [agendaRes, turnosRes] = await Promise.all([
    supabase.from('agenda')
      .select('id, fecha, hora_inicio, hora_fin')
      .eq('centro_id', currentCentroId).eq('profesional_id', profesionalId)
      .gte('fecha', start).lte('fecha', end)
      .order('fecha', { ascending: true }),
    supabase.from('turnos')
      .select('id, fecha, hora_inicio, hora_fin, estado, paciente_id, agenda_id')
      .eq('centro_id', currentCentroId).eq('profesional_id', profesionalId)
      .gte('fecha', start).lte('fecha', end)
      .order('hora_inicio', { ascending: true })
  ]);
  return { agenda: agendaRes.data || [], turnos: turnosRes.data || [] };
}

function generarSlotsDeDia(agendaDelDia, turnosDelDia, tipo){
  const dur = Number(duracionCfg[tipo] || 15);
  if (!dur || isNaN(dur) || dur<=0) return [];

  const reservas = (turnosDelDia||[])
    .filter(t => (t.estado||'').toLowerCase() !== 'cancelado')
    .map(t => ({ start: toHM(t.hora_inicio), end: toHM(t.hora_fin) || addMinutes(toHM(t.hora_inicio), dur) }));

  const slots = [];
  for (const bloque of (agendaDelDia||[])) {
    const bStart = toHM(bloque.hora_inicio);
    const bEnd   = toHM(bloque.hora_fin);
    let t = bStart;
    while (cmpTime(addMinutes(t,dur), bEnd) <= 0) {
      const start = t;
      const end = addMinutes(t,dur);
      const choca = reservas.some(r => overlaps(start,end,r.start,r.end));
      slots.push({ start, end, agenda_id: bloque.id, disponible: !choca });
      t = end;
    }
  }
  return slots;
}

/* ========== Render calendario ========== */
function renderDOWRow(){ UI.calDow.innerHTML = DOW.map(d=>`<div class="dow">${d}</div>`).join(''); }
async function renderCalendar(){
  if (!currentProfesional){ UI.status.textContent='No hay profesional seleccionado.'; UI.calGrid.innerHTML=''; return; }
  UI.status.textContent = 'Cargando agenda...';

  const { agenda, turnos } = await fetchAgendaYTurnos(currentProfesional, view.y, view.m);
  const byFechaAgenda = groupByFecha(agenda);
  const byFechaTurnos = groupByFecha(turnos);
  const tipo = UI.tipoTurno.value;

  UI.calGrid.innerHTML = '';
  const first = new Date(view.y, view.m, 1);
  const last  = new Date(view.y, view.m+1, 0);
  UI.calTitle.textContent = first.toLocaleString('es-AR', { month: 'long', year: 'numeric' });

  const startOffset = nativeFirstDow(first);
  const totalCells = startOffset + last.getDate();
  const rows = Math.ceil(totalCells / 7);
  let dayNum = 1;

  for (let r=0; r<rows*7; r++){
    const cell = document.createElement('div');
    if (r < startOffset || dayNum>last.getDate()){
      cell.className = 'day empty';
      UI.calGrid.appendChild(cell); continue;
    }

    const iso = toISODate(view.y, view.m, dayNum);
    const agendaDia = byFechaAgenda.get(iso) || [];
    const turnosDia = byFechaTurnos.get(iso) || [];
    const slotsPreview = generarSlotsDeDia(agendaDia, turnosDia, tipo);
    const libres = slotsPreview.filter(s=>s.disponible).length;

    let classNames = ['day'];
    let badgeText = 'sin agenda';
    if (agendaDia.length === 0){ classNames.push('empty'); }
    else if (libres>0){ classNames.push('free','clickable'); badgeText = `${libres} libres`; }
    else { classNames.push('busy','clickable'); badgeText = 'sin huecos'; }

    cell.className = classNames.join(' ');
    cell.innerHTML = `<div class="num">${dayNum}</div><div class="badge">${badgeText}</div>`;
    if (classNames.includes('clickable')){
      cell.addEventListener('click', ()=> openDayModal(iso, agendaDia, turnosDia));
    }
    UI.calGrid.appendChild(cell);
    dayNum++;
  }

  UI.status.textContent = (agenda.length===0)
    ? 'No hay agenda cargada para este mes en el centro seleccionado.'
    : '';
}

/* ========== Modal día ========== */
async function openDayModal(isoDate, agendaDia, turnosDia){
  modalDateISO = isoDate;
  UI.modalTitle.textContent = `Turnos del ${new Date(isoDate).toLocaleDateString('es-AR')}`;
  UI.modal.style.display = 'flex';
  renderSlots(generarSlotsDeDia(agendaDia, turnosDia, UI.tipoTurno.value));
  renderTurnosDelDia(turnosDia);
}
UI.modalClose.addEventListener('click', ()=> UI.modal.style.display='none');
window.addEventListener('click', (e)=>{ if(e.target===UI.modal) UI.modal.style.display='none' });

function renderTurnosDelDia(turnosDia){
  if (!turnosDia?.length){ UI.turnosDiaList.innerHTML = '<div class="footer-mini">No hay turnos en esta fecha.</div>'; return; }
  UI.turnosDiaList.innerHTML = turnosDia.map(t=>`
    <div class="slot">
      <div><b>${toHM(t.hora_inicio)}</b> — ${toHM(t.hora_fin) || ''} <span class="footer-mini">(${t.estado})</span></div>
      <div class="footer-mini">ID ${t.id}</div>
    </div>`).join('');
}

function renderSlots(slots){
  if (!slots.length){ UI.slotsList.innerHTML = '<div class="footer-mini">No hay horarios disponibles para el tipo seleccionado.</div>'; return; }
  UI.slotsList.innerHTML = '';
  for (const s of slots){
    const row = document.createElement('div');
    row.className = 'slot' + (s.disponible ? '' : ' unavailable');
    row.innerHTML = `
      <div>
        <div class="time">${s.start} — ${s.end}</div>
        <div class="footer-mini">${s.agenda_id ? 'Agenda' : 'Libre'}</div>
      </div>
      <div>${s.disponible
        ? `<button class="btn" data-start="${s.start}" data-end="${s.end}" data-agenda="${s.agenda_id||''}">Agendar</button>`
        : `<button class="btn" disabled>Ocupado</button>`}
      </div>`;
    if (s.disponible){ row.querySelector('button').addEventListener('click', () => tryAgendar(s)); }
    UI.slotsList.appendChild(row);
  }
}

async function tryAgendar(slot){
  if (!pacienteSeleccionado){ alert('Seleccioná un paciente arriba antes de agendar.'); return; }
  if (!isValidHourRange(slot.start, slot.end)){ alert('Rango horario inválido.'); return; }

  const { error } = await supabase
    .from('turnos')
    .insert([{
      agenda_id: slot.agenda_id || null,
      centro_id: currentCentroId,
      profesional_id: currentProfesional,
      paciente_id: pacienteSeleccionado.id,
      fecha: modalDateISO,
      hora_inicio: slot.start,
      hora_fin: slot.end,
      estado: 'asignado',
      notas: (UI.tipoTurno.value === 'sobreturno') ? 'Sobreturno' : null
    }]);

  if (error){
    const msg = (error.message||'').toLowerCase().includes('solap')
      ? 'Ese horario se ocupó recién por otro usuario.'
      : (error.message || 'No se pudo agendar.');
    alert(msg);
  } else {
    alert('Turno agendado correctamente.');
  }
  // refrescar modal y mes
  const { agenda, turnos } = await fetchAgendaYTurnos(currentProfesional, view.y, view.m);
  const agendaDia = (agenda||[]).filter(a=>a.fecha===modalDateISO);
  const turnosDia = (turnos||[]).filter(t=>t.fecha===modalDateISO);
  renderSlots(generarSlotsDeDia(agendaDia, turnosDia, UI.tipoTurno.value));
  renderTurnosDelDia(turnosDia);
  await renderCalendar();
}

/* ========== Eventos generales ========== */
UI.profesionalSelect.addEventListener('change', async ()=>{
  currentProfesional = UI.profesionalSelect.value || null;
  await loadDuracionConfig(currentProfesional);
  await renderCalendar();
});
UI.tipoTurno.addEventListener('change', renderCalendar);
UI.prevMonth.addEventListener('click', async ()=>{ if (view.m===0){ view.m=11; view.y--; } else view.m--; await renderCalendar(); });
UI.nextMonth.addEventListener('click', async ()=>{ if (view.m===11){ view.m=0; view.y++; } else view.m++; await renderCalendar(); });
UI.btnHoy.addEventListener('click', async ()=>{ const t=todayInfo(); view={ y:t.y, m:t.m, d:t.d }; await renderCalendar(); });

/* ========== Init ========== */
async function initTurnos(){
  renderDOW();
  await ensureCentroWidgets();
  await loadProfesionales();
  if (!currentProfesional){ UI.status.textContent='No hay profesional seleccionado.'; return; }
  await loadDuracionConfig(currentProfesional);
  await renderCalendar();
}
await initTurnos();
</script>
</body>
</html>
