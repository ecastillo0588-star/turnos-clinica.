<!-- Vista TURNOS (partial) - se inyecta dentro de #main-content -->
<div id="turnos-view" data-view="turnos">
  <style>
    /* ... Tu CSS original ... */
    /* Puedes dejar esto igual que antes, o moverlo a un archivo .css */
  </style>

  <!-- Toolbar, calendario y modales aquí, igual que tu versión original -->

  <div class="tw-head">
    <!-- ... -->
  </div>
  <div class="tw-cal">
    <!-- ... -->
  </div>
  <div class="tw-status" id="turnos-status"></div>

  <!-- Modal día -->
  <div class="tw-backdrop" id="turnos-modal">
    <div class="tw-modal">
      <div class="tw-modal-header">
        <h3 id="turnos-modal-title" class="tw-modal-title">Turnos del día</h3>
        <div class="tw-day-nav">
          <button class="tw-icon-btn" id="turnos-modal-prev-day" data-tip="Día anterior">◀</button>
          <input type="date" id="turnos-modal-date" class="tw-inp tw-date">
          <button class="tw-icon-btn" id="turnos-modal-next-day" data-tip="Día siguiente">▶</button>
        </div>
        <button class="tw-close" id="turnos-modal-close">×</button>
      </div>
      <section class="tw-slots">
        <h4>Horarios</h4>
        <div id="turnos-slots-list"></div>
      </section>
    </div>
  </div>

  <!-- ... Otros modales y estructura igual que tu versión ... -->

  <script type="module">
  import supabase from './supabaseClient.js';

  /* === Helpers === */
  function todayInfo() {
    const d = new Date();
    return { y: d.getFullYear(), m: d.getMonth(), d: d.getDate() };
  }
  function pad(n) { return n < 10 ? '0' + n : '' + n; }
  function toISODate(y, m, d) { return `${y}-${pad(m + 1)}-${pad(d)}`; }
  function dateToISO(d){return d.toISOString().slice(0,10);}
  function toHM(t){return (t||'').substring(0,5);}
  function addMinutes(hhmm,mm){
    const[h,m]=hhmm.split(':').map(Number);
    const base=new Date(2000,0,1,h,m);
    base.setMinutes(base.getMinutes()+mm);
    return `${pad(base.getHours())}:${pad(base.getMinutes())}`;
  }
  function overlaps(aS,aE,bS,bE){return(aS<bE)&&(bS<aE);}

  /* === UI refs === */
  const UI = {
    slotsList: document.getElementById('turnos-slots-list'),
    modalTitle: document.getElementById('turnos-modal-title'),
    modalDateInput: document.getElementById('turnos-modal-date'),
    modalPrevDay: document.getElementById('turnos-modal-prev-day'),
    modalNextDay: document.getElementById('turnos-modal-next-day'),
    modalClose: document.getElementById('turnos-modal-close'),
    // ... agrega los demás según tu estructura ...
  };

  /* === State === */
  let currentCentroId = localStorage.getItem('centro_medico_id');
  let currentProfesional = null;
  let modalDateISO = null;
  let pacienteSeleccionado = null;
  let reprogramState = null;
  let duracionCfg = { nueva_consulta:15, recurrente:15, sobreturno:15 };

  /* === Consulta de turnos con datos de paciente === */
  async function fetchTurnosDelDia(fechaISO, profesionalId, centroId) {
    const { data: turnos } = await supabase
      .from('turnos')
      .select(`
        id, fecha, hora_inicio, hora_fin, estado, paciente_id,
        paciente:paciente_id (
          nombre,
          apellido,
          dni
        ),
        agenda_id
      `)
      .eq('fecha', fechaISO)
      .eq('profesional_id', profesionalId)
      .eq('centro_id', centroId)
      .order('hora_inicio', { ascending: true });
    return turnos || [];
  }

  /* === Armado de slots === */
  function generarSlots(agendaDia, turnosDia, tipo, excludeId) {
    const dur = Number(duracionCfg[tipo] || 15);
    if (!dur || dur <= 0) return [];
    const out = [];
    const vivos = (turnosDia || []).filter(t => (t.estado || '').toLowerCase() !== 'cancelado' && t.id !== excludeId);
    for (const bloque of (agendaDia || [])) {
      const bStart = toHM(bloque.hora_inicio), bEnd = toHM(bloque.hora_fin);
      let t = bStart;
      while (addMinutes(t, dur) <= bEnd) {
        const start = t, end = addMinutes(t, dur);
        const oc = vivos.find(tr => {
          const s = toHM(tr.hora_inicio), e = toHM(tr.hora_fin);
          return overlaps(start, end, s, e);
        });
        out.push({start, end, agenda_id: bloque.id, disponible: !oc, turno: oc || null});
        t = end;
      }
    }
    return out;
  }

  /* === Render de slots === */
  function renderSlots(slots) {
    const ahora = new Date();
    const hoyISO = dateToISO(ahora);
    const ahoraHM = pad(ahora.getHours()) + ':' + pad(ahora.getMinutes());

    const filtroSlots = slots.filter(s => {
      if (!modalDateISO) return true;
      if (modalDateISO > hoyISO) return true;
      if (modalDateISO < hoyISO) return false;
      return s.start > ahoraHM;
    });

    if (!filtroSlots.length) {
      UI.slotsList.innerHTML = '<div style="color:#888;padding:20px;text-align:center;font-size:19px;">No hay horarios disponibles.</div>';
      return;
    }

    UI.slotsList.innerHTML = '';
    if (reprogramState) {
      const banner = document.createElement('div');
      banner.style = `
        background:#f2eefe;
        padding:16px 28px;
        margin-bottom:16px;
        border-radius:14px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        font-size:18px;
      `;
      banner.innerHTML = `<div>
        Reprogramando turno ${toHM(reprogramState.turno.hora_inicio)}–${toHM(reprogramState.turno.hora_fin)}.
        Seleccioná nuevo horario (${reprogramState.durMin} min).
      </div>
      <button style="background:none;border:none;color:#7b5da7;cursor:pointer;padding:7px 20px;border-radius:9px;font-size:16px;" id="tw-cancel-rep">Cancelar</button>`;
      UI.slotsList.appendChild(banner);
      banner.querySelector('#tw-cancel-rep').addEventListener('click', () => {
        reprogramState = null;
        refreshDayModal();
      });
    }

    filtroSlots.forEach(slot => {
      const slotElem = document.createElement('div');
      slotElem.style = `
        display:flex;
        align-items:center;
        justify-content:space-between;
        border-bottom:1px solid #e8e2f2;
        padding:20px 30px;
        background:${slot.turno ? "#eae6f7" : "#fff"};
        opacity:${slot.turno ? 0.85 : 1};
        min-height:66px;
        font-size:21px;
        transition:background 0.2s, opacity 0.2s;
      `;
      const horario = document.createElement('span');
      horario.textContent = `${toHM(slot.start)} - ${toHM(slot.end)}`;
      horario.style = `
        font-weight:600;
        font-size:1.13em;
        min-width:140px;
        margin-right:28px;
        letter-spacing:0.5px;
      `;

      const nombrePaciente = document.createElement('span');
      nombrePaciente.style = `
        color:#432e6b;
        font-size:1.12em;
        font-weight:500;
        margin-right:auto;
        margin-left:22px;
        min-width:250px;
        white-space:nowrap;
        text-overflow:ellipsis;
        overflow:hidden;
      `;
      if (slot.turno && slot.turno.paciente) {
        const pac = slot.turno.paciente;
        nombrePaciente.textContent = `${pac.nombre || ''} ${pac.apellido || ''} ${pac.dni ? '• DNI ' + pac.dni : ''}`.trim();
      } else if (slot.turno) {
        nombrePaciente.textContent = 'Ocupado';
      } else {
        nombrePaciente.textContent = '';
      }

      const btns = document.createElement('div');
      btns.style = 'display:flex;gap:15px;';

      if (slot.turno && slot.turno.paciente_id === pacienteSeleccionado?.id) {
        // Eliminar
        const btnBorrar = document.createElement('button');
        btnBorrar.textContent = '🗑️';
        btnBorrar.title = 'Eliminar turno';
        btnBorrar.style = `
          background:#7b5da7;
          color:#fff;
          border:none;
          border-radius:11px;
          padding:10px 22px;
          cursor:pointer;
          font-size:1.18em;
          font-weight:600;
          transition:background 0.2s;
        `;
        btnBorrar.onmouseover = () => btnBorrar.style.background = "#6b4b98";
        btnBorrar.onmouseout  = () => btnBorrar.style.background = "#7b5da7";
        btnBorrar.onclick = () => cancelarTurno(slot.turno);
        btns.appendChild(btnBorrar);

        // Reprogramar
        const btnReprog = document.createElement('button');
        btnReprog.textContent = '↻';
        btnReprog.title = 'Reprogramar';
        btnReprog.style = btnBorrar.style;
        btnReprog.onmouseover = () => btnReprog.style.background = "#6b4b98";
        btnReprog.onmouseout  = () => btnReprog.style.background = "#7b5da7";
        btnReprog.onclick = () => {
          reprogramState = { turno: slot.turno, durMin: slot.turno.duracion_minutos || 30 };
          refreshDayModal();
        };
        btns.appendChild(btnReprog);

        // Editar (si existe la función)
        if (typeof editarTurno === "function") {
          const btnEdit = document.createElement('button');
          btnEdit.textContent = '✏️';
          btnEdit.title = 'Editar turno';
          btnEdit.style = btnBorrar.style;
          btnEdit.onmouseover = () => btnEdit.style.background = "#6b4b98";
          btnEdit.onmouseout  = () => btnEdit.style.background = "#7b5da7";
          btnEdit.onclick = () => editarTurno(slot.turno);
          btns.appendChild(btnEdit);
        }
      } else if (!slot.turno) {
        // Reservar
        const btnReservar = document.createElement('button');
        btnReservar.textContent = '+';
        btnReservar.title = 'Reservar turno';
        btnReservar.style = `
          background:#7b5da7;
          color:#fff;
          border:none;
          border-radius:11px;
          padding:10px 22px;
          cursor:pointer;
          font-size:1.18em;
          font-weight:600;
          transition:background 0.2s;
        `;
        btnReservar.onmouseover = () => btnReservar.style.background = "#6b4b98";
        btnReservar.onmouseout  = () => btnReservar.style.background = "#7b5da7";
        btnReservar.onclick = () => tryAgendar(slot);
        btns.appendChild(btnReservar);
      }

      slotElem.appendChild(horario);
      slotElem.appendChild(nombrePaciente);
      slotElem.appendChild(btns);

      UI.slotsList.appendChild(slotElem);
    });
  }

  /* === Modal Día: consulta y render === */
  async function refreshDayModal() {
    if (!modalDateISO) return;
    // Consultar agenda (igual que antes)
    const { data: agendaDia } = await supabase
      .from('agenda')
      .select('id,fecha,hora_inicio,hora_fin')
      .eq('centro_id', currentCentroId)
      .eq('profesional_id', currentProfesional)
      .eq('fecha', modalDateISO)
      .order('hora_inicio', { ascending: true });

    // Consultar turnos con datos de paciente
    const turnosDiaRaw = await fetchTurnosDelDia(modalDateISO, currentProfesional, currentCentroId);

    // Armar slots y renderizar
    const slots = generarSlots(agendaDia || [], turnosDiaRaw || [], "nueva_consulta", reprogramState?.turno.id || null);
    renderSlots(slots);
  }

  /* === Eventos para navegación de modal día === */
  UI.modalPrevDay.addEventListener('click', async () => {
    if (!modalDateISO) return;
    const d = new Date(modalDateISO + 'T00:00:00');
    d.setDate(d.getDate() - 1);
    modalDateISO = dateToISO(d);
    await refreshDayModal();
  });
  UI.modalNextDay.addEventListener('click', async () => {
    if (!modalDateISO) return;
    const d = new Date(modalDateISO + 'T00:00:00');
    d.setDate(d.getDate() + 1);
    modalDateISO = dateToISO(d);
    await refreshDayModal();
  });
  UI.modalDateInput.addEventListener('change', async () => {
    if (UI.modalDateInput.value) {
      modalDateISO = UI.modalDateInput.value;
      await refreshDayModal();
    }
  });
  UI.modalClose.addEventListener('click', () => {
    document.getElementById('turnos-modal').style.display = 'none';
  });

  // ... Agrega el resto de handlers y lógica, según tu app ...

  </script>
</div>
