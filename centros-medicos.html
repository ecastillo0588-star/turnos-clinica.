<!-- Botón crear centro -->
<button type="button" id="crear-centro-btn" class="btn primary">Crear centro médico</button>

<!-- Modal crear centro -->
<div id="modal-centro" class="modal">
  <div class="modal-content">
    <span class="close" id="cerrar-modal-centro">&times;</span>
    <h4 id="modal-title">Crear centro médico</h4>
    <form id="form-centro">
      <input type="text" id="centro_nombre" placeholder="Nombre del centro" required>
      <input type="text" id="centro_direccion" placeholder="Dirección">
      <input type="text" id="centro_telefono" placeholder="Teléfono (ej: 5493511234567)" required>
      <input type="email" id="centro_email" placeholder="Email">
      <textarea id="centro_notas" placeholder="Notas"></textarea>
      <button type="submit" class="btn primary" style="margin-top:10px;">Guardar</button>
      <div id="modal-centro-status" class="muted" style="margin-top:10px;"></div>
    </form>
  </div>
</div>

<script type="module">
import supabase from './supabaseClient.js';

const profesionalId = localStorage.getItem('profesional_id');
const modalCentro = document.getElementById('modal-centro');
const cerrarModalCentro = document.getElementById('cerrar-modal-centro');
const formCentro = document.getElementById('form-centro');
const modalCentroStatus = document.getElementById('modal-centro-status');

function openModalCentro() {
  formCentro.reset();
  modalCentroStatus.textContent = '';
  modalCentro.style.display = 'flex';
}
function closeModalCentro() {
  modalCentro.style.display = 'none';
}

document.getElementById('crear-centro-btn').addEventListener('click', openModalCentro);
cerrarModalCentro.addEventListener('click', closeModalCentro);
window.addEventListener('click', e => { if (e.target === modalCentro) closeModalCentro(); });

// --- VALIDAR TELÉFONO ---
function validarTelefono(telefono) {
  const regex = /^54\d{8,12}$/; // empieza con 54 y 10-14 dígitos
  return regex.test(telefono);
}

// --- CREAR / ASOCIAR CENTRO ---
formCentro.addEventListener('submit', async e => {
  e.preventDefault();

  const nombre = document.getElementById('centro_nombre').value.trim();
  const direccion = document.getElementById('centro_direccion').value.trim();
  const telefono = document.getElementById('centro_telefono').value.trim();
  const email = document.getElementById('centro_email').value.trim();
  const notas = document.getElementById('centro_notas').value.trim();

  if (!validarTelefono(telefono)) {
    modalCentroStatus.textContent = 'El teléfono debe empezar con 54 y tener entre 10 y 14 dígitos.';
    return;
  }

  modalCentroStatus.textContent = 'Verificando centro...';

  // Chequear si ya existe ese teléfono
  const { data: existe, error: errExiste } = await supabase
    .from('centros_medicos')
    .select('*')
    .eq('telefono', telefono)
    .maybeSingle();

  if (errExiste) {
    modalCentroStatus.textContent = 'Error al verificar teléfono.';
    return;
  }

  if (existe) {
    // Ya existe: preguntar si lo quiere asociar
    const confirmar = confirm(`Ya existe un centro con este teléfono (${telefono}): ${existe.nombre}. ¿Querés asociarlo a tu perfil?`);
    if (confirmar) {
      const { error: errorPC } = await supabase
        .from('profesional_centro')
        .upsert({
          profesional_id: profesionalId,
          centro_id: existe.id,
          medico_registrador_id: profesionalId,
          activo: true
        });
      if (errorPC) {
        modalCentroStatus.textContent = 'Error al asociar el centro existente.';
        return;
      }
      modalCentroStatus.textContent = 'Centro existente asociado exitosamente!';
      await cargarCentros();
      setTimeout(closeModalCentro, 1000);
    } else {
      modalCentroStatus.textContent = 'Operación cancelada.';
    }
  } else {
    // No existe: crear nuevo centro
    const { data: nuevo, error: errorCentro } = await supabase
      .from('centros_medicos')
      .insert([{ nombre, direccion, telefono, email, notas, activo: true }])
      .select();
    if (errorCentro || !nuevo || !nuevo[0]) {
      modalCentroStatus.textContent = 'Error al crear centro médico.';
      return;
    }

    const { error: errorPC } = await supabase
      .from('profesional_centro')
      .insert({
        profesional_id: profesionalId,
        centro_id: nuevo[0].id,
        medico_registrador_id: profesionalId,
        activo: true
      });
    if (errorPC) {
      modalCentroStatus.textContent = 'Error al asociar nuevo centro.';
      return;
    }

    modalCentroStatus.textContent = 'Centro creado y asociado!';
    await cargarCentros();
    setTimeout(closeModalCentro, 1000);
  }
});
</script>
