<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Configuración de Duración de Turnos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f9fb; margin: 0; }
    .duracion-turnos-card { background: #fff; padding: 24px 20px; border-radius: 18px; box-shadow: 0 2px 8px rgba(80,60,160,.13); max-width: 860px; margin: 30px auto;}
    .duracion-turnos-card h3 { color:#381e60; margin-bottom:22px;}
    label { color:#381e60;}
    .btn { background: #7656b0; color: #fff; border: none; border-radius: 6px; padding: 6px 16px; cursor:pointer; margin: 3px;}
    .btn.primary { background: #7656b0; }
    .btn:hover { background: #7f62b6; }
    .muted { color: #6b6480; font-size: 13px; }
    select, input, textarea { border: 1px solid #e3d8f6; border-radius: 6px; padding: 6px 10px; font-size:15px; background:#f7f9fb;}
    form label { font-size:15px; margin-bottom:6px; display:block; }
    .fila-tipos { display:grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
    .tipo-card { border: 1px solid #ece5fc; background:#fff; border-radius: 10px; padding: 12px; }
    .tipo-line { display:flex; align-items:center; gap:10px; }
    .tipo-line .unit { color:#6b6480; font-size: 13px; }
    .row-footer { display:flex; align-items:center; gap:16px; margin-top:18px; flex-wrap: wrap; }
    .top-row { display:flex; gap:12px; align-items: center; flex-wrap: wrap; }
    .top-row select { min-width: 260px; }
    /* Modal */
    .modal { position:fixed; z-index:999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); display:flex; align-items:center; justify-content:center;}
    .modal-content { background:#fff; padding:28px 22px 20px 22px; border-radius:14px; min-width:300px; max-width:380px; position:relative; box-shadow:0 2px 18px rgba(80,60,160,.18);}
    .close { position:absolute; right:12px; top:10px; font-size:20px; color:#7656b0; cursor:pointer;}
    .modal-content h4 { color:#381e60; margin-bottom:16px;}
    .modal-content input, .modal-content textarea { width:100%; margin-bottom:10px; }
  </style>
</head>
<body>
<div class="duracion-turnos-card">
  <h3>Duración de Turnos</h3>

  <!-- Selector de centro + crear centro -->
  <div style="margin-bottom:22px;">
    <label for="centro_id"><b>Centro Médico</b></label>
    <div class="top-row">
      <select id="centro_id" name="centro_id" required>
        <option disabled selected value="">Cargando centros...</option>
      </select>
      <button type="button" id="crear-centro-btn" class="btn">Crear centro médico</button>
      <span id="centros-status" class="muted"></span>
    </div>
  </div>

  <!-- Formulario de duraciones -->
  <form id="duracion-form" style="margin-bottom:16px; display:none;">
    <div class="fila-tipos">
      <div class="tipo-card">
        <label><b>Nueva consulta</b></label>
        <div class="tipo-line">
          <select name="duracion_nueva" required>
            <option value="5">5</option><option value="10">10</option><option value="15">15</option>
            <option value="20">20</option><option value="30">30</option>
            <option value="45">45</option><option value="60">60</option>
          </select>
          <span class="unit">minutos</span>
        </div>
      </div>
      <div class="tipo-card">
        <label><b>Consulta recurrente</b></label>
        <div class="tipo-line">
          <select name="duracion_recurrente" required>
            <option value="5">5</option><option value="10">10</option><option value="15">15</option>
            <option value="20">20</option><option value="30">30</option>
            <option value="45">45</option><option value="60">60</option>
          </select>
          <span class="unit">minutos</span>
        </div>
      </div>
      <div class="tipo-card">
        <label><b>Sobreturno</b></label>
        <div class="tipo-line">
          <select name="duracion_sobreturno" required>
            <option value="5">5</option><option value="10">10</option><option value="15">15</option>
            <option value="20">20</option><option value="30">30</option>
            <option value="45">45</option><option value="60">60</option>
          </select>
          <span class="unit">minutos</span>
        </div>
      </div>
    </div>

    <div class="row-footer">
      <button type="submit" class="btn primary">Guardar duraciones</button>
      <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
        <input type="checkbox" id="aplicar-todos" style="accent-color:#7656b0;">
        <span>Aplicar a todos mis centros</span>
      </label>
    </div>
  </form>

  <div id="duracion-status" class="muted" style="margin-bottom:6px;"></div>
</div>

<!-- Modal para crear centro médico -->
<div id="modal-centro" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" id="cerrar-modal-centro">&times;</span>
    <h4>Crear nuevo centro médico</h4>
    <form id="form-crear-centro">
      <input type="text" id="nuevo_centro_nombre" placeholder="Nombre del centro" required>
      <input type="text" id="nuevo_centro_direccion" placeholder="Dirección">
      <input type="text" id="nuevo_centro_telefono" placeholder="Teléfono">
      <input type="email" id="nuevo_centro_email" placeholder="Email">
      <textarea id="nuevo_centro_notas" placeholder="Notas"></textarea>
      <button type="submit" class="btn primary" style="margin-top:10px;">Guardar centro</button>
      <div id="modal-centro-status" class="muted" style="margin-top:10px;"></div>
    </form>
  </div>
</div>

<script type="module">
/**
 * Usa helpers:
 * - supabaseClient.js  -> export default supabase
 * - centrosService.js  -> opcional (aquí sólo necesitamos los centros del profesional)
 * Mantengo la lógica específica de config_duracion_turnos acá.
 */
import supabase from './supabaseClient.js';

const profesionalId = localStorage.getItem('profesional_id');
const centroSelect = document.getElementById('centro_id');
const centrosStatusDiv = document.getElementById('centros-status');
const duracionForm = document.getElementById('duracion-form');
const statusDiv = document.getElementById('duracion-status');
const aplicarTodosCheckbox = document.getElementById('aplicar-todos');
const crearCentroBtn = document.getElementById('crear-centro-btn');
const modalCentro = document.getElementById('modal-centro');
const cerrarModalCentro = document.getElementById('cerrar-modal-centro');
const formCrearCentro = document.getElementById('form-crear-centro');
const modalCentroStatus = document.getElementById('modal-centro-status');

let centrosMedicos = [];

/* ----------------- Carga de centros del profesional ----------------- */
async function getCentrosDeProfesional(profesional_id) {
  // Sólo los centros asociados ACTIVOS al profesional
  const { data, error } = await supabase
    .from('profesional_centro')
    .select('centro_id, activo, centros_medicos(id, nombre)')
    .eq('profesional_id', profesional_id)
    .eq('activo', true);

  if (error || !data) return { data: [], error };
  const result = data
    .filter(r => r.centros_medicos)
    .map(r => ({ id: r.centros_medicos.id, nombre: r.centros_medicos.nombre }));
  return { data: result, error: null };
}

async function cargarCentros() {
  centroSelect.innerHTML = '<option disabled selected value="">Cargando centros...</option>';
  centrosMedicos = [];

  const { data, error } = await getCentrosDeProfesional(profesionalId);
  if (error) {
    centroSelect.innerHTML = '<option disabled>Error al cargar centros</option>';
    centrosStatusDiv.textContent = 'Error al cargar centros médicos';
    duracionForm.style.display = 'none';
    return;
  }

  centrosMedicos = data || [];
  centroSelect.innerHTML = '';
  if (centrosMedicos.length === 0) {
    centroSelect.innerHTML = '<option disabled selected value="">No tienes centros asociados</option>';
    centrosStatusDiv.textContent = 'No hay centros médicos agregados.';
    duracionForm.style.display = 'none';
    return;
  }

  centrosMedicos.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.nombre;
    centroSelect.appendChild(opt);
  });

  centrosStatusDiv.textContent = '';
  const preferido = localStorage.getItem('centro_medico_id');
  centroSelect.value = (preferido && centrosMedicos.some(c => c.id === preferido))
    ? preferido
    : centrosMedicos[0].id;

  await cargarConfiguracionDuracion(centroSelect.value);
  duracionForm.style.display = '';
}

/* ----------------- Modal Crear Centro + asociar ----------------- */
crearCentroBtn.addEventListener('click', () => {
  modalCentro.style.display = 'flex';
  modalCentroStatus.textContent = '';
  formCrearCentro.reset();
});
cerrarModalCentro.addEventListener('click', () => {
  modalCentro.style.display = 'none';
});
window.addEventListener('click', (e) => {
  if (e.target === modalCentro) modalCentro.style.display = 'none';
});

formCrearCentro.addEventListener('submit', async function(e) {
  e.preventDefault();
  const nombre = document.getElementById('nuevo_centro_nombre').value.trim();
  const direccion = document.getElementById('nuevo_centro_direccion').value.trim();
  const telefono = document.getElementById('nuevo_centro_telefono').value.trim();
  const email = document.getElementById('nuevo_centro_email').value.trim();
  const notas = document.getElementById('nuevo_centro_notas').value.trim();

  if (!nombre) {
    modalCentroStatus.textContent = 'El nombre es obligatorio.';
    return;
  }
  modalCentroStatus.textContent = 'Guardando centro...';

  // Crear centro
  const { data: centro, error: errorCentro } = await supabase
    .from('centros_medicos')
    .insert([{ nombre, direccion, telefono, email, notas, activo: true }])
    .select();
  if (errorCentro || !centro || !centro[0]) {
    modalCentroStatus.textContent = 'Error al crear centro médico';
    return;
  }
  // Asociar centro al profesional
  const { error: errorPC } = await supabase
    .from('profesional_centro')
    .insert({ profesional_id: profesionalId, centro_id: centro[0].id, activo: true });
  if (errorPC) {
    modalCentroStatus.textContent = 'Error al asociar centro médico';
    return;
  }
  modalCentroStatus.textContent = 'Centro creado y asociado exitosamente!';
  await cargarCentros();
  centroSelect.value = centro[0].id;
  await cargarConfiguracionDuracion(centro[0].id);
  setTimeout(() => { modalCentro.style.display = 'none'; }, 1200);
});

/* ----------------- Carga y guardado de configuración ----------------- */
centroSelect.addEventListener('change', async function() {
  await cargarConfiguracionDuracion(this.value);
});

async function cargarConfiguracionDuracion(centro_id) {
  const { data, error } = await supabase
    .from('config_duracion_turnos')
    .select('tipo_turno, minutos')
    .eq('profesional_id', profesionalId)
    .eq('centro_id', centro_id);

  if (error) {
    statusDiv.textContent = 'Error al cargar configuración';
    duracionForm.style.display = '';
    return;
  }
  if (!data || data.length === 0) {
    statusDiv.textContent = 'No hay configuración previa para este centro médico. Completa y guarda para configurar.';
    duracionForm.reset();
    duracionForm.style.display = '';
    return;
  }

  const cfg = Object.fromEntries(data.map(r => [r.tipo_turno, r.minutos]));
  duracionForm.duracion_nueva.value       = String(cfg['nueva_consulta'] ?? '15');
  duracionForm.duracion_recurrente.value  = String(cfg['recurrente'] ?? '15');
  duracionForm.duracion_sobreturno.value  = String(cfg['sobreturno'] ?? '15');
  statusDiv.textContent = 'Configuración cargada.';
  duracionForm.style.display = '';
}

duracionForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  const centro_id = centroSelect.value;
  if (!centro_id) {
    statusDiv.textContent = 'Selecciona un centro médico';
    return;
  }

  const nueva        = parseInt(this.duracion_nueva.value, 10);
  const recurrente   = parseInt(this.duracion_recurrente.value, 10);
  const sobreturno   = parseInt(this.duracion_sobreturno.value, 10);

  const base = (cId) => ([
    { profesional_id: profesionalId, centro_id: cId, tipo_turno: 'nueva_consulta', minutos: nueva },
    { profesional_id: profesionalId, centro_id: cId, tipo_turno: 'recurrente',      minutos: recurrente },
    { profesional_id: profesionalId, centro_id: cId, tipo_turno: 'sobreturno',      minutos: sobreturno }
  ]);

  if (aplicarTodosCheckbox.checked) {
    // Aplica a TODOS los centros del profesional
    const payload = centrosMedicos.flatMap(c => base(c.id));
    const { error } = await supabase
      .from('config_duracion_turnos')
      .upsert(payload, { onConflict: ['profesional_id','centro_id','tipo_turno'] });
    if (error) {
      statusDiv.textContent = 'Error al aplicar a todos los centros: ' + error.message;
      return;
    }
    statusDiv.textContent = 'Configuración aplicada a todos los centros médicos';
    await cargarConfiguracionDuracion(centro_id);
  } else {
    const payload = base(centro_id);
    const { error } = await supabase
      .from('config_duracion_turnos')
      .upsert(payload, { onConflict: ['profesional_id','centro_id','tipo_turno'] });
    if (error) {
      statusDiv.textContent = 'Error al guardar la configuración: ' + error.message;
      return;
    }
    statusDiv.textContent = 'Duración guardada exitosamente';
    await cargarConfiguracionDuracion(centro_id);
  }
});

/* ----------------- Init ----------------- */
if (profesionalId) {
  await cargarCentros();
} else {
  statusDiv.textContent = 'No se detectó profesional en sesión.';
}
</script>
</body>
</html>
