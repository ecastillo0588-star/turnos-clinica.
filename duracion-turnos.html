<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Duración de Turnos</title>
  <style>
    .duracion-card {
      background: #fff;
      padding: 22px;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(80,60,160,0.08);
      max-width: 700px;
      margin: 0 auto;
    }
    .duracion-card h2 {
      margin-top: 0;
      margin-bottom: 18px;
      color: #381e60;
    }
    .tipos-turno {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 18px;
    }
    .tipo-turno {
      flex: 1 1 200px;
      background: #f7f4fa;
      border: 1px solid #ece3fa;
      border-radius: 8px;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .tipo-turno label {
      font-weight: 500;
      color: #381e60;
      font-size: 15px;
    }
    .tipo-turno input {
      width: 70px;
      padding: 5px;
      font-size: 14px;
      text-align: center;
      border: 1px solid #d2c6ed;
      border-radius: 6px;
    }
    .btn {
      background: #7656b0;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
    }
    .btn:hover { background: #7f62b6; }
    #msg-duracion {
      margin-left: 14px;
      font-size: 14px;
      color: #381e60;
    }
  </style>
</head>
<body>

<div class="duracion-card">
  <h2>Duración de Turnos</h2>

  <div class="tipos-turno">
    <div class="tipo-turno">
      <label for="duracion-nueva">Nueva consulta</label>
      <input type="number" id="duracion-nueva" min="5" step="5"> 
    </div>
    <div class="tipo-turno">
      <label for="duracion-recurrente">Recurrente</label>
      <input type="number" id="duracion-recurrente" min="5" step="5"> 
    </div>
    <div class="tipo-turno">
      <label for="duracion-sobreturno">Sobreturno</label>
      <input type="number" id="duracion-sobreturno" min="5" step="5"> 
    </div>
  </div>

  <button class="btn" id="guardar-duracion">Guardar configuración</button>
  <span id="msg-duracion"></span>
</div>

<script type="module">
import supabase from './supabaseClient.js';

const profesional_id   = localStorage.getItem('profesional_id');
const centro_default_id = localStorage.getItem('centro_medico_id');
if (!profesional_id || !centro_default_id) {
  alert('Sesión no iniciada o datos incompletos. Redirigiendo a login.');
  window.location.href = "index.html";
}

// Cargar duraciones guardadas
async function cargarDuraciones() {
  const { data, error } = await supabase
    .from('duracion_turnos')
    .select('tipo_turno, minutos')
    .eq('profesional_id', profesional_id)
    .eq('centro_id', centro_default_id);

  if (error) {
    console.error("Error cargando duraciones:", error);
    return;
  }
  (data || []).forEach(d => {
    if (d.tipo_turno === 'nueva_consulta') document.getElementById('duracion-nueva').value = d.minutos;
    if (d.tipo_turno === 'recurrente') document.getElementById('duracion-recurrente').value = d.minutos;
    if (d.tipo_turno === 'sobreturno') document.getElementById('duracion-sobreturno').value = d.minutos;
  });
}

// Guardar cambios
document.getElementById('guardar-duracion').onclick = async function() {
  const msg = document.getElementById('msg-duracion');
  msg.textContent = "";

  const registros = [
    { tipo_turno: 'nueva_consulta', minutos: parseInt(document.getElementById('duracion-nueva').value) || null },
    { tipo_turno: 'recurrente', minutos: parseInt(document.getElementById('duracion-recurrente').value) || null },
    { tipo_turno: 'sobreturno', minutos: parseInt(document.getElementById('duracion-sobreturno').value) || null }
  ].filter(r => r.minutos);

  if (registros.length === 0) {
    msg.textContent = "Ingrese al menos una duración válida.";
    return;
  }

  // upsert para cada tipo
  const { error } = await supabase
    .from('duracion_turnos')
    .upsert(
      registros.map(r => ({
        ...r,
        profesional_id,
        centro_id: centro_default_id
      })),
      { onConflict: ['profesional_id', 'centro_id', 'tipo_turno'] }
    );

  if (error) {
    console.error("Error guardando duraciones:", error);
    msg.textContent = "Error al guardar.";
  } else {
    msg.textContent = "Duraciones guardadas correctamente.";
  }
};

// Cargar al iniciar
cargarDuraciones();
</script>
</body>
</html>
