<div class="duracion-turnos-card" style="max-width: 600px; margin: 30px auto;">
  <h3>Duración de Turnos</h3>
  
  <!-- Centro Médico selector y creación -->
  <div style="margin-bottom:18px;">
    <label for="centro_id"><b>Centro Médico</b></label>
    <div style="display:flex; gap:12px;">
      <select id="centro_id" name="centro_id" required style="max-width:220px;">
        <option disabled selected value="">Cargando centros...</option>
      </select>
      <input type="text" id="nuevo_centro_nombre" placeholder="Nuevo centro..." style="max-width:160px;">
      <button type="button" id="agregar_centro" class="btn">Agregar</button>
    </div>
  </div>
  <div id="centros-status" class="muted" style="margin-bottom:10px;"></div>
  
  <!-- Formulario de duración de turnos -->
  <form id="duracion-form" style="margin-bottom:20px; display:none;">
    <div style="margin-bottom:13px;">
      <label><b>Duración turno nueva consulta</b></label><br>
      <select name="duracion_nueva" required style="max-width:95px;">
        <option value="5">5 min</option><option value="10">10 min</option><option value="15">15 min</option>
        <option value="20">20 min</option><option value="30">30 min</option>
        <option value="45">45 min</option><option value="60">60 min</option>
      </select>
    </div>
    <div style="margin-bottom:13px;">
      <label><b>Duración turno consulta recurrente</b></label><br>
      <select name="duracion_recurrente" required style="max-width:95px;">
        <option value="5">5 min</option><option value="10">10 min</option><option value="15">15 min</option>
        <option value="20">20 min</option><option value="30">30 min</option>
        <option value="45">45 min</option><option value="60">60 min</option>
      </select>
    </div>
    <div style="margin-bottom:13px;">
      <label><b>Duración de sobre turnos</b></label><br>
      <select name="duracion_sobreturno" required style="max-width:95px;">
        <option value="5">5 min</option><option value="10">10 min</option><option value="15">15 min</option>
        <option value="20">20 min</option><option value="30">30 min</option>
        <option value="45">45 min</option><option value="60">60 min</option>
      </select>
    </div>
    <div style="display:flex; gap:12px;">
      <button type="submit" class="btn primary">Guardar duraciones</button>
      <button type="button" id="aplicar-todos" class="btn" style="">Aplicar a todos los centros</button>
    </div>
  </form>
  <div id="duracion-status" class="muted" style="margin-bottom:20px;"></div>
</div>

<script type="module">
// Supabase config
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
const supabaseUrl = 'https://vwkszvdvswznlgxlfdtz.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3a3N6dmR2c3d6bmxneGxmZHR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NDM4NDQsImV4cCI6MjA3MTExOTg0NH0.TnDGheCSTUqGwTCMiHZ_CUgcAztCqVTc1cINkMud8p0';
const supabase = createClient(supabaseUrl, supabaseAnonKey);

// UI Elements
const centroSelect = document.getElementById('centro_id');
const nuevoCentroInput = document.getElementById('nuevo_centro_nombre');
const agregarCentroBtn = document.getElementById('agregar_centro');
const centrosStatusDiv = document.getElementById('centros-status');
const duracionForm = document.getElementById('duracion-form');
const statusDiv = document.getElementById('duracion-status');
const aplicarTodosBtn = document.getElementById('aplicar-todos');

// Estado global de centros
let centrosMedicos = [];
let configActual = {};
let profesional_id = null;

// Obtener UUID del profesional autenticado
async function obtenerProfesionalId() {
  try {
    const { data: user } = await supabase.auth.getUser();
    profesional_id = user?.user?.id || null;
  } catch (e) {
    profesional_id = null;
  }
}

// Cargar centros médicos asociados al profesional y actualizar el desplegable
async function cargarCentros() {
  centroSelect.innerHTML = '<option disabled selected value="">Cargando centros...</option>';
  centrosMedicos = [];
  let { data, error } = await supabase
    .from('centros_medicos')
    .select('id, nombre')
    .eq('profesional_id', profesional_id);

  if (error) {
    centroSelect.innerHTML = '<option disabled>Error al cargar centros</option>';
    centrosStatusDiv.textContent = 'Error al cargar centros médicos';
    duracionForm.style.display = 'none';
    return;
  }
  centrosMedicos = data || [];
  centroSelect.innerHTML = '';
  if (centrosMedicos.length === 0) {
    centroSelect.innerHTML = '<option disabled selected value="">No tienes centros asociados</option>';
    centrosStatusDiv.textContent = 'No hay centros médicos agregados.';
    duracionForm.style.display = 'none';
    return;
  }
  centrosMedicos.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.nombre;
    centroSelect.appendChild(opt);
  });
  centrosStatusDiv.textContent = '';
  centroSelect.value = centrosMedicos[0].id;
  await cargarConfiguracionDuracion(centroSelect.value);
  duracionForm.style.display = '';
}

// Crear nuevo centro médico
agregarCentroBtn.addEventListener('click', async function() {
  const nombre = nuevoCentroInput.value.trim();
  if (!nombre) return;
  agregarCentroBtn.disabled = true;
  centrosStatusDiv.textContent = 'Agregando centro...';
  const { error, data } = await supabase
    .from('centros_medicos')
    .insert({ nombre, profesional_id })
    .select();
  if (error) {
    centrosStatusDiv.textContent = 'Error al agregar centro';
    agregarCentroBtn.disabled = false;
    return;
  }
  centrosStatusDiv.textContent = 'Centro agregado';
  nuevoCentroInput.value = '';
  await cargarCentros();
  // Selecciona el centro recién creado
  if (data && data[0]) {
    centroSelect.value = data[0].id;
    await cargarConfiguracionDuracion(data[0].id);
  }
  agregarCentroBtn.disabled = false;
});

// Al cambiar centro médico, carga la configuración asociada
centroSelect.addEventListener('change', async function() {
  await cargarConfiguracionDuracion(this.value);
});

// Cargar configuración de duración para centro médico
async function cargarConfiguracionDuracion(centro_id) {
  configActual = {};
  let { data, error } = await supabase
    .from('config_duracion_turnos')
    .select('tipo_turno, minutos')
    .eq('profesional_id', profesional_id)
    .eq('centro_id', centro_id);

  if (error || !data) {
    statusDiv.textContent = 'Error al cargar configuración';
    duracionForm.style.display = '';
    return;
  }
  if (data.length === 0) {
    statusDiv.textContent = 'No hay configuración previa para este centro médico. Completa y guarda para configurar.';
    duracionForm.style.display = '';
    duracionForm.reset();
    return;
  }
  // Cargar los valores existentes en el form
  data.forEach(cfg => {
    configActual[cfg.tipo_turno] = cfg.minutos;
  });
  duracionForm.duracion_nueva.value = configActual['nueva_consulta'] || '15';
  duracionForm.duracion_recurrente.value = configActual['recurrente'] || '15';
  duracionForm.duracion_sobreturno.value = configActual['sobreturno'] || '15';
  statusDiv.textContent = 'Configuración cargada.';
  duracionForm.style.display = '';
}

// Guardar configuración para centro seleccionado
duracionForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  const centro_id = centroSelect.value;
  if (!centro_id) {
    statusDiv.textContent = 'Selecciona un centro médico';
    return;
  }
  const duraciones = [
    { profesional_id, centro_id, tipo_turno: 'nueva_consulta', minutos: parseInt(this.duracion_nueva.value) },
    { profesional_id, centro_id, tipo_turno: 'recurrente', minutos: parseInt(this.duracion_recurrente.value) },
    { profesional_id, centro_id, tipo_turno: 'sobreturno', minutos: parseInt(this.duracion_sobreturno.value) }
  ];
  const { error } = await supabase
    .from('config_duracion_turnos')
    .upsert(duraciones, { onConflict: ['profesional_id', 'centro_id', 'tipo_turno'] });
  if (error) {
    statusDiv.textContent = 'Error al guardar la configuración';
  } else {
    statusDiv.textContent = 'Duración guardada exitosamente';
    await cargarConfiguracionDuracion(centro_id);
  }
});

// Aplicar configuración a todos los centros médicos asociados
aplicarTodosBtn.addEventListener('click', async function() {
  if (centrosMedicos.length === 0) return;
  aplicarTodosBtn.disabled = true;
  const duracionesAll = [];
  centrosMedicos.forEach(c=> {
    duracionesAll.push(
      { profesional_id, centro_id: c.id, tipo_turno: 'nueva_consulta', minutos: parseInt(duracionForm.duracion_nueva.value) },
      { profesional_id, centro_id: c.id, tipo_turno: 'recurrente', minutos: parseInt(duracionForm.duracion_recurrente.value) },
      { profesional_id, centro_id: c.id, tipo_turno: 'sobreturno', minutos: parseInt(duracionForm.duracion_sobreturno.value) }
    );
  });
  const { error } = await supabase
    .from('config_duracion_turnos')
    .upsert(duracionesAll, { onConflict: ['profesional_id', 'centro_id', 'tipo_turno'] });
  if (error) {
    statusDiv.textContent = 'Error al aplicar a todos los centros';
  } else {
    statusDiv.textContent = 'Configuración aplicada a todos los centros médicos';
    await cargarConfiguracionDuracion(centroSelect.value);
  }
  aplicarTodosBtn.disabled = false;
});

// Inicialización
await obtenerProfesionalId();
if (profesional_id) {
  await cargarCentros();
} else {
  statusDiv.textContent = 'No se detectó usuario autenticado.';
}

</script>

<style>
.duracion-turnos-card { background: #fff; padding: 22px 16px; border-radius: 15px; box-shadow: 0 2px 8px rgba(80,60,160,.11); }
.duracion-turnos-card h3 { color:#381e60; margin-bottom:17px;}
label { color:#381e60;}
.btn { background: #7656b0; color: #fff; border: none; border-radius: 6px; padding: 6px 16px; cursor:pointer; margin: 3px;}
.btn.primary { background: #7656b0; }
.btn:hover { background: #7f62b6; }
.muted { color: #6b6480; font-size: 13px; }
input, select { border: 1px solid #e3d8f6; border-radius: 6px; padding: 5px 8px; font-size:15px; }
form label { font-size:15px; margin-bottom:3px; display:block; }
</style>
