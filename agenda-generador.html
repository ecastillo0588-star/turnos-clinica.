<!-- Generador de Agenda de Disponibilidad de Turnos (Slots sin tipo) -->
<div class="card agenda-generador">
  <h2>Generar Agenda de Disponibilidad</h2>
  <!-- Nombre de la agenda -->
  <section class="bloque-nombre-agenda">
    <label for="nombre-agenda"><b>Nombre de la agenda <span class="obligatorio">*</span></b></label><br>
    <input type="text" id="nombre-agenda" placeholder="Ejemplo: Agenda Septiembre 2025" style="max-width:300px;" required>
  </section>

  <!-- Bloque de Fechas y Centro -->
  <section class="bloque-fechas" style="margin-top:14px;">
    <div style="display:flex;flex-wrap:wrap;gap:14px;align-items:center;">
      <div>
        <label for="fecha-inicio"><b>Fecha inicio <span class="obligatorio">*</span></b></label><br>
        <input type="date" id="fecha-inicio" required>
      </div>
      <div>
        <label for="fecha-fin"><b>Fecha fin <span class="obligatorio">*</span></b></label><br>
        <input type="date" id="fecha-fin" required>
      </div>
      <div>
        <label for="centro-agenda"><b>Centro médico <span class="obligatorio">*</span></b></label><br>
        <select id="centro-agenda" required>
          <option value="">Seleccione un centro...</option>
        </select>
        <button type="button" class="btn" id="btn-nuevo-centro" style="margin-top:6px;">Agregar nuevo centro</button>
      </div>
    </div>
    <!-- Formulario para crear centro médico completo -->
    <div id="nuevo-centro-form" class="hidden centro-form-block">
      <h4>Nuevo Centro Médico</h4>
      <div>
        <label>Nombre <span class="obligatorio">*</span></label>
        <input type="text" id="nuevo-centro-nombre" required>
      </div>
      <div>
        <label>Dirección</label>
        <input type="text" id="nuevo-centro-direccion">
      </div>
      <div>
        <label>Teléfono</label>
        <input type="text" id="nuevo-centro-telefono">
      </div>
      <div>
        <label>Email</label>
        <input type="email" id="nuevo-centro-email">
      </div>
      <div>
        <label>Notas</label>
        <input type="text" id="nuevo-centro-notas">
      </div>
      <button type="button" class="btn" id="guardar-nuevo-centro">Guardar</button>
      <button type="button" class="btn" id="cancelar-nuevo-centro">Cancelar</button>
    </div>
  </section>

  <!-- Duración de los slots básicos -->
  <section class="bloque-duracion-turno" style="margin-top:12px;display:flex;gap:32px;">
    <div>
      <label for="duracion-slot"><b>Duración de cada slot (minutos) <span class="obligatorio">*</span></b></label><br>
      <select id="duracion-slot" required>
        <option value="">Seleccione...</option>
        <option value="5">5 min</option><option value="10">10 min</option><option value="15">15 min</option>
        <option value="20">20 min</option><option value="30">30 min</option><option value="45">45 min</option><option value="60">60 min</option>
      </select>
    </div>
  </section>

  <!-- Tabla compacta de horarios por día -->
  <section class="bloque-horario-dias" style="margin-top:18px;">
    <h3 style="margin-bottom:9px;">Horarios por Día</h3>
    <table class="horarios-table-compact">
      <thead>
        <tr>
          <th style="width:60px;">Día</th>
          <th colspan="2">Mañana</th>
          <th colspan="2">Tarde</th>
          <th style="width:55px;">Habilitar</th>
        </tr>
        <tr>
          <td></td>
          <td style="font-size:11px;">Inicio</td>
          <td style="font-size:11px;">Fin</td>
          <td style="font-size:11px;">Inicio</td>
          <td style="font-size:11px;">Fin</td>
          <td></td>
        </tr>
      </thead>
      <tbody id="horarios-body">
        <!-- Se llena por JS -->
      </tbody>
    </table>
  </section>
</div>

<!-- Botón SIEMPRE visible y sticky, con tooltip -->
<div class="agenda-footer-sticky">
  <button class="btn primary" id="btn-generar-agenda" disabled
    title="Debe completar los campos obligatorios*">Generar agenda</button>
  <span id="msg-agenda" style="margin-left:18px;"></span>
</div>

<script type="module">
// Supabase config
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
const supabaseUrl = 'https://vwkszvdvswznlgxlfdtz.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3a3N6dmR2c3d6bmxneGxmZHR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NDM4NDQsImV4cCI6MjA3MTExOTg0NH0.TnDGheCSTUqGwTCMiHZ_CUgcAztCqVTc1cINkMud8p0';
const supabase = createClient(supabaseUrl, supabaseAnonKey);

// Validación de sesión
const profesional_id = localStorage.getItem('profesional_id');
const centro_default_id = localStorage.getItem('centro_medico_id');
if (!profesional_id || !centro_default_id) {
  alert('Sesión no iniciada o datos incompletos. Redirigiendo a login.');
  window.location.href = "index.html";
}

const DIAS = [
  {nombre:'lunes', label:'LUN'}, {nombre:'martes', label:'MAR'}, {nombre:'miercoles', label:'MIÉR'},
  {nombre:'jueves', label:'JUEV'}, {nombre:'viernes', label:'VIER'}, {nombre:'sabado', label:'SÁB'}
];

// --- Cargar centros médicos activos ---
async function cargarCentros() {
  const selector = document.getElementById('centro-agenda');
  selector.innerHTML = '<option value="">Seleccione un centro...</option>';
  try {
    const { data: centros, error } = await supabase
      .from('centros_medicos')
      .select('id, nombre')
      .eq('activo', true)
      .order('nombre', { ascending: true });
    if (error || !Array.isArray(centros)) throw error;
    centros.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.nombre;
      selector.appendChild(opt);
    });
    if (centro_default_id && selector.querySelector(`option[value="${centro_default_id}"]`)) {
      selector.value = centro_default_id;
    }
  } catch (e) {
    const opt = document.createElement('option');
    opt.value = "";
    opt.textContent = "Error al cargar";
    opt.className = "error-option";
    selector.appendChild(opt);
  }
}
cargarCentros();

document.getElementById('btn-nuevo-centro').onclick = function() {
  document.getElementById('nuevo-centro-form').classList.remove('hidden');
};
document.getElementById('cancelar-nuevo-centro').onclick = function() {
  document.getElementById('nuevo-centro-form').classList.add('hidden');
};

// Guardar nuevo centro médico
document.getElementById('guardar-nuevo-centro').onclick = async function() {
  const nombre = document.getElementById('nuevo-centro-nombre').value.trim();
  const direccion = document.getElementById('nuevo-centro-direccion').value.trim();
  const telefono = document.getElementById('nuevo-centro-telefono').value.trim();
  const email = document.getElementById('nuevo-centro-email').value.trim();
  const notas = document.getElementById('nuevo-centro-notas').value.trim();
  if (!nombre) return alert("El nombre es obligatorio");

  const { data, error } = await supabase
    .from('centros_medicos')
    .insert([{ nombre, direccion, telefono, email, notas, activo: true }])
    .select('id, nombre')
    .single();

  if (!error && data) {
    await cargarCentros();
    document.getElementById('centro-agenda').value = data.id;
    document.getElementById('nuevo-centro-form').classList.add('hidden');
    document.getElementById('nuevo-centro-nombre').value = '';
    document.getElementById('nuevo-centro-direccion').value = '';
    document.getElementById('nuevo-centro-telefono').value = '';
    document.getElementById('nuevo-centro-email').value = '';
    document.getElementById('nuevo-centro-notas').value = '';
    validarCamposAgenda();
  } else {
    alert('Error al crear centro médico');
  }
};

// --- Renderizar horarios por día ---
function renderTablaHorarios() {
  const tbody = document.getElementById('horarios-body');
  tbody.innerHTML = '';
  DIAS.forEach((dia, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-size:13px;"><b>${dia.label}</b></td>
      <td><input type="time" name="tm_ini_${idx}" class="input-hora"></td>
      <td><input type="time" name="tm_fin_${idx}" class="input-hora"></td>
      <td><input type="time" name="tt_ini_${idx}" class="input-hora"></td>
      <td><input type="time" name="tt_fin_${idx}" class="input-hora"></td>
      <td><input type="checkbox" name="hab_${idx}" checked></td>
    `;
    tbody.appendChild(tr);
  });
}
renderTablaHorarios();

// --- Validaciones en tiempo real ---
const campos_requeridos = [
  'nombre-agenda', 'fecha-inicio', 'fecha-fin',
  'centro-agenda', 'duracion-slot'
];
campos_requeridos.forEach(id => {
  document.getElementById(id).addEventListener('input', validarCamposAgenda);
});
function validarCamposAgenda() {
  let valido = true;
  campos_requeridos.forEach(id => {
    const el = document.getElementById(id);
    if (!el.value || el.value === "") valido = false;
  });
  const btn = document.getElementById('btn-generar-agenda');
  btn.disabled = !valido;
  btn.title = valido ? "" : "Debe completar los campos obligatorios*";
}

// --- Generar agenda ---
document.getElementById('btn-generar-agenda').onclick = async function() {
  const msg = document.getElementById('msg-agenda');
  msg.textContent = '';
  const nombre_agenda = document.getElementById('nombre-agenda').value.trim();
  const fecha_inicio = document.getElementById('fecha-inicio').value;
  const fecha_fin = document.getElementById('fecha-fin').value;
  const centro_id = document.getElementById('centro-agenda').value;
  const duracion_slot = Number(document.getElementById('duracion-slot').value);

  // Recopilar horarios por día
  const bloques = [];
  DIAS.forEach((dia, idx)=>{
    const habilitado = document.querySelector(`[name="hab_${idx}"]`).checked;
    if(!habilitado) return;
    // Mañana
    const tm_ini = document.querySelector(`[name="tm_ini_${idx}"]`).value;
    const tm_fin = document.querySelector(`[name="tm_fin_${idx}"]`).value;
    if(tm_ini && tm_fin && tm_ini < tm_fin){
      bloques.push({
        dia:dia.nombre,
        hora_inicio:tm_ini,
        hora_fin:tm_fin,
      });
    }
    // Tarde
    const tt_ini = document.querySelector(`[name="tt_ini_${idx}"]`).value;
    const tt_fin = document.querySelector(`[name="tt_fin_${idx}"]`).value;
    if(tt_ini && tt_fin && tt_ini < tt_fin){
      bloques.push({
        dia:dia.nombre,
        hora_inicio:tt_ini,
        hora_fin:tt_fin,
      });
    }
  });
  if(bloques.length===0){
    msg.textContent = "Configure al menos un horario válido para algún día.";
    return;
  }

  // Generar slots de agenda: SOLO UNO por bloque, tipo_turno se asigna en la reserva
  msg.textContent = "Generando agenda...";
  let totalSlots = 0;
  let fechaActual = new Date(fecha_inicio);
  const fechaFin = new Date(fecha_fin);
  while(fechaActual <= fechaFin){
    const diaSemanaNum = fechaActual.getDay(); // 0=domingo, 1=lunes, ..., 6=sábado
    const diaMap = {1:'lunes',2:'martes',3:'miercoles',4:'jueves',5:'viernes',6:'sabado'}; // lunes=1
    const diaSemana = diaMap[diaSemanaNum];
    if(!diaSemana) { fechaActual.setDate(fechaActual.getDate()+1); continue; }
    const bloquesDia = bloques.filter(b=>b.dia===diaSemana);
    for(const b of bloquesDia){
      let hIni = toMinutes(b.hora_inicio);
      let hFin = toMinutes(b.hora_fin);
      for(let m=hIni; m+duracion_slot<=hFin; m+=duracion_slot){
        const hora_inicio = toHoraStr(m);
        const hora_fin = toHoraStr(m+duracion_slot);
        await supabase
          .from('agenda')
          .upsert({
            centro_id,
            profesional_id,
            fecha: fechaActual.toISOString().slice(0,10),
            hora_inicio,
            hora_fin,
            capacidad: 1,
            estado: 'disponible',
            notas: '',
            "Nombre de Agenda": nombre_agenda,
            tipo_turno: '', // Pendiente, se asigna en la reserva
          }, { onConflict: ['centro_id','profesional_id','fecha','hora_inicio','hora_fin'] });
        totalSlots++;
      }
    }
    fechaActual.setDate(fechaActual.getDate()+1);
  }
  msg.textContent = `Agenda generada (${totalSlots} slots disponibles).`;
};

// --- Helpers ---
function toMinutes(horaStr){
  const [h,m] = horaStr.split(':'); return parseInt(h)*60+parseInt(m);
}
function toHoraStr(minutos){
  const h = Math.floor(minutos/60), m = minutos%60;
  return (h<10?'0':'')+h+':'+(m<10?'0':'')+m;
}
</script>

<style>
.agenda-generador { max-width: 740px; margin: 24px auto; }
.horarios-table-compact { border-collapse:collapse;width:100%;background:#f7f4fa;font-size:13px; }
.horarios-table-compact th, .horarios-table-compact td { border:1px solid #e3d8f6;padding:5px;text-align:center; }
.horarios-table-compact th { background:#ece3fa;font-weight:600;font-size:13px; }
.input-hora { width:70px; padding:2px 4px; font-size:13px; border-radius:5px; border:1px solid #d2c6ed; }
.horarios-table-compact td input[type="checkbox"] { transform:scale(1.1); }
.btn.primary { background: #7656b0; }
.btn { background: #7656b0; color: #fff; border: none; border-radius: 6px; padding: 5px 12px; cursor:pointer; margin: 2px;}
.btn:disabled { background: #d2c6ed; color:#fff; cursor:not-allowed;}
.btn:hover:not(:disabled) { background: #7f62b6; }
.card { background: #fff; padding: 22px; border-radius: 16px; box-shadow: 0 2px 8px rgba(80,60,160,.09); }
.bloque-fechas label, .bloque-duracion-turno label { font-size:13px; }
.bloque-nombre-agenda label { font-size:15px; margin-bottom:2px; color:#381e60; }
.obligatorio { color: #c2001d; font-weight:700; font-size:1em; }
.hidden { display:none; }
.agenda-footer-sticky {
  position: sticky;
  bottom: 0;
  left: 0;
  background: #f7f4fa;
  width: 100%;
  padding: 14px 0 10px 0;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  z-index: 99;
  border-top: 1px solid #ece3fa;
}
.centro-form-block {
  background: #f3eafc;
  border-radius: 8px;
  box-shadow: 0 1px 6px rgba(120,80,180,.07);
  padding: 14px 16px 12px 16px;
  margin-top: 8px;
  margin-bottom: 8px;
  max-width:320px;
}
.centro-form-block h4 {margin-top:0;margin-bottom:8px;color:#7656b0;font-size:16px;}
.centro-form-block label {display:block;font-size:13px;margin-bottom:2px;margin-top:8px;}
.centro-form-block input {width:95%;margin-bottom:4px;}
</style>
