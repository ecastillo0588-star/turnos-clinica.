<!-- Pacientes Panel -->
<style>
  /* === Pacientes Panel Styles (scoped) === */
  #pacientes-panel { font-family: system-ui, Arial, sans-serif; }

  .panel-header {
    display:flex;
    flex-wrap:wrap;
    gap:14px;
    align-items:flex-end;
    margin-bottom:18px;
  }
  .panel-header h2 {
    flex: 1 1 100%;
    margin:0 0 6px 0;
    font-size:22px;
    color:#381e60;
    letter-spacing:.5px;
  }
  .filters-row {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .filters-row .field {
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .filters-row label {
    font-size:13px;
    color:#5b4a80;
    font-weight:500;
  }
  .filters-row input {
    background:#f7f9fb;
    border:1.5px solid #ece5fc;
    padding:6px 9px;
    border-radius:7px;
    min-width:170px;
    font-size:14px;
    outline:none;
    color:#381e60;
    transition:border .15s, background .2s;
  }
  .filters-row input:focus {
    border-color:#a490d7;
    background:#fff;
  }
  .actions-row {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .btn {
    background:#7656b0;
    color:#fff;
    border:none;
    border-radius:7px;
    padding:9px 16px;
    font-size:14px;
    cursor:pointer;
    font-weight:500;
    letter-spacing:.3px;
    display:inline-flex;
    align-items:center;
    gap:6px;
    transition:background .18s, transform .05s;
  }
  .btn:hover { background:#7f62b6; }
  .btn:active { transform:translateY(1px); }
  .btn.secondary {
    background:#f0ecfa;
    color:#5a418d;
  }
  .btn.secondary:hover { background:#e6def6; }
  .btn.danger {
    background:#b00020;
  }
  .btn.danger:hover { background:#8e0c2f; }

  .table-wrapper {
    border:1px solid #ece5fc;
    border-radius:12px;
    overflow:hidden;
    background:#fff;
    box-shadow:0 2px 8px rgba(80,60,160,.08);
  }
  table.pacientes {
    width:100%;
    border-collapse:collapse;
    font-size:14px;
  }
  table.pacientes thead {
    background:#f0ecfa;
  }
  table.pacientes th, table.pacientes td {
    padding:10px 12px;
    text-align:left;
    border-bottom:1px solid #eee9fa;
  }
  table.pacientes th {
    font-weight:600;
    font-size:13px;
    color:#5a418d;
    letter-spacing:.5px;
  }
  table.pacientes tbody tr {
    cursor:pointer;
    transition:background .12s;
  }
  table.pacientes tbody tr:hover {
    background:#faf7ff;
  }
  table.pacientes tbody tr.selected {
    background:#efe7ff;
  }
  .empty-row td {
    text-align:center;
    padding:45px 10px;
    font-size:15px;
    color:#8269b5;
  }
  .status-dot {
    width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px;
    background:#4caf50;
  }
  .status-inactive { background:#d32f2f; }

  .pagination {
    display:flex;
    justify-content:space-between;
    padding:12px 6px 4px 6px;
    align-items:center;
    flex-wrap:wrap;
    gap:10px;
  }
  .pagination-info {
    font-size:12.5px;
    color:#6b6480;
  }
  .pagination-controls {
    display:flex;
    gap:6px;
  }
  .btn.small {
    padding:6px 12px;
    font-size:13px;
    border-radius:6px;
  }
  .loading-bar {
    height:4px;
    width:100%;
    background:linear-gradient(90deg,#a490d733,#a490d7);
    background-size:200% 100%;
    animation:loadingDash 1.1s linear infinite;
  }
  @keyframes loadingDash {
    0% { background-position:0 0; }
    100% { background-position:-200% 0; }
  }

  /* Modal */
  .modal-backdrop {
    position:fixed;
    inset:0;
    background:rgba(40,20,70,.32);
    backdrop-filter:blur(2px);
    display:flex;
    align-items:flex-start;
    justify-content:center;
    overflow:auto;
    z-index:6000;
    padding:40px 18px;
  }
  .modal {
    background:#fff;
    width:100%;
    max-width:860px;
    border-radius:18px;
    box-shadow:0 5px 26px -4px rgba(50,20,100,.26);
    animation:fadeInScale .35s cubic-bezier(.4,.1,.2,1);
    display:flex;
    flex-direction:column;
    position:relative;
  }
  @keyframes fadeInScale {
    0% { transform:translateY(14px) scale(.96); opacity:0; }
    100% { transform:translateY(0) scale(1); opacity:1; }
  }
  .modal-header {
    padding:20px 26px 14px 26px;
    border-bottom:1px solid #f0ecfa;
  }
  .modal-header h3 {
    margin:0;
    font-size:20px;
    color:#381e60;
  }
  .modal-close {
    position:absolute;
    top:12px;
    right:12px;
    background:none;
    border:none;
    font-size:20px;
    line-height:1;
    cursor:pointer;
    color:#6b6480;
    padding:6px 10px;
    border-radius:50%;
    transition:background .15s;
  }
  .modal-close:hover { background:#f0ecfa; }
  .modal-body {
    padding:20px 26px 10px 26px;
    max-height:68vh;
    overflow:auto;
  }
  .form-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:14px 20px;
  }
  .form-group {
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .form-group label {
    font-size:12.5px;
    letter-spacing:.4px;
    font-weight:600;
    color:#5a418d;
  }
  .form-group input,
  .form-group select,
  .form-group textarea {
    background:#f7f9fb;
    border:1.5px solid #e9e2f9;
    border-radius:8px;
    padding:8px 10px;
    font-size:14px;
    outline:none;
    resize:vertical;
    font-family:inherit;
    min-height:41px;
    color:#381e60;
  }
  .form-group textarea { min-height:80px; }
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    border-color:#a490d7;
    background:#fff;
  }
  .fieldset {
    border:1px solid #eee5fb;
    padding:14px 16px 10px 16px;
    border-radius:14px;
    margin-bottom:18px;
    background:#fcfbfe;
  }
  .fieldset legend {
    font-size:12.5px;
    font-weight:600;
    padding:0 8px;
    color:#6b6480;
    letter-spacing:.5px;
  }
  .modal-footer {
    padding:16px 26px 24px 26px;
    display:flex;
    justify-content:flex-end;
    gap:10px;
    border-top:1px solid #f0ecfa;
  }
  .error-box, .success-box {
    border-radius:10px;
    padding:10px 14px;
    font-size:13.5px;
    line-height:1.4;
    margin:0 0 14px 0;
    display:flex;
    gap:10px;
    align-items:flex-start;
  }
  .error-box {
    background:#ffebee;
    color:#8e0c2f;
    border:1px solid #ffcdd2;
  }
  .success-box {
    background:#e8f5e9;
    color:#256029;
    border:1px solid #c8e6c9;
  }
  .badge-date {
    background:#efe8ff;
    color:#5a418d;
    padding:3px 8px;
    border-radius:20px;
    font-size:11.5px;
    font-weight:500;
    letter-spacing:.3px;
    display:inline-block;
  }
  .badge-warn {
    background:#fff4e0;
    color:#9c5700;
  }
  .badge-overdue {
    background:#ffe3e3;
    color:#b00020;
  }
  .inline-flex { display:inline-flex; align-items:center; gap:6px; }
  .nowrap { white-space:nowrap; }

  @media (max-width:780px) {
    .modal { max-width:100%; }
    .modal-body { max-height:none; }
  }
</style>

<div id="pacientes-panel">
  <div class="panel-header">
    <h2>Pacientes</h2>

    <div class="filters-row">
      <div class="field">
        <label for="filtro-dni">Buscar por DNI</label>
        <input id="filtro-dni" type="text" placeholder="Ej: 30111222">
      </div>
      <div class="field">
        <label for="filtro-apellido">Buscar por Apellido</label>
        <input id="filtro-apellido" type="text" placeholder="Ej: García">
      </div>
      <div class="actions-row" style="align-items:flex-end;">
        <button id="btn-limpiar" class="btn secondary" type="button">Limpiar</button>
        <button id="btn-nuevo" class="btn" type="button">
          <span style="font-size:16px; line-height:0;">➕</span> Nuevo Paciente
        </button>
      </div>
    </div>
  </div>

  <div id="loading-bar" class="loading-bar" style="display:none;"></div>

  <div class="table-wrapper">
    <table class="pacientes" id="tabla-pacientes">
      <thead>
        <tr>
          <th>Activo</th>
          <th>DNI</th>
            <th>Apellido</th>
          <th>Nombre</th>
          <th>Edad</th>
          <th>Obra Social</th>
          <th>Próx. Control</th>
          <th>Renovación Receta</th>
        </tr>
      </thead>
      <tbody id="tbody-pacientes">
        <tr class="empty-row">
          <td colspan="8">Sin datos</td>
        </tr>
      </tbody>
    </table>
    <div class="pagination" id="paginacion" style="display:none;">
      <div class="pagination-info" id="pagination-info"></div>
      <div class="pagination-controls">
        <button id="btn-prev" class="btn small secondary">&larr; Anterior</button>
        <button id="btn-next" class="btn small secondary">Siguiente &rarr;</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal placeholder -->
<div id="modal-root"></div>

<script type="module">
  import supabase from './supabaseClient.js';

  // ====== State ======
  const PAGE_SIZE = 20;
  let currentPage = 1;
  let totalRows = 0;
  let currentFilters = { dni: '', apellido: '' };
  let loading = false;

  const dniInput = document.getElementById('filtro-dni');
  const apellidoInput = document.getElementById('filtro-apellido');
  const btnLimpiar = document.getElementById('btn-limpiar');
  const btnNuevo = document.getElementById('btn-nuevo');
  const tbody = document.getElementById('tbody-pacientes');
  const loadingBar = document.getElementById('loading-bar');
  const paginacion = document.getElementById('paginacion');
  const paginationInfo = document.getElementById('pagination-info');
  const btnPrev = document.getElementById('btn-prev');
  const btnNext = document.getElementById('btn-next');
  const modalRoot = document.getElementById('modal-root');

  // ===== Utilities =====
  const debounce = (fn, ms=380) => {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); };
  };

  function setLoading(state) {
    loading = state;
    loadingBar.style.display = state ? 'block' : 'none';
  }

  function formatDate(dStr) {
    if (!dStr) return '';
    const d = new Date(dStr);
    if (isNaN(d)) return '';
    return d.toLocaleDateString('es-AR',{ day:'2-digit', month:'2-digit', year:'numeric'});
  }

  function calcEdad(fecha_nacimiento) {
    if (!fecha_nacimiento) return '';
    const fn = new Date(fecha_nacimiento);
    if (isNaN(fn)) return '';
    const hoy = new Date();
    let edad = hoy.getFullYear() - fn.getFullYear();
    const m = hoy.getMonth() - fn.getMonth();
    if (m < 0 || (m === 0 && hoy.getDate() < fn.getDate())) edad--;
    return edad;
  }

  function buildBadgeFecha(value) {
    if (!value) return '';
    const hoy = new Date();
    const f = new Date(value);
    if (isNaN(f)) return '';
    const diffDays = Math.floor((f - hoy)/(1000*60*60*24));
    let cls = 'badge-date';
    if (diffDays < 0) cls += ' badge-overdue';
    else if (diffDays <= 7) cls += ' badge-warn';
    return `<span class="${cls}" title="${formatDate(value)}">${formatDate(value)}</span>`;
  }

  // ===== Fetch logic =====
  async function loadPacientes(page = 1) {
    if (loading) return;
    setLoading(true);
    currentPage = page;

    let query = supabase.from('pacientes')
      .select('id,dni,apellido,nombre,fecha_nacimiento,obra_social,proximo_control,renovacion_receta,activo', { count: 'exact' })
      .order('apellido', { ascending: true })
      .order('nombre', { ascending: true });

    if (currentFilters.dni) {
      // For exact or starts-with? We'll use ilike for partial.
      const dniLike = currentFilters.dni.replace(/[%_]/g,''); // simple sanitation
      query = query.ilike('dni', dniLike + '%');
    }
    if (currentFilters.apellido) {
      const ap = currentFilters.apellido.trim().toLowerCase();
      if (ap) query = query.ilike('apellido', ap + '%');
    }

    const from = (page - 1) * PAGE_SIZE;
    const to = from + PAGE_SIZE - 1;
    query = query.range(from, to);

    const { data, error, count } = await query;
    setLoading(false);

    if (error) {
      tbody.innerHTML = `<tr class="empty-row"><td colspan="8">Error cargando: ${error.message}</td></tr>`;
      paginacion.style.display = 'none';
      return;
    }

    totalRows = count || 0;
    renderTable(data || []);
    renderPagination();
  }

  function renderTable(rows) {
    if (!rows.length) {
      tbody.innerHTML = `<tr class="empty-row"><td colspan="8">No se encontraron pacientes</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map(r => {
      const edad = calcEdad(r.fecha_nacimiento);
      return `<tr data-id="${r.id}">
        <td><span class="status-dot ${r.activo ? '' : 'status-inactive'}" title="${r.activo ? 'Activo' : 'Inactivo'}"></span></td>
        <td>${r.dni || ''}</td>
        <td>${r.apellido || ''}</td>
        <td>${r.nombre || ''}</td>
        <td>${edad ?? ''}</td>
        <td>${r.obra_social || ''}</td>
        <td>${buildBadgeFecha(r.proximo_control)}</td>
        <td>${buildBadgeFecha(r.renovacion_receta)}</td>
      </tr>`;
    }).join('');
  }

  function renderPagination() {
    if (totalRows <= PAGE_SIZE) {
      paginacion.style.display = 'none';
      return;
    }
    paginacion.style.display = 'flex';
    const totalPages = Math.ceil(totalRows / PAGE_SIZE);
    paginationInfo.textContent = `Página ${currentPage} de ${totalPages} — ${totalRows} pacientes`;
    btnPrev.disabled = currentPage === 1;
    btnNext.disabled = currentPage === totalPages;
  }

  // ===== Modal / Form =====
  function openPacienteModal(paciente = null) {
    modalRoot.innerHTML = '';
    const isEdit = !!paciente;
    const modal = document.createElement('div');
    modal.className = 'modal-backdrop';
    modal.innerHTML = `
      <div class="modal" role="dialog" aria-modal="true">
        <button class="modal-close" aria-label="Cerrar">&times;</button>
        <div class="modal-header">
          <h3>${isEdit ? 'Editar Paciente' : 'Nuevo Paciente'}</h3>
        </div>
        <form id="form-paciente">
          <div class="modal-body">
            <div id="form-alerts"></div>

            <fieldset class="fieldset">
              <legend>Datos Personales</legend>
              <div class="form-grid">
                <div class="form-group">
                  <label>DNI *</label>
                  <input name="dni" required autocomplete="off" value="${paciente?.dni ?? ''}">
                </div>
                <div class="form-group">
                  <label>Apellido *</label>
                  <input name="apellido" required value="${paciente?.apellido ?? ''}">
                </div>
                <div class="form-group">
                  <label>Nombre *</label>
                  <input name="nombre" required value="${paciente?.nombre ?? ''}">
                </div>
                <div class="form-group">
                  <label>Fecha Nacimiento</label>
                  <input name="fecha_nacimiento" type="date" value="${paciente?.fecha_nacimiento ?? ''}">
                </div>
                <div class="form-group">
                  <label>Teléfono</label>
                  <input name="telefono" value="${paciente?.telefono ?? ''}">
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input name="email" type="email" value="${paciente?.email ?? ''}">
                </div>
                <div class="form-group">
                  <label>Obra Social</label>
                  <input name="obra_social" value="${paciente?.obra_social ?? ''}">
                </div>
                <div class="form-group">
                  <label>N° Afiliado</label>
                  <input name="numero_afiliado" value="${paciente?.numero_afiliado ?? ''}">
                </div>
              </div>
            </fieldset>

            <fieldset class="fieldset">
              <legend>Contacto de Emergencia</legend>
              <div class="form-grid">
                <div class="form-group">
                  <label>Nombre Contacto</label>
                  <input name="contacto_nombre" value="${paciente?.contacto_nombre ?? ''}">
                </div>
                <div class="form-group">
                  <label>Apellido Contacto</label>
                  <input name="contacto_apellido" value="${paciente?.contacto_apellido ?? ''}">
                </div>
                <div class="form-group">
                  <label>Celular Contacto</label>
                  <input name="contacto_celular" value="${paciente?.contacto_celular ?? ''}">
                </div>
                <div class="form-group">
                  <label>Vínculo</label>
                  <input name="vinculo" value="${paciente?.vinculo ?? ''}">
                </div>
              </div>
            </fieldset>

            <fieldset class="fieldset">
              <legend>Historial y Fechas</legend>
              <div class="form-grid">
                <div class="form-group">
                  <label>Credencial (URL / nota)</label>
                  <input name="credencial" value="${paciente?.credencial ?? ''}">
                </div>
                <div class="form-group">
                  <label>Próximo Control</label>
                  <input name="proximo_control" type="date" value="${paciente?.proximo_control ?? ''}">
                </div>
                <div class="form-group">
                  <label>Renovación Receta</label>
                  <input name="renovacion_receta" type="date" value="${paciente?.renovacion_receta ?? ''}">
                </div>
                <div class="form-group" style="grid-column:1/-1;">
                  <label>Historia Clínica</label>
                  <textarea name="historia_clinica" placeholder="Antecedentes, notas...">${paciente?.historia_clinica ?? ''}</textarea>
                </div>
                <div class="form-group">
                  <label>Activo</label>
                  <select name="activo">
                    <option value="true" ${paciente?.activo !== false ? 'selected':''}>Sí</option>
                    <option value="false" ${paciente?.activo === false ? 'selected':''}>No</option>
                  </select>
                </div>
              </div>
            </fieldset>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn secondary" id="btn-cancelar">Cancelar</button>
            <button type="submit" class="btn">${isEdit ? 'Guardar Cambios' : 'Crear Paciente'}</button>
          </div>
        </form>
      </div>
    `;
    modalRoot.appendChild(modal);

    // Event handlers
    modal.querySelector('.modal-close').addEventListener('click', closeModal);
    modal.querySelector('#btn-cancelar').addEventListener('click', closeModal);
    modal.addEventListener('click', e => {
      if (e.target === modal) closeModal();
    });

    const form = modal.querySelector('#form-paciente');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      await submitPacienteForm(form, paciente);
    });
  }

  function closeModal() {
    modalRoot.innerHTML = '';
  }

  function showFormMessage(type, message) {
    const container = document.getElementById('form-paciente')?.querySelector('#form-alerts');
    if (!container) return;
    container.innerHTML = `
      <div class="${type === 'error' ? 'error-box':'success-box'}">
        <span style="font-size:18px; line-height:1;">${type === 'error' ? '⚠️':'✅'}</span>
        <div>${message}</div>
      </div>
    `;
  }

  function extractFormData(form) {
    const fd = new FormData(form);
    const obj = {};
    fd.forEach((v,k)=> { obj[k] = v.trim ? v.trim() : v });
    // Convert
    obj.activo = obj.activo === 'true';
    // Empty to null for optional
    [
      'fecha_nacimiento','proximo_control','renovacion_receta',
      'telefono','email','obra_social','numero_afiliado','contacto_nombre',
      'contacto_apellido','contacto_celular','vinculo','credencial','historia_clinica'
    ].forEach(f => {
      if (obj[f] === '') obj[f] = null;
    });
    return obj;
  }

  async function submitPacienteForm(form, pacienteExistente) {
    const data = extractFormData(form);

    // Basic validations
    if (!data.dni || !data.apellido || !data.nombre) {
      showFormMessage('error', 'Campos obligatorios faltantes: DNI, Apellido y Nombre.');
      return;
    }
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Guardando...';

    try {
      if (pacienteExistente) {
        const { error } = await supabase
          .from('pacientes')
          .update(data)
          .eq('id', pacienteExistente.id);
        if (error) throw error;
        showFormMessage('success', 'Paciente actualizado con éxito.');
      } else {
        // Check unique DNI
        const { data: existing, error: qErr } = await supabase
          .from('pacientes')
          .select('id')
          .eq('dni', data.dni)
          .limit(1);
        if (qErr) throw qErr;
        if (existing && existing.length) {
          showFormMessage('error', 'Ya existe un paciente con ese DNI.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Crear Paciente';
          return;
        }

        const { error: insErr } = await supabase
          .from('pacientes')
          .insert([data]);
        if (insErr) throw insErr;
        showFormMessage('success', 'Paciente creado correctamente.');
        form.reset();
      }
      // Refresh list
      await loadPacientes(1);
      setTimeout(()=> {
        closeModal();
      }, 900);
    } catch (e) {
      console.error(e);
      showFormMessage('error', 'Error guardando: ' + (e.message || e));
      submitBtn.disabled = false;
      submitBtn.textContent = pacienteExistente ? 'Guardar Cambios' : 'Crear Paciente';
    }
  }

  // ===== Event Listeners =====
  dniInput.addEventListener('input', debounce(() => {
    currentFilters.dni = dniInput.value.trim();
    loadPacientes(1);
  }, 400));

  apellidoInput.addEventListener('input', debounce(() => {
    currentFilters.apellido = apellidoInput.value.trim();
    loadPacientes(1);
  }, 400));

  btnLimpiar.addEventListener('click', () => {
    dniInput.value = '';
    apellidoInput.value = '';
    currentFilters = { dni:'', apellido:'' };
    loadPacientes(1);
  });

  btnNuevo.addEventListener('click', () => openPacienteModal());

  btnPrev.addEventListener('click', () => {
    if (currentPage > 1) loadPacientes(currentPage - 1);
  });
  btnNext.addEventListener('click', () => {
    const totalPages = Math.ceil(totalRows / PAGE_SIZE);
    if (currentPage < totalPages) loadPacientes(currentPage + 1);
  });

  tbody.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr[data-id]');
    if (!tr) return;
    const id = tr.getAttribute('data-id');
    // Fetch row details for edit
    const { data, error } = await supabase
      .from('pacientes')
      .select('*')
      .eq('id', id)
      .maybeSingle();
    if (error) {
      alert('Error obteniendo paciente: ' + error.message);
      return;
    }
    if (data) {
      openPacienteModal(data);
    }
  });

  // ===== Initial load =====
  loadPacientes();
</script>
