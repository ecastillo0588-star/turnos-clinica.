<!-- Pacientes Panel -->
<style>
  #main-content.card {
    max-width: none !important;
    width: 100% !important;
    padding: 26px 26px 34px 26px !important;
  }
  #pacientes-panel { font-family: system-ui, Arial, sans-serif; }
  .panel-top-bar { display:flex; flex-wrap:wrap; gap:18px; align-items:flex-end; margin-bottom:20px; }
  .panel-top-bar h2 { flex:0 0 100%; margin:0 0 8px 0; font-size:24px; color:#381e60; letter-spacing:.5px; }
  .filters-group { display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end; }
  .field { display:flex; flex-direction:column; gap:4px; }
  .field label { font-size:12.5px; color:#5b4a80; font-weight:600; letter-spacing:.35px; }
  .field input {
    background:#f7f9fb; border:1.5px solid #ece5fc; padding:7px 10px; border-radius:8px;
    min-width:180px; font-size:14px; outline:none; color:#381e60; transition:border .15s, background .2s;
  }
  .field input:focus { border-color:#a490d7; background:#fff; }
  .actions-inline { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
  .btn {
    background:#7656b0; color:#fff; border:none; border-radius:8px; padding:9px 16px; font-size:14px;
    cursor:pointer; font-weight:500; letter-spacing:.3px; display:inline-flex; align-items:center; gap:6px;
    transition:background .18s, transform .05s; line-height:1.1;
  }
  .btn:hover { background:#7f62b6; }
  .btn:active { transform:translateY(1px); }
  .btn.secondary { background:#eee9fb; color:#5a418d; border:1px solid #e1d6f5; }
  .btn.secondary:hover { background:#e3daf7; }
  .btn.outline { background:#fff; color:#5a418d; border:1.5px solid #cbb8f1; }
  .btn.outline:hover { background:#f7f3fe; }
  .btn.danger { background:#b00020; }
  .btn.danger:hover { background:#8e0c2f; }
  .btn.small { padding:5px 10px; font-size:12.5px; border-radius:6px; }
  .export-note { font-size:12px; color:#6b6480; margin-top:4px; }
  .table-zone { background:#fff; border:1px solid #e7e0f5; border-radius:14px; padding:0; box-shadow:0 2px 10px rgba(80,60,160,.10); }
  .table-scroll { width:100%; overflow:auto; border-radius:14px; }
  table.pacientes { width:100%; border-collapse:collapse; font-size:13.5px; min-width:1500px; }
  table.pacientes thead { background:#f0ecfa; position:sticky; top:0; z-index:3; }
  table.pacientes th, table.pacientes td { padding:9px 12px; text-align:left; border-bottom:1px solid #eee9fa; vertical-align:middle; }
  table.pacientes th { font-weight:600; font-size:12px; color:#5a418d; letter-spacing:.45px; text-transform:uppercase; }
  table.pacientes tbody tr { transition:background .10s; }
  table.pacientes tbody tr:hover { background:#faf7ff; }
  .empty-row td { text-align:center; padding:48px 10px; font-size:15px; color:#8269b5; }
  .status-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; background:#4caf50; }
  .status-inactive { background:#d32f2f; }
  td.nowrap, th.nowrap { white-space:nowrap; }
  .acciones-cell { display:flex; gap:6px; align-items:center; }
  .row-action {
    background:#fff; border:1px solid #d9cffa; color:#5a418d; width:30px; height:30px;
    display:flex; align-items:center; justify-content:center; border-radius:8px; font-size:15px;
    cursor:pointer; transition:background .15s, border-color .15s;
  }
  .row-action:hover { background:#efe8ff; }
  .row-action.danger:hover { background:#ffe3e8; border-color:#ff9aa7; color:#b00020; }
  .badge-date { background:#efe8ff; color:#5a418d; padding:3px 8px; border-radius:20px; font-size:11px; font-weight:500; letter-spacing:.3px; display:inline-block; }
  .badge-warn { background:#fff4e0; color:#9c5700; }
  .badge-overdue { background:#ffe3e3; color:#b00020; }
  .pagination { display:flex; justify-content:space-between; padding:14px 10px 10px 10px; align-items:center; flex-wrap:wrap; gap:12px; }
  .pagination-info { font-size:12.5px; color:#6b6480; }
  .loading-bar { height:4px; width:100%; background:linear-gradient(90deg,#a490d733,#a490d7); background-size:200% 100%; animation:loadingDash 1.1s linear infinite; border-radius:4px 4px 0 0; }
  @keyframes loadingDash { 0%{background-position:0 0;} 100%{background-position:-200% 0;} }
</style>

<div id="pacientes-panel">
  <div class="panel-top-bar">
    <h2>Pacientes</h2>
    <div class="filters-group">
      <div class="field">
        <label for="filtro-dni">Buscar por DNI</label>
        <input id="filtro-dni" type="text" placeholder="Ej: 30111222">
      </div>
      <div class="field">
        <label for="filtro-apellido">Buscar por Apellido</label>
        <input id="filtro-apellido" type="text" placeholder="Ej: García">
      </div>
      <div class="actions-inline">
        <button id="btn-limpiar" class="btn secondary" type="button">Limpiar</button>
        <button id="btn-nuevo" class="btn" type="button">➕ Nuevo Paciente</button>
        <button id="btn-exportar-csv" class="btn outline" type="button" title="Descargar todos los pacientes como CSV">📥 Exportar CSV</button>
      </div>
      <div style="flex:1 1 100%;"></div>
      <div class="export-note" id="export-status"></div>
    </div>
  </div>

  <div id="loading-bar" class="loading-bar" style="display:none;"></div>

  <div class="table-zone">
    <div class="table-scroll">
      <table class="pacientes" id="tabla-pacientes">
        <thead>
          <tr>
            <th class="nowrap">Activo</th>
            <th>DNI</th>
            <th>Apellido</th>
            <th>Nombre</th>
            <th>Edad</th>
            <th>Teléfono</th>
            <th>Email</th>
            <th>Obra Social</th>
            <th>N° Afiliado</th>
            <th class="nowrap">Próx. Control</th>
            <th class="nowrap">Renov. Receta</th>
            <th class="nowrap">Hist. Clínica</th>
            <th class="nowrap">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody-pacientes">
          <tr class="empty-row"><td colspan="13">Sin datos</td></tr>
        </tbody>
      </table>
    </div>
    <div class="pagination" id="paginacion" style="display:none;">
      <div class="pagination-info" id="pagination-info"></div>
      <div style="display:flex; gap:6px;">
        <button id="btn-prev" class="btn small secondary">&larr; Anterior</button>
        <button id="btn-next" class="btn small secondary">Siguiente &rarr;</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import supabase from './supabaseClient.js';
  import { openPacienteModal } from './global.js';

  const PAGE_SIZE = 25;
  let currentPage = 1;
  let totalRows = 0;
  let currentFilters = { dni:'', apellido:'' };
  let loading = false;

  const dniInput = document.getElementById('filtro-dni');
  const apellidoInput = document.getElementById('filtro-apellido');
  const btnLimpiar = document.getElementById('btn-limpiar');
  const btnNuevo = document.getElementById('btn-nuevo');
  const btnExportarCSV = document.getElementById('btn-exportar-csv');
  const exportStatus = document.getElementById('export-status');
  const tbody = document.getElementById('tbody-pacientes');
  const loadingBar = document.getElementById('loading-bar');
  const paginacion = document.getElementById('paginacion');
  const paginationInfo = document.getElementById('pagination-info');
  const btnPrev = document.getElementById('btn-prev');
  const btnNext = document.getElementById('btn-next');

  const debounce = (fn, ms=400) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
  function setLoading(s){ loading=s; loadingBar.style.display=s?'block':'none'; }

  function formatDate(dStr){
    if(!dStr) return '';
    const d=new Date(dStr);
    if(isNaN(d)) return '';
    return d.toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'});
  }
  function calcEdad(f){
    if(!f) return '';
    const fn=new Date(f); if(isNaN(fn)) return '';
    const hoy=new Date();
    let edad=hoy.getFullYear()-fn.getFullYear();
    const m=hoy.getMonth()-fn.getMonth();
    if(m<0||(m===0 && hoy.getDate()<fn.getDate())) edad--;
    return edad;
  }
  function buildBadgeFecha(value){
    if(!value) return '';
    const hoy=new Date();
    const f=new Date(value);
    if(isNaN(f)) return '';
    const diffDays=Math.floor((f - hoy)/(1000*60*60*24));
    let cls='badge-date';
    if(diffDays<0) cls+=' badge-overdue';
    else if(diffDays<=7) cls+=' badge-warn';
    return `<span class="${cls}" title="${formatDate(value)}">${formatDate(value)}</span>`;
  }
  function buildHistDocIcon(url){
    if(!url) return '';
    const isUrl = /^https?:\/\//i.test(url);
    if(!isUrl) return '';
    const safeUrl = url.replace(/"/g,'&quot;');
    return `<a class="doc-link-btn" href="${safeUrl}" target="_blank" rel="noopener noreferrer" title="Abrir Historia Clínica">📄</a>`;
  }

  async function loadPacientes(page=1){
    if(loading) return;
    setLoading(true);
    currentPage=page;

    let query = supabase.from('pacientes')
      .select('id,dni,apellido,nombre,fecha_nacimiento,telefono,email,obra_social,numero_afiliado,proximo_control,renovacion_receta,activo,historia_clinica',{ count:'exact'})
      .order('apellido',{ascending:true})
      .order('nombre',{ascending:true});

    if(currentFilters.dni){
      const dniLike=currentFilters.dni.replace(/[%_]/g,'');
      query=query.ilike('dni', dniLike + '%');
    }
    if(currentFilters.apellido){
      const ap=currentFilters.apellido.trim();
      if(ap) query=query.ilike('apellido', ap + '%');
    }

    const from=(page-1)*PAGE_SIZE;
    const to=from+PAGE_SIZE-1;
    query=query.range(from,to);

    const { data, error, count } = await query;
    setLoading(false);

    if(error){
      tbody.innerHTML=`<tr class="empty-row"><td colspan="13">Error: ${error.message}</td></tr>`;
      paginacion.style.display='none';
      return;
    }
    totalRows=count || 0;
    renderTable(data||[]);
    renderPagination();
  }

  function renderTable(rows){
    if(!rows.length){
      tbody.innerHTML=`<tr class="empty-row"><td colspan="13">No se encontraron pacientes</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map(r=>{
      const edad = calcEdad(r.fecha_nacimiento);
      return `<tr data-id="${r.id}">
        <td class="nowrap"><span class="status-dot ${r.activo ? '' : 'status-inactive'}"></span></td>
        <td>${r.dni || ''}</td>
        <td>${r.apellido || ''}</td>
        <td>${r.nombre || ''}</td>
        <td class="nowrap">${edad ?? ''}</td>
        <td>${r.telefono || ''}</td>
        <td>${r.email || ''}</td>
        <td>${r.obra_social || ''}</td>
        <td>${r.numero_afiliado || ''}</td>
        <td>${buildBadgeFecha(r.proximo_control)}</td>
        <td>${buildBadgeFecha(r.renovacion_receta)}</td>
        <td class="nowrap" style="text-align:center;">${buildHistDocIcon(r.historia_clinica)}</td>
        <td class="acciones-cell nowrap">
          <button class="row-action" data-action="edit">✏️</button>
          <button class="row-action" data-action="toggle">${r.activo ? '⏻' : '✅'}</button>
          <button class="row-action danger" data-action="delete">🗑️</button>
        </td>
      </tr>`;
    }).join('');
  }

  function renderPagination(){
    if(totalRows <= PAGE_SIZE){ paginacion.style.display='none'; return; }
    paginacion.style.display='flex';
    const totalPages = Math.ceil(totalRows / PAGE_SIZE);
    paginationInfo.textContent = `Página ${currentPage} de ${totalPages} — ${totalRows} pacientes`;
    btnPrev.disabled = currentPage === 1;
    btnNext.disabled = currentPage === totalPages;
  }

  async function toggleActivo(id,current){
    if(!confirm(`¿Seguro que deseas ${current?'inactivar':'activar'} este paciente?`)) return;
    const { error } = await supabase.from('pacientes').update({ activo: !current }).eq('id', id);
    if(error){ alert('Error: '+error.message); return; }
    await loadPacientes(currentPage);
  }

  async function deletePaciente(id){
    if(!confirm('¿Eliminar este paciente permanentemente?')) return;
    const { error } = await supabase.from('pacientes').delete().eq('id', id);
    if(error){ alert('Error eliminando: '+error.message); return; }
    const expectedLastIndex=(currentPage-1)*PAGE_SIZE;
    await loadPacientes(expectedLastIndex >= (totalRows-1) && currentPage>1 ? currentPage-1 : currentPage);
  }

  tbody.addEventListener('click', async e=>{
    const actionBtn=e.target.closest('.row-action');
    const tr=e.target.closest('tr[data-id]');
    if(!tr) return;
    const id=tr.getAttribute('data-id');

    if(actionBtn){
      const action=actionBtn.dataset.action;
      if(action==='edit'){
        const { data } = await supabase.from('pacientes').select('*').eq('id', id).maybeSingle();
        if(data) openPacienteModal(data);
      } else if(action==='toggle'){
        const { data } = await supabase.from('pacientes').select('activo').eq('id', id).maybeSingle();
        await toggleActivo(id, data?.activo);
      } else if(action==='delete'){
        await deletePaciente(id);
      }
      return;
    }

    if(!e.target.closest('.doc-link-btn') && !e.target.closest('.acciones-cell')){
      const { data } = await supabase.from('pacientes').select('*').eq('id', id).maybeSingle();
      if(data) openPacienteModal(data);
    }
  });

  // Exportar CSV
  btnExportarCSV.addEventListener('click', exportarCSV);
  async function exportarCSV(){
    exportStatus.textContent='Generando CSV...';
    btnExportarCSV.disabled=true;
    try{
      const batchSize=1000;
      let all=[], from=0, more=true;
      while(more){
        let q=supabase.from('pacientes')
          .select('*')
          .order('apellido',{ascending:true})
          .order('nombre',{ascending:true})
          .range(from, from+batchSize-1);

        if(currentFilters.dni){
          const dniLike=currentFilters.dni.replace(/[%_]/g,'');
          q=q.ilike('dni', dniLike+'%');
        }
        if(currentFilters.apellido){
          const ap=currentFilters.apellido.trim();
          if(ap) q=q.ilike('apellido', ap+'%');
        }
        const { data } = await q;
        if(!data || !data.length){ more=false; break; }
        all=all.concat(data);
        if(data.length < batchSize) more=false;
        from += batchSize;
      }
      if(!all.length){ exportStatus.textContent='No hay datos.'; btnExportarCSV.disabled=false; return; }

      const header = [
        'dni','apellido','nombre','edad','fecha_nacimiento','telefono','email','obra_social',
        'numero_afiliado','proximo_control','renovacion_receta','activo','historia_clinica',
        'contacto_nombre','contacto_apellido','contacto_celular','vinculo','credencial'
      ];
      const lines = [];
      lines.push(header.join(','));
      for(const p of all){
        const row = header.map(h=>{
          let val;
            if(h==='edad') val = calcEdad(p.fecha_nacimiento);
            else val = p[h] ?? '';
          val = (''+val).replace(/"/g,'""');
          return `"${val}"`;
        }).join(',');
        lines.push(row);
      }
      const csv = lines.join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `pacientes_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      exportStatus.textContent = `CSV generado (${all.length} registros).`;
    } catch(e){
      exportStatus.textContent = 'Error exportando: '+(e.message||e);
    } finally {
      btnExportarCSV.disabled=false;
      setTimeout(()=>{ exportStatus.textContent=''; }, 9000);
    }
  }

  // Filtros y eventos
  dniInput.addEventListener('input', debounce(()=>{ currentFilters.dni = dniInput.value.trim(); loadPacientes(1); }));
  apellidoInput.addEventListener('input', debounce(()=>{ currentFilters.apellido = apellidoInput.value.trim(); loadPacientes(1); }));
  btnLimpiar.addEventListener('click', ()=>{ dniInput.value=''; apellidoInput.value=''; currentFilters={dni:'',apellido:''}; loadPacientes(1); });
  btnNuevo.addEventListener('click', ()=> openPacienteModal());
  btnPrev.addEventListener('click', ()=> { if(currentPage>1) loadPacientes(currentPage-1); });
  btnNext.addEventListener('click', ()=> { const totalPages=Math.ceil(totalRows/PAGE_SIZE); if(currentPage<totalPages) loadPacientes(currentPage+1); });

  loadPacientes();
</script>
