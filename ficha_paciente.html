<script type="module">
  // ✅ cliente Supabase inline (no uses service_role, solo la anon key)
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const SUPABASE_URL = 'https://TU-PROYECTO.supabase.co';
const SUPABASE_ANON_KEY = 'TU_PUBLIC_ANON_KEY';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


  /* ============== helpers UI ============== */
  const qs = (id) => document.getElementById(id);
  const UI = {
    root: qs('root'),
    status: qs('status'),
    btnBack: qs('btnBack'), btnReload: qs('btnReload'), btnCerrar: qs('btnCerrar'),
    btnGuardar: qs('btnGuardar'), btnTerminar: qs('btnTerminar'),
    // resumen
    p_prof: qs('p_prof'), p_centro: qs('p_centro'), p_dir: qs('p_dir'),
    p_fecha: qs('p_fecha'), p_hora: qs('p_hora'), p_copago: qs('p_copago'), p_estado: qs('p_estado'),
    // paciente
    dni: qs('dni'), apellido: qs('apellido'), nombre: qs('nombre'),
    fecha_nacimiento: qs('fecha_nacimiento'), edad: qs('edad'),
    telefono: qs('telefono'), email: qs('email'),
    historia_clinica: qs('historia_clinica'), btnHC: qs('btnHC'),
    obra_social: qs('obra_social'), numero_afiliado: qs('numero_afiliado'),
    credencial: qs('credencial'), btnCred: qs('btnCred'),
    contacto_nombre: qs('contacto_nombre'), contacto_apellido: qs('contacto_apellido'),
    contacto_celular: qs('contacto_celular'), vinculo: qs('vinculo'),
    notas: qs('notas'),
  };

  // utilidad de estado
  function setStatus(msg, tone=''){ UI.status && (UI.status.textContent = msg || ''); UI.status && (UI.status.className='msg '+(tone||'')); }

  // helpers varios
  function pad(n){return n<10?'0'+n:''+n}
  function toHM(t){ return (t??'').toString().slice(0,5); }
  function nowHHMMSS(){ const d=new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}` }
  function calcEdad(f){ if(!f) return null; const d=new Date(f); if(isNaN(d)) return null; const t=new Date();
    let a=t.getFullYear()-d.getFullYear(); const m=t.getMonth()-d.getMonth();
    if (m<0 || (m===0 && t.getDate()<d.getDate())) a--; return Math.max(a,0);
  }
  function money(n){ return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0)); }

  // role
  const userRole = localStorage.getItem('user_role') || '';
  const isMedico = (userRole === 'medico');
  if (!isMedico && UI.btnTerminar) UI.btnTerminar.style.display = 'none';

  /* ============== obtener TURNO_ID (querystring -> localStorage fallback) ============== */
  let TURNO_ID = new URLSearchParams(location.search).get('turno_id') || null;
  if (!TURNO_ID) {
    try { TURNO_ID = localStorage.getItem('current_turno_id') || null; } catch {}
  }
  if (!TURNO_ID) {
    setStatus('Falta parámetro turno_id', 'warn');
  }

  /* ============== catálogos ============== */
  async function loadObrasSociales(currentLabel){
    if (!UI.obra_social) return;
    UI.obra_social.innerHTML = '<option value="">(Sin obra social)</option>';
    const { data, error } = await supabase
      .from('obras_sociales')
      .select('obra_social')
      .order('obra_social',{ascending:true});
    if (error) console.warn('Error obras_sociales:', error);

    const labels = (data||[]).map(r=>r.obra_social);
    labels.forEach(lbl => {
      const opt=document.createElement('option'); opt.value=lbl; opt.textContent=lbl; UI.obra_social.appendChild(opt);
    });
    if (currentLabel && !labels.includes(currentLabel)) {
      const opt=document.createElement('option'); opt.value=currentLabel; opt.textContent=currentLabel; UI.obra_social.appendChild(opt);
    }
    UI.obra_social.value = currentLabel || '';
  }

  /* ============== cargar turno + paciente (2 pasos, robusto) ============== */
  let turno = null;
  let pacienteId = null;

  async function load(){
    if (!TURNO_ID){ setStatus('Falta parámetro turno_id', 'warn'); return; }
    setStatus('Cargando...');

    // 1) Traer el turno "plano"
    const { data: t, error: terr } = await supabase
      .from('turnos')
      .select('id, fecha, hora_inicio, hora_fin, estado, hora_arribo, copago, notas, paciente_id, profesional_id, centro_id')
      .eq('id', TURNO_ID)
      .maybeSingle();

    if (terr || !t){
      console.error('Error cargando turno:', terr);
      setStatus('No se pudo cargar el turno', 'warn');
      return;
    }
    turno = t;
    pacienteId = t.paciente_id;

    // 2) Relacionados
    const [pRes, profRes, centroRes] = await Promise.all([
      supabase.from('pacientes').select(
        'id, dni, apellido, nombre, fecha_nacimiento, telefono, email, '+
        'obra_social, numero_afiliado, credencial, contacto_nombre, contacto_apellido, '+
        'contacto_celular, vinculo, historia_clinica'
      ).eq('id', t.paciente_id).maybeSingle(),
      supabase.from('profesionales').select('id, display_name, nombre, apellido').eq('id', t.profesional_id).maybeSingle(),
      supabase.from('centros_medicos').select('id, nombre, direccion').eq('id', t.centro_id).maybeSingle(),
    ]);

    const prof = profRes?.data || null;
    const centro = centroRes?.data || null;
    const p = pRes?.data || null;

    // resumen
    const profLabel = prof ? (prof.display_name || [prof.apellido, prof.nombre].filter(Boolean).join(', ')) : '—';
    if (UI.p_prof)   UI.p_prof.textContent   = `Profesional: ${profLabel}`;
    if (UI.p_centro) UI.p_centro.textContent = `Centro: ${centro?.nombre || '—'}`;
    if (UI.p_dir)    UI.p_dir.textContent    = `Dirección: ${centro?.direccion || '—'}`;
    if (UI.p_fecha)  UI.p_fecha.textContent  = `Fecha: ${turno.fecha || '—'}`;
    if (UI.p_hora)   UI.p_hora.textContent   = `Hora: ${turno.hora_inicio ? toHM(turno.hora_inicio) : '—'}`;
    if (UI.p_copago) UI.p_copago.textContent = `Copago: ${turno.copago!=null ? money(turno.copago) : '—'}`;
    if (UI.p_estado) UI.p_estado.textContent = `Estado: ${turno.estado || '—'}`;
    if (UI.notas)    UI.notas.value          = turno.notas || '';

    // paciente
    if (p){
      if (UI.dni) UI.dni.value = p.dni || '';
      if (UI.apellido) UI.apellido.value = p.apellido || '';
      if (UI.nombre) UI.nombre.value = p.nombre || '';
      if (UI.fecha_nacimiento) { UI.fecha_nacimiento.value = p.fecha_nacimiento || ''; renderEdad(); }
      if (UI.telefono) UI.telefono.value = p.telefono || '';
      if (UI.email) UI.email.value = p.email || '';
      if (UI.historia_clinica) UI.historia_clinica.value = p.historia_clinica || '';
      if (UI.btnHC) {
        UI.btnHC.href  = p.historia_clinica ? p.historia_clinica : '#';
        UI.btnHC.target = p.historia_clinica ? '_blank' : '_self';
      }

      await loadObrasSociales(p.obra_social || '');
      if (UI.numero_afiliado) UI.numero_afiliado.value = p.numero_afiliado || '';
      if (UI.credencial) UI.credencial.value = p.credencial || '';
      if (UI.btnCred) {
        UI.btnCred.href  = p.credencial ? p.credencial : '#';
        UI.btnCred.target = p.credencial ? '_blank' : '_self';
      }

      if (UI.contacto_nombre) UI.contacto_nombre.value = p.contacto_nombre || '';
      if (UI.contacto_apellido) UI.contacto_apellido.value = p.contacto_apellido || '';
      if (UI.contacto_celular) UI.contacto_celular.value = p.contacto_celular || '';
      if (UI.vinculo) UI.vinculo.value = p.vinculo || '';
    } else {
      await loadObrasSociales('');
    }

    setStatus('');
  }

  function renderEdad(){
    const a = calcEdad(UI.fecha_nacimiento?.value);
    if (UI.edad) UI.edad.textContent = (a==null) ? '—' : `${a} años`;
  }

  /* ============== guardar paciente + notas ============== */
  function validate(){
    const req = [
      ['dni', UI.dni?.value?.trim()],
      ['apellido', UI.apellido?.value?.trim()],
      ['nombre', UI.nombre?.value?.trim()],
      ['fecha_nacimiento', UI.fecha_nacimiento?.value],
      ['telefono', UI.telefono?.value?.trim()],
    ];
    const faltan = req.filter(([,v])=>!v);
    if (faltan.length){ setStatus('Faltan campos obligatorios', 'warn'); return false; }
    return true;
  }

  async function guardar(){
    if (!validate()) return;
    setStatus('Guardando...');

    const payloadP = {
      dni: UI.dni.value.trim(),
      apellido: UI.apellido.value.trim(),
      nombre: UI.nombre.value.trim(),
      fecha_nacimiento: UI.fecha_nacimiento.value || null,
      telefono: UI.telefono.value.trim() || null,
      email: UI.email.value.trim() || null,
      obra_social: UI.obra_social.value || null,
      numero_afiliado: UI.numero_afiliado.value.trim() || null,
      credencial: UI.credencial.value.trim() || null,
      contacto_nombre: UI.contacto_nombre.value.trim() || null,
      contacto_apellido: UI.contacto_apellido.value.trim() || null,
      contacto_celular: UI.contacto_celular.value.trim() || null,
      vinculo: UI.vinculo.value.trim() || null,
      historia_clinica: UI.historia_clinica.value.trim() || null,
    };

    const [r1, r2] = await Promise.all([
      supabase.from('pacientes').update(payloadP).eq('id', pacienteId),
      supabase.from('turnos').update({ notas: UI.notas.value || null }).eq('id', TURNO_ID),
    ]);

    if (r1.error){ setStatus('Error guardando paciente: '+r1.error.message, 'warn'); return; }
    if (r2.error){ setStatus('Error guardando notas: '+r2.error.message, 'warn'); return; }
    setStatus('Cambios guardados.', 'ok');
    setTimeout(()=>setStatus(''), 1800);
  }

  /* ============== terminar consulta (solo médico) ============== */
  function goBack(){
    const backTo = (localStorage.getItem('inicio_url') || '');
    if (backTo) { window.location.href = backTo; return; }
    if (history.length > 1) { history.back(); return; }
    window.location.href = 'index.html'; // último fallback
  }

  async function terminarConsulta(){
    if (!isMedico){ alert('Solo los médicos pueden terminar la consulta.'); return; }
    if (!confirm('¿Marcar este turno como FINALIZADO?')) return;
    setStatus('Finalizando...');

    const { error } = await supabase
      .from('turnos')
      .update({ estado: 'finalizado', hora_fin: nowHHMMSS() })
      .eq('id', TURNO_ID);

    if (error){
      alert('No se pudo marcar FINALIZADO.');
      setStatus('No se pudo finalizar.', 'warn'); return;
    }
    setStatus('Consulta finalizada.', 'ok');
    setTimeout(()=>goBack(), 700);
  }

  /* ============== bindings seguros ============== */
  if (UI.btnBack)    UI.btnBack.onclick   = ()=> goBack();
  if (UI.btnCerrar)  UI.btnCerrar.onclick = ()=> goBack();
  if (UI.btnReload)  UI.btnReload.onclick = ()=> load();
  if (UI.btnGuardar) UI.btnGuardar.onclick= ()=> guardar();
  if (UI.btnTerminar)UI.btnTerminar.onclick= ()=> terminarConsulta();

  if (UI.fecha_nacimiento) UI.fecha_nacimiento.addEventListener('change', renderEdad);
  if (UI.historia_clinica && UI.btnHC) {
    UI.historia_clinica.addEventListener('input', ()=>{
      UI.btnHC.href = UI.historia_clinica.value || '#';
      UI.btnHC.target = UI.historia_clinica.value ? '_blank' : '_self';
    });
  }
  if (UI.credencial && UI.btnCred) {
    UI.credencial.addEventListener('input', ()=>{
      UI.btnCred.href = UI.credencial.value || '#';
      UI.btnCred.target = UI.credencial.value ? '_blank' : '_self';
    });
  }

  // debug rápido (si te vuelve a salir el error de null):
  Object.entries(UI).forEach(([k,el])=>{ if (el==null) console.warn('Falta nodo UI:', k); });

  // init
  await load();
</script>
