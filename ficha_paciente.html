<script type="module">
  import supabase from './supabaseClient.js';

  /* ============== helpers UI ============== */
  const qs = (id) => document.getElementById(id);
  const UI = {
    root: qs('root'),
    status: qs('status'),
    btnBack: qs('btnBack'), btnReload: qs('btnReload'), btnCerrar: qs('btnCerrar'),
    btnGuardar: qs('btnGuardar'), btnTerminar: qs('btnTerminar'),
    // resumen
    p_prof: qs('p_prof'), p_centro: qs('p_centro'), p_dir: qs('p_dir'),
    p_fecha: qs('p_fecha'), p_hora: qs('p_hora'), p_copago: qs('p_copago'), p_estado: qs('p_estado'),
    // paciente
    dni: qs('dni'), apellido: qs('apellido'), nombre: qs('nombre'),
    fecha_nacimiento: qs('fecha_nacimiento'), edad: qs('edad'),
    telefono: qs('telefono'), email: qs('email'),
    historia_clinica: qs('historia_clinica'), btnHC: qs('btnHC'),
    obra_social: qs('obra_social'), numero_afiliado: qs('numero_afiliado'),
    credencial: qs('credencial'), btnCred: qs('btnCred'),
    contacto_nombre: qs('contacto_nombre'), contacto_apellido: qs('contacto_apellido'),
    contacto_celular: qs('contacto_celular'), vinculo: qs('vinculo'),
    notas: qs('notas'),
  };

  function setStatus(msg, tone=''){ UI.status.textContent=msg||''; UI.status.className='msg '+(tone||''); }

  const userRole = localStorage.getItem('user_role') || '';
  const isMedico = (userRole === 'medico');

  if (!isMedico) {
    // Asistente puede editar datos, pero no finalizar.
    UI.btnTerminar.style.display = 'none';
  }

  function pad(n){return n<10?'0'+n:''+n}
  function toHM(t){ return (t??'').toString().slice(0,5); }
  function nowHHMMSS(){ const d=new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}` }
  function calcEdad(f){ if(!f) return null; const d=new Date(f); if(isNaN(d)) return null; const t=new Date();
    let a=t.getFullYear()-d.getFullYear(); const m=t.getMonth()-d.getMonth();
    if (m<0 || (m===0 && t.getDate()<d.getDate())) a--; return Math.max(a,0);
  }
  function money(n){ return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0)); }

  /* ============== obtener TURNO_ID (querystring -> localStorage fallback) ============== */
  let TURNO_ID = new URLSearchParams(location.search).get('turno_id') || null;
  if (!TURNO_ID) {
    try { TURNO_ID = localStorage.getItem('current_turno_id') || null; } catch {}
  }
  if (!TURNO_ID) {
    setStatus('Falta parámetro turno_id', 'warn');
  }

  /* ============== catálogos ============== */
  async function loadObrasSociales(currentLabel){
    UI.obra_social.innerHTML = '<option value="">(Sin obra social)</option>';
    const { data, error } = await supabase
      .from('obras_sociales')
      .select('obra_social')
      .order('obra_social',{ascending:true});

    if (error) { console.error('Error obras_sociales:', error); }

    const labels = (data||[]).map(r=>r.obra_social);
    labels.forEach(lbl => {
      const opt=document.createElement('option'); opt.value=lbl; opt.textContent=lbl; UI.obra_social.appendChild(opt);
    });
    if (currentLabel && !labels.includes(currentLabel)) {
      const opt=document.createElement('option'); opt.value=currentLabel; opt.textContent=currentLabel; UI.obra_social.appendChild(opt);
    }
    UI.obra_social.value = currentLabel || '';
  }

  /* ============== cargar turno + paciente (2 pasos, robusto) ============== */
  let turno = null;
  let pacienteId = null;

  async function load(){
    if (!TURNO_ID){ setStatus('Falta parámetro turno_id', 'warn'); return; }
    setStatus('Cargando...');

    // 1) Traer el turno "plano"
    const { data: t, error: terr } = await supabase
      .from('turnos')
      .select('id, fecha, hora_inicio, hora_fin, estado, hora_arribo, copago, notas, paciente_id, profesional_id, centro_id')
      .eq('id', TURNO_ID)
      .maybeSingle();

    if (terr || !t){
      console.error('Error cargando turno:', terr);
      setStatus('No se pudo cargar el turno', 'warn');
      return;
    }
    turno = t;
    pacienteId = t.paciente_id;

    // 2) Traer entidades relacionadas por separado
    const [pRes, profRes, centroRes] = await Promise.all([
      supabase.from('pacientes').select(
        'id, dni, apellido, nombre, fecha_nacimiento, telefono, email, '+
        'obra_social, numero_afiliado, credencial, contacto_nombre, contacto_apellido, '+
        'contacto_celular, vinculo, historia_clinica'
      ).eq('id', t.paciente_id).maybeSingle(),

      supabase.from('profesionales').select('id, display_name, nombre, apellido')
        .eq('id', t.profesional_id).maybeSingle(),

      supabase.from('centros_medicos').select('id, nombre, direccion')
        .eq('id', t.centro_id).maybeSingle(),
    ]);

    const prof = profRes?.data || null;
    const centro = centroRes?.data || null;
    const p = pRes?.data || null;

    // resumen
    const profLabel = prof ? (prof.display_name || [prof.apellido, prof.nombre].filter(Boolean).join(', ')) : '—';
    UI.p_prof.textContent = `Profesional: ${profLabel}`;
    UI.p_centro.textContent = `Centro: ${centro?.nombre || '—'}`;
    UI.p_dir.textContent    = `Dirección: ${centro?.direccion || '—'}`;
    UI.p_fecha.textContent  = `Fecha: ${turno.fecha || '—'}`;
    UI.p_hora.textContent   = `Hora: ${turno.hora_inicio ? toHM(turno.hora_inicio) : '—'}`;
    UI.p_copago.textContent = `Copago: ${turno.copago!=null ? money(turno.copago) : '—'}`;
    UI.p_estado.textContent = `Estado: ${turno.estado || '—'}`;
    UI.notas.value          = turno.notas || '';

    // paciente
    if (p){
      UI.dni.value = p.dni || '';
      UI.apellido.value = p.apellido || '';
      UI.nombre.value = p.nombre || '';
      UI.fecha_nacimiento.value = p.fecha_nacimiento || '';
      renderEdad();
      UI.telefono.value = p.telefono || '';
      UI.email.value = p.email || '';
      UI.historia_clinica.value = p.historia_clinica || '';
      UI.btnHC.href  = p.historia_clinica ? p.historia_clinica : '#';
      UI.btnHC.target = p.historia_clinica ? '_blank' : '_self';

      await loadObrasSociales(p.obra_social || '');
      UI.numero_afiliado.value = p.numero_afiliado || '';
      UI.credencial.value = p.credencial || '';
      UI.btnCred.href  = p.credencial ? p.credencial : '#';
      UI.btnCred.target = p.credencial ? '_blank' : '_self';

      UI.contacto_nombre.value = p.contacto_nombre || '';
      UI.contacto_apellido.value = p.contacto_apellido || '';
      UI.contacto_celular.value = p.contacto_celular || '';
      UI.vinculo.value = p.vinculo || '';
    } else {
      await loadObrasSociales('');
    }

    setStatus('');
  }

  function renderEdad(){
    const a = calcEdad(UI.fecha_nacimiento.value);
    UI.edad.textContent = (a==null) ? '—' : `${a} años`;
  }

  /* ============== guardar paciente + notas ============== */
  function validate(){
    const req = [
      ['dni', UI.dni.value.trim()],
      ['apellido', UI.apellido.value.trim()],
      ['nombre', UI.nombre.value.trim()],
      ['fecha_nacimiento', UI.fecha_nacimiento.value],
      ['telefono', UI.telefono.value.trim()],
    ];
    const faltan = req.filter(([,v])=>!v);
    if (faltan.length){ setStatus('Faltan campos obligatorios', 'warn'); return false; }
    return true;
  }

  async function guardar(){
    if (!validate()) return;
    setStatus('Guardando...');

    const payloadP = {
      dni: UI.dni.value.trim(),
      apellido: UI.apellido.value.trim(),
      nombre: UI.nombre.value.trim(),
      fecha_nacimiento: UI.fecha_nacimiento.value || null,
      telefono: UI.telefono.value.trim() || null,
      email: UI.email.value.trim() || null,
      obra_social: UI.obra_social.value || null,
      numero_afiliado: UI.numero_afiliado.value.trim() || null,
      credencial: UI.credencial.value.trim() || null,
      contacto_nombre: UI.contacto_nombre.value.trim() || null,
      contacto_apellido: UI.contacto_apellido.value.trim() || null,
      contacto_celular: UI.contacto_celular.value.trim() || null,
      vinculo: UI.vinculo.value.trim() || null,
      historia_clinica: UI.historia_clinica.value.trim() || null,
    };

    const [r1, r2] = await Promise.all([
      supabase.from('pacientes').update(payloadP).eq('id', pacienteId),
      supabase.from('turnos').update({ notas: UI.notas.value || null }).eq('id', TURNO_ID),
    ]);

    if (r1.error){ setStatus('Error guardando paciente: '+r1.error.message, 'warn'); return; }
    if (r2.error){ setStatus('Error guardando notas: '+r2.error.message, 'warn'); return; }
    setStatus('Cambios guardados.', 'ok');
    setTimeout(()=>setStatus(''), 1800);
  }

  /* ============== terminar consulta (solo médico) ============== */
  async function terminarConsulta(){
    if (!isMedico){ alert('Solo los médicos pueden terminar la consulta.'); return; }
    if (!confirm('¿Marcar este turno como FINALIZADO?')) return;
    setStatus('Finalizando...');

    const { error } = await supabase
      .from('turnos')
      .update({ estado: 'finalizado', hora_fin: nowHHMMSS() }) // consistente con tu tablero
      .eq('id', TURNO_ID);

    if (error){
      alert('No se pudo marcar FINALIZADO.');
      setStatus('No se pudo finalizar.', 'warn'); return;
    }
    setStatus('Consulta finalizada.', 'ok');
    try{ if (window.opener) window.opener.postMessage({type:'turno_finalizado', id:TURNO_ID}, '*'); }catch{}
    setTimeout(()=>window.close(), 900);
  }

  /* ============== eventos ============== */
  UI.btnBack.onclick = ()=> window.close();
  UI.btnCerrar.onclick = ()=> window.close();
  UI.btnReload.onclick = ()=> load();
  UI.btnGuardar.onclick = ()=> guardar();
  UI.btnTerminar.onclick = ()=> terminarConsulta();

  UI.fecha_nacimiento.addEventListener('change', renderEdad);
  UI.historia_clinica.addEventListener('input', ()=>{
    UI.btnHC.href = UI.historia_clinica.value || '#';
    UI.btnHC.target = UI.historia_clinica.value ? '_blank' : '_self';
  });
  UI.credencial.addEventListener('input', ()=>{
    UI.btnCred.href = UI.credencial.value || '#';
    UI.btnCred.target = UI.credencial.value ? '_blank' : '_self';
  });

  // init
  await load();
</script>
