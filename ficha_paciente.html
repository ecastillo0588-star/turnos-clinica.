<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ficha Paciente ‚Äî EG Health Solutions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#7656b0; --brand2:#a490d7; --ink:#381e60; --muted:#6b6480;
      --bg:#f7f9fb; --card:#fff; --line:#ece5fc; --ok:#0a7d38; --warn:#8a5800;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:'Segoe UI',Arial,sans-serif;color:var(--ink)}
    .shell{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:18px}
    .modal{
      width:min(1100px,96vw); max-height:92vh; background:var(--card);
      border:1px solid var(--line); border-radius:14px; box-shadow:0 10px 40px rgba(0,0,0,.20);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .head{display:flex;align-items:center;gap:12px;padding:12px;background:#e8def8;border-bottom:1px solid var(--line)}
    .head h2{margin:0;font-size:18px;color:#4b3a78;display:flex;gap:10px;align-items:center}
    .head .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:58vw}
    .iconbtn{border:none;background:transparent;cursor:pointer;font-size:18px;padding:6px 8px;border-radius:8px}
    .iconbtn:hover{background:rgba(0,0,0,.06)}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#f2effc;border:1px solid var(--line);color:#4b3a78;padding:6px 10px;border-radius:999px;font-size:13px}
    .spacer{flex:1}
    .content{padding:14px;overflow:auto}
    .krow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;min-width:820px}
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px}
    h3{margin:0 0 10px 0;font-size:15px;color:#4b3a78}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted)}
    .inp,.sel,textarea{
      background:#f7f9fb;border:1px solid var(--line);border-radius:8px;padding:9px 10px;font-size:14px;outline:none;color:#333;width:100%;
    }
    .inp:focus,.sel:focus,textarea:focus{border-color:var(--brand2)}
    textarea{resize:vertical;min-height:70px}
    .req::after{content:' *';color:#b00020}
    .age{display:inline-flex;align-items:center;gap:6px;background:#eef7ff;border:1px solid #cfe6ff;color:#0b4c8a;border-radius:999px;padding:2px 8px;font-size:12px}
    .foot{padding:10px 12px;border-top:1px solid var(--line);background:#faf7ff;display:flex;gap:10px;align-items:center}
    .right{margin-left:auto}
    .btn{appearance:none;border:none;border-radius:8px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.ghost{background:#f2effc;border:1px solid var(--line);color:#4b3a78}
    .btn.success{background:#0f9960;color:#fff}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .msg{font-size:13px}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    .hl{background:#fff;border:2px dashed #e0d6ff}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="shell">
    <section class="modal" id="root">
      <header class="head">
        <button id="btnBack" class="iconbtn" title="Volver">‚¨ÖÔ∏è</button>
        <h2>
          <span class="name" id="hdrName">Ficha Paciente</span>
          <a id="hdrHC" class="iconbtn" href="#" target="_blank" rel="noopener" title="Abrir historia cl√≠nica" style="opacity:.5">üìÑ</a>
        </h2>
        <span class="spacer"></span>
        <div class="pill" id="hdrDNI">DNI: ‚Äî</div>
        <button id="btnReload" class="iconbtn" title="Actualizar ficha">üîÑ</button>
      </header>

      <div class="content">
        <!-- Resumen del turno -->
        <div class="krow" id="resumen">
          <span class="pill" id="p_prof">Profesional: ‚Äî</span>
          <span class="pill" id="p_centro">Centro: ‚Äî</span>
          <span class="pill" id="p_dir">Direcci√≥n: ‚Äî</span>
          <span class="pill" id="p_fecha">Fecha: ‚Äî</span>
          <span class="pill" id="p_hora">Hora: ‚Äî</span>
          <span class="pill" id="p_copago">Copago: ‚Äî</span>
          <span class="pill" id="p_estado">Estado: ‚Äî</span>
        </div>

        <div class="grid">
          <!-- Datos del paciente -->
          <div class="card">
            <h3>Datos del paciente</h3>

            <div class="row3">
              <div class="field"><label class="req">DNI</label><input id="dni" class="inp" /></div>
              <div class="field"><label class="req">Apellido</label><input id="apellido" class="inp" /></div>
              <div class="field"><label class="req">Nombre</label><input id="nombre" class="inp" /></div>
            </div>

            <div class="row3">
              <div class="field"><label>Fecha de nacimiento</label><input id="fecha_nacimiento" type="date" class="inp" /></div>
              <div class="field"><label>Edad</label><div id="edad" class="age">‚Äî</div></div>
              <div class="field"><label>Activo</label>
                <label style="display:inline-flex;align-items:center;gap:8px">
                  <input id="activo" type="checkbox"> Activo en el sistema
                </label>
              </div>
            </div>

            <div class="row2">
              <div class="field"><label>Tel√©fono</label><input id="telefono" class="inp" /></div>
              <div class="field"><label>Email</label><input id="email" class="inp" placeholder="correo@dominio.com" /></div>
            </div>

            <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

            <h3>Historia cl√≠nica</h3>
            <div class="field">
              <label>URL (GDrive, PDF, etc.)</label>
              <div style="display:flex;gap:8px;align-items:center">
                <input id="historia_clinica" class="inp" placeholder="https://..." />
                <a id="btnHC" class="btn ghost" href="#" target="_blank" rel="noopener">Abrir</a>
              </div>
            </div>

            <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

            <h3>Seguimiento</h3>
            <div class="row2">
              <div class="field"><label>Pr√≥ximo control</label><input id="proximo_control" type="date" class="inp" /></div>
              <div class="field"><label>Renovaci√≥n de receta</label><input id="renovacion_receta" type="date" class="inp" /></div>
            </div>
          </div>

          <!-- Obra social + contacto de emergencia + notas del turno -->
          <div class="card">
            <h3>Obra social</h3>
            <div class="row3">
              <div class="field">
                <label>Obra social</label>
                <select id="obra_social" class="sel"></select>
              </div>
              <div class="field"><label>N¬∞ afiliado</label><input id="numero_afiliado" class="inp" /></div>
              <div class="field">
                <label>Credencial (URL imagen)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input id="credencial" class="inp" placeholder="https://..." />
                  <a id="btnCred" class="btn ghost" href="#" target="_blank" rel="noopener">Ver</a>
                </div>
              </div>
            </div>

            <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

            <h3>Contacto de emergencia</h3>
            <div class="row2">
              <div class="field"><label>Nombre</label><input id="contacto_nombre" class="inp" /></div>
              <div class="field"><label>Apellido</label><input id="contacto_apellido" class="inp" /></div>
            </div>
            <div class="row2">
              <div class="field"><label>Celular</label><input id="contacto_celular" class="inp" /></div>
              <div class="field"><label>V√≠nculo</label><input id="vinculo" class="inp" /></div>
            </div>

            <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

            <h3>Notas del turno</h3>
            <div class="field"><textarea id="notas" class="inp" placeholder="Observaciones internas..."></textarea></div>
          </div>
        </div>
      </div>

      <footer class="foot" id="foot">
        <span id="status" class="msg"></span>
        <div class="right">
          <button id="btnGuardar" class="btn primary">Guardar cambios</button>
          <button id="btnTerminar" class="btn success">Finalizar turno</button>
          <button id="btnCerrar" class="btn ghost">Volver</button>
        </div>
      </footer>
    </section>
  </div>

  <script type="module">
    import supabase from './supabaseClient.js';

    /* ============== helpers UI ============== */
    const qs = (id) => document.getElementById(id);
    const UI = {
      // header
      hdrName: qs('hdrName'), hdrHC: qs('hdrHC'), hdrDNI: qs('hdrDNI'),
      // resumen
      p_prof: qs('p_prof'), p_centro: qs('p_centro'), p_dir: qs('p_dir'),
      p_fecha: qs('p_fecha'), p_hora: qs('p_hora'), p_copago: qs('p_copago'), p_estado: qs('p_estado'),
      // patient form
      dni: qs('dni'), apellido: qs('apellido'), nombre: qs('nombre'),
      fecha_nacimiento: qs('fecha_nacimiento'), edad: qs('edad'), activo: qs('activo'),
      telefono: qs('telefono'), email: qs('email'),
      historia_clinica: qs('historia_clinica'), btnHC: qs('btnHC'),
      proximo_control: qs('proximo_control'), renovacion_receta: qs('renovacion_receta'),
      obra_social: qs('obra_social'), numero_afiliado: qs('numero_afiliado'),
      credencial: qs('credencial'), btnCred: qs('btnCred'),
      contacto_nombre: qs('contacto_nombre'), contacto_apellido: qs('contacto_apellido'),
      contacto_celular: qs('contacto_celular'), vinculo: qs('vinculo'),
      // acciones
      notas: qs('notas'),
      // footer
      status: qs('status'),
      btnBack: qs('btnBack'), btnReload: qs('btnReload'), btnCerrar: qs('btnCerrar'),
      btnGuardar: qs('btnGuardar'), btnTerminar: qs('btnTerminar'),
    };

    // helpers
    function pad(n){return n<10?'0'+n:''+n}
    function toHM(t){ return (t??'').toString().slice(0,5); }
    function nowHHMMSS(){ const d=new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}` }
    function calcEdad(f){ if(!f) return null; const d=new Date(f); if(isNaN(d)) return null; const t=new Date();
      let a=t.getFullYear()-d.getFullYear(); const m=t.getMonth()-d.getMonth();
      if (m<0 || (m===0 && t.getDate()<d.getDate())) a--; return Math.max(a,0);
    }
    function money(n){ return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0)); }
    function setStatus(msg, tone=''){ UI.status.textContent=msg||''; UI.status.className='msg '+(tone||''); }

    // roles
    const userRole = localStorage.getItem('user_role') || '';
    const isMedico = userRole === 'medico';
    if (!isMedico) UI.btnTerminar.style.display = 'none';

    /* ============== obtener TURNO_ID ============== */
    let TURNO_ID = new URLSearchParams(location.search).get('turno_id') || null;
    if (!TURNO_ID) { try { TURNO_ID = localStorage.getItem('current_turno_id') || null; } catch {} }
    if (!TURNO_ID) { setStatus('Falta par√°metro turno_id', 'warn'); }

    /* ============== cat√°logos ============== */
    async function loadObrasSociales(currentLabel){
      UI.obra_social.innerHTML = '<option value="">(Sin obra social)</option>';
      const { data, error } = await supabase.from('obras_sociales').select('obra_social').order('obra_social',{ascending:true});
      if (error) console.warn('Error obras_sociales:', error);
      const labels = (data||[]).map(r=>r.obra_social);
      labels.forEach(lbl => {
        const opt=document.createElement('option'); opt.value=lbl; opt.textContent=lbl; UI.obra_social.appendChild(opt);
      });
      if (currentLabel && !labels.includes(currentLabel)) {
        const opt=document.createElement('option'); opt.value=currentLabel; opt.textContent=currentLabel; UI.obra_social.appendChild(opt);
      }
      UI.obra_social.value = currentLabel || '';
    }

    /* ============== cargar turno + paciente ============== */
    let turno=null, pacienteId=null;

    async function load(){
      if (!TURNO_ID){ setStatus('Falta par√°metro turno_id', 'warn'); return; }
      setStatus('Cargando...');

      // turno base (sin joins complejos)
      const { data: t, error: terr } = await supabase
        .from('turnos')
        .select('id, fecha, hora_inicio, hora_fin, estado, hora_arribo, copago, notas, paciente_id, profesional_id, centro_id')
        .eq('id', TURNO_ID)
        .maybeSingle();

      if (terr || !t){
        console.error('Error cargando turno:', terr);
        setStatus('No se pudo cargar el turno', 'warn');
        return;
      }
      turno = t; pacienteId = t.paciente_id;

      // relacionados
      const [pRes, profRes, centroRes] = await Promise.all([
        supabase.from('pacientes').select('id, dni, apellido, nombre, fecha_nacimiento, telefono, email, obra_social, numero_afiliado, credencial, contacto_nombre, contacto_apellido, contacto_celular, vinculo, historia_clinica, proximo_control, renovacion_receta, activo').eq('id', t.paciente_id).maybeSingle(),
        supabase.from('profesionales').select('id, display_name, nombre, apellido').eq('id', t.profesional_id).maybeSingle(),
        supabase.from('centros_medicos').select('id, nombre, direccion').eq('id', t.centro_id).maybeSingle(),
      ]);

      const prof = profRes?.data || null;
      const centro = centroRes?.data || null;
      const p = pRes?.data || null;

      // encabezado
      const nombreCompleto = p ? ([p.apellido, p.nombre].filter(Boolean).join(', ') || '‚Äî') : '‚Äî';
      UI.hdrName.textContent = nombreCompleto;
      UI.hdrDNI.textContent = `DNI: ${p?.dni || '‚Äî'}`;
      const hc = (p?.historia_clinica||'').trim();
      UI.hdrHC.href = hc || '#';
      UI.hdrHC.target = hc ? '_blank' : '_self';
      UI.hdrHC.style.opacity = hc ? '1' : '.5';

      // resumen
      const profLabel = prof ? (prof.display_name || [prof.apellido, prof.nombre].filter(Boolean).join(', ')) : '‚Äî';
      UI.p_prof.textContent = `Profesional: ${profLabel}`;
      UI.p_centro.textContent = `Centro: ${centro?.nombre || '‚Äî'}`;
      UI.p_dir.textContent    = `Direcci√≥n: ${centro?.direccion || '‚Äî'}`;
      UI.p_fecha.textContent  = `Fecha: ${turno.fecha || '‚Äî'}`;
      UI.p_hora.textContent   = `Hora: ${turno.hora_inicio ? toHM(turno.hora_inicio) : '‚Äî'}`;
      UI.p_copago.textContent = `Copago: ${turno.copago!=null ? money(turno.copago) : '‚Äî'}`;
      UI.p_estado.textContent = `Estado: ${turno.estado || '‚Äî'}`;
      UI.notas.value          = turno.notas || '';

      // paciente
      if (p){
        UI.dni.value = p.dni || ''; UI.apellido.value = p.apellido || ''; UI.nombre.value = p.nombre || '';
        UI.fecha_nacimiento.value = p.fecha_nacimiento || ''; renderEdad();
        UI.activo.checked = !!p.activo;
        UI.telefono.value = p.telefono || ''; UI.email.value = p.email || '';
        UI.historia_clinica.value = p.historia_clinica || '';
        UI.btnHC.href  = p.historia_clinica ? p.historia_clinica : '#';
        UI.btnHC.target = p.historia_clinica ? '_blank' : '_self';

        await loadObrasSociales(p.obra_social || '');
        UI.numero_afiliado.value = p.numero_afiliado || '';
        UI.credencial.value = p.credencial || '';
        UI.btnCred.href  = p.credencial ? p.credencial : '#';
        UI.btnCred.target = p.credencial ? '_blank' : '_self';

        UI.contacto_nombre.value = p.contacto_nombre || '';
        UI.contacto_apellido.value = p.contacto_apellido || '';
        UI.contacto_celular.value = p.contacto_celular || '';
        UI.vinculo.value = p.vinculo || '';

        UI.proximo_control.value = p.proximo_control || '';
        UI.renovacion_receta.value = p.renovacion_receta || '';
      } else {
        await loadObrasSociales('');
      }

      setStatus('');
    }

    function renderEdad(){
      const a = calcEdad(UI.fecha_nacimiento.value);
      UI.edad.textContent = (a==null) ? '‚Äî' : `${a} a√±os`;
    }

    /* ============== guardar paciente + notas ============== */
    function validate(){
      const req = [
        ['dni', UI.dni.value.trim()],
        ['apellido', UI.apellido.value.trim()],
        ['nombre', UI.nombre.value.trim()],
      ];
      const faltan = req.filter(([,v])=>!v);
      if (faltan.length){ setStatus('Faltan DNI/Apellido/Nombre', 'warn'); return false; }
      return true;
    }

    async function guardar(){
      if (!validate()) return;
      setStatus('Guardando...');

      const payloadP = {
        dni: UI.dni.value.trim(),
        apellido: UI.apellido.value.trim(),
        nombre: UI.nombre.value.trim(),
        fecha_nacimiento: UI.fecha_nacimiento.value || null,
        activo: !!UI.activo.checked,
        telefono: UI.telefono.value.trim() || null,
        email: UI.email.value.trim() || null,
        obra_social: UI.obra_social.value || null,
        numero_afiliado: UI.numero_afiliado.value.trim() || null,
        credencial: UI.credencial.value.trim() || null,
        contacto_nombre: UI.contacto_nombre.value.trim() || null,
        contacto_apellido: UI.contacto_apellido.value.trim() || null,
        contacto_celular: UI.contacto_celular.value.trim() || null,
        vinculo: UI.vinculo.value.trim() || null,
        historia_clinica: UI.historia_clinica.value.trim() || null,
        proximo_control: UI.proximo_control.value || null,
        renovacion_receta: UI.renovacion_receta.value || null,
      };

      const [r1, r2] = await Promise.all([
        supabase.from('pacientes').update(payloadP).eq('id', pacienteId),
        supabase.from('turnos').update({ notas: UI.notas.value || null }).eq('id', TURNO_ID),
      ]);

      if (r1.error){ setStatus('Error guardando paciente: '+r1.error.message, 'warn'); return; }
      if (r2.error){ setStatus('Error guardando notas: '+r2.error.message, 'warn'); return; }
      setStatus('Cambios guardados.', 'ok');
      setTimeout(()=>setStatus(''), 1800);
    }

    /* ============== terminar consulta (solo m√©dico) ============== */
    async function terminarConsulta(){
      if (!isMedico){ alert('Solo los m√©dicos pueden finalizar.'); return; }
      if (!confirm('¬øMarcar este turno como FINALIZADO?')) return;
      setStatus('Finalizando...');

      const { error } = await supabase
        .from('turnos')
        .update({ estado: 'finalizado', hora_fin: nowHHMMSS() })
        .eq('id', TURNO_ID);

      if (error){
        setStatus('No se pudo finalizar: '+error.message, 'warn'); return;
      }
      setStatus('Turno finalizado.', 'ok');
      setTimeout(()=>goBack(), 800);
    }

    /* ============== navegaci√≥n ============== */
    function goBack(){
      const backTo = (localStorage.getItem('inicio_url') || '');
      if (backTo) { window.location.href = backTo; return; }
      if (history.length > 1) { history.back(); return; }
      window.location.href = 'index.html';
    }

    /* ============== bindings ============== */
    UI.btnBack.onclick = ()=> goBack();
    UI.btnCerrar.onclick = ()=> goBack();
    UI.btnReload.onclick = ()=> load();
    UI.btnGuardar.onclick = ()=> guardar();
    UI.btnTerminar.onclick = ()=> terminarConsulta();

    UI.fecha_nacimiento.addEventListener('change', renderEdad);
    UI.historia_clinica.addEventListener('input', ()=>{
      UI.btnHC.href = UI.historia_clinica.value || '#';
      UI.btnHC.target = UI.historia_clinica.value ? '_blank' : '_self';
      UI.hdrHC.href = UI.historia_clinica.value || '#';
      UI.hdrHC.target = UI.historia_clinica.value ? '_blank' : '_self';
      UI.hdrHC.style.opacity = UI.historia_clinica.value ? '1' : '.5';
    });
    UI.credencial.addEventListener('input', ()=>{
      UI.btnCred.href = UI.credencial.value || '#';
      UI.btnCred.target = UI.credencial.value ? '_blank' : '_self';
    });

    // init
    await load();
  </script>
</body>
</html>
