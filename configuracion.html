<div class="card config-grid">
  <div class="config-left">
    <h2>Configuración de Agenda</h2>
    <form id="config-form">
      <div id="turnos-list"></div>
      <button type="button" class="btn" id="btn-agregar-turno" style="margin-top:8px;">Agregar turno</button>
      <div class="actions" style="margin-top:24px;">
        <button type="submit" class="btn primary">Guardar configuración</button>
      </div>
    </form>
  </div>
  <!-- ... resto del panel asistentes ... -->
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
const supabaseUrl = 'https://vwkszvdvswznlgxlfdtz.supabase.co';
const supabaseAnonKey = 'eyJ...'; // tu key real aquí
const supabase = createClient(supabaseUrl, supabaseAnonKey);
const profesional_id = localStorage.getItem('profesional_id');

const DIAS = ['lunes','martes','miercoles','jueves','viernes','sabado','domingo'];

function crearTurnoHTML(turno = {}) {
  // turno: {dias:[], hora_inicio:'', hora_fin:''}
  const idx = turno.idx !== undefined ? turno.idx : Date.now();
  return `
    <div class="turno-row" data-idx="${idx}">
      <div>
        <label>Días:</label>
        <div style="display:flex;gap:8px;">
          ${DIAS.map(dia => `
            <label>
              <input type="checkbox" name="dias_${idx}" value="${dia}" ${turno.dias && turno.dias.includes(dia)?'checked':''}> ${dia.slice(0,3)}
            </label>
          `).join('')}
        </div>
      </div>
      <div>
        <label>Horario:</label>
        <input type="time" name="hora_inicio_${idx}" value="${turno.hora_inicio||''}" required>
        <span>-</span>
        <input type="time" name="hora_fin_${idx}" value="${turno.hora_fin||''}" required>
      </div>
      <button type="button" class="btn btn-quitar-turno" style="margin-left:10px;">Quitar</button>
    </div>
  `;
}

function renderTurnos(turnos) {
  const cont = document.getElementById('turnos-list');
  cont.innerHTML = '';
  turnos.forEach((turno, idx) => {
    turno.idx = idx;
    cont.innerHTML += crearTurnoHTML(turno);
  });
  // Listeners para quitar turno
  cont.querySelectorAll('.btn-quitar-turno').forEach((btn, idx) => {
    btn.onclick = () => {
      turnos.splice(idx,1);
      renderTurnos(turnos);
    };
  });
}

let turnosActuales = [];

async function cargarTurnos() {
  // Obtener los turnos de ese profesional
  const { data } = await supabase
    .from('profesional_turnos')
    .select('*')
    .eq('profesional_id', profesional_id);
  turnosActuales = data ? data.map(t=>({
    dias: t.dias,
    hora_inicio: t.hora_inicio,
    hora_fin: t.hora_fin
  })) : [];
  renderTurnos(turnosActuales.length ? turnosActuales : [{dias:[],hora_inicio:'',hora_fin:''}]);
}
cargarTurnos();

document.getElementById('btn-agregar-turno').onclick = () => {
  turnosActuales.push({dias:[],hora_inicio:'',hora_fin:''});
  renderTurnos(turnosActuales);
};

document.getElementById('config-form').addEventListener('submit', async function(e){
  e.preventDefault();
  // Recoger todos los turnos del DOM
  const turnos = [];
  document.querySelectorAll('.turno-row').forEach(row=>{
    const idx = row.getAttribute('data-idx');
    const dias = Array.from(row.querySelectorAll(`[name="dias_${idx}"]:checked`)).map(cb=>cb.value);
    const hora_inicio = row.querySelector(`[name="hora_inicio_${idx}"]`).value;
    const hora_fin = row.querySelector(`[name="hora_fin_${idx}"]`).value;
    if(dias.length && hora_inicio && hora_fin) {
      turnos.push({dias, hora_inicio, hora_fin});
    }
  });
  // Elimina todos los turnos previos y guarda los nuevos (puedes optimizar si quieres editar/actualizar)
  await supabase.from('profesional_turnos').delete().eq('profesional_id', profesional_id);
  for(const turno of turnos) {
    await supabase.from('profesional_turnos').insert([{profesional_id, ...turno}]);
  }
  alert('Turnos guardados');
  cargarTurnos();
});
</script>

<style>
.config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; max-width: 1050px; margin: 32px auto; }
.turno-row { display:flex;align-items:center;gap:22px;margin-bottom:14px;padding-bottom:6px;border-bottom:1px solid #eee;}
@media (max-width: 900px) { .config-grid { grid-template-columns: 1fr; } }
</style>
