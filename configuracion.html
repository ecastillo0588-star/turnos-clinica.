<!-- Generador de Agenda de Disponibilidad de Turnos -->
<div class="card agenda-generador">
  <h2>Generar Agenda de Disponibilidad</h2>
  <!-- Bloque de Fechas y Centro -->
  <section class="bloque-fechas">
    <div style="display:flex;gap:24px;align-items:center;">
      <div>
        <label for="fecha-inicio"><b>Fecha inicio</b></label><br>
        <input type="date" id="fecha-inicio" required>
      </div>
      <div>
        <label for="fecha-fin"><b>Fecha fin</b></label><br>
        <input type="date" id="fecha-fin" required>
      </div>
      <div>
        <label for="centro-agenda"><b>Centro médico</b></label><br>
        <select id="centro-agenda" required style="min-width:180px;"></select>
      </div>
    </div>
  </section>

  <!-- Bloque de Horarios por Día -->
  <section class="bloque-horario-dias" style="margin-top:24px;">
    <h3>Horarios por Día</h3>
    <table class="horarios-table">
      <thead>
        <tr>
          <th>Día</th>
          <th>Turno Mañana<br><small>Hora inicio</small></th>
          <th>Turno Mañana<br><small>Hora fin</small></th>
          <th>Turno Tarde<br><small>Hora inicio</small></th>
          <th>Turno Tarde<br><small>Hora fin</small></th>
          <th>Habilitar</th>
        </tr>
      </thead>
      <tbody id="horarios-body">
        <!-- Se llena por JS -->
      </tbody>
    </table>
  </section>

  <!-- Bloque de Duración de Turno -->
  <section class="bloque-duracion-turno" style="margin-top:18px;">
    <label for="duracion-turno"><b>Duración de cada turno</b></label>
    <select id="duracion-turno" required>
      <!-- Opciones por JS -->
    </select>
  </section>

  <!-- Acción -->
  <div class="actions" style="margin-top:32px;">
    <button class="btn primary" id="btn-generar-agenda">Generar agenda</button>
  </div>

  <!-- Mensajes -->
  <div id="msg-agenda" style="margin-top:22px;"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
const supabaseUrl = 'https://vwkszvdvswznlgxlfdtz.supabase.co';
const supabaseAnonKey = 'eyJ...'; // tu key aquí
const supabase = createClient(supabaseUrl, supabaseAnonKey);

const profesional_id = localStorage.getItem('profesional_id');
const DIAS = [
  {nombre:'lunes', label:'LUN'},
  {nombre:'martes', label:'MAR'},
  {nombre:'miercoles', label:'MIÉR'},
  {nombre:'jueves', label:'JUEV'},
  {nombre:'viernes', label:'VIER'},
  {nombre:'sabado', label:'SÁB'}
];

// Rellenar duración: desde 10 min, luego cada 5 hasta 60
const selectDuracion = document.getElementById('duracion-turno');
for(let i=10; i<=60; i+=5){
  const opt = document.createElement('option');
  opt.value = i;
  opt.textContent = i + ' min';
  selectDuracion.appendChild(opt);
}

// Cargar centros médicos asociados
async function cargarCentros() {
  const { data: vinculos } = await supabase
    .from('profesional_centro')
    .select('centro_id')
    .eq('profesional_id', profesional_id)
    .eq('activo', true);
  const centro_ids = vinculos ? vinculos.map(v=>v.centro_id) : [];
  const { data: centros } = await supabase
    .from('centros_medicos')
    .select('id,nombre')
    .in('id', centro_ids);
  const selector = document.getElementById('centro-agenda');
  selector.innerHTML = '';
  centros.forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.nombre;
    selector.appendChild(opt);
  });
}
cargarCentros();

// Renderizar la tabla de horarios/días
function renderTablaHorarios() {
  const tbody = document.getElementById('horarios-body');
  tbody.innerHTML = '';
  DIAS.forEach((dia, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><b>${dia.label}</b></td>
      <td><input type="time" name="tm_ini_${idx}" style="width:84px;"></td>
      <td><input type="time" name="tm_fin_${idx}" style="width:84px;"></td>
      <td><input type="time" name="tt_ini_${idx}" style="width:84px;"></td>
      <td><input type="time" name="tt_fin_${idx}" style="width:84px;"></td>
      <td><input type="checkbox" name="hab_${idx}" checked></td>
    `;
    tbody.appendChild(tr);
  });
}
renderTablaHorarios();

// Generar agenda al hacer click
document.getElementById('btn-generar-agenda').onclick = async function() {
  const msg = document.getElementById('msg-agenda');
  msg.textContent = '';
  // 1. Fechas y centro
  const fecha_inicio = document.getElementById('fecha-inicio').value;
  const fecha_fin = document.getElementById('fecha-fin').value;
  const centro_id = document.getElementById('centro-agenda').value;
  const duracion_turno = Number(document.getElementById('duracion-turno').value);
  if(!fecha_inicio || !fecha_fin || !centro_id){
    msg.textContent = "Seleccione fechas y centro médico.";
    return;
  }
  // 2. Recopilar horarios por día
  const turnos = [];
  DIAS.forEach((dia, idx)=>{
    const habilitado = document.querySelector(`[name="hab_${idx}"]`).checked;
    if(!habilitado) return;
    // Mañana
    const tm_ini = document.querySelector(`[name="tm_ini_${idx}"]`).value;
    const tm_fin = document.querySelector(`[name="tm_fin_${idx}"]`).value;
    if(tm_ini && tm_fin && tm_ini < tm_fin){
      turnos.push({dia:dia.nombre, turno:'mañana', hora_inicio:tm_ini, hora_fin:tm_fin});
    }
    // Tarde
    const tt_ini = document.querySelector(`[name="tt_ini_${idx}"]`).value;
    const tt_fin = document.querySelector(`[name="tt_fin_${idx}"]`).value;
    if(tt_ini && tt_fin && tt_ini < tt_fin){
      turnos.push({dia:dia.nombre, turno:'tarde', hora_inicio:tt_ini, hora_fin:tt_fin});
    }
  });
  if(turnos.length===0){
    msg.textContent = "Configure al menos un horario válido para algún día.";
    return;
  }

  // 3. Generar slots de agenda
  msg.textContent = "Generando agenda...";
  let totalSlots = 0;
  let fechaActual = new Date(fecha_inicio);
  const fechaFin = new Date(fecha_fin);
  while(fechaActual <= fechaFin){
    const diaSemana = DIAS[fechaActual.getDay()];
    if(!diaSemana) { fechaActual.setDate(fechaActual.getDate()+1); continue; }
    const diaTurnos = turnos.filter(t=>t.dia===diaSemana.nombre);
    for(const t of diaTurnos){
      // Genera slots de la franja para ese día
      let hIni = toMinutes(t.hora_inicio);
      let hFin = toMinutes(t.hora_fin);
      for(let m=hIni; m+duracion_turno<=hFin; m+=duracion_turno){
        const hora_inicio = toHoraStr(m);
        const hora_fin = toHoraStr(m+duracion_turno);
        // Guardar slot en agenda
        await supabase
          .from('agenda')
          .upsert({
            centro_id,
            profesional_id,
            fecha: fechaActual.toISOString().slice(0,10),
            hora_inicio,
            hora_fin,
            capacidad: 1,
            estado: 'disponible'
          }, { onConflict: ['centro_id','profesional_id','fecha','hora_inicio','hora_fin'] });
        totalSlots++;
      }
    }
    fechaActual.setDate(fechaActual.getDate()+1);
  }
  msg.textContent = `Agenda generada (${totalSlots} turnos disponibles).`;
};

// Helpers
function toMinutes(horaStr){
  const [h,m] = horaStr.split(':'); return parseInt(h)*60+parseInt(m);
}
function toHoraStr(minutos){
  const h = Math.floor(minutos/60), m = minutos%60;
  return (h<10?'0':'')+h+':'+(m<10?'0':'')+m;
}
</script>

<style>
.agenda-generador { max-width: 900px; margin: 32px auto; }
.bloque-fechas { margin-bottom: 18px; }
.horarios-table { border-collapse:collapse;width:100%;background:#f7f4fa;}
.horarios-table th, .horarios-table td { border:1px solid #e3d8f6;padding:8px;text-align:center; }
.horarios-table th { background:#ece3fa;font-weight:600; }
.horarios-table td input[type="time"] { width:84px;}
.horarios-table td input[type="checkbox"] { transform:scale(1.2);}
.btn.primary { background: #7656b0; }
.btn { background: #7656b0; color: #fff; border: none; border-radius: 6px; padding: 6px 16px; cursor:pointer; margin: 2px;}
.btn:hover { background: #7f62b6; }
.card { background: #fff; padding: 32px; border-radius: 16px; box-shadow: 0 2px 8px rgba(80,60,160,.09); }
</style>
