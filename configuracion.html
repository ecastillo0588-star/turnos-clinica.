<!-- Configuración de Agenda EG Health Solutions -->
<div class="config-grid card">
  <!-- BLOQUE 1: Centros Médicos y Asociación -->
  <section class="bloque-centros">
    <h2>Centros Médicos</h2>
    <div>
      <label>Centros médicos donde atiende</label>
      <div style="display:flex;gap:8px;">
        <select id="centro-selector" style="min-width:220px;">
          <option value="">Seleccione un centro...</option>
        </select>
        <button type="button" class="btn" id="btn-agregar-centro">Asociar</button>
        <button type="button" class="btn" id="btn-nuevo-centro">Crear nuevo centro</button>
      </div>
      <div id="centros-elegidos" style="margin-top:10px;"></div>
    </div>
    <!-- Modal para crear nuevo centro -->
    <div id="modal-nuevo-centro" class="modal hidden">
      <div class="modal-content card">
        <h3>Crear nuevo centro médico</h3>
        <form id="form-nuevo-centro">
          <label>Nombre <input type="text" name="nombre" required></label>
          <div class="actions">
            <button type="submit" class="btn primary">Crear</button>
            <button type="button" class="btn" id="btn-cancel-nuevo-centro">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- BLOQUE 2: Configuración General de Agenda -->
  <section class="bloque-agenda">
    <h2>Configuración General</h2>
    <form id="config-form">
      <div class="grid agenda-grid">
        <div>
          <label>Días laborales</label>
          <div style="display:flex;flex-wrap:wrap;gap:8px;">
            <label><input type="checkbox" name="dias" value="lunes">Lun</label>
            <label><input type="checkbox" name="dias" value="martes">Mar</label>
            <label><input type="checkbox" name="dias" value="miercoles">Mié</label>
            <label><input type="checkbox" name="dias" value="jueves">Jue</label>
            <label><input type="checkbox" name="dias" value="viernes">Vie</label>
            <label><input type="checkbox" name="dias" value="sabado">Sáb</label>
            <label><input type="checkbox" name="dias" value="domingo">Dom</label>
          </div>
        </div>
        <div>
          <label>Horario laboral</label>
          <div style="display:flex;gap:8px;">
            <input type="time" name="hora_inicio" required>
            <span>-</span>
            <input type="time" name="hora_fin" required>
          </div>
        </div>
        <div>
          <label>Duración turno nueva consulta (min)</label>
          <select name="duracion_nueva" required></select>
        </div>
        <div>
          <label>Duración turno consulta recurrente (min)</label>
          <select name="duracion_recurrente" required></select>
        </div>
      </div>
      <div class="actions" style="margin-top:24px;">
        <button type="submit" class="btn primary">Guardar configuración</button>
      </div>
    </form>
  </section>

  <!-- BLOQUE 3: Turnos por Día y Centro Médico -->
  <section class="bloque-turnos">
    <h2>Turnos por Día y Centro Médico</h2>
    <div id="turnos-list"></div>
    <button type="button" class="btn" id="btn-agregar-turno" style="margin-top:8px;">Agregar turno</button>
  </section>

  <!-- BLOQUE 4: Asistentes -->
  <section class="bloque-asistentes">
    <h2>Asistentes</h2>
    <div id="asistentes-list"></div>
    <button class="btn" id="btn-add-asistente" style="margin-top:10px;">Agregar asistente</button>
    <div id="asistente-form-wrap" class="card hidden" style="margin-top:12px;">
      <form id="asistente-form">
        <label>Email <input type="email" name="email" required></label>
        <label>Nombre <input type="text" name="nombre" required></label>
        <label>Apellido <input type="text" name="apellido" required></label>
        <label>Teléfono <input type="text" name="telefono"></label>
        <div class="actions">
          <button type="submit" class="btn primary">Crear asistente</button>
          <button type="button" class="btn" id="btn-cancel-asistente">Cancelar</button>
        </div>
      </form>
    </div>
  </section>
</div>

<!-- SCRIPTS -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
// REEMPLAZA por tus credenciales reales
const supabaseUrl = 'https://vwkszvdvswznlgxlfdtz.supabase.co';
const supabaseAnonKey = 'eyJ...';
const supabase = createClient(supabaseUrl, supabaseAnonKey);

const profesional_id = localStorage.getItem('profesional_id');
const DIAS = ['lunes','martes','miercoles','jueves','viernes','sabado','domingo'];

// --- Duración de turnos ---
function llenarOpcionesDuracion() {
  for(let i=10;i<=60;i+=5) {
    ['duracion_nueva','duracion_recurrente'].forEach(name=>{
      const select = document.querySelector(`[name="${name}"]`);
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = i + ' min';
      select.appendChild(opt);
    });
  }
}
llenarOpcionesDuracion();

// --- Bloque CENTROS MEDICOS ---
let centrosDisponibles = [];
let centrosElegidos = [];
async function cargarCentros() {
  // 1. Todos los centros activos
  const selector = document.getElementById('centro-selector');
  selector.innerHTML = '<option value="">Seleccione un centro...</option>';
  const { data: centros } = await supabase
    .from('centros_medicos')
    .select('id, nombre')
    .eq('activo', true);
  centrosDisponibles = centros || [];
  centrosDisponibles.forEach(centro=>{
    const opt = document.createElement('option');
    opt.value = centro.id;
    opt.textContent = centro.nombre;
    selector.appendChild(opt);
  });
  // 2. Los ya asociados
  const { data: vinculos } = await supabase
    .from('profesional_centro')
    .select('centro_id')
    .eq('profesional_id', profesional_id)
    .eq('activo', true);
  centrosElegidos = vinculos ? vinculos.map(vc=>vc.centro_id) : [];
  renderCentrosElegidos();
}
function renderCentrosElegidos() {
  const cont = document.getElementById('centros-elegidos');
  cont.innerHTML = '<b>Centros asociados:</b><br>';
  if (!centrosElegidos.length) cont.innerHTML += '<i>No hay centros asociados.</i>';
  centrosElegidos.forEach(id=>{
    const centro = centrosDisponibles.find(c=>c.id===id);
    if(centro){
      const div = document.createElement('div');
      div.className = 'centro-elegido';
      div.textContent = centro.nombre;
      const btn = document.createElement('button');
      btn.textContent = 'Quitar';
      btn.className = 'btn';
      btn.style.marginLeft = "10px";
      btn.onclick = () => quitarCentro(id);
      div.appendChild(btn);
      cont.appendChild(div);
    }
  });
}
function quitarCentro(id) {
  centrosElegidos = centrosElegidos.filter(cid=>cid!==id);
  supabase
    .from('profesional_centro')
    .update({ activo: false })
    .eq('profesional_id', profesional_id)
    .eq('centro_id', id)
    .then(()=>cargarCentros());
}
document.getElementById('btn-agregar-centro').onclick = function(){
  const id = document.getElementById('centro-selector').value;
  if(id && !centrosElegidos.includes(id)){
    supabase
      .from('profesional_centro')
      .upsert({ profesional_id, centro_id: id, activo: true }, { onConflict: ['profesional_id','centro_id'] })
      .then(()=>cargarCentros());
  }
};
// Modal para crear nuevo centro
document.getElementById('btn-nuevo-centro').onclick = function(){
  document.getElementById('modal-nuevo-centro').classList.remove('hidden');
};
document.getElementById('btn-cancel-nuevo-centro').onclick = function(){
  document.getElementById('modal-nuevo-centro').classList.add('hidden');
};
document.getElementById('form-nuevo-centro').addEventListener('submit', async function(e){
  e.preventDefault();
  const nombre = this.nombre.value;
  const { data, error } = await supabase
    .from('centros_medicos')
    .insert([{ nombre, activo: true }]);
  if(error) alert('Error al crear centro: ' + error.message);
  else {
    document.getElementById('modal-nuevo-centro').classList.add('hidden');
    await cargarCentros();
    const nuevoId = data[0].id;
    await supabase
      .from('profesional_centro')
      .upsert({ profesional_id, centro_id: nuevoId, activo: true }, { onConflict: ['profesional_id','centro_id'] });
    await cargarCentros();
  }
});
cargarCentros();

// --- Bloque AGENDA GENERAL ---
async function cargarConfiguracion() {
  const { data } = await supabase
    .from('profesional_preferencias')
    .select('*')
    .eq('profesional_id', profesional_id)
    .single();
  if(data) {
    if(data.dias_laborales) {
      document.querySelectorAll('[name="dias"]').forEach(cb => {
        cb.checked = data.dias_laborales.includes(cb.value);
      });
    }
    document.querySelector('[name="hora_inicio"]').value = data.horario_inicio || '08:00';
    document.querySelector('[name="hora_fin"]').value = data.horario_fin || '17:00';
    document.querySelector('[name="duracion_nueva"]').value = data.duracion_turno_nueva || 10;
    document.querySelector('[name="duracion_recurrente"]').value = data.duracion_turno_recurrente || 10;
  }
}
cargarConfiguracion();

document.getElementById('config-form').addEventListener('submit', async function(e){
  e.preventDefault();
  const dias = Array.from(document.querySelectorAll('[name="dias"]:checked')).map(cb=>cb.value);
  const hora_inicio = document.querySelector('[name="hora_inicio"]').value;
  const hora_fin = document.querySelector('[name="hora_fin"]').value;
  const duracion_nueva = Number(document.querySelector('[name="duracion_nueva"]').value);
  const duracion_recurrente = Number(document.querySelector('[name="duracion_recurrente"]').value);
  await supabase
    .from('profesional_preferencias')
    .upsert({
      profesional_id,
      dias_laborales: dias,
      horario_inicio: hora_inicio,
      horario_fin: hora_fin,
      duracion_turno_nueva: duracion_nueva,
      duracion_turno_recurrente: duracion_recurrente
    });
  alert('Configuración guardada');
});

// --- Bloque TURNOS POR DÍA/CENTRO ---
function crearTurnoHTML(turno = {}, idx) {
  return `
    <div class="turno-row" data-idx="${idx}">
      <div>
        <label>Día:</label>
        <select name="dia_${idx}" required>
          ${DIAS.map(dia => `<option value="${dia}" ${turno.dia===dia?'selected':''}>${dia.charAt(0).toUpperCase()+dia.slice(1)}</option>`).join('')}
        </select>
      </div>
      <div>
        <label>Horario:</label>
        <input type="time" name="hora_inicio_${idx}" value="${turno.hora_inicio||''}" required>
        <span>-</span>
        <input type="time" name="hora_fin_${idx}" value="${turno.hora_fin||''}" required>
      </div>
      <div>
        <label>Centro médico:</label>
        <select name="centro_id_${idx}" required>
          <option value="">Seleccione...</option>
          ${centrosDisponibles.map(centro=>`
            <option value="${centro.id}" ${turno.centro_id===centro.id?'selected':''}>${centro.nombre}</option>
          `).join('')}
        </select>
      </div>
      <div>
        <label>Capacidad:</label>
        <input type="number" name="capacidad_${idx}" min="1" max="99" value="${turno.capacidad||1}">
      </div>
      <button type="button" class="btn btn-quitar-turno" style="margin-left:10px;">Quitar</button>
    </div>
  `;
}
let turnosActuales = [];
async function cargarTurnos() {
  // Debes tener la tabla agenda. Aquí solo traemos los slots futuros del profesional para edición.
  const { data } = await supabase
    .from('agenda')
    .select('*')
    .eq('profesional_id', profesional_id)
    .gte('fecha', new Date().toISOString().slice(0,10));
  turnosActuales = data ? data.map(t=>({
    dia: DIAS[new Date(t.fecha).getDay()],
    hora_inicio: t.hora_inicio,
    hora_fin: t.hora_fin,
    centro_id: t.centro_id,
    capacidad: t.capacidad
  })) : [];
  renderTurnos(turnosActuales.length ? turnosActuales : []);
}
function renderTurnos(turnos) {
  const cont = document.getElementById('turnos-list');
  cont.innerHTML = '';
  turnos.forEach((turno, idx) => {
    cont.innerHTML += crearTurnoHTML(turno, idx);
  });
  // Listeners para quitar turno
  cont.querySelectorAll('.btn-quitar-turno').forEach((btn, idx) => {
    btn.onclick = () => {
      turnos.splice(idx,1);
      renderTurnos(turnos);
    };
  });
}
document.getElementById('btn-agregar-turno').onclick = () => {
  turnosActuales.push({dia:'lunes',hora_inicio:'',hora_fin:'',centro_id:'',capacidad:1});
  renderTurnos(turnosActuales);
};
// Guardar turnos (slots) en tabla agenda
document.getElementById('turnos-list').addEventListener('change', function() {
  // Opcional: puedes guardar en tiempo real si lo prefieres.
});
document.getElementById('btn-agregar-turno').onclick = () => {
  turnosActuales.push({dia:'lunes',hora_inicio:'',hora_fin:'',centro_id:'',capacidad:1});
  renderTurnos(turnosActuales);
};
async function guardarTurnos() {
  // Recoger todos los turnos del DOM y guardar en agenda
  const turnos = [];
  document.querySelectorAll('.turno-row').forEach(row=>{
    const idx = row.getAttribute('data-idx');
    const dia = row.querySelector(`[name="dia_${idx}"]`).value;
    const centro_id = row.querySelector(`[name="centro_id_${idx}"]`).value;
    const hora_inicio = row.querySelector(`[name="hora_inicio_${idx}"]`).value;
    const hora_fin = row.querySelector(`[name="hora_fin_${idx}"]`).value;
    const capacidad = Number(row.querySelector(`[name="capacidad_${idx}"]`).value);
    if(centro_id && hora_inicio && hora_fin) {
      turnos.push({
        profesional_id,
        centro_id,
        fecha: calcularProximaFecha(dia),
        hora_inicio,
        hora_fin,
        capacidad
      });
    }
  });
  // Guarda cada slot en agenda
  for(const turno of turnos) {
    await supabase
      .from('agenda')
      .upsert(turno, { onConflict: ['centro_id','profesional_id','fecha','hora_inicio','hora_fin'] });
  }
  alert('Turnos guardados');
}
// Para ejemplo: calcula la próxima fecha de un día (puedes adaptar a tu lógica real)
function calcularProximaFecha(dia) {
  const hoy = new Date();
  const idx = DIAS.indexOf(dia);
  const hoyIdx = hoy.getDay();
  let delta = idx - hoyIdx;
  if(delta < 0) delta += 7;
  const fecha = new Date(hoy);
  fecha.setDate(hoy.getDate() + delta);
  return fecha.toISOString().slice(0,10);
}
// Puedes agregar un botón para guardar los turnos
const guardarBtn = document.createElement('button');
guardarBtn.className = "btn primary";
guardarBtn.textContent = "Guardar turnos";
guardarBtn.style.marginTop = "10px";
guardarBtn.onclick = guardarTurnos;
document.querySelector('.bloque-turnos').appendChild(guardarBtn);

cargarTurnos();

// --- Bloque ASISTENTES ---
async function cargarAsistentes(){
  const { data } = await supabase
    .from('profiles')
    .select('*')
    .eq('role', 'asistente')
    .eq('active', true)
    .eq('profesional_id', profesional_id);
  const list = document.getElementById('asistentes-list');
  list.innerHTML = '';
  if(data && data.length){
    data.forEach(asistente=>{
      const div = document.createElement('div');
      div.textContent = `${asistente.display_name} (${asistente.email})`;
      const btn = document.createElement('button');
      btn.textContent = 'Desactivar';
      btn.className = 'btn';
      btn.onclick = async function(){
        await supabase
          .from('profiles')
          .update({ active: false })
          .eq('id', asistente.id);
        cargarAsistentes();
      };
      div.appendChild(btn);
      list.appendChild(div);
    });
  } else {
    list.textContent = 'No hay asistentes vinculados.';
  }
}
document.getElementById('btn-add-asistente').onclick = ()=> {
  document.getElementById('asistente-form-wrap').classList.remove('hidden');
};
document.getElementById('btn-cancel-asistente').onclick = ()=> {
  document.getElementById('asistente-form-wrap').classList.add('hidden');
};
document.getElementById('asistente-form').addEventListener('submit', async function(e){
  e.preventDefault();
  const fd = new FormData(this);
  const asistente = {
    email: fd.get('email'),
    display_name: `${fd.get('nombre')} ${fd.get('apellido')}`,
    telefono: fd.get('telefono'),
    role: 'asistente',
    active: true,
    profesional_id
  };
  const { data, error } = await supabase
    .from('profiles')
    .insert([asistente]);
  if(error) alert('Error al crear asistente: ' + error.message);
  else alert('Asistente creado.');
  document.getElementById('asistente-form-wrap').classList.add('hidden');
  cargarAsistentes();
});
cargarAsistentes();
</script>

<style>
body { background: #f6f3fa;}
.card { background: #fff; padding: 32px; border-radius: 16px; box-shadow: 0 2px 8px rgba(80,60,160,.09); }
.btn { background: #7656b0; color: #fff; border: none; border-radius: 6px; padding: 6px 16px; cursor:pointer; margin: 2px;}
.btn.primary { background: #7656b0; }
.btn:hover { background: #7f62b6; }
.grid { display: grid; }
.actions { margin-top:20px;}
.hidden { display:none; }
.modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.25); align-items:center; justify-content:center; z-index:1000;}
.modal:not(.hidden) { display:flex; }
.modal-content { min-width:320px; background:#fff; padding:24px; border-radius:10px; }
.config-grid {
  display: grid;
  grid-template-columns: 1.1fr 1fr 1.1fr 1fr;
  gap: 22px;
  max-width: 1400px;
  margin: 32px auto;
}
.bloque-centros, .bloque-agenda, .bloque-turnos, .bloque-asistentes { min-width: 0; }
.agenda-grid { grid-template-columns: repeat(2,1fr); gap: 12px;}
.turno-row { display:flex;align-items:center;gap:15px;margin-bottom:16px;padding-bottom:6px;border-bottom:1px solid #eee;}
@media (max-width: 1100px) {
  .config-grid { grid-template-columns: 1fr; }
}
</style>
