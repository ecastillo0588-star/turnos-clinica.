<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Login - EG Health Solutions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f9fb; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    .login-container { background: #fff; box-shadow: 0 2px 24px rgba(0,0,0,0.07); border-radius: 10px; padding: 32px 24px; width: 100%; max-width: 340px; text-align: center; position: relative; }
    .logo { width: 90px; height: 90px; border-radius: 50%; object-fit: contain; margin-bottom: 16px; background: #eaf3fa; display: inline-block; }
    h2 { margin-bottom: 8px; color: #0055a5; font-size: 1.6em; font-weight: 700; }
    .subtitle { color: #666; margin-bottom: 24px; font-size: 1em; font-weight: 400; }
    input, select { width: 100%; padding: 10px 12px; margin: 8px 0; border: 1px solid #d3e0ea; border-radius: 6px; font-size: 1em; background: #f7f9fb; transition: border-color 0.2s; }
    input:focus, select:focus { border-color: #0055a5; outline: none; }
    .login-btn { width: 100%; background: #0055a5; color: #fff; border: none; border-radius: 6px; padding: 12px; font-size: 1.07em; font-weight: 600; margin-top: 10px; cursor: pointer; transition: background .2s; }
    .login-btn:hover { background: #073d7d; }
    .error-message { color: #d0003a; margin-top: 12px; font-size: 0.93em; min-height: 24px; }
    .hidden { display: none; }
    .success-message { color: #008c4a; margin-top: 12px; font-size: 0.93em; min-height: 24px; }
    .forgot-link { display:block; margin-top:10px; margin-bottom:8px; color:#0055a5; font-size:0.97em; text-decoration:underline; cursor:pointer; }
    #forgot-form { margin-top:16px; }
  </style>
</head>
<body>
  <div class="login-container">
    <img src="https://i.postimg.cc/ZY8mGGf2/Chat-GPT-Image-30-ago-2025-17-14-28.png" alt="EG Health Solutions Logo" class="logo" id="logo-img">
    <h2>EG Health Solutions</h2>
    <div class="subtitle">Iniciar sesión en el sistema</div>

    <!-- Login -->
    <form id="login-form" autocomplete="off">
      <input type="email" id="email" placeholder="Correo electrónico" required>
      <input type="password" id="password" placeholder="Contraseña" required>
      <button type="submit" class="login-btn">Ingresar</button>
      <div class="error-message" id="error-message"></div>
      <span class="forgot-link" id="forgot-link">¿Olvidaste tu contraseña?</span>
    </form>

    <!-- Forgot password -->
    <form id="forgot-form" class="hidden">
      <input type="email" id="forgot-email" placeholder="Correo para recuperar contraseña" required>
      <button type="submit" class="login-btn">Enviar recuperación</button>
      <div class="success-message" id="forgot-success"></div>
      <div class="error-message" id="forgot-error"></div>
      <span class="forgot-link" id="volver-login">Volver al login</span>
    </form>

    <!-- Selección de centro -->
    <form id="center-form" class="hidden">
      <div id="center-select-div"></div>
      <button type="submit" class="login-btn">Entrar al sistema</button>
      <div class="success-message" id="success-message"></div>
      <div class="error-message" id="center-error-message"></div>
    </form>

    <!-- Asociar a centro existente (solo propietario/medico sin centros) -->
    <form id="associate-form" class="hidden">
      <div id="associate-select-div"></div>
      <button type="submit" class="login-btn">Asociar centro médico</button>
      <div class="success-message" id="associate-success-message"></div>
      <div class="error-message" id="associate-error-message"></div>
    </form>
  </div>

  <script type="module">
    import supabase from "./supabaseClient.js";

    let userEmail = null;
    let userRole = null;            // 'propietario' | 'medico' | 'amp' | 'amc'
    let profesionalId = null;       // profesionales.id del usuario
    let centros = [];
    let userName = null;

    /** Asegura profesional_id del perfil:
     *  1) Usa profiles.profesional_id si existe.
     *  2) Si no, busca en profesionales por profile_id = authUser.id y lo guarda en el perfil.
     *  3) Fallback por email (si lo usás en profesionales).
     */
    async function ensureProfesionalId(profileData) {
      if (profileData.profesional_id) return profileData.profesional_id;

      const { data: userResp } = await supabase.auth.getUser();
      const authUser = userResp?.user;
      if (!authUser) return null;

      // Buscar por profile_id (tu FK)
      const { data: profesionalRow } = await supabase
        .from('profesionales')
        .select('id, profile_id, email')
        .eq('profile_id', authUser.id)
        .maybeSingle();

      if (profesionalRow?.id) {
        await supabase.from('profiles')
          .update({ profesional_id: profesionalRow.id })
          .eq('id', profileData.id);
        return profesionalRow.id;
      }

      // Fallback por email
      if (profileData.email) {
        const { data: profesionalByEmail } = await supabase
          .from('profesionales')
          .select('id')
          .eq('email', profileData.email)
          .maybeSingle();
        if (profesionalByEmail?.id) {
          await supabase.from('profiles')
            .update({ profesional_id: profesionalByEmail.id })
            .eq('id', profileData.id);
          return profesionalByEmail.id;
        }
      }
      return null;
    }

    /** Devuelve centros asociados al profesional (activos), con fallback robusto. */
    async function cargarCentrosAsociados(profId) {
      if (!profId) return { centros: [], error: new Error("profId requerido") };

      const normalize = (rows) => {
        const list = (rows || [])
          .map(r => r?.centros_medicos ?? r)
          .filter(c => c && c.id && c.activo !== false)
          .map(c => ({ id: c.id, nombre: c.nombre, activo: c.activo }));
        const map = new Map(list.map(c => [c.id, c]));
        return Array.from(map.values()).sort((a, b) =>
          (a.nombre || "").localeCompare(b.nombre || "", "es", { sensitivity: "base" })
        );
      };

      // 1) Embed directo
      let { data, error } = await supabase
        .from('profesional_centro')
        .select('centros_medicos ( id, nombre, activo )')
        .eq('profesional_id', profId)
        .eq('activo', true);

      if (!error) return { centros: normalize(data), error: null };

      // 2) Fallback: dos consultas (IDs -> IN)
      const { data: links, error: e1 } = await supabase
        .from('profesional_centro')
        .select('centro_id')
        .eq('profesional_id', profId)
        .eq('activo', true);

      if (e1) return { centros: [], error: e1 };

      const ids = (links || []).map(r => r.centro_id).filter(Boolean);
      if (!ids.length) return { centros: [], error: null };

      const { data: centrosRows, error: e2 } = await supabase
        .from('centros_medicos')
        .select('id, nombre, activo')
        .in('id', ids)
        .eq('activo', true);

      if (e2) return { centros: [], error: e2 };

      return { centros: normalize(centrosRows), error: null };
    }

    function mostrarSelectorCentros(listaCentros) {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('center-select-div').innerHTML = `
        <label for="select-centro">Elige tu centro médico:</label>
        <select id="select-centro" required>
          ${listaCentros.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('')}
        </select>`;
      document.getElementById('center-form').classList.remove('hidden');
    }

    async function mostrarFormularioAsociar() {
      // Solo propietarios/médicos pueden asociarse a un centro si no tienen
      if (!['propietario'].includes(userRole) && !['medico'].includes(userRole)) {
        document.getElementById('error-message').textContent =
          'No tenés permisos para asociar centros. Contactá al administrador.';
        return;
      }

      // Traer centros disponibles para asociar al profesional actual (RPC tuya)
      const { data: allCentros, error: allCentrosError } = await supabase
        .rpc('centros_listar_para_asociar', { prof_id: profesionalId });

      if (allCentrosError || !allCentros?.length) {
        document.getElementById('error-message').textContent =
          'No hay centros médicos disponibles para asociar.';
        return;
      }

      centros = allCentros;
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('associate-select-div').innerHTML = `
        <label for="associate-centro">Asociar un centro médico:</label>
        <select id="associate-centro" required>
          ${allCentros.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('')}
        </select>`;
      document.getElementById('associate-form').classList.remove('hidden');
    }

    // --- LOGIN ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const errorMessage = document.getElementById('error-message');
      errorMessage.textContent = '';

      const { error: authError } = await supabase.auth.signInWithPassword({ email, password });
      if (authError) {
        errorMessage.textContent = 'Correo o contraseña incorrectos.';
        return;
      }
      userEmail = email;

      // Traer perfil por ID del usuario autenticado
      const { data: userResp } = await supabase.auth.getUser();
      const authUser = userResp?.user;

      const { data: profileData, error: profileError } = await supabase
        .from('profiles')
        .select('id, role, profesional_id, email, display_name')
        .eq('id', authUser.id)
        .single();

      if (profileError || !profileData) {
        errorMessage.textContent = 'Perfil no encontrado.';
        return;
      }

      userRole = profileData.role;              // propietario | medico | amp | amc
      userName = profileData.display_name || email;

      // Aseguramos profesional_id
      profesionalId = await ensureProfesionalId(profileData);
      if (!profesionalId) {
        errorMessage.textContent = 'No se pudo determinar tu ID de profesional.';
        return;
      }

      // Persistimos datos básicos
      localStorage.setItem('usuario_id', profileData.id);
      localStorage.setItem('profesional_id', profesionalId || '');
      localStorage.setItem('email', userEmail);
      localStorage.setItem('user_role', userRole);
      localStorage.setItem('user_name', userName);

      // Cargamos centros asociados (igual para todos los roles).
      const { centros: asociados, error: centrosError } = await cargarCentrosAsociados(profesionalId);
      if (centrosError) {
        errorMessage.textContent = 'Error buscando centros asociados.';
        return;
      }

      if (asociados.length > 0) {
        // Para AMC será 1 (se mostrará ese único item).
        centros = asociados;
        mostrarSelectorCentros(centros);
        return;
      }

      // Si no tiene centros y es propietario/medico → permitir asociar.
      if (['propietario', 'medico'].includes(userRole)) {
        await mostrarFormularioAsociar();
        return;
      }

      // Resto (AMP/AMC) sin centros → mensaje.
      errorMessage.textContent = 'No tenés centros médicos asignados.';
    });

    // --- Seleccionar centro ---
    document.getElementById('center-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const select = document.getElementById('select-centro');
      const centroId = select ? select.value : (centros[0]?.id || null);
      if (!centroId) {
        document.getElementById('center-error-message').textContent = 'Seleccione un centro válido.';
        return;
      }
      const nombre = centros.find(c => c.id === centroId)?.nombre || centros[0]?.nombre;
      localStorage.setItem('centro_medico_id', centroId);
      localStorage.setItem('centro_medico_nombre', nombre);
      window.location.href = "dashboard.html";
    });

    // --- Asociar centro si no tiene ninguno (propietario/medico) ---
    document.getElementById('associate-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const centroId = document.getElementById('associate-centro').value;
      const successMessage = document.getElementById('associate-success-message');
      const errorMessage = document.getElementById('associate-error-message');
      successMessage.textContent = '';
      errorMessage.textContent = '';

      if (!profesionalId) {
        errorMessage.textContent = 'No se puede asociar: profesional no identificado.';
        return;
      }

      const { error: insertError } = await supabase
        .from('profesional_centro')
        .insert([{ profesional_id: profesionalId, centro_id: centroId, activo: true }]);

      if (insertError) {
        errorMessage.textContent = 'Error asociando centro médico.';
        return;
      }

      successMessage.textContent = 'Centro médico asociado con éxito. Redirigiendo...';
      const nombre = centros.find(c => c.id === centroId)?.nombre || '';
      localStorage.setItem('centro_medico_id', centroId);
      localStorage.setItem('centro_medico_nombre', nombre);
      setTimeout(() => window.location.href = "dashboard.html", 1200);
    });

    // --- Recuperar contraseña ---
    const forgotLink = document.getElementById('forgot-link');
    const forgotForm = document.getElementById('forgot-form');
    const loginForm = document.getElementById('login-form');
    const volverLogin = document.getElementById('volver-login');

    forgotLink.addEventListener('click', () => {
      loginForm.classList.add('hidden');
      forgotForm.classList.remove('hidden');
      document.getElementById('forgot-success').textContent = '';
      document.getElementById('forgot-error').textContent = '';
      document.getElementById('forgot-email').value = '';
    });

    volverLogin.addEventListener('click', () => {
      forgotForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
      document.getElementById('error-message').textContent = '';
    });

    forgotForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('forgot-email').value.trim();
      const success = document.getElementById('forgot-success');
      const errorDiv = document.getElementById('forgot-error');
      success.textContent = '';
      errorDiv.textContent = '';
      if (!email) {
        errorDiv.textContent = 'Ingrese su correo electrónico.';
        return;
      }
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + "/reset-password.html"
      });
      if (error) {
        errorDiv.textContent = 'No se pudo enviar el correo de recuperación.';
        return;
      }
      success.textContent = 'Correo de recuperación enviado. Revise su bandeja de entrada.';
    });
  </script>
</body>
</html>
