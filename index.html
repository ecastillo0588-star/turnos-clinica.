<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Login - EG Health Solutions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f9fb; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    .login-container { background: #fff; box-shadow: 0 2px 24px rgba(0,0,0,0.07); border-radius: 10px; padding: 32px 24px; width: 100%; max-width: 340px; text-align: center; position: relative; }
    .logo { width: 90px; height: 90px; border-radius: 50%; object-fit: contain; margin-bottom: 16px; background: #eaf3fa; display: inline-block; }
    h2 { margin-bottom: 8px; color: #0055a5; font-size: 1.6em; font-weight: 700; }
    .subtitle { color: #666; margin-bottom: 24px; font-size: 1em; font-weight: 400; }
    input, select { width: 100%; padding: 10px 12px; margin: 8px 0; border: 1px solid #d3e0ea; border-radius: 6px; font-size: 1em; background: #f7f9fb; transition: border-color 0.2s; }
    input:focus, select:focus { border-color: #0055a5; outline: none; }
    .login-btn { width: 100%; background: #0055a5; color: #fff; border: none; border-radius: 6px; padding: 12px; font-size: 1.07em; font-weight: 600; margin-top: 10px; cursor: pointer; transition: background 0.2s; }
    .login-btn:hover { background: #073d7d; }
    .error-message { color: #d0003a; margin-top: 12px; font-size: 0.93em; min-height: 24px; }
    .hidden { display: none; }
    .success-message { color: #008c4a; margin-top: 12px; font-size: 0.93em; min-height: 24px; }
    .forgot-link { display:block; margin-top:10px; margin-bottom:8px; color:#0055a5; font-size:0.97em; text-decoration:underline; cursor:pointer; }
    #forgot-form { margin-top:16px; }
  </style>
</head>
<body>
  <div class="login-container">
   <img src="https://i.postimg.cc/ZY8mGGf2/Chat-GPT-Image-30-ago-2025-17-14-28.png" alt="EG Health Solutions Logo" class="logo" id="logo-img">
    <h2>EG Health Solutions</h2>
    <div class="subtitle">Iniciar sesión en el sistema</div>
    <form id="login-form" autocomplete="off">
      <input type="email" id="email" placeholder="Correo electrónico" required>
      <input type="password" id="password" placeholder="Contraseña" required>
      <button type="submit" class="login-btn">Ingresar</button>
      <div class="error-message" id="error-message"></div>
      <span class="forgot-link" id="forgot-link">¿Olvidaste tu contraseña?</span>
    </form>
    <form id="forgot-form" class="hidden">
      <input type="email" id="forgot-email" placeholder="Correo para recuperar contraseña" required>
      <button type="submit" class="login-btn">Enviar recuperación</button>
      <div class="success-message" id="forgot-success"></div>
      <div class="error-message" id="forgot-error"></div>
      <span class="forgot-link" id="volver-login">Volver al login</span>
    </form>
    <form id="center-form" class="hidden">
      <div id="center-select-div"></div>
      <button type="submit" class="login-btn">Entrar al sistema</button>
      <div class="success-message" id="success-message"></div>
      <div class="error-message" id="center-error-message"></div>
    </form>
    <form id="associate-form" class="hidden">
      <div id="associate-select-div"></div>
      <button type="submit" class="login-btn">Asociar centro médico</button>
      <div class="success-message" id="associate-success-message"></div>
      <div class="error-message" id="associate-error-message"></div>
    </form>
  </div>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const supabaseUrl = 'https://vwkszvdvswznlgxlfdtz.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3a3N6dmR2c3d6bmxneGxmZHR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NDM4NDQsImV4cCI6MjA3MTExOTg0NH0.TnDGheCSTUqGwTCMiHZ_CUgcAztCqVTc1cINkMud8p0';
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    let userEmail = null;
    let userRole = null;
    let profesionalId = null;
    let centros = [];
    let centroAsignado = null;

    // Login handler
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const errorMessage = document.getElementById('error-message');
      errorMessage.textContent = '';
      // Iniciar sesión con Supabase Auth
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        errorMessage.textContent = 'Correo o contraseña incorrectos.';
        return;
      }
      // Guardar email de usuario
      userEmail = email;
      // Buscar perfil y rol
      const { data: profileData, error: profileError } = await supabase
        .from('profiles')
        .select('role, profesional_id, id, email')
        .eq('email', email)
        .single();
      if (profileError || !profileData) {
        errorMessage.textContent = 'Perfil no encontrado.';
        return;
      }
      userRole = profileData.role;
      profesionalId = profileData.profesional_id;

      // Guardar datos básicos en localStorage
      localStorage.setItem('usuario_id', profileData.id);
      localStorage.setItem('profesional_id', profesionalId);
      localStorage.setItem('email', userEmail);
      localStorage.setItem('user_role', userRole);

      // Debugging: mostrar valores en la consola
      console.log("Email logueado:", userEmail);
      console.log("Rol:", userRole);
      console.log("profesional_id usado:", profesionalId);

      // Según el rol, buscar centros médicos
      if (userRole === 'propietario' || userRole === 'medico') {
        // Buscar centros asociados
        const { data: centrosRel, error: centrosError } = await supabase
          .from('profesional_centro')
          .select('centro_id')
          .eq('profesional_id', profesionalId);

        // Debugging: mostrar resultado consulta
        console.log("Resultado consulta profesional_centro:", centrosRel);
        console.log("Error en consulta profesional_centro:", centrosError);

        if (centrosError) {
          errorMessage.textContent = 'Error buscando centros médicos asociados: ' + centrosError.message;
          return;
        }
        if (!centrosRel || centrosRel.length === 0) {
          // No tiene centros médicos asociados: mostrar todos los centros activos para asociar
          const { data: allCentros, error: allCentrosError } = await supabase
            .from('centros_medicos')
            .select('id, nombre')
            .eq('activo', true);
          if (allCentrosError || !allCentros || allCentros.length === 0) {
            errorMessage.textContent = 'No hay centros médicos disponibles.';
            return;
          }
          document.getElementById('login-form').classList.add('hidden');
          document.getElementById('associate-select-div').innerHTML = `
            <label for="associate-centro">Asocia un centro médico a tu perfil:</label>
            <select id="associate-centro" required>
              ${allCentros.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('')}
            </select>`;
          document.getElementById('associate-form').classList.remove('hidden');
          centros = allCentros;
          return;
        }
        // Tiene centros asociados: buscar info de cada centro
        const centroIds = centrosRel.map(c => c.centro_id);
        const { data: centrosData, error: centrosDataError } = await supabase
          .from('centros_medicos')
          .select('id, nombre')
          .in('id', centroIds)
          .eq('activo', true);
        if (centrosDataError || !centrosData || centrosData.length === 0) {
          errorMessage.textContent = 'No hay centros médicos activos asociados.';
          return;
        }
        centros = centrosData;
        document.getElementById('login-form').classList.add('hidden');
        const selectHtml = `<label for="select-centro">Elige tu centro médico:</label>
          <select id="select-centro" required>
            ${centros.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('')}
          </select>`;
        document.getElementById('center-select-div').innerHTML = selectHtml;
        document.getElementById('center-form').classList.remove('hidden');
      } else if (userRole === 'asistente') {
        if (!profileData.profesional_id) {
          errorMessage.textContent = 'No tienes centro médico asignado.';
          return;
        }
        const { data: centroData, error: centroError } = await supabase
          .from('centros_medicos')
          .select('id, nombre')
          .eq('id', profileData.profesional_id)
          .eq('activo', true)
          .single();
        if (centroError || !centroData) {
          errorMessage.textContent = 'Centro médico no encontrado o inactivo.';
          return;
        }
        centroAsignado = centroData;
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('center-select-div').innerHTML = `<label>Centro médico asignado:</label>
          <div style="font-weight:600;color:#0055a5;padding:10px 0;">${centroAsignado.nombre}</div>`;
        document.getElementById('center-form').classList.remove('hidden');
      } else {
        errorMessage.textContent = 'Rol no reconocido.';
      }
    });

    // Handler para seleccionar centro y entrar al sistema
    document.getElementById('center-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      let centroId = null;
      if (userRole === 'propietario' || userRole === 'medico') {
        centroId = document.getElementById('select-centro').value;
      } else if (userRole === 'asistente') {
        centroId = centroAsignado.id;
      }
      localStorage.setItem('centro_medico_id', centroId);
      localStorage.setItem('centro_medico_nombre', centros.find(c => c.id === centroId)?.nombre || centroAsignado?.nombre);
      window.location.href = "dashboard.html";
    });

    // Handler para asociar centro médico si no tiene ninguno
    document.getElementById('associate-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const centroId = document.getElementById('associate-centro').value;
      const successMessage = document.getElementById('associate-success-message');
      const errorMessage = document.getElementById('associate-error-message');
      successMessage.textContent = '';
      errorMessage.textContent = '';
      // Insertar relación en profesional_centro
      const { error: insertError } = await supabase
        .from('profesional_centro')
        .insert([{ profesional_id: profesionalId, centro_id: centroId, activo: true }]);
      if (insertError) {
        errorMessage.textContent = 'Error asociando centro médico.';
        return;
      }
      successMessage.textContent = 'Centro médico asociado con éxito. Redirigiendo...';
      localStorage.setItem('centro_medico_id', centroId);
      localStorage.setItem('centro_medico_nombre', centros.find(c => c.id === centroId)?.nombre);
      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 1500);
    });

    // --- Recuperar contraseña ---
    const forgotLink = document.getElementById('forgot-link');
    const forgotForm = document.getElementById('forgot-form');
    const loginForm = document.getElementById('login-form');
    const volverLogin = document.getElementById('volver-login');
    forgotLink.addEventListener('click', () => {
      loginForm.classList.add('hidden');
      forgotForm.classList.remove('hidden');
      document.getElementById('forgot-success').textContent = '';
      document.getElementById('forgot-error').textContent = '';
      document.getElementById('forgot-email').value = '';
    });
    volverLogin.addEventListener('click', () => {
      forgotForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
      document.getElementById('error-message').textContent = '';
    });

    forgotForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('forgot-email').value.trim();
      const success = document.getElementById('forgot-success');
      const errorDiv = document.getElementById('forgot-error');
      success.textContent = '';
      errorDiv.textContent = '';
      if (!email) {
        errorDiv.textContent = 'Ingrese su correo electrónico.';
        return;
      }
      // Enviar email de recuperación con Supabase
      const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + "/reset-password.html"
      });
      if (error) {
        errorDiv.textContent = 'No se pudo enviar el correo de recuperación. Revise el email ingresado.';
        return;
      }
      success.textContent = 'Correo de recuperación enviado. Revise su bandeja de entrada.';
    });

    // Puedes luego cambiar el src de #logo-img por tu logo real
    // document.getElementById('logo-img').src = "tu-logo.png";
  </script>
</body>
</html>
