<script type="module">
import supabase from './supabaseClient.js';
import { getCentrosActivos } from './centrosService.js';

// ELEMENTOS UI
const centroAsistenteSelect = document.getElementById('centro_asistente_select');
const tbodyAsistentesVinculados = document.getElementById('tbody-asistentes-vinculados');
const errorTablaAsistentes = document.getElementById('error-tabla-asistentes');
const abrirModalAsistenteBtn = document.getElementById('abrir-modal-asistente-btn');
const modalAsistente = document.getElementById('modal-asistente');
const cerrarModalAsistente = document.getElementById('cerrar-modal-asistente');
const formVincularAsistente = document.getElementById('form-vincular-asistente');
const asistenteModalSelect = document.getElementById('asistente_modal_select');
const centroModalAsistenteSelect = document.getElementById('centro_modal_asistente_select');
const statusFormAsistente = document.getElementById('status-form-asistente');
const errorFormAsistente = document.getElementById('error-form-asistente');

/* -------- Centros (selector superior y modal) via centrosService -------- */
async function cargarCentrosAsistenteSelect() {
  centroAsistenteSelect.innerHTML = `<option value="" disabled selected>Cargando centros...</option>`;
  centroModalAsistenteSelect.innerHTML = `<option value="" disabled selected>Cargando centros...</option>`;

  try {
    const centros = await getCentrosActivos(); // <- usa tu servicio
    centroAsistenteSelect.innerHTML = `<option value="" disabled selected>Seleccione centro médico</option>`;
    centroModalAsistenteSelect.innerHTML = `<option value="" disabled selected>Seleccione centro médico</option>`;
    (centros || []).forEach(c => {
      const opt1 = document.createElement('option');
      opt1.value = c.id;
      opt1.textContent = c.nombre;
      centroAsistenteSelect.appendChild(opt1);

      const opt2 = document.createElement('option');
      opt2.value = c.id;
      opt2.textContent = c.nombre;
      centroModalAsistenteSelect.appendChild(opt2);
    });
  } catch (e) {
    centroAsistenteSelect.innerHTML = `<option value="" disabled>Error al cargar centros</option>`;
    centroModalAsistenteSelect.innerHTML = `<option value="" disabled>Error al cargar centros</option>`;
  }
}

/* -------- Asistentes (solo rol asistente) -------- */
async function cargarAsistenteSelect() {
  asistenteModalSelect.innerHTML = `<option value="" disabled selected>Cargando asistentes...</option>`;
  const { data, error } = await supabase
    .from('profesionales')
    .select('id, nombre, apellido, email, rol')
    .eq('rol', 'asistente');

  if (error || !data) {
    asistenteModalSelect.innerHTML = `<option value="" disabled>Error al cargar asistentes</option>`;
    return;
  }
  asistenteModalSelect.innerHTML = `<option value="" disabled selected>Seleccione un asistente</option>`;
  data.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.id;
    opt.textContent = `${a.nombre} ${a.apellido}${a.email ? ' ('+a.email+')' : ''}`;
    asistenteModalSelect.appendChild(opt);
  });
}

/* -------- Tabla: vínculos del centro (solo asistentes) -------- */
async function cargarTablaAsistentesVinculados(centro_id) {
  if (!centro_id) {
    tbodyAsistentesVinculados.innerHTML = `<tr><td colspan="6" class="muted">Seleccione un centro médico para ver sus asistentes vinculados.</td></tr>`;
    return;
  }
  tbodyAsistentesVinculados.innerHTML = `<tr><td colspan="6" class="muted">Cargando asistentes vinculados...</td></tr>`;
  errorTablaAsistentes.textContent = '';

  const { data, error } = await supabase
    .from('profesional_centro')
    .select(`
      profesional_id,
      activo,
      profesionales!inner(id, nombre, apellido, email, rol)
    `)
    .eq('centro_id', centro_id)
    .eq('activo', true)
    .eq('profesionales.rol', 'asistente');

  if (error) {
    tbodyAsistentesVinculados.innerHTML = `<tr><td colspan="6" class="muted">Error al cargar asistentes vinculados</td></tr>`;
    errorTablaAsistentes.textContent = error.message || JSON.stringify(error);
    return;
  }

  const vinculaciones = (data || []).filter(
    v => v.profesionales && v.profesionales.rol === 'asistente'
  );

  if (vinculaciones.length === 0) {
    tbodyAsistentesVinculados.innerHTML = `<tr><td colspan="6" class="muted">No hay asistentes vinculados a este centro médico.</td></tr>`;
    return;
  }

  tbodyAsistentesVinculados.innerHTML = vinculaciones.map(a => `
    <tr>
      <td>${a.profesionales?.nombre ?? ''}</td>
      <td>${a.profesionales?.apellido ?? ''}</td>
      <td>${a.profesionales?.email ?? ''}</td>
      <td>${a.profesionales?.rol ?? ''}</td>
      <td>${a.activo ? 'Sí' : 'No'}</td>
      <td class="action-cell">
        <button class="btn desasociar-btn"
                title="Desasociar"
                data-prof-id="${a.profesional_id}"
                data-centro-id="${centro_id}">
          Desasociar
        </button>
      </td>
    </tr>
  `).join('');

  // Enganche del click para los botones renderizados
  tbodyAsistentesVinculados.querySelectorAll('.desasociar-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const profId = btn.getAttribute('data-prof-id');
      const cenId  = btn.getAttribute('data-centro-id');
      desasociarAsistenteCentro(profId, cenId);
    });
  });
}

/* -------- Desasociar (marca activo=false en la relación) -------- */
async function desasociarAsistenteCentro(profesionalIdAsistente, centroId) {
  if (!confirm('¿Seguro que quieres desasociar este asistente del centro médico?')) return;
  const { error } = await supabase
    .from('profesional_centro')
    .update({ activo: false })
    .eq('profesional_id', profesionalIdAsistente)
    .eq('centro_id', centroId);

  if (error) {
    errorTablaAsistentes.textContent = 'Error al desasociar el asistente: ' + (error.message || JSON.stringify(error));
    return;
  }
  await cargarTablaAsistentesVinculados(centroId);
}

/* -------- Eventos -------- */
centroAsistenteSelect.addEventListener('change', async function() {
  await cargarTablaAsistentesVinculados(this.value);
});

document.getElementById('abrir-modal-asistente-btn').addEventListener('click', async () => {
  formVincularAsistente.reset();
  statusFormAsistente.textContent = '';
  errorFormAsistente.textContent = '';
  await cargarAsistenteSelect();
  await cargarCentrosAsistenteSelect();
  centroModalAsistenteSelect.value = centroAsistenteSelect.value || "";
  modalAsistente.style.display = 'flex';
});

cerrarModalAsistente.addEventListener('click', () => {
  modalAsistente.style.display = 'none';
});
window.addEventListener('click', (e) => {
  if (e.target === modalAsistente) modalAsistente.style.display = 'none';
});

/* -------- Vincular asistente -------- */
formVincularAsistente.addEventListener('submit', async function(e) {
  e.preventDefault();
  const profesional_id = asistenteModalSelect.value;
  const centro_id = centroModalAsistenteSelect.value;
  const activo = document.getElementById('activo_asistente_select').value === 'true';

  errorFormAsistente.textContent = '';
  if (!profesional_id || !centro_id) {
    statusFormAsistente.textContent = '';
    errorFormAsistente.textContent = 'Debe seleccionar asistente y centro médico.';
    return;
  }
  statusFormAsistente.textContent = 'Procesando...';

  const { data: vinculosExist, error: errorVincCheck } = await supabase
    .from('profesional_centro')
    .select('*')
    .eq('profesional_id', profesional_id)
    .eq('centro_id', centro_id)
    .eq('activo', true);

  if (errorVincCheck) {
    statusFormAsistente.textContent = '';
    errorFormAsistente.textContent = 'Error al verificar vinculación: ' + (errorVincCheck.message || JSON.stringify(errorVincCheck));
    return;
  }

  if (vinculosExist && vinculosExist.length > 0) {
    statusFormAsistente.textContent = '';
    errorFormAsistente.textContent = 'Ya existe la vinculación de este asistente con ese centro.';
    return;
  }

  const { error: errorPC } = await supabase
    .from('profesional_centro')
    .insert({ profesional_id, centro_id, activo: activo, prioridad: 1 });

  if (errorPC) {
    statusFormAsistente.textContent = '';
    errorFormAsistente.textContent = 'Error al asociar asistente a centro médico: ' +
      (errorPC.details || errorPC.message || JSON.stringify(errorPC));
    return;
  }

  errorFormAsistente.textContent = '';
  statusFormAsistente.textContent = '¡Asistente vinculado exitosamente!';
  formVincularAsistente.reset();
  modalAsistente.style.display = 'none';
  await cargarTablaAsistentesVinculados(centro_id);
  centroAsistenteSelect.value = centro_id;
});

/* -------- Init -------- */
await cargarCentrosAsistenteSelect();
</script>
