<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Asistentes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f9fb; margin: 0; }
    .container { max-width: 900px; margin: 36px auto; background: #fff; padding: 28px 22px 20px 22px; border-radius: 18px; box-shadow: 0 2px 8px rgba(80,60,160,.13); }
    h3 { color:#381e60; margin-bottom:22px;}
    .btn { background: #7656b0; color: #fff; border: none; border-radius: 6px; padding: 6px 16px; cursor:pointer; margin: 3px;}
    .btn.primary { background: #7656b0; }
    .btn:hover { background: #7f62b6; }
    input, select { border: 1px solid #e3d8f6; border-radius: 6px; padding: 5px 8px; font-size:15px; background:#f7f9fb; }
    label { color:#381e60;}
    .muted { color: #6b6480; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { text-align:left; padding: 10px 8px; }
    th { background: #e7e2fa; color: #381e60; font-size: 16px; }
    td { font-size: 15px; border-bottom: 1px solid #ece5fc; }
    tr:last-child td { border-bottom: none; }
    .action-cell { text-align: right; }
    .modal { position:fixed; z-index:999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); display:flex; align-items:center; justify-content:center;}
    .modal-content { background:#fff; padding:28px 22px 20px 22px; border-radius:14px; min-width:300px; max-width:350px; position:relative; box-shadow:0 2px 18px rgba(80,60,160,.18);}
    .close { position:absolute; right:12px; top:10px; font-size:20px; color:#7656b0; cursor:pointer;}
    .modal-content h4 { color:#381e60; margin-bottom:16px;}
    .modal-content input, .modal-content select { width:100%; margin-bottom:10px; }
    .modal-content .btn { width:100%; }
  </style>
</head>
<body>
<div class="container">
  <h3>Asistentes</h3>
  <table id="tabla-asistentes">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Email</th>
        <th>Centro Médico</th>
        <th>Activo</th>
      </tr>
    </thead>
    <tbody id="asistentes-tbody">
      <!-- Asistentes asociados se mostrarán aquí -->
    </tbody>
  </table>
  <div style="margin-top:20px;">
    <button type="button" id="crear-asistente-btn" class="btn primary">Crear asistente</button>
  </div>
  <div id="status-msg-asistente" class="muted" style="margin-top:10px;"></div>
</div>

<!-- Modal para crear asistente -->
<div id="modal-asistente" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" id="cerrar-modal-asistente">&times;</span>
    <h4 id="modal-title-asistente">Crear asistente</h4>
    <form id="form-asistente">
      <label for="asistente_nombre">Nombre Completo</label>
      <input type="text" id="asistente_nombre" placeholder="Nombre del asistente" required>
      <label for="asistente_email">Email</label>
      <input type="email" id="asistente_email" placeholder="Email" required>
      <label for="asistente_centro">Centro médico</label>
      <select id="asistente_centro" required>
        <option value="" disabled selected>Cargando centros...</option>
      </select>
      <label for="asistente_activo">Activo</label>
      <select id="asistente_activo">
        <option value="true" selected>Activo</option>
        <option value="false">Inactivo</option>
      </select>
      <button type="submit" class="btn primary" style="margin-top:10px;">Guardar</button>
      <div id="modal-asistente-status" class="muted" style="margin-top:10px;"></div>
    </form>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

// AVISO: Para crear usuarios en Auth necesitas la "service key" de Supabase (NO el anon key).
const supabaseUrl = 'https://vwkszvdvswznlgxlfdtz.supabase.co';
// Reemplaza esta clave por tu Supabase service key (NO la anon key)
const supabaseServiceKey = 'TU_SERVICE_KEY_AQUI';
const supabase = createClient(supabaseUrl, supabaseServiceKey);

const profesionalId = localStorage.getItem('profesional_id');

const asistentesTbody = document.getElementById('asistentes-tbody');
const crearAsistenteBtn = document.getElementById('crear-asistente-btn');
const modalAsistente = document.getElementById('modal-asistente');
const cerrarModalAsistente = document.getElementById('cerrar-modal-asistente');
const formAsistente = document.getElementById('form-asistente');
const modalAsistenteStatus = document.getElementById('modal-asistente-status');
const statusMsgAsistente = document.getElementById('status-msg-asistente');
const asistenteCentroSelect = document.getElementById('asistente_centro');

let centrosMedicosAsistente = [];

// Cargar centros médicos asociados al profesional para el select del asistente
async function cargarCentrosAsistente() {
  asistenteCentroSelect.innerHTML = `<option value="" disabled selected>Cargando centros...</option>`;
  if (!profesionalId) {
    asistenteCentroSelect.innerHTML = `<option value="" disabled>No se detectó profesional en sesión.</option>`;
    return;
  }
  try {
    const { data, error } = await supabase
      .from('profesional_centro')
      .select('centro_id, centros_medicos(id, nombre)')
      .eq('profesional_id', profesionalId)
      .eq('activo', true);

    if (error || !data) {
      asistenteCentroSelect.innerHTML = `<option value="" disabled>Error al cargar centros: ${error ? error.message : "Sin datos"}</option>`;
      console.error(error);
      return;
    }
    // Filtrar duplicados por centro_id
    const centrosUnicos = {};
    data.forEach(row => {
      if (row.centros_medicos && !centrosUnicos[row.centro_id]) {
        centrosUnicos[row.centro_id] = {
          id: row.centros_medicos.id,
          nombre: row.centros_medicos.nombre
        };
      }
    });
    centrosMedicosAsistente = Object.values(centrosUnicos);
    if (centrosMedicosAsistente.length === 0) {
      asistenteCentroSelect.innerHTML = `<option value="" disabled>No tienes centros médicos asociados aún.</option>`;
      return;
    }
    asistenteCentroSelect.innerHTML = `<option value="" disabled selected>Seleccione un centro</option>`;
    centrosMedicosAsistente.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.nombre;
      asistenteCentroSelect.appendChild(opt);
    });
  } catch (err) {
    asistenteCentroSelect.innerHTML = `<option value="" disabled>Error inesperado al cargar centros.</option>`;
    console.error(err);
  }
}

// Cargar asistentes asociados a los centros médicos del usuario
async function cargarTablaAsistentes() {
  asistentesTbody.innerHTML = `<tr><td colspan="4" class="muted">Cargando asistentes...</td></tr>`;
  if (!profesionalId) {
    asistentesTbody.innerHTML = '<tr><td colspan="4" class="muted">No se detectó profesional en sesión.</td></tr>';
    return;
  }
  try {
    const { data: centros, error: errorCentros } = await supabase
      .from('profesional_centro')
      .select('centro_id')
      .eq('profesional_id', profesionalId)
      .eq('activo', true);
    if (errorCentros) {
      asistentesTbody.innerHTML = `<tr><td colspan="4" class="muted">Error al cargar centros: ${errorCentros.message}</td></tr>`;
      return;
    }
    const idsCentros = centros && centros.length ? centros.map(c => c.centro_id) : [];
    let asistentes = [];
    if (idsCentros.length) {
      const { data, error } = await supabase
        .from('profesional_centro')
        .select(`
          profesional_id, centro_id, activo,
          profiles(display_name, email, role),
          centros_medicos(nombre)
        `)
        .in('centro_id', idsCentros)
        .eq('activo', true);
      if (error) {
        asistentesTbody.innerHTML = `<tr><td colspan="4" class="muted">Error al cargar asistentes: ${error.message}</td></tr>`;
        return;
      }
      if (data) {
        asistentes = data.filter(a => a.profiles && a.profiles.role === 'asistente');
      }
    }
    asistentesTbody.innerHTML = '';
    if (asistentes.length === 0) {
      asistentesTbody.innerHTML = '<tr><td colspan="4" class="muted">No hay asistentes asociados.</td></tr>';
      return;
    }
    asistentes.forEach(a => {
      asistentesTbody.innerHTML += `
        <tr>
          <td>${a.profiles.display_name ?? ''}</td>
          <td>${a.profiles.email ?? ''}</td>
          <td>${a.centros_medicos?.nombre ?? a.centro_id}</td>
          <td>${a.activo ? 'Sí' : 'No'}</td>
        </tr>
      `;
    });
  } catch (err) {
    asistentesTbody.innerHTML = `<tr><td colspan="4" class="muted">Error inesperado al cargar asistentes.</td></tr>`;
    console.error(err);
  }
}

// Abrir modal para crear asistente
crearAsistenteBtn.addEventListener('click', async () => {
  formAsistente.reset();
  modalAsistenteStatus.textContent = '';
  await cargarCentrosAsistente();
  modalAsistente.style.display = 'flex';
});

// Cerrar modal asistente
cerrarModalAsistente.addEventListener('click', () => {
  modalAsistente.style.display = 'none';
});
window.addEventListener('click', (e) => {
  if (e.target === modalAsistente) modalAsistente.style.display = 'none';
});

// Guardar asistente
formAsistente.addEventListener('submit', async function(e) {
  e.preventDefault();
  const nombre = document.getElementById('asistente_nombre').value.trim();
  const email = document.getElementById('asistente_email').value.trim();
  const centro_id = document.getElementById('asistente_centro').value;
  const activo = document.getElementById('asistente_activo').value === 'true';

  if (!nombre || !email || !centro_id) {
    modalAsistenteStatus.textContent = 'Todos los campos son obligatorios.';
    return;
  }
  modalAsistenteStatus.textContent = 'Guardando...';

  // 1. Crear el usuario en Auth (requiere service key, solo backend seguro)
  let userId = null;
  try {
    const { data: user, error: errorUser } = await supabase.auth.admin.createUser({
      email,
      password: 'Asistente_' + Math.random().toString(36).slice(-8), // contraseña temporal
      email_confirm: true
    });
    if (errorUser) {
      modalAsistenteStatus.textContent = 'Error al crear usuario en Auth: ' + errorUser.message;
      return;
    }
    userId = user.user.id;
  } catch (err) {
    modalAsistenteStatus.textContent = 'Error inesperado al crear usuario en Auth.';
    console.error(err);
    return;
  }

  // 2. Crear el registro en profiles usando el id del usuario Auth
  try {
    const { error: errorProfile } = await supabase
      .from('profiles')
      .insert([{ id: userId, email, display_name: nombre, role: 'asistente', active: activo }]);
    if (errorProfile) {
      modalAsistenteStatus.textContent = 'Error al crear asistente: ' + errorProfile.message;
      return;
    }
  } catch (err) {
    modalAsistenteStatus.textContent = 'Error inesperado al crear asistente en profiles.';
    console.error(err);
    return;
  }

  // 3. Asociar al centro
  try {
    const { error: errorPC } = await supabase
      .from('profesional_centro')
      .insert({ profesional_id: userId, centro_id, activo: true });
    if (errorPC) {
      modalAsistenteStatus.textContent = 'Asistente creado, pero error al asociar al centro: ' + errorPC.message;
      return;
    }
  } catch (err) {
    modalAsistenteStatus.textContent = 'Asistente creado, pero error inesperado al asociar al centro.';
    console.error(err);
    return;
  }

  modalAsistenteStatus.textContent = 'Asistente creado y asociado exitosamente!';
  await cargarTablaAsistentes();
  setTimeout(() => { modalAsistente.style.display = 'none'; }, 1200);
});

// Inicialización
if (profesionalId) {
  cargarTablaAsistentes();
} else {
  statusMsgAsistente.textContent = 'No se detectó profesional en sesión.';
}
</script>
</body>
</html>
