<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar Asistente y Vincular al Centro Médico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f9fb; margin: 0; }
    .container { max-width: 480px; margin: 36px auto; background: #fff; padding: 28px 22px 20px 22px; border-radius: 18px; box-shadow: 0 2px 8px rgba(80,60,160,.13); }
    h3 { color:#381e60; margin-bottom:22px;}
    .btn { background: #7656b0; color: #fff; border: none; border-radius: 6px; padding: 6px 16px; cursor:pointer; margin: 3px;}
    .btn.primary { background: #7656b0; }
    .btn:hover { background: #7f62b6; }
    input, select { border: 1px solid #e3d8f6; border-radius: 6px; padding: 6px 10px; font-size:15px; background:#f7f9fb; margin-bottom:12px; width:100%; }
    label { color:#381e60; display:block; margin-bottom:2px;}
    .muted { color: #6b6480; font-size: 13px; }
    .error { color: #b02525; font-size: 14px; margin-top:8px;}
    .success { color: #267c30; font-size: 14px; margin-top:8px;}
  </style>
</head>
<body>
<div class="container">
  <h3>Registrar Asistente</h3>
  <form id="asistente-form">
    <label for="nombre">Nombre</label>
    <input type="text" id="nombre" required>
    <label for="apellido">Apellido</label>
    <input type="text" id="apellido" required>
    <label for="email">Email</label>
    <input type="email" id="email" required>
    <label for="centro_select">Centro Médico</label>
    <select id="centro_select" required>
      <option value="" disabled selected>Cargando centros...</option>
    </select>
    <button type="submit" class="btn primary" style="margin-top:10px;">Crear y vincular asistente</button>
    <div id="form-status" style="margin-top:10px;"></div>
  </form>
</div>
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
const supabaseUrl = 'https://vwkszvdvswznlgxlfdtz.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3a3N6dmR2c3d6bmxneGxmZHR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NDM4NDQsImV4cCI6MjA3MTExOTg0NH0.TnDGheCSTUqGwTCMiHZ_CUgcAztCqVTc1cINkMud8p0';
const supabase = createClient(supabaseUrl, supabaseAnonKey);

const asistenteForm = document.getElementById('asistente-form');
const centroSelect = document.getElementById('centro_select');
const formStatus = document.getElementById('form-status');

// Carga los centros médicos activos
async function cargarCentros() {
  centroSelect.innerHTML = `<option value="" disabled selected>Cargando centros...</option>`;
  const { data, error } = await supabase
    .from('centros_medicos')
    .select('id, nombre')
    .eq('activo', true);

  if (error || !data) {
    centroSelect.innerHTML = `<option value="" disabled>Error al cargar centros</option>`;
    return;
  }
  if (data.length === 0) {
    centroSelect.innerHTML = `<option value="" disabled>No hay centros médicos activos.</option>`;
    return;
  }
  centroSelect.innerHTML = `<option value="" disabled selected>Seleccione un centro</option>`;
  data.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.nombre;
    centroSelect.appendChild(opt);
  });
}

// Al cargar la página, carga los centros médicos
cargarCentros();

// Evento submit para crear asistente y vincularlo
asistenteForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  formStatus.textContent = '';
  formStatus.className = '';

  const nombre = document.getElementById('nombre').value.trim();
  const apellido = document.getElementById('apellido').value.trim();
  const email = document.getElementById('email').value.trim();
  const centro_id = centroSelect.value;

  if (!nombre || !apellido || !email || !centro_id) {
    formStatus.textContent = 'Todos los campos son obligatorios.';
    formStatus.className = 'error';
    return;
  }

  // Verifica si existe ya el profesional con ese email
  const { data: existe, error: errorBusca } = await supabase
    .from('profesionales')
    .select('id')
    .eq('email', email)
    .single();

  let profesional_id;
  if (existe && existe.id) {
    profesional_id = existe.id; // Si ya existe, lo usamos
  } else {
    // Crea el profesional
    const { data: creado, error: errorInsert } = await supabase
      .from('profesionales')
      .insert({
        nombre,
        apellido,
        email,
        rol: 'asistente', // Si tienes el campo 'rol'
        activo: true
      })
      .select('id')
      .single();

    if (errorInsert || !creado) {
      formStatus.textContent = 'Error al crear asistente: ' + (errorInsert?.message || JSON.stringify(errorInsert));
      formStatus.className = 'error';
      return;
    }
    profesional_id = creado.id;
  }

  // Vincula el asistente al centro médico
  const { error: errorVinc } = await supabase
    .from('profesional_centro')
    .insert({
      profesional_id,
      centro_id,
      activo: true,
      prioridad: 1
    });

  if (errorVinc) {
    formStatus.textContent = 'Error al vincular asistente al centro: ' + (errorVinc.message || JSON.stringify(errorVinc));
    formStatus.className = 'error';
    return;
  }

  formStatus.textContent = '¡Asistente creado y vinculado exitosamente!';
  formStatus.className = 'success';
  asistenteForm.reset();
  await cargarCentros();
});
</script>
</body>
</html>
