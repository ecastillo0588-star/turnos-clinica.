<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Vincular asistente a centro médico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f9fb; margin: 0; }
    .container { max-width: 480px; margin: 50px auto; background: #fff; padding: 28px 22px; border-radius: 18px; box-shadow: 0 2px 8px rgba(80,60,160,.13); }
    h3 { color:#381e60; margin-bottom:22px;}
    .btn { background: #7656b0; color: #fff; border: none; border-radius: 6px; padding: 6px 16px; cursor:pointer; margin: 3px;}
    .btn.primary { background: #7656b0; }
    .btn:hover { background: #7f62b6; }
    input, select { border: 1px solid #e3d8f6; border-radius: 6px; padding: 5px 8px; font-size:15px; background:#f7f9fb; }
    label { color:#381e60;}
    .muted { color: #6b6480; font-size: 14px; }
    .error { color: #b02525; font-size: 14px; margin-top:8px;}
  </style>
</head>
<body>
<div class="container">
  <h3>Vincular asistente a centro médico</h3>
  <form id="vincular-form">
    <label for="asistente_select">Seleccione asistente</label>
    <select id="asistente_select" required>
      <option value="" disabled selected>Cargando asistentes...</option>
    </select>
    <label for="centro_select">Seleccione centro médico</label>
    <select id="centro_select" required>
      <option value="" disabled selected>Cargando centros...</option>
    </select>
    <label for="activo_select">Activo</label>
    <select id="activo_select">
      <option value="true" selected>Activo</option>
      <option value="false">Inactivo</option>
    </select>
    <button type="submit" class="btn primary" style="margin-top:10px;">Vincular</button>
    <div id="form-status" class="muted" style="margin-top:10px;"></div>
    <div id="form-error" class="error" style="margin-top:6px;"></div>
  </form>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
const supabaseUrl = 'https://vwkszvdvswznlgxlfdtz.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3a3N6dmR2c3d6bmxneGxmZHR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NDM4NDQsImV4cCI6MjA3MTExOTg0NH0.TnDGheCSTUqGwTCMiHZ_CUgcAztCqVTc1cINkMud8p0';
const supabase = createClient(supabaseUrl, supabaseAnonKey);

const vincularForm = document.getElementById('vincular-form');
const asistenteSelect = document.getElementById('asistente_select');
const centroSelect = document.getElementById('centro_select');
const formStatus = document.getElementById('form-status');
const formError = document.getElementById('form-error');

// Cargar asistentes (profesionales)
async function cargarAsistentes() {
  asistenteSelect.innerHTML = `<option value="" disabled selected>Cargando asistentes...</option>`;
  const { data, error } = await supabase
    .from('profesionales')
    .select('id, nombre, apellido, email');
  if (error || !data) {
    asistenteSelect.innerHTML = `<option value="" disabled>Error al cargar asistentes</option>`;
    return;
  }
  asistenteSelect.innerHTML = `<option value="" disabled selected>Seleccione un asistente</option>`;
  data.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    // Evita mostrar null en el email
    opt.textContent = `${p.nombre} ${p.apellido}${p.email ? ' ('+p.email+')' : ''}`;
    asistenteSelect.appendChild(opt);
  });
}

// Cargar centros médicos
async function cargarCentros() {
  centroSelect.innerHTML = `<option value="" disabled selected>Cargando centros...</option>`;
  const { data, error } = await supabase
    .from('centros_medicos')
    .select('id, nombre')
    .eq('activo', true);
  if (error || !data) {
    centroSelect.innerHTML = `<option value="" disabled>Error al cargar centros</option>`;
    return;
  }
  centroSelect.innerHTML = `<option value="" disabled selected>Seleccione centro médico</option>`;
  data.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.nombre;
    centroSelect.appendChild(opt);
  });
}

// Inicializar selects
cargarAsistentes();
cargarCentros();

// Vincular asistente al centro médico
vincularForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  const profesional_id = asistenteSelect.value;
  const centro_id = centroSelect.value;
  const activo = document.getElementById('activo_select').value === 'true';

  formError.textContent = '';

  if (!profesional_id || !centro_id) {
    formStatus.textContent = '';
    formError.textContent = 'Debe seleccionar asistente y centro médico.';
    return;
  }
  formStatus.textContent = 'Procesando...';

  // Verifica si la vinculación ya existe
  const { data: vinculosExist, error: errorVincCheck } = await supabase
    .from('profesional_centro')
    .select('*')
    .eq('profesional_id', profesional_id)
    .eq('centro_id', centro_id)
    .eq('activo', true);

  if (errorVincCheck) {
    formStatus.textContent = '';
    formError.textContent = 'Error al verificar vinculación: ' + (errorVincCheck.message || JSON.stringify(errorVincCheck));
    return;
  }

  if (vinculosExist && vinculosExist.length > 0) {
    formStatus.textContent = '';
    formError.textContent = 'Ya existe la vinculación de este asistente con ese centro.';
    return;
  }

  // Vincular al centro
  const { error: errorPC } = await supabase
    .from('profesional_centro')
    .insert({ profesional_id, centro_id, activo: activo, prioridad: 1 });

  if (errorPC) {
    formStatus.textContent = '';
    formError.textContent = 'Error al asociar asistente a centro médico: ' +
      (errorPC.details || errorPC.message || JSON.stringify(errorPC));
    return;
  }

  formError.textContent = '';
  formStatus.textContent = '¡Asistente vinculado exitosamente!';
  vincularForm.reset();
  setTimeout(() => { formStatus.textContent = ''; }, 1200);
});
</script>
</body>
</html>
