<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Alta de Asistentes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f9fb; margin: 0; }
    .container { max-width: 520px; margin: 44px auto; background: #fff; padding: 28px 22px 20px 22px; border-radius: 18px; box-shadow: 0 2px 8px rgba(80,60,160,.13); }
    h3 { color:#381e60; margin-bottom:22px;}
    label { color:#381e60;}
    input, select { border: 1px solid #e3d8f6; border-radius: 6px; padding: 6px 10px; font-size:15px; background:#f7f9fb; margin-bottom:10px; width:100%; }
    .btn { background: #7656b0; color: #fff; border: none; border-radius: 6px; padding: 8px 18px; cursor:pointer; margin-top:10px; width:100%;}
    .btn:hover { background: #7f62b6; }
    .muted { color: #6b6480; font-size: 13px; }
    .success { color: #2e994e; font-size: 14px; margin-top:8px;}
    .error { color: #b02525; font-size: 14px; margin-top:8px;}
    .small { font-size: 12px; color: #6b6480; margin-top: 2px;}
  </style>
</head>
<body>
<div class="container">
  <h3>Alta de Asistente</h3>
  <form id="form-asistente">
    <label for="asistente_nombre">Nombre Completo</label>
    <input type="text" id="asistente_nombre" required>
    <label for="asistente_email">Email</label>
    <input type="email" id="asistente_email" required>
    <label for="asistente_centro">Centro médico</label>
    <select id="asistente_centro" required>
      <option value="" disabled selected>Cargando centros...</option>
    </select>
    <button type="submit" class="btn">Crear asistente</button>
    <div id="status-msg" class="muted"></div>
    <div id="pass-msg" class="small"></div>
  </form>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
const supabaseUrl = 'https://vwkszvdvswznlgxlfdtz.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3a3N6dmR2c3d6bmxneGxmZHR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NDM4NDQsImV4cCI6MjA3MTExOTg0NH0.TnDGheCSTUqGwTCMiHZ_CUgcAztCqVTc1cINkMud8p0';
const supabase = createClient(supabaseUrl, supabaseAnonKey);

const profesionalId = localStorage.getItem('profesional_id');
const asistenteCentroSelect = document.getElementById('asistente_centro');
const formAsistente = document.getElementById('form-asistente');
const statusMsg = document.getElementById('status-msg');
const passMsg = document.getElementById('pass-msg');

// 1. Cargar centros médicos asociados al profesional
async function cargarCentros() {
  asistenteCentroSelect.innerHTML = `<option value="" disabled selected>Cargando centros...</option>`;
  const { data, error } = await supabase
    .from('profesional_centro')
    .select('centro_id, centros_medicos(id, nombre)')
    .eq('profesional_id', profesionalId)
    .eq('activo', true);

  if (error || !data) {
    asistenteCentroSelect.innerHTML = `<option value="" disabled>Error al cargar centros</option>`;
    return;
  }
  // Filtrar duplicados
  const centrosUnicos = {};
  data.forEach(row => {
    if (row.centros_medicos && !centrosUnicos[row.centro_id]) {
      centrosUnicos[row.centro_id] = {
        id: row.centros_medicos.id,
        nombre: row.centros_medicos.nombre
      };
    }
  });
  const centros = Object.values(centrosUnicos);
  if (centros.length === 0) {
    asistenteCentroSelect.innerHTML = `<option value="" disabled>No tienes centros médicos asociados aún.</option>`;
    return;
  }
  asistenteCentroSelect.innerHTML = `<option value="" disabled selected>Seleccione un centro</option>`;
  centros.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.nombre;
    asistenteCentroSelect.appendChild(opt);
  });
}

// 2. Crear asistente (registro + perfil + vinculación)
formAsistente.addEventListener('submit', async function(e) {
  e.preventDefault();
  statusMsg.textContent = '';
  passMsg.textContent = '';
  const nombre = document.getElementById('asistente_nombre').value.trim();
  const email = document.getElementById('asistente_email').value.trim();
  const centro_id = document.getElementById('asistente_centro').value;

  if (!nombre || !email || !centro_id) {
    statusMsg.textContent = 'Todos los campos son obligatorios.';
    statusMsg.className = 'error';
    return;
  }

  statusMsg.textContent = 'Creando asistente...';
  statusMsg.className = 'muted';

  // Genera contraseña temporal segura
  const password = Math.random().toString(36).slice(-8) + 'A1!';
  
  // 2.1 Registrar usuario en Auth
  let authResult;
  try {
    authResult = await supabase.auth.signUp({
      email,
      password,
      options: { emailRedirectTo: window.location.origin }
    });
  } catch (err) {
    statusMsg.textContent = "Error de conexión con Auth.";
    statusMsg.className = 'error';
    return;
  }

  if (authResult.error) {
    statusMsg.textContent = 'Error al crear usuario: ' + authResult.error.message;
    statusMsg.className = 'error';
    return;
  }

  const user = authResult.data.user;
  if (!user) {
    statusMsg.textContent = 'No se pudo obtener el usuario creado.';
    statusMsg.className = 'error';
    return;
  }

  // 2.2 Crear perfil en profiles
  const { error: errorProfile } = await supabase
    .from('profiles')
    .insert([{ id: user.id, display_name: nombre, email: email, role: 'asistente', active: true }]);
  if (errorProfile) {
    statusMsg.textContent = 'Error al crear perfil: ' + errorProfile.message;
    statusMsg.className = 'error';
    return;
  }

  // 2.3 Vincular a centro médico
  const { error: errorPC } = await supabase
    .from('profesional_centro')
    .insert({ profesional_id: user.id, centro_id, activo: true });
  if (errorPC) {
    statusMsg.textContent = 'Perfil creado, pero error al asociar a centro médico.';
    statusMsg.className = 'error';
    return;
  }

  statusMsg.textContent = '¡Asistente creado y vinculado exitosamente!';
  statusMsg.className = 'success';
  passMsg.textContent = `Contraseña temporal enviada al asistente: ${password}`;
  formAsistente.reset();
});

// Inicializar
if (profesionalId) {
  cargarCentros();
} else {
  statusMsg.textContent = 'No se detectó profesional en sesión.';
  statusMsg.className = 'error';
}
</script>
</body>
</html>
