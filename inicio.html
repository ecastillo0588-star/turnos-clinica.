<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inicio — EG Health Solutions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  /* ====== Variables y base ====== */
  :root{
    --brand:#7656b0; --brand-2:#a490d7; --ink:#381e60; --muted:#6b6480;
    --bg:#f7f9fb; --card:#fff; --line:#ece5fc;
    --ok:#0a7d38; --warn:#8a5800; --danger:#d32f2f;
    --board-h: 420px; /* Altura fija de cada tablero */
  }

  :where(#main-content.card){
    max-width:none!important;width:100%!important;padding:0!important;
    background:transparent!important;box-shadow:none!important;border-radius:0!important;
  }

  *{box-sizing:border-box}
  body{background:var(--bg);margin:0;font-family:'Segoe UI',Arial,sans-serif;color:var(--ink)}

  /* ====== Panel contenedor ====== */
  .shell{padding:10px}
  .panel{
    background:var(--card);border-radius:12px;box-shadow:0 1px 10px rgba(80,60,160,.08);
    padding:10px;display:flex;flex-direction:column;gap:10px;min-height:calc(100vh - 20px)
  }

  /* ====== Toolbar ====== */
  .toolbar{
    display:grid;
    grid-template-columns: minmax(220px,1fr) minmax(180px,.8fr) minmax(160px,.6fr) auto;
    gap:10px 12px; align-items:end;
  }
  .field{display:flex;flex-direction:column;gap:3px;min-width:0}
  .field label{font-size:11px;color:var(--muted)}
  .inp,.sel{
    background:#f7f9fb;border:1px solid var(--line);border-radius:8px;padding:7px 9px;
    font-size:13px;color:var(--ink);outline:none;width:100%;
  }
  .inp:focus,.sel:focus,textarea:focus{border-color:var(--brand-2)}
  .sel.compact{max-width:240px}
  .btn{appearance:none;border:none;background:var(--brand);color:#fff;border-radius:8px;padding:7px 10px;font-weight:600;cursor:pointer}
  .btn.secondary{background:#e7e2fa;color:#5a3e9a}

  /* Chip pill del centro */
  .pill{
    display:inline-flex;align-items:center;gap:6px;background:#f2effc;border:1px solid var(--line);
    color:#4b3a78;padding:6px 10px;border-radius:999px;font-size:13px;max-width:100%;white-space:nowrap;
  }

  /* ====== Barra superior: buscador + único KPI (horas libres) ====== */
  .bar{
    display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center;
  }
  .search-wrap{display:flex; align-items:center; gap:8px; width:fit-content;}
  .search-wrap .inp{ height:36px; width:22ch; max-width:22ch; } /* ≈20–22 caracteres */
  .search-clear{
    border:none;background:#efeafb;border:1px solid var(--line);
    border-radius:8px;padding:6px 10px;cursor:pointer
  }

  .stats{display:flex;flex-wrap:wrap;gap:8px}
  .chip{
    display:flex;align-items:baseline;gap:6px;background:#f3f1fb;border:1px solid var(--line);
    padding:6px 9px;border-radius:999px;font-size:12px;white-space:nowrap
  }
  .chip .v{font-size:16px;font-weight:800;line-height:1}

  /* ====== Grilla de tableros (2x2) ====== */
  .boards{
    display:grid; gap:12px; grid-template-columns:1fr 1fr;
    grid-auto-rows: var(--board-h);
    min-height:0;
  }
  .board{
    background:var(--card); border:1px solid var(--line); border-radius:10px;
    padding:10px; display:flex; flex-direction:column;
    height: var(--board-h); min-height:0; overflow:hidden;
  }
  .board h3{
    margin:2px 2px 8px; font-size:18px; line-height:1.2;
    display:flex; align-items:center; gap:8px; color:#3b2b66;
  }
  .hcount{
    font-size:12px; font-weight:700; color:#5a3e9a;
    background:#f0ebff; border:1px solid var(--line);
    padding:2px 8px; border-radius:999px;
  }

  /* Cuerpo con scroll interno y encabezado pegajoso */
  .board-body{
    position:relative; flex:1 1 auto; min-height:0; overflow:auto; padding:0 2px 6px;
  }
  .table{width:100%;border-collapse:separate;border-spacing:0 5px;min-width:720px;font-size:12.5px}
  .thead{position:sticky; top:0; z-index:2; background:#fff}
  .hrow,.row{display:grid;gap:0;align-items:center;border:1px solid var(--line);padding:5px 8px;border-radius:8px}
  .hrow{background:#f4f1ff;color:#5a3e9a;font-weight:700}
  .row{background:#faf9ff}
  .cell{padding:0 4px;min-width:0}
  .right{text-align:right} .nowrap{white-space:nowrap}

  .actions{display:flex;gap:6px;justify-content:flex-end}
  .icon{
    border:none;background:#f4f1ff;border:1px solid var(--line);
    width:28px;height:28px;border-radius:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;
  }

  /* Badges */
  .wait{display:inline-block;font-size:11px;padding:2px 7px;border-radius:999px;background:#fff4e6;border:1px solid #ffe0b3;color:#8a5800}
  .copago{display:inline-block;font-size:11px;padding:2px 7px;border-radius:999px;background:#e8fff0;border:1px solid #b9f0cb;color:#0a7d38}
  .copago.none{background:#f1f1f1;border-color:#e0e0e0;color:#666}

  /* Scrollbars bonitos en los cuerpos */
  .board-body::-webkit-scrollbar{height:8px;width:8px}
  .board-body::-webkit-scrollbar-thumb{background:#d8cfff;border-radius:8px}

  /* Ocultar acciones según rol (asistente) */
  .role-asistente [data-act="atender"]{ display:none !important; }
  .role-asistente [data-act="abrir-ficha"]{ display:none !important; }
  .role-asistente [data-act="finalizar"]{ display:none !important; }
  .role-asistente [data-act="volver-espera"]{ display:none !important; }

  /* ===== Drawer (ficha paciente) ===== */
  .drawer{
    position:fixed; top:0; right:0; height:100vh; width:min(980px,96vw);
    background:#fff; border-left:1px solid var(--line);
    box-shadow:-12px 0 40px rgba(0,0,0,.18);
    transform:translateX(100%); transition:transform .28s ease; z-index:9999;
    display:flex; flex-direction:column;
  }
  .drawer.open{ transform:translateX(0); }
  .drawer-head{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#e8def8;border-bottom:1px solid var(--line)}
  .drawer-title{margin:0;font-size:17px;color:#4b3a78;font-weight:700}
  .drawer-sub{font-size:12px;color:#6b6480}
  .drawer-body{flex:1;overflow:auto;padding:12px}
  .drawer-foot{padding:10px 12px;border-top:1px solid var(--line);background:#faf7ff;display:flex;gap:10px;justify-content:flex-end}
  .msg{font-size:13px}
  .ok{color:var(--ok)} .warn{color:var(--warn)}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:12px}
  .card h4{margin:0 0 10px 0;font-size:14px;color:#4b3a78}

  /* Enlace Historia Clínica con alto contraste */
  .hc-link{
    display:inline-flex; align-items:center; gap:6px;
    font-weight:600; text-decoration:none;
    color:#3b2b66; background:#ffffff; border:1px solid #cbbbe8;
    padding:6px 10px; border-radius:8px; box-shadow:0 1px 0 rgba(0,0,0,.05);
  }
  .hc-link:hover{ background:#fff; border-color:#b6a3ea; box-shadow:0 2px 6px rgba(0,0,0,.08); }
  .hc-link:focus-visible{ outline:2px solid #5a3e9a; outline-offset:2px; }
  .hc-ico{ display:block; flex:0 0 auto; opacity:.95; }

  #fichaDrawer .drawer-foot #fd-finalizar{
    background:#d32f2f !important; border-color:#b71c1c !important; color:#fff !important;
  }
  #fichaDrawer .drawer-foot #fd-finalizar:hover{ background:#b71c1c !important; }
  #fichaDrawer .drawer-foot #fd-finalizar:focus-visible{ outline:2px solid #7f1d1d; outline-offset:2px; }

  /* (Opcional) Mini-cal CSS si algún día lo usás para resaltar días con turnos */
  .mini-cal{
    display:grid; grid-template-columns:repeat(7,1fr); gap:6px;
    background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px;
    max-width:320px; box-shadow:0 8px 24px rgba(0,0,0,.12);
  }
  .mc-dow{ font-size:11px; color:#8a85a1; text-align:center; }
  .mc-day{
    display:flex; align-items:center; justify-content:center; height:36px;
    border-radius:8px; position:relative; cursor:pointer; user-select:none;
    border:1px solid transparent;
  }
  .mc-day .dot{ width:8px; height:8px; border-radius:50%; position:absolute; bottom:6px; left:50%; transform:translateX(-50%); background:#cfc8ef; }
  .mc-day.none .dot{ background:#e5e5ea; }
  .mc-day.free .dot{ background:#0a7d38; }
  .mc-day.busy .dot{ background:var(--danger); }
  .mc-day.selected{ outline:2px solid var(--brand); }
  .mc-day.today{ border-color:#b9a8ea; }
  .mc-day:hover{ background:#f5f1ff; }

  @media (max-width:1100px){
    .boards{grid-template-columns:1fr}
    .table{min-width:660px}
  }
  @media (max-width:700px){
    .bar{ grid-template-columns: 1fr; }
    .search-wrap{ width:100%; }
    .search-wrap .inp{ width:100%; max-width:100%; }
  }
</style>
</head>
<body>
<div class="shell">
  <section class="panel" id="inicio-root">

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="field">
        <label>Centro médico</label>
        <div class="pill" id="centro-chip">—</div>
      </div>
      <div class="field">
        <label>Profesional</label>
        <select id="prof-select" class="sel compact"><option>Profesional</option></select>
      </div>
      <div class="field">
        <label>Fecha</label>
        <input id="fecha" type="date" class="inp"/>
      </div>
      <div class="field" style="align-items:flex-end">
        <button id="btn-hoy" class="btn secondary">Hoy</button>
      </div>
    </div>

    <!-- Buscador masivo + único KPI -->
    <div class="bar">
      <div class="search-wrap">
        <input id="mass-search" class="inp" placeholder="Buscar por DNI o Apellido (en toda la vista)"/>
        <button id="mass-clear" class="search-clear" title="Limpiar">✖️</button>
      </div>
      <div class="stats">
        <div class="chip"><span>Horas libres</span> <span class="v" id="kpi-free">0 min</span></div>
        <div class="chip" id="kpi-sub" style="opacity:.8"></div>
      </div>
    </div>

    <!-- Boards -->
    <div class="boards">
      <div class="board">
        <h3 id="h-pend">Por llegar</h3>
        <div class="board-body"><table class="table" id="tbl-pend"></table></div>
      </div>
      <div class="board">
        <h3 id="h-esp">En sala de espera</h3>
        <div class="board-body"><table class="table" id="tbl-esp"></table></div>
      </div>
      <div class="board">
        <h3 id="h-atencion">En atención</h3>
        <div class="board-body"><table class="table" id="tbl-atencion"></table></div>
      </div>
      <div class="board">
        <h3 id="h-done">Atendidos</h3>
        <div class="board-body"><table class="table" id="tbl-done"></table></div>
      </div>
    </div>

    <!-- Drawer Ficha Paciente -->
    <aside id="fichaDrawer" class="drawer" aria-hidden="true">
      <header class="drawer-head">
        <div style="display:flex;flex-direction:column;gap:2px;min-width:0">
          <div id="fd-title" class="drawer-title">Paciente —</div>
          <div id="fd-sub" class="drawer-sub">DNI — · Edad —</div>
        </div>
        <span style="flex:1"></span>
        <a id="fd-hc" class="hc-link" href="#" target="_blank" rel="noopener" style="display:none">
          <svg class="hc-ico" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M14 2V8h6" fill="currentColor"/></svg>
          <span>Historia clínica</span>
        </a>
        <button id="fd-close" class="icon" title="Cerrar">✖️</button>
      </header>

      <div class="drawer-body">
        <div id="fd-status" class="msg" style="margin-bottom:8px"></div>

        <div class="stats" id="fd-summary" style="margin-bottom:10px">
          <div class="chip" id="fd-prof">Prof: —</div>
          <div class="chip" id="fd-centro">Centro: —</div>
          <div class="chip" id="fd-fecha">Fecha: —</div>
          <div class="chip" id="fd-hora">Hora: —</div>
          <div class="chip" id="fd-estado">Estado: —</div>
          <div class="chip" id="fd-copago">Copago: —</div>
        </div>

        <div class="card">
          <h4>Datos del paciente</h4>
          <div class="row3">
            <div class="field"><label>DNI</label><input id="fd-dni" class="inp"></div>
            <div class="field"><label>Apellido</label><input id="fd-apellido" class="inp"></div>
            <div class="field"><label>Nombre</label><input id="fd-nombre" class="inp"></div>
          </div>
          <div class="row3" style="margin-top:10px">
            <div class="field"><label>Fecha de nacimiento</label><input id="fd-nac" type="date" class="inp"></div>
            <div class="field"><label>Teléfono</label><input id="fd-tel" class="inp"></div>
            <div class="field"><label>Email</label><input id="fd-mail" class="inp"></div>
          </div>
        </div>

        <div class="card">
          <h4>Obra social</h4>
          <div class="row3">
            <div class="field">
              <label>Obra social</label>
              <select id="fd-obra" class="sel"></select>
            </div>
            <div class="field"><label>N° afiliado</label><input id="fd-afiliado" class="inp"></div>
            <div class="field">
              <label>Credencial (URL)</label>
              <div style="display:flex;gap:8px;align-items:center">
                <input id="fd-cred" class="inp" placeholder="https://..." />
                <a id="fd-cred-link" class="btn secondary" href="#" target="_blank" rel="noopener">Ver</a>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h4>Contacto de emergencia</h4>
          <div class="row2">
            <div class="field"><label>Nombre</label><input id="fd-ec-nom" class="inp" /></div>
            <div class="field"><label>Apellido</label><input id="fd-ec-ape" class="inp" /></div>
          </div>
          <div class="row2" style="margin-top:10px">
            <div class="field"><label>Celular</label><input id="fd-ec-cel" class="inp" /></div>
            <div class="field"><label>Vínculo</label><input id="fd-ec-vin" class="inp" /></div>
          </div>
        </div>

        <div class="card">
          <h4>Seguimiento</h4>
          <div class="row3">
            <div class="field"><label>Próximo control</label><input id="fd-prox" type="date" class="inp" /></div>
            <div class="field"><label>Renovación de receta</label><input id="fd-renov" type="date" class="inp" /></div>
            <div class="field" style="display:flex;align-items:center;gap:8px;margin-top:22px">
              <input id="fd-activo" type="checkbox" /><label for="fd-activo">Activo</label>
            </div>
          </div>
        </div>

        <div class="card">
          <h4>Notas del turno</h4>
          <div class="field"><textarea id="fd-notas" class="inp" placeholder="Observaciones internas..." style="min-height:80px"></textarea></div>
        </div>

      </div>

      <footer class="drawer-foot">
        <span id="fd-msg" class="msg"></span>
        <button id="fd-cerrar" class="btn secondary">Cerrar</button>
        <button id="fd-guardar" class="btn">Guardar cambios</button>
        <button id="fd-finalizar" class="btn">Finalizar</button>
      </footer>
    </aside>

  </section>
</div>

<script type="module">
import supabase from './supabaseClient.js';

/* === ESTADOS === */
const EST = {
  ASIGNADO:'asignado',
  EN_ESPERA:'en_espera',
  EN_ATENCION:'en_atencion',
  CANCELADO:'cancelado',
  CONFIRMADO:'confirmado',
  ATENDIDO:'atendido'
};

const UI = {
  centroChip: document.getElementById('centro-chip'),
  profSelect: document.getElementById('prof-select'),
  fecha: document.getElementById('fecha'),
  btnHoy: document.getElementById('btn-hoy'),
  tblPend: document.getElementById('tbl-pend'),
  tblEsp: document.getElementById('tbl-esp'),
  tblAtencion: document.getElementById('tbl-atencion'),
  tblDone: document.getElementById('tbl-done'),
  kpiFree: document.getElementById('kpi-free'),
  kpiSub: document.getElementById('kpi-sub'),
  massSearch: document.getElementById('mass-search'),
  massClear: document.getElementById('mass-clear'),
};
const H = {
  pend: document.getElementById('h-pend'),
  esp: document.getElementById('h-esp'),
  atenc: document.getElementById('h-atencion'),
  done: document.getElementById('h-done'),
};

/* Drawer refs */
const Drawer = {
  el: document.getElementById('fichaDrawer'),
  close: document.getElementById('fd-close'),
  status: document.getElementById('fd-status'),
  msg: document.getElementById('fd-msg'),
  title: document.getElementById('fd-title'),
  sub: document.getElementById('fd-sub'),
  hc: document.getElementById('fd-hc'),

  prof: document.getElementById('fd-prof'),
  centro: document.getElementById('fd-centro'),
  fecha: document.getElementById('fd-fecha'),
  hora: document.getElementById('fd-hora'),
  estado: document.getElementById('fd-estado'),
  copago: document.getElementById('fd-copago'),

  dni: document.getElementById('fd-dni'),
  ape: document.getElementById('fd-apellido'),
  nom: document.getElementById('fd-nombre'),
  nac: document.getElementById('fd-nac'),
  tel: document.getElementById('fd-tel'),
  mail: document.getElementById('fd-mail'),

  obra: document.getElementById('fd-obra'),
  afiliado: document.getElementById('fd-afiliado'),
  cred: document.getElementById('fd-cred'),
  credLink: document.getElementById('fd-cred-link'),

  ecNom: document.getElementById('fd-ec-nom'),
  ecApe: document.getElementById('fd-ec-ape'),
  ecCel: document.getElementById('fd-ec-cel'),
  ecVin: document.getElementById('fd-ec-vin'),

  prox: document.getElementById('fd-prox'),
  renov: document.getElementById('fd-renov'),
  activo: document.getElementById('fd-activo'),

  notas: document.getElementById('fd-notas'),

  btnCerrar: document.getElementById('fd-cerrar'),
  btnGuardar: document.getElementById('fd-guardar'),
  btnFinalizar: document.getElementById('fd-finalizar'),
};

/* Preferencias / contexto */
let currentCentroId = localStorage.getItem('centro_medico_id');
let currentCentroNombre = localStorage.getItem('centro_medico_nombre') || '';
const userRole = localStorage.getItem('user_role');
const loggedProfesionalId = localStorage.getItem('profesional_id');
let currentProfesional = null;
let currentFechaISO = null;
let centroWatchTimer = null;

/* Filtro global (buscador masivo) */
let filterText = '';

/* —— Helpers —— */
function pad(n){return n<10?'0'+n:''+n}
function todayISO(){const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}
function toHM(t){return (t??'').toString().slice(0,5)}
function minutesDiff(start,end){ const [h1,m1]=start.split(':').map(Number),[h2,m2]=end.split(':').map(Number); return (h2*60+m2)-(h1*60+m1); }
function nowHHMMSS(){const d=new Date();return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`}
function fmtMoney(n){return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0))}
function titleCase(s){ return (s||'').split(' ').filter(Boolean).map(w=>w[0]?.toUpperCase()+w.slice(1).toLowerCase()).join(' ') }
function calcEdad(f){ if(!f) return null; const d=new Date(f); if(isNaN(d)) return null; const t=new Date();
  let a=t.getFullYear()-d.getFullYear(); const m=t.getMonth()-d.getMonth(); if (m<0 || (m===0 && t.getDate()<d.getDate())) a--; return Math.max(a,0);
}
function norm(s){ return (s??'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); }
function matchTurno(t){
  if (!filterText) return true;
  const p=t.pacientes||{};
  return norm(p.apellido).includes(filterText) || String(p.dni||'').includes(filterText);
}
function setDrawerMsg(msg,tone=''){ if(Drawer.msg){ Drawer.msg.textContent=msg||''; Drawer.msg.className='msg '+(tone||''); } }
function setDrawerStatus(msg,tone=''){ if(Drawer.status){ Drawer.status.textContent=msg||''; Drawer.status.className='msg '+(tone||''); } }

/* Rol en body */
if (userRole !== 'medico') document.body.classList.add('role-asistente'); else document.body.classList.remove('role-asistente');

/* Drawer helpers */
function showDrawer(){ Drawer.el.classList.add('open'); Drawer.el.setAttribute('aria-hidden','false'); }
function hideDrawer(){ Drawer.el.classList.remove('open'); Drawer.el.setAttribute('aria-hidden','true'); }
if (Drawer.close) Drawer.close.onclick = hideDrawer;
if (Drawer.btnCerrar) Drawer.btnCerrar.onclick = hideDrawer;

/* centro */
async function fetchCentroById(id){
  const { data } = await supabase.from('centros_medicos').select('nombre').eq('id', id).maybeSingle();
  return data?.nombre || '';
}
function renderCentroChip(){ UI.centroChip.textContent = currentCentroNombre || '—'; }
async function syncCentroFromStorage(force=false){
  const id = localStorage.getItem('centro_medico_id');
  const nom = localStorage.getItem('centro_medico_nombre') || currentCentroNombre;
  if (force || id !== currentCentroId || nom !== currentCentroNombre){
    currentCentroId = id;
    currentCentroNombre = nom || await fetchCentroById(id);
    localStorage.setItem('centro_medico_nombre', currentCentroNombre);
    renderCentroChip();
    await loadProfesionales();
    await refreshAll();
  }
}
function startCentroWatcher(){ if (centroWatchTimer) clearInterval(centroWatchTimer); centroWatchTimer=setInterval(()=>syncCentroFromStorage(false), 1000); }
window.addEventListener('beforeunload', ()=>{ if (centroWatchTimer) clearInterval(centroWatchTimer); });

/* profesionales */
async function loadProfesionales(){
  const sel=UI.profSelect;

  if (userRole==='medico' && loggedProfesionalId){
    let label=null;
    try{
      const { data }=await supabase.from('profesionales').select('id,nombre,apellido,display_name').eq('id',loggedProfesionalId).single();
      if (data) label = data.display_name || [data.apellido,data.nombre].filter(Boolean).join(', ') || data.nombre || data.apellido;
    }catch(_){}
    if (!label) label = localStorage.getItem('user_name') || localStorage.getItem('email') || 'Mi agenda';
    sel.innerHTML = `<option value="${loggedProfesionalId}">${label}</option>`;
    sel.value = loggedProfesionalId; sel.disabled = true; currentProfesional = loggedProfesionalId; return;
  }

  sel.disabled = false;

  const { data: map } = await supabase
    .from('profesional_centro')
    .select('profesional_id')
    .eq('centro_id', currentCentroId)
    .eq('activo', true);

  const ids = [...new Set((map||[]).map(r=>r.profesional_id).filter(Boolean))];
  if (!ids.length){ sel.innerHTML='<option value="">Sin profesionales</option>'; currentProfesional=null; return; }

  const { data: profs } = await supabase
    .from('profesionales')
    .select('id,nombre,apellido,display_name')
    .in('id', ids)
    .order('apellido', {ascending:true});

  sel.innerHTML = (profs||[]).map(p=>{
    const n=p.display_name||[p.apellido,p.nombre].filter(Boolean).join(', ')||p.nombre||p.apellido||p.id;
    return `<option value="${p.id}">${n}</option>`;
  }).join('');

  currentProfesional = (profs && profs[0]) ? profs[0].id : null;
  if (currentProfesional) sel.value = currentProfesional;
}
UI.profSelect.addEventListener('change', async ()=>{ currentProfesional = UI.profSelect.value || null; await refreshAll(); });

/* fecha */
UI.fecha.value=todayISO(); currentFechaISO=UI.fecha.value;
UI.fecha.addEventListener('change', ()=>{ currentFechaISO=UI.fecha.value||todayISO(); refreshAll(); });
UI.btnHoy.addEventListener('click', ()=>{ const h=todayISO(); UI.fecha.value=h; currentFechaISO=h; refreshAll(); });

/* data día */
async function fetchDiaData(){
  if(!currentProfesional) return { pendientes:[], presentes:[], atencion:[], atendidos:[], agenda:[], turnos:[] };
  const common={centro_id:currentCentroId, profesional_id:currentProfesional, fecha:currentFechaISO};

  const [pend, pres, atenc, done, agenda, turnos] = await Promise.all([
    supabase.from('turnos')
      .select('id, fecha, hora_inicio, hora_fin, estado, hora_arribo, copago, paciente_id, pacientes(id, dni, nombre, apellido, obra_social)')
      .eq('centro_id', common.centro_id).eq('profesional_id', common.profesional_id).eq('fecha', common.fecha)
      .eq('estado', EST.ASIGNADO).order('hora_inicio', {ascending:true}),
    supabase.from('turnos')
      .select('id, fecha, hora_inicio, hora_fin, estado, hora_arribo, copago, paciente_id, pacientes(id, dni, nombre, apellido, obra_social)')
      .eq('centro_id', common.centro_id).eq('profesional_id', common.profesional_id).eq('fecha', common.fecha)
      .eq('estado', EST.EN_ESPERA).order('hora_inicio', {ascending:true}),
    supabase.from('turnos')
      .select('id, fecha, hora_inicio, hora_fin, estado, hora_arribo, copago, paciente_id, pacientes(id, dni, nombre, apellido, obra_social)')
      .eq('centro_id', common.centro_id).eq('profesional_id', common.profesional_id).eq('fecha', common.fecha)
      .eq('estado', EST.EN_ATENCION).order('hora_inicio', {ascending:true}),
    supabase.from('turnos')
      .select('id, fecha, hora_inicio, hora_fin, estado, hora_arribo, copago, paciente_id, pacientes(id, dni, nombre, apellido, obra_social, historia_clinica)')
      .eq('centro_id', common.centro_id).eq('profesional_id', common.profesional_id).eq('fecha', common.fecha)
      .eq('estado', EST.ATENDIDO).order('hora_inicio', {ascending:true}),
    supabase.from('agenda').select('id, fecha, hora_inicio, hora_fin')
      .eq('centro_id', common.centro_id).eq('profesional_id', common.profesional_id).eq('fecha', common.fecha).order('hora_inicio',{ascending:true}),
    supabase.from('turnos').select('id, hora_inicio, hora_fin, estado')
      .eq('centro_id', common.centro_id).eq('profesional_id', common.profesional_id).eq('fecha', common.fecha)
  ]);

  return {
    pendientes: pend.data||[],
    presentes: pres.data||[],
    atencion:  atenc.data||[],
    atendidos: done.data||[],
    agenda:    agenda.data||[],
    turnos:    turnos.data||[]
  };
}

/* —— Render helpers de filtro —— */
function applyFilter(data){
  if (!filterText) return {
    pendientes:data.pendientes, presentes:data.presentes, atencion:data.atencion, atendidos:data.atendidos
  };
  return {
    pendientes: (data.pendientes||[]).filter(matchTurno),
    presentes:  (data.presentes||[]).filter(matchTurno),
    atencion:   (data.atencion||[]).filter(matchTurno),
    atendidos:  (data.atendidos||[]).filter(matchTurno),
  };
}

/* Por llegar */
function renderPendientes(list){
  const grid='100px 120px 1fr 1fr 1fr 150px';
  const head=`<thead class="thead"><tr class="hrow" style="grid-template-columns:${grid}">
      <th class="cell">Hora</th><th class="cell">DNI</th>
      <th class="cell">Nombre</th><th class="cell">Apellido</th><th class="cell">Obra social</th>
      <th class="cell right">Acciones</th></tr></thead>`;

  const rows=(list||[]).map(t=>{
    const p=t.pacientes||{};
    const hora=`<b>${toHM(t.hora_inicio)}</b>${t.hora_fin?' — '+toHM(t.hora_fin):''}`;
    const acciones = `
      <div class="actions">
        <button class="icon" data-id="${t.id}" data-act="cancel" title="Anular">🗑️</button>
        <button class="icon" data-id="${t.id}" data-act="arribo" title="Pasar a En espera">🟢</button>
      </div>`;
    return `<tr class="row" style="grid-template-columns:${grid}">
      <td class="cell nowrap">${hora}</td>
      <td class="cell">${p.dni||'—'}</td>
      <td class="cell">${titleCase(p.nombre)||'—'}</td>
      <td class="cell">${titleCase(p.apellido)||'—'}</td>
      <td class="cell">${p.obra_social||'—'}</td>
      <td class="cell right">${acciones}</td>
    </tr>`;
  }).join('');

  UI.tblPend.innerHTML=head+'<tbody>'+rows+'</tbody>';

  UI.tblPend.querySelectorAll('.icon').forEach(btn=>{
    const id=btn.getAttribute('data-id'), act=btn.getAttribute('data-act');
    if(act==='arribo') btn.onclick=()=> marcarLlegadaYCopago(id);
    if(act==='cancel') btn.onclick=()=> anularTurno(id);
  });
}

/* En sala de espera */
let waitTimer=null;
function startWaitTicker(){ if(waitTimer) clearInterval(waitTimer); waitTimer=setInterval(updateWaitBadges, 30000); }
function updateWaitBadges(){
  const nodes=document.querySelectorAll('[data-arribo-ts]');
  const now=new Date();
  nodes.forEach(n=>{
    const ts=n.getAttribute('data-arribo-ts'); if(!ts) return;
    const ms= now - new Date(ts);
    const mins=Math.max(0, Math.round(ms/60000));
    const hh=Math.floor(mins/60), mm=mins%60;
    n.textContent = hh? `${hh}h ${mm}m` : `${mm}m`;
  });
}
function renderPresentes(list){
  const grid='90px 100px 1fr 1fr 1fr 110px 180px';
  const head=`<thead class="thead"><tr class="hrow" style="grid-template-columns:${grid}">
      <th class="cell">Espera</th><th class="cell">Hora</th><th class="cell">Nombre</th>
      <th class="cell">Apellido</th><th class="cell">Obra social</th><th class="cell">Copago</th>
      <th class="cell right">Acciones</th></tr></thead>`;

  const puedeAtender = (userRole === 'medico');

  const rows=(list||[]).map(t=>{
    const p=t.pacientes||{};
    const hora=`<b>${toHM(t.hora_inicio)}</b>${t.hora_fin?' — '+toHM(t.hora_fin):''}`;
    const arriboISO=`${currentFechaISO}T${toHM(t.hora_arribo)||'00:00'}:00`;
    const copBadge=(t.copago && Number(t.copago)>0)?`<span class="copago">${fmtMoney(t.copago)}</span>`:`<span class="copago none">Sin copago</span>`;
    const acciones = `
      <button class="icon" data-id="${t.id}" data-act="volver" title="Volver a pendientes">↩️</button>
      <button class="icon" data-id="${t.id}" data-act="cancel" title="Anular">🗑️</button>
      ${puedeAtender ? `<button class="icon" data-id="${t.id}" data-act="atender" title="En atención">✅</button>` : ''}`;
    return `<tr class="row" style="grid-template-columns:${grid}">
      <td class="cell"><span class="wait" data-arribo-ts="${arriboISO}">—</span></td>
      <td class="cell nowrap">${hora}</td>
      <td class="cell">${titleCase(p.nombre)||'—'}</td>
      <td class="cell">${titleCase(p.apellido)||'—'}</td>
      <td class="cell">${p.obra_social||'—'}</td>
      <td class="cell">${copBadge}</td>
      <td class="cell right"><div class="actions">${acciones}</div></td>
    </tr>`;
  }).join('');

  UI.tblEsp.innerHTML=head+'<tbody>'+rows+'</tbody>';

  UI.tblEsp.querySelectorAll('.icon').forEach(btn=>{
    const id=btn.getAttribute('data-id'), act=btn.getAttribute('data-act');
    if(act==='volver') btn.onclick=async()=>{ await supabase.from('turnos').update({estado:EST.ASIGNADO, hora_arribo:null}).eq('id',id); await refreshAll(); };
    if(act==='cancel') btn.onclick=()=> anularTurno(id);
    if(act==='atender') btn.onclick=()=> pasarAEnAtencion(id);
  });

  updateWaitBadges(); startWaitTicker();
}

/* En atención */
function renderAtencion(list){
  const grid='100px 120px 1fr 1fr 1fr 210px';
  const head=`<thead class="thead"><tr class="hrow" style="grid-template-columns:${grid}">
      <th class="cell">Hora</th><th class="cell">DNI</th>
      <th class="cell">Nombre</th><th class="cell">Apellido</th><th class="cell">Obra social</th>
      <th class="cell right">Acciones</th></tr></thead>`;
  const puedeFinalizar = (userRole === 'medico');
  const rows=(list||[]).map(t=>{
    const p=t.pacientes||{};
    const hora=`<b>${toHM(t.hora_inicio)}</b>${t.hora_fin?' — '+toHM(t.hora_fin):''}`;
    const acciones = `
      <button class="icon" data-id="${t.id}" data-act="abrir-ficha" title="Abrir ficha paciente">📄</button>
      <button class="icon" data-id="${t.id}" data-act="volver-espera" title="Volver a sala de espera">⏪</button>
      ${puedeFinalizar ? `<button class="icon" data-id="${t.id}" data-act="finalizar" title="Marcar ATENDIDO">✅</button>` : ''}`;
    return `<tr class="row" style="grid-template-columns:${grid}">
      <td class="cell nowrap">${hora}</td>
      <td class="cell">${p.dni||'—'}</td>
      <td class="cell">${titleCase(p.nombre)||'—'}</td>
      <td class="cell">${titleCase(p.apellido)||'—'}</td>
      <td class="cell">${p.obra_social||'—'}</td>
      <td class="cell right"><div class="actions">${acciones}</div></td>
    </tr>`;
  }).join('');
  UI.tblAtencion.innerHTML = head + '<tbody>' + rows + '</tbody>';

  UI.tblAtencion.querySelectorAll('.icon').forEach(btn=>{
    const id=btn.getAttribute('data-id'), act=btn.getAttribute('data-act');
    if(act==='abrir-ficha') btn.onclick=()=> openFicha(id);
    if(act==='volver-espera') btn.onclick=()=> volverASalaEspera(id);
    if(act==='finalizar') btn.onclick=()=> finalizarAtencion(id);
  });
}

/* Atendidos (con HC y abrir ficha) */
function renderAtendidos(list){
  const grid='100px 120px 1fr 1fr 1fr 120px 120px';
  const head=`<thead class="thead"><tr class="hrow" style="grid-template-columns:${grid}">
      <th class="cell">Hora</th><th class="cell">DNI</th>
      <th class="cell">Nombre</th><th class="cell">Apellido</th><th class="cell">Obra social</th>
      <th class="cell">Copago</th><th class="cell right">Acciones</th></tr></thead>`;
  const rows=(list||[]).map(t=>{
    const p=t.pacientes||{};
    const hora=`<b>${toHM(t.hora_inicio)}</b>${t.hora_fin?' — '+toHM(t.hora_fin):''}`;
    const cop = (t.copago && Number(t.copago)>0)? fmtMoney(t.copago) : '—';
    const hcBtn = p.historia_clinica ? `<a class="icon" href="${p.historia_clinica}" target="_blank" rel="noopener" title="Historia clínica">🔗</a>` : '';
    const acciones = `<button class="icon" data-id="${t.id}" data-act="abrir-ficha" title="Abrir ficha paciente">📄</button>${hcBtn}`;
    return `<tr class="row" style="grid-template-columns:${grid}">
      <td class="cell nowrap">${hora}</td>
      <td class="cell">${p.dni||'—'}</td>
      <td class="cell">${titleCase(p.nombre)||'—'}</td>
      <td class="cell">${titleCase(p.apellido)||'—'}</td>
      <td class="cell">${p.obra_social||'—'}</td>
      <td class="cell">${cop}</td>
      <td class="cell right"><div class="actions">${acciones}</div></td>
    </tr>`;
  }).join('');
  UI.tblDone.innerHTML = head + '<tbody>' + rows + '</tbody>';

  UI.tblDone.querySelectorAll('.icon').forEach(btn=>{
    const id=btn.getAttribute('data-id'), act=btn.getAttribute('data-act');
    if(act==='abrir-ficha') btn.onclick=()=> openFicha(id);
  });
}

/* Drawer: carga */
let drawerTurnoId = null;

async function loadObrasSociales(currentLabel){
  Drawer.obra.innerHTML = '<option value="">(Sin obra social)</option>';
  const { data } = await supabase.from('obras_sociales').select('obra_social').order('obra_social',{ascending:true});
  const labels = (data||[]).map(r=>r.obra_social);
  labels.forEach(lbl => {
    const opt=document.createElement('option');
    opt.value=lbl; opt.textContent=lbl; Drawer.obra.appendChild(opt);
  });
  if (currentLabel && !labels.includes(currentLabel)) {
    const opt=document.createElement('option'); opt.value=currentLabel; opt.textContent=currentLabel; Drawer.obra.appendChild(opt);
  }
  Drawer.obra.value = currentLabel || '';
}

function renderHeaderPaciente(p){
  const ape = titleCase(p?.apellido||'');
  const nom = titleCase(p?.nombre||'');
  const dni = (p?.dni || '—');
  const edad = calcEdad(p?.fecha_nacimiento);
  if (Drawer.title) Drawer.title.textContent = `${ape}, ${nom}`;
  if (Drawer.sub) Drawer.sub.textContent = `DNI ${dni} · ${edad!=null? `${edad} años`:'Edad —'}`;
  if (p?.historia_clinica){
    Drawer.hc.style.display='inline-flex';
    Drawer.hc.href = p.historia_clinica;
  } else {
    Drawer.hc.style.display='none';
    Drawer.hc.removeAttribute('href');
  }
}

async function openFicha(turnoId){
  drawerTurnoId = turnoId;
  try { localStorage.setItem('current_turno_id', String(turnoId)); } catch {}
  setDrawerStatus('Cargando...');
  setDrawerMsg('');
  showDrawer();

  const { data:t, error:terr } = await supabase
    .from('turnos')
    .select('id, fecha, hora_inicio, hora_fin, estado, hora_arribo, copago, notas, paciente_id, profesional_id, centro_id')
    .eq('id', turnoId)
    .maybeSingle();

  if (terr || !t){ setDrawerStatus('No se pudo cargar el turno','warn'); console.error(terr); return; }

  const [pRes, profRes, centroRes] = await Promise.all([
    supabase.from('pacientes').select('id,dni,apellido,nombre,fecha_nacimiento,telefono,email,obra_social,numero_afiliado,credencial,contacto_nombre,contacto_apellido,contacto_celular,vinculo,historia_clinica,proximo_control,renovacion_receta,activo').eq('id', t.paciente_id).maybeSingle(),
    supabase.from('profesionales').select('display_name,nombre,apellido').eq('id', t.profesional_id).maybeSingle(),
    supabase.from('centros_medicos').select('nombre').eq('id', t.centro_id).maybeSingle(),
  ]);

  const p = pRes?.data || {};
  const prof = profRes?.data || null;
  const centro = centroRes?.data || null;

  Drawer.prof.textContent   = `Prof: ${prof ? (prof.display_name || [prof.apellido, prof.nombre].filter(Boolean).join(', ')) : '—'}`;
  Drawer.centro.textContent = `Centro: ${centro?.nombre || '—'}`;
  Drawer.fecha.textContent  = `Fecha: ${t.fecha || '—'}`;
  Drawer.hora.textContent   = `Hora: ${t.hora_inicio ? toHM(t.hora_inicio) : '—'}`;
  Drawer.estado.textContent = `Estado: ${t.estado || '—'}`;
  Drawer.copago.textContent = `Copago: ${t.copago!=null ? fmtMoney(t.copago) : '—'}`;
  Drawer.notas.value        = t.notas || '';

  renderHeaderPaciente(p);
  Drawer.dni.value = p.dni || '';
  Drawer.ape.value = p.apellido || '';
  Drawer.nom.value = p.nombre || '';
  Drawer.nac.value = p.fecha_nacimiento || '';
  Drawer.tel.value = p.telefono || '';
  Drawer.mail.value= p.email || '';
  await loadObrasSociales(p.obra_social || '');
  Drawer.afiliado.value = p.numero_afiliado || '';
  Drawer.cred.value = p.credencial || '';
  Drawer.credLink.href = p.credencial || '#';
  if (!p.credencial) Drawer.credLink.setAttribute('tabindex','-1');

  Drawer.ecNom.value = p.contacto_nombre || '';
  Drawer.ecApe.value = p.contacto_apellido || '';
  Drawer.ecCel.value = p.contacto_celular || '';
  Drawer.ecVin.value = p.vinculo || '';

  Drawer.prox.value = p.proximo_control || '';
  Drawer.renov.value = p.renovacion_receta || '';
  Drawer.activo.checked = !!p.activo;

  setDrawerStatus('');
}

/* Guardar / Finalizar */
function validatePaciente(){
  const faltan = [];
  if (!Drawer.dni.value.trim()) faltan.push('DNI');
  if (!Drawer.ape.value.trim()) faltan.push('Apellido');
  if (!Drawer.nom.value.trim()) faltan.push('Nombre');
  if (faltan.length){ setDrawerMsg('Faltan: '+faltan.join(', '), 'warn'); return false; }
  return true;
}
async function guardarFicha(){
  if (!drawerTurnoId) return;
  if (!validatePaciente()) return;
  setDrawerMsg('Guardando...');

  const { data: t } = await supabase.from('turnos').select('paciente_id').eq('id', drawerTurnoId).maybeSingle();
  const pacienteId = t?.paciente_id;
  if (!pacienteId){ setDrawerMsg('No se encontró paciente del turno','warn'); return; }

  const payloadP = {
    dni: Drawer.dni.value.trim(),
    apellido: Drawer.ape.value.trim(),
    nombre: Drawer.nom.value.trim(),
    fecha_nacimiento: Drawer.nac.value || null,
    telefono: Drawer.tel.value.trim() || null,
    email: Drawer.mail.value.trim() || null,
    obra_social: Drawer.obra.value || null,
    numero_afiliado: Drawer.afiliado.value.trim() || null,
    credencial: Drawer.cred.value.trim() || null,
    contacto_nombre: Drawer.ecNom.value.trim() || null,
    contacto_apellido: Drawer.ecApe.value.trim() || null,
    contacto_celular: Drawer.ecCel.value.trim() || null,
    vinculo: Drawer.ecVin.value.trim() || null,
    historia_clinica: Drawer.hc?.href || null,
    proximo_control: Drawer.prox.value || null,
    renovacion_receta: Drawer.renov.value || null,
    activo: Drawer.activo.checked,
  };
  const payloadTurno = { notas: Drawer.notas.value || null };

  const [r1, r2] = await Promise.all([
    supabase.from('pacientes').update(payloadP).eq('id', pacienteId),
    supabase.from('turnos').update(payloadTurno).eq('id', drawerTurnoId),
  ]);
  if (r1.error){ setDrawerMsg('Error guardando paciente: '+r1.error.message,'warn'); return; }
  if (r2.error){ setDrawerMsg('Error guardando notas: '+r2.error.message,'warn'); return; }

  renderHeaderPaciente({
    dni: payloadP.dni,
    apellido: payloadP.apellido,
    nombre: payloadP.nombre,
    fecha_nacimiento: payloadP.fecha_nacimiento,
    historia_clinica: payloadP.historia_clinica
  });
  setDrawerMsg('Cambios guardados.','ok');
  setTimeout(()=> setDrawerMsg(''), 1500);
}
if (Drawer.btnGuardar) Drawer.btnGuardar.onclick = guardarFicha;
if (Drawer.btnFinalizar){
  if (userRole !== 'medico') {
    Drawer.btnFinalizar.style.display = 'none';
  } else {
    Drawer.btnFinalizar.onclick = () => finalizarAtencion(drawerTurnoId, { closeDrawer: true });
  }
}
if (Drawer.cred) Drawer.cred.addEventListener('input', ()=>{ Drawer.credLink.href = Drawer.cred.value || '#'; });
if (Drawer.nac) Drawer.nac.addEventListener('change', ()=>{
  const dniTxt = (Drawer.sub.textContent||'').split('·')[0] || '';
  const edad = calcEdad(Drawer.nac.value);
  Drawer.sub.textContent = `${dniTxt.trim()} · ${edad!=null? `${edad} años`:'Edad —'}`;
});

/* Acciones */
async function volverASalaEspera(turnoId){
  await supabase.from('turnos').update({estado:EST.EN_ESPERA}).eq('id', turnoId);
  await refreshAll();
}
async function finalizarAtencion(turnoId, { closeDrawer = false } = {}) {
  if (userRole !== 'medico') { alert('Solo los médicos pueden finalizar.'); return; }
  const id = turnoId ?? drawerTurnoId; if (!id) return;
  if (!confirm('¿Marcar este turno como ATENDIDO?')) return;

  const { data, error } = await supabase
    .from('turnos')
    .update({ estado: EST.ATENDIDO })
    .eq('id', id)
    .eq('estado', EST.EN_ATENCION)
    .select('id');

  if (error){ console.error('No se pudo marcar atendido:', error); alert('No se pudo finalizar.'); return; }
  if (!data?.length){ alert('El turno no estaba en "En atención".'); return; }

  if (closeDrawer) hideDrawer();
  await refreshAll();
}
async function marcarLlegadaYCopago(turnoId){
  const { data: t } = await supabase
    .from('turnos')
    .select('id, pacientes(obra_social)')
    .eq('id', turnoId)
    .single();

  let copago=null, obra=t?.pacientes?.obra_social||null;
  if (obra){
    const { data: os } = await supabase
      .from('obras_sociales')
      .select('condicion_copago, valor_copago')
      .eq('obra_social', obra)
      .maybeSingle();
    if (os && os.condicion_copago===true && os.valor_copago!=null) copago=os.valor_copago;
  }
  await supabase.from('turnos').update({ estado: EST.EN_ESPERA, hora_arribo: nowHHMMSS(), copago }).eq('id', turnoId);
  await refreshAll();
}

/* Pasar a En atención */
async function pasarAEnAtencion(turnoId, ev) {
  if (ev) ev.preventDefault();
  const role = localStorage.getItem('user_role');
  if (role !== 'medico') { alert('Solo los médicos pueden atender pacientes.'); return; }

  const { error } = await supabase
    .from('turnos')
    .update({ estado: EST.EN_ATENCION })
    .eq('id', turnoId);

  if (error) { alert('No se pudo pasar a "En atención".'); return; }
  await refreshAll();
  await openFicha(turnoId);
}

/* KPIs y títulos */
function computeHorasDisponibles(agenda, turnos){
  const totalAgendaMin=(agenda||[]).reduce((acc,b)=>acc+minutesDiff(toHM(b.hora_inicio), toHM(b.hora_fin)),0);
  const ocupadosMin=(turnos||[]).filter(t=>t.estado!==EST.CANCELADO)
    .reduce((acc,t)=>acc+(t.hora_fin?minutesDiff(toHM(t.hora_inicio), toHM(t.hora_fin)):0),0);
  const libresMin=Math.max(0,totalAgendaMin-ocupadosMin);
  return { horas:(libresMin/60).toFixed(1), libresMin, totalAgendaMin };
}
function formatFreeTime(mins) {
  mins = Math.max(0, Math.round(Number(mins||0)));
  if (mins < 60) return `${mins} min`;
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  const hm = `${h}.${String(m).padStart(2,'0')}`; // “H.MM”
  return `${h} h ${m} min (${hm} hs)`;
}
function renderKPIs({agenda, turnos}){
  const free=computeHorasDisponibles(agenda, turnos);
  UI.kpiFree.textContent = `${formatFreeTime(free.libresMin)} disponibles`;
  UI.kpiSub.textContent = `${currentCentroNombre || ''} · ${UI.profSelect.options[UI.profSelect.selectedIndex]?.textContent || ''} · ${currentFechaISO}`;
}
function renderBoardTitles({pendientes, presentes, atencion, atendidos}){
  if (H.pend)  H.pend.textContent  = `Por llegar (${(pendientes||[]).length})`;
  if (H.esp)   H.esp.textContent   = `En sala de espera (${(presentes||[]).length})`;
  if (H.atenc) H.atenc.textContent = `En atención (${(atencion||[]).length})`;
  if (H.done)  H.done.textContent  = `Atendidos (${(atendidos||[]).length})`;
}

/* —— Buscador masivo bindings —— */
let searchTimer=null;
function applySearch(value){ filterText = norm((value||'').trim()); refreshAll(); }
UI.massSearch.addEventListener('input', ()=>{
  clearTimeout(searchTimer);
  searchTimer=setTimeout(()=>applySearch(UI.massSearch.value), 160);
});
UI.massClear.addEventListener('click', ()=>{ UI.massSearch.value=''; applySearch(''); });

/* Refresh & Init */
async function refreshAll(){
  if(!currentProfesional){
    UI.tblPend.innerHTML=''; UI.tblEsp.innerHTML=''; UI.tblAtencion.innerHTML=''; UI.tblDone.innerHTML='';
    UI.kpiSub.textContent=`${currentCentroNombre||''} · ${currentFechaISO}`;
    renderBoardTitles({pendientes:[],presentes:[],atendidos:[],atencion:[]});
    return;
  }
  const raw = await fetchDiaData();
  const filtered = applyFilter(raw);

  renderPendientes(filtered.pendientes);
  renderPresentes(filtered.presentes);
  renderAtencion(filtered.atencion);
  renderAtendidos(filtered.atendidos);

  renderKPIs(raw);            // Horas libres: sobre total del día (no filtrado)
  renderBoardTitles(filtered); // Títulos: cantidades filtradas
}
async function initInicio(){
  // Limpiezas por si quedó algo viejo
  try {
    localStorage.removeItem('reprogram_turno_intent');
    localStorage.removeItem('turnos_prefill');
  } catch {}

  currentCentroId = localStorage.getItem('centro_medico_id');
  currentCentroNombre = localStorage.getItem('centro_medico_nombre') || (await fetchCentroById(currentCentroId));
  renderCentroChip();
  await loadProfesionales();
  currentFechaISO = UI.fecha.value || todayISO();
  try { localStorage.setItem('inicio_url', location.href); } catch {}
  await refreshAll();
  startCentroWatcher();
}
await initInicio();
</script>
</body>
</html>
