<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inicio ‚Äî EG Health Solutions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :where(#main-content.card){
      max-width:none!important;width:100%!important;padding:0!important;background:transparent!important;box-shadow:none!important;border-radius:0!important;
    }
    *{box-sizing:border-box}
    :root{
      --brand:#7656b0; --brand-2:#a490d7; --ink:#381e60; --muted:#6b6480;
      --bg:#f7f9fb; --card:#fff; --line:#ece5fc;
    }
    body{background:var(--bg);margin:0;font-family:'Segoe UI',Arial,sans-serif;color:var(--ink)}
    .shell{padding:10px}
    .panel{
      background:var(--card);border-radius:12px;box-shadow:0 1px 10px rgba(80,60,160,.08);
      padding:10px;display:flex;flex-direction:column;gap:10px;min-height:calc(100vh - 20px)
    }

    .toolbar{
      display:grid;
      grid-template-columns: minmax(220px,1fr) minmax(180px,.8fr) minmax(160px,.6fr) auto;
      gap:10px 12px; align-items:end;
    }
    .field{display:flex;flex-direction:column;gap:3px;min-width:0}
    .field label{font-size:11px;color:var(--muted)}
    .inp,.sel{
      background:#f7f9fb;border:1px solid var(--line);border-radius:8px;padding:7px 9px;
      font-size:13px;color:var(--ink);outline:none;width:100%;
    }
    .inp:focus,.sel:focus{border-color:var(--brand-2)}
    .sel.compact{max-width:240px}
    .btn{appearance:none;border:none;background:var(--brand);color:#fff;border-radius:8px;padding:7px 10px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#e7e2fa;color:#5a3e9a}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#f2effc;border:1px solid var(--line);color:#4b3a78;padding:6px 10px;border-radius:999px;font-size:13px;max-width:100%;white-space:nowrap;}

    .stats{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:flex;align-items:baseline;gap:6px;background:#f3f1fb;border:1px solid var(--line);
      padding:6px 9px;border-radius:999px;font-size:12px;white-space:nowrap}
    .chip .v{font-size:16px;font-weight:800;line-height:1}

    .boards{display:grid;gap:12px;grid-template-columns:1fr 1fr;min-height:0}
    .board{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:8px;display:flex;flex-direction:column;min-height:380px}
    .board h3{margin:2px 2px 6px;font-size:14px}
    .board-body{position:relative;overflow:auto;flex:1;padding:0 2px 6px}

    .table{width:100%;border-collapse:separate;border-spacing:0 5px;min-width:720px;font-size:12.5px}
    .thead{position:sticky;top:0;z-index:2;background:#fff}
    .hrow,.row{display:grid;gap:0;align-items:center;border:1px solid var(--line);padding:5px 8px;border-radius:8px}
    .hrow{background:#f4f1ff;color:#5a3e9a;font-weight:700}
    .row{background:#faf9ff}
    .cell{padding:0 4px;min-width:0}
    .right{text-align:right} .nowrap{white-space:nowrap}

    .actions{display:flex;gap:6px;justify-content:flex-end}
    .icon{
      border:none;background:#f4f1ff;border:1px solid var(--line);
      width:28px;height:28px;border-radius:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;
    }

    .wait{display:inline-block;font-size:11px;padding:2px 7px;border-radius:999px;background:#fff4e6;border:1px solid #ffe0b3;color:#8a5800}
    .copago{display:inline-block;font-size:11px;padding:2px 7px;border-radius:999px;background:#e8fff0;border:1px solid #b9f0cb;color:#0a7d38}
    .copago.none{background:#f1f1f1;border-color:#e0e0e0;color:#666}

    .board-body::-webkit-scrollbar{height:8px;width:8px}
    .board-body::-webkit-scrollbar-thumb{background:#d8cfff;border-radius:8px}

    .role-asistente [data-act="atender"]{ display:none !important; }
    .role-asistente [data-act="abrir-ficha"]{ display:none !important; }
    .role-asistente [data-act="finalizar"]{ display:none !important; }
    .role-asistente [data-act="volver-espera"]{ display:none !important; }

    @media (max-width:1100px){
      .toolbar{grid-template-columns:1fr minmax(180px,.9fr) minmax(160px,.7fr) auto}
      .boards{grid-template-columns:1fr}
      .table{min-width:660px}
    }
    @media (min-width:1100px){
      .boards .board:last-child { grid-column: span 2; }
    }

    /* === Drawer ficha paciente (off-canvas) === */
    .drawer{
      position:fixed; top:0; right:0; height:100vh; width:min(980px,96vw);
      background:#fff; border-left:1px solid var(--line);
      box-shadow:-12px 0 40px rgba(0,0,0,.18);
      transform:translateX(100%); transition:transform .28s ease; z-index:9999;
      display:flex; flex-direction:column;
    }
    .drawer.open{ transform:translateX(0); }
    .drawer-head{display:flex;align-items:center;gap:8px;padding:10px 12px;background:#e8def8;border-bottom:1px solid var(--line)}
    .drawer-head h3{margin:0;font-size:16px;color:#4b3a78}
    .drawer-body{flex:1;overflow:auto;padding:12px}
    .drawer-foot{padding:10px 12px;border-top:1px solid var(--line);background:#faf7ff;display:flex;gap:10px;justify-content:flex-end}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .mini{font-size:12px;color:#6b6480}
    .link{color:#4b3a78;text-decoration:underline;cursor:pointer}
  </style>
</head>
<body>
<div class="shell">
  <section class="panel" id="inicio-root">

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="field">
        <label>Centro m√©dico</label>
        <div class="pill" id="centro-chip">‚Äî</div>
      </div>
      <div class="field">
        <label>Profesional</label>
        <select id="prof-select" class="sel compact"><option>Profesional</option></select>
      </div>
      <div class="field">
        <label>Fecha</label>
        <input id="fecha" type="date" class="inp"/>
      </div>
      <div class="field" style="align-items:flex-end">
        <button id="btn-hoy" class="btn secondary">Hoy</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="stats">
      <div class="chip"><span>Pendientes</span> <span class="v" id="kpi-pend">0</span></div>
      <div class="chip"><span>Presentes</span> <span class="v" id="kpi-esp">0</span></div>
      <div class="chip"><span>En atenci√≥n</span> <span class="v" id="kpi-atencion">0</span></div>
      <div class="chip"><span>Horas libres</span> <span class="v" id="kpi-free">0.0 h</span></div>
      <div class="chip" id="kpi-sub" style="opacity:.8"></div>
    </div>

    <!-- Boards -->
    <div class="boards">
      <div class="board">
        <h3>Pendientes de arribo</h3>
        <div class="board-body"><table class="table" id="tbl-pend"></table></div>
      </div>
      <div class="board">
        <h3>Presentes</h3>
        <div class="board-body"><table class="table" id="tbl-esp"></table></div>
      </div>
      <div class="board">
        <h3>En atenci√≥n</h3>
        <div class="board-body"><table class="table" id="tbl-atencion"></table></div>
      </div>
    </div>

    <!-- Drawer Ficha Paciente -->
    <aside id="fichaDrawer" class="drawer" aria-hidden="true">
      <header class="drawer-head">
        <h3 id="fd-title">Ficha paciente</h3>
        <span id="fd-status" class="pill" style="margin-left:auto">‚Äî</span>
        <button id="fd-close" class="icon" title="Cerrar">‚úñÔ∏è</button>
      </header>

      <div class="drawer-body">
        <!-- Resumen -->
        <div class="stats" id="fd-summary">
          <div class="chip" id="fd-prof">Prof: ‚Äî</div>
          <div class="chip" id="fd-centro">Centro: ‚Äî</div>
          <div class="chip" id="fd-fecha">Fecha: ‚Äî</div>
          <div class="chip" id="fd-hora">Hora: ‚Äî</div>
          <div class="chip" id="fd-estado">Estado: ‚Äî</div>
          <div class="chip" id="fd-copago">Copago: ‚Äî</div>
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

        <!-- Encabezado con historia cl√≠nica -->
        <div class="field" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <div id="fd-encabezado" class="mini">‚Äî</div>
          <a id="fd-hc-link" class="link mini" href="#" target="_blank" rel="noopener" style="display:none">üìÑ Historia cl√≠nica</a>
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

        <!-- Datos b√°sicos (lectura r√°pida) -->
        <div class="row3">
          <div class="field"><label>DNI</label><input id="fd-dni" class="inp" disabled></div>
          <div class="field"><label>Apellido</label><input id="fd-apellido" class="inp" disabled></div>
          <div class="field"><label>Nombre</label><input id="fd-nombre" class="inp" disabled></div>
        </div>
        <div class="row3">
          <div class="field"><label>Nacimiento</label><input id="fd-nac" type="date" class="inp" disabled></div>
          <div class="field"><label>Tel√©fono</label><input id="fd-tel" class="inp" disabled></div>
          <div class="field"><label>Email</label><input id="fd-mail" class="inp" disabled></div>
        </div>

        <div class="mini" style="margin-top:10px">
          ¬øEditar m√°s datos? <a id="fd-open-full" class="link">Abrir ficha completa</a>
        </div>
      </div>

      <footer class="drawer-foot">
        <button id="fd-volver" class="btn secondary">Volver</button>
        <button id="fd-finalizar" class="btn">Finalizar</button>
      </footer>
    </aside>

  </section>
</div>

<script type="module">
import supabase from './supabaseClient.js';

const EST = { ASIGNADO:'asignado', EN_ESPERA:'en_espera', EN_ATENCION:'en_atencion', CANCELADO:'cancelado', FINALIZADO:'finalizado' };

const UI = {
  centroChip: document.getElementById('centro-chip'),
  profSelect: document.getElementById('prof-select'),
  fecha: document.getElementById('fecha'),
  btnHoy: document.getElementById('btn-hoy'),
  tblPend: document.getElementById('tbl-pend'),
  tblEsp: document.getElementById('tbl-esp'),
  tblAtencion: document.getElementById('tbl-atencion'),
  kpiPend: document.getElementById('kpi-pend'),
  kpiEsp: document.getElementById('kpi-esp'),
  kpiAtencion: document.getElementById('kpi-atencion'),
  kpiFree: document.getElementById('kpi-free'),
  kpiSub: document.getElementById('kpi-sub'),
};

// Drawer refs
const Drawer = {
  el: document.getElementById('fichaDrawer'),
  close: document.getElementById('fd-close'),
  status: document.getElementById('fd-status'),
  title: document.getElementById('fd-title'),
  encabezado: document.getElementById('fd-encabezado'),
  hcLink: document.getElementById('fd-hc-link'),
  prof: document.getElementById('fd-prof'),
  centro: document.getElementById('fd-centro'),
  fecha: document.getElementById('fd-fecha'),
  hora: document.getElementById('fd-hora'),
  estado: document.getElementById('fd-estado'),
  copago: document.getElementById('fd-copago'),
  dni: document.getElementById('fd-dni'),
  ape: document.getElementById('fd-apellido'),
  nom: document.getElementById('fd-nombre'),
  nac: document.getElementById('fd-nac'),
  tel: document.getElementById('fd-tel'),
  mail: document.getElementById('fd-mail'),
  btnVolver: document.getElementById('fd-volver'),
  btnFin: document.getElementById('fd-finalizar'),
  btnOpenFull: document.getElementById('fd-open-full'),
};

let currentCentroId = localStorage.getItem('centro_medico_id');
let currentCentroNombre = localStorage.getItem('centro_medico_nombre') || '';
const userRole = localStorage.getItem('user_role');
const loggedProfesionalId = localStorage.getItem('profesional_id');
let currentProfesional = null;
let currentFechaISO = null;
let centroWatchTimer = null;

/* ===== helpers ===== */
function pad(n){return n<10?'0'+n:''+n}
function todayISO(){const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}
function toHM(t){return (t??'').toString().slice(0,5)}
function minutesDiff(start,end){
  const [h1,m1]=String(start||'00:00').split(':').map(Number);
  const [h2,m2]=String(end||'00:00').split(':').map(Number);
  return (h2*60+m2)-(h1*60+m1);
}
function nowHHMMSS(){const d=new Date();return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`}
function fmtMoney(n){return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0))}
if (userRole !== 'medico') document.body.classList.add('role-asistente'); else document.body.classList.remove('role-asistente');

/* ===== Drawer helpers ===== */
function showDrawer(){ Drawer.el.classList.add('open'); Drawer.el.setAttribute('aria-hidden','false'); }
function hideDrawer(){ Drawer.el.classList.remove('open'); Drawer.el.setAttribute('aria-hidden','true'); }
if (Drawer.close) Drawer.close.onclick = hideDrawer;
if (Drawer.btnVolver) Drawer.btnVolver.onclick = hideDrawer;

/* ===== centro ===== */
async function fetchCentroById(id){
  const { data } = await supabase.from('centros_medicos').select('nombre').eq('id', id).maybeSingle();
  return data?.nombre || '';
}
function renderCentroChip(){ UI.centroChip.textContent = currentCentroNombre || '‚Äî'; }
async function syncCentroFromStorage(force=false){
  const id = localStorage.getItem('centro_medico_id');
  const nom = localStorage.getItem('centro_medico_nombre') || currentCentroNombre;
  if (force || id !== currentCentroId || nom !== currentCentroNombre){
    currentCentroId = id;
    currentCentroNombre = nom || await fetchCentroById(id);
    localStorage.setItem('centro_medico_nombre', currentCentroNombre);
    renderCentroChip();
    await loadProfesionales();
    await refreshAll();
  }
}
function startCentroWatcher(){ if (centroWatchTimer) clearInterval(centroWatchTimer); centroWatchTimer=setInterval(()=>syncCentroFromStorage(false), 1000); }

/* ===== profesionales ===== */
async function loadProfesionales(){
  const sel=UI.profSelect;

  if (userRole==='medico' && loggedProfesionalId){
    let label=null;
    try{
      const { data }=await supabase.from('profesionales').select('id,nombre,apellido,display_name').eq('id',loggedProfesionalId).single();
      if (data) label = data.display_name || [data.apellido,data.nombre].filter(Boolean).join(', ') || data.nombre || data.apellido;
    }catch(_){}
    if (!label) label = localStorage.getItem('user_name') || localStorage.getItem('email') || 'Mi agenda';
    sel.innerHTML = `<option value="${loggedProfesionalId}">${label}</option>`;
    sel.value = loggedProfesionalId; sel.disabled = true; currentProfesional = loggedProfesionalId; return;
  }

  sel.disabled = false;

  const { data: map } = await supabase
    .from('profesional_centro')
    .select('profesional_id')
    .eq('centro_id', currentCentroId)
    .eq('activo', true);

  const ids = [...new Set((map||[]).map(r=>r.profesional_id).filter(Boolean))];
  if (!ids.length){ sel.innerHTML='<option value="">Sin profesionales</option>'; currentProfesional=null; return; }

  const { data: profs } = await supabase
    .from('profesionales')
    .select('id,nombre,apellido,display_name')
    .in('id', ids)
    .order('apellido', {ascending:true});

  sel.innerHTML = (profs||[]).map(p=>{
    const n=p.display_name||[p.apellido,p.nombre].filter(Boolean).join(', ')||p.nombre||p.apellido||p.id;
    return `<option value="${p.id}">${n}</option>`;
  }).join('');

  currentProfesional = (profs && profs[0]) ? profs[0].id : null;
  if (currentProfesional) sel.value = currentProfesional;
}
UI.profSelect.addEventListener('change', async ()=>{ currentProfesional = UI.profSelect.value || null; await refreshAll(); });

/* ===== Fecha ===== */
UI.fecha.value=todayISO(); currentFechaISO=UI.fecha.value;
UI.fecha.addEventListener('change', ()=>{ currentFechaISO=UI.fecha.value||todayISO(); refreshAll(); });
UI.btnHoy.addEventListener('click', ()=>{ const h=todayISO(); UI.fecha.value=h; currentFechaISO=h; refreshAll(); });

/* ===== data d√≠a ===== */
async function fetchDiaData(){
  if(!currentProfesional) return { pendientes:[], presentes:[], atencion:[], agenda:[], turnos:[] };
  const common={centro_id:currentCentroId, profesional_id:currentProfesional, fecha:currentFechaISO};

  const [pend, pres, atenc, agenda, turnos] = await Promise.all([
    supabase.from('turnos')
      .select('id, fecha, hora_inicio, hora_fin, estado, hora_arribo, copago, paciente_id, pacientes(id, dni, nombre, apellido, obra_social)')
      .eq('centro_id', common.centro_id).eq('profesional_id', common.profesional_id).eq('fecha', common.fecha)
      .eq('estado', EST.ASIGNADO).order('hora_inicio', {ascending:true}),
    supabase.from('turnos')
      .select('id, fecha, hora_inicio, hora_fin, estado, hora_arribo, copago, paciente_id, pacientes(id, dni, nombre, apellido, obra_social)')
      .eq('centro_id', common.centro_id).eq('profesional_id', common.profesional_id).eq('fecha', common.fecha)
      .eq('estado', EST.EN_ESPERA).order('hora_inicio', {ascending:true}),
    supabase.from('turnos')
      .select('id, fecha, hora_inicio, hora_fin, estado, hora_arribo, copago, paciente_id, pacientes(id, dni, nombre, apellido, obra_social)')
      .eq('centro_id', common.centro_id).eq('profesional_id', common.profesional_id).eq('fecha', common.fecha)
      .eq('estado', EST.EN_ATENCION).order('hora_inicio', {ascending:true}),
    supabase.from('agenda').select('id, fecha, hora_inicio, hora_fin')
      .eq('centro_id', common.centro_id).eq('profesional_id', common.profesional_id).eq('fecha', common.fecha).order('hora_inicio',{ascending:true}),
    supabase.from('turnos').select('id, hora_inicio, hora_fin, estado')
      .eq('centro_id', common.centro_id).eq('profesional_id', common.profesional_id).eq('fecha', common.fecha)
  ]);

  return { pendientes: pend.data||[], presentes: pres.data||[], atencion: atenc.data||[], agenda: agenda.data||[], turnos: turnos.data||[] };
}

/* ===== Render: Pendientes ===== */
function renderPendientes(list){
  const grid='100px 120px 1fr 1fr 1fr 150px';
  const head=`<thead class="thead"><tr class="hrow" style="grid-template-columns:${grid}">
      <th class="cell">Hora</th><th class="cell">DNI</th>
      <th class="cell">Nombre</th><th class="cell">Apellido</th><th class="cell">Obra social</th>
      <th class="cell right">Acciones</th></tr></thead>`;
  const rows=(list||[]).map(t=>{
    const p=t.pacientes||{};
    const hora=`<b>${toHM(t.hora_inicio)}</b>${t.hora_fin?' ‚Äî '+toHM(t.hora_fin):''}`;
    return `<tr class="row" style="grid-template-columns:${grid}">
      <td class="cell nowrap">${hora}</td>
      <td class="cell">${p.dni||'‚Äî'}</td>
      <td class="cell">${p.nombre||'‚Äî'}</td>
      <td class="cell">${p.apellido||'‚Äî'}</td>
      <td class="cell">${p.obra_social||'‚Äî'}</td>
      <td class="cell right">
        <div class="actions">
          <button class="icon" data-id="${t.id}" data-act="arribo" title="Pasar a En espera">üü¢</button>
          <button class="icon" data-id="${t.id}" data-act="reprog" title="Reprogramar">‚Ü™Ô∏è</button>
          <button class="icon" data-id="${t.id}" data-act="cancel" title="Anular">üóëÔ∏è</button>
        </div>
      </td>
    </tr>`;
  }).join('');
  UI.tblPend.innerHTML=head+'<tbody>'+rows+'</tbody>';

  UI.tblPend.querySelectorAll('.icon').forEach(btn=>{
    const id=btn.getAttribute('data-id'), act=btn.getAttribute('data-act');
    if(act==='arribo') btn.onclick=()=> marcarLlegadaYCopago(id);
    if(act==='reprog') btn.onclick=()=> abrirTurnosParaReprogramar(id);
    if(act==='cancel') btn.onclick=()=> anularTurno(id);
  });
}

/* ===== Espera ===== */
let waitTimer=null;
function startWaitTicker(){ if(waitTimer) clearInterval(waitTimer); waitTimer=setInterval(updateWaitBadges, 30000); }
function updateWaitBadges(){
  const nodes=document.querySelectorAll('[data-arribo-ts]');
  const now=new Date();
  nodes.forEach(n=>{
    const ts=n.getAttribute('data-arribo-ts'); if(!ts) return;
    const ms= now - new Date(ts);
    const mins=Math.max(0, Math.round(ms/60000));
    const hh=Math.floor(mins/60), mm=mins%60;
    n.textContent = hh? `${hh}h ${mm}m` : `${mm}m`;
  });
}
function renderPresentes(list){
  const grid='90px 100px 1fr 1fr 1fr 110px 180px';
  const head=`<thead class="thead"><tr class="hrow" style="grid-template-columns:${grid}">
      <th class="cell">Espera</th><th class="cell">Hora</th><th class="cell">Nombre</th>
      <th class="cell">Apellido</th><th class="cell">Obra social</th><th class="cell">Copago</th>
      <th class="cell right">Acciones</th></tr></thead>`;
  const puedeAtender = (userRole === 'medico');

  const rows=(list||[]).map(t=>{
    const p=t.pacientes||{};
    const hora=`<b>${toHM(t.hora_inicio)}</b>${t.hora_fin?' ‚Äî '+toHM(t.hora_fin):''}`;
    const arriboISO=`${currentFechaISO}T${toHM(t.hora_arribo)||'00:00'}:00`;
    const copBadge=(t.copago && Number(t.copago)>0)?`<span class="copago">${fmtMoney(t.copago)}</span>`:`<span class="copago none">Sin copago</span>`;
    const acciones = `
      <button class="icon" data-id="${t.id}" data-act="volver" title="Volver a pendientes">‚Ü©Ô∏è</button>
      <button class="icon" data-id="${t.id}" data-act="reprog" title="Reprogramar">‚Ü™Ô∏è</button>
      <button class="icon" data-id="${t.id}" data-act="cancel" title="Anular">üóëÔ∏è</button>
      ${puedeAtender ? `<button class="icon" data-id="${t.id}" data-act="atender" title="En atenci√≥n">‚úÖ</button>` : ''}
    `;
    return `<tr class="row" style="grid-template-columns:${grid}">
      <td class="cell"><span class="wait" data-arribo-ts="${arriboISO}">‚Äî</span></td>
      <td class="cell nowrap">${hora}</td>
      <td class="cell">${p.nombre||'‚Äî'}</td>
      <td class="cell">${p.apellido||'‚Äî'}</td>
      <td class="cell">${p.obra_social||'‚Äî'}</td>
      <td class="cell">${copBadge}</td>
      <td class="cell right"><div class="actions">${acciones}</div></td>
    </tr>`;
  }).join('');
  UI.tblEsp.innerHTML=head+'<tbody>'+rows+'</tbody>';

  UI.tblEsp.querySelectorAll('.icon').forEach(btn=>{
    const id=btn.getAttribute('data-id'), act=btn.getAttribute('data-act');
    if(act==='volver') btn.onclick=async()=>{ await supabase.from('turnos').update({estado:EST.ASIGNADO, hora_arribo:null}).eq('id',id); await refreshAll(); };
    if(act==='reprog') btn.onclick=()=> abrirTurnosParaReprogramar(id);
    if(act==='cancel') btn.onclick=()=> anularTurno(id);
    if(act==='atender') btn.onclick=()=> pasarAEnAtencion(id);
  });

  updateWaitBadges(); startWaitTicker();
}

/* ===== En atenci√≥n ===== */
function renderAtencion(list){
  const grid='100px 120px 1fr 1fr 1fr 180px';
  const head=`<thead class="thead"><tr class="hrow" style="grid-template-columns:${grid}">
      <th class="cell">Hora</th><th class="cell">DNI</th>
      <th class="cell">Nombre</th><th class="cell">Apellido</th><th class="cell">Obra social</th>
      <th class="cell right">Acciones</th></tr></thead>`;
  const puedeFinalizar = (userRole === 'medico');

  const rows=(list||[]).map(t=>{
    const p=t.pacientes||{};
    const hora=`<b>${toHM(t.hora_inicio)}</b>${t.hora_fin?' ‚Äî '+toHM(t.hora_fin):''}`;
    const acciones = `
      <button class="icon" data-id="${t.id}" data-act="abrir-ficha" title="Abrir ficha (drawer)">üìÑ</button>
      <button class="icon" data-id="${t.id}" data-act="volver-espera" title="Volver a sala de espera">‚è™</button>
      ${puedeFinalizar ? `<button class="icon" data-id="${t.id}" data-act="finalizar" title="Finalizar atenci√≥n">‚úÖ</button>` : ''}
    `;
    return `<tr class="row" style="grid-template-columns:${grid}">
      <td class="cell nowrap">${hora}</td>
      <td class="cell">${p.dni||'‚Äî'}</td>
      <td class="cell">${p.nombre||'‚Äî'}</td>
      <td class="cell">${p.apellido||'‚Äî'}</td>
      <td class="cell">${p.obra_social||'‚Äî'}</td>
      <td class="cell right"><div class="actions">${acciones}</div></td>
    </tr>`;
  }).join('');
  UI.tblAtencion.innerHTML = head + '<tbody>' + rows + '</tbody>';

  UI.tblAtencion.querySelectorAll('.icon').forEach(btn=>{
    const id=btn.getAttribute('data-id'), act=btn.getAttribute('data-act');
    if(act==='abrir-ficha') btn.onclick=()=> openFicha(id);                 // <-- abre drawer
    if(act==='volver-espera') btn.onclick=()=> volverASalaEspera(id);
    if(act==='finalizar') btn.onclick=()=> finalizarAtencion(id);
  });
}

/* ===== Ficha (drawer): cargar y mostrar ===== */
async function openFicha(turnoId){
  try { localStorage.setItem('current_turno_id', String(turnoId)); } catch {}
  try { localStorage.setItem('inicio_url', location.href); } catch {}
  if (Drawer.status) Drawer.status.textContent = 'Cargando‚Ä¶';
  showDrawer();

  // 1) turno base
  const { data:t, error:terr } = await supabase
    .from('turnos')
    .select('id, fecha, hora_inicio, hora_fin, estado, hora_arribo, copago, notas, paciente_id, profesional_id, centro_id')
    .eq('id', turnoId)
    .maybeSingle();

  if (terr || !t){ if (Drawer.status) Drawer.status.textContent='No se pudo cargar'; console.error(terr); return; }

  // 2) relacionados
  const [pRes, profRes, centroRes] = await Promise.all([
    supabase.from('pacientes').select('dni,apellido,nombre,fecha_nacimiento,telefono,email,historia_clinica').eq('id', t.paciente_id).maybeSingle(),
    supabase.from('profesionales').select('display_name,nombre,apellido').eq('id', t.profesional_id).maybeSingle(),
    supabase.from('centros_medicos').select('nombre').eq('id', t.centro_id).maybeSingle(),
  ]);

  const prof = profRes?.data;
  const centro = centroRes?.data;
  const p = pRes?.data;

  if (Drawer.title) Drawer.title.textContent = 'Ficha paciente';
  if (Drawer.prof)   Drawer.prof.textContent   = `Prof: ${prof ? (prof.display_name || [prof.apellido, prof.nombre].filter(Boolean).join(', ')) : '‚Äî'}`;
  if (Drawer.centro) Drawer.centro.textContent = `Centro: ${centro?.nombre || '‚Äî'}`;
  if (Drawer.fecha)  Drawer.fecha.textContent  = `Fecha: ${t.fecha || '‚Äî'}`;
  if (Drawer.hora)   Drawer.hora.textContent   = `Hora: ${t.hora_inicio ? toHM(t.hora_inicio) : '‚Äî'}`;
  if (Drawer.estado) Drawer.estado.textContent = `Estado: ${t.estado || '‚Äî'}`;
  if (Drawer.copago) Drawer.copago.textContent = `Copago: ${t.copago!=null ? fmtMoney(t.copago) : '‚Äî'}`;

  // Encabezado + historia cl√≠nica
  const enc = p ? `${p.apellido || ''}, ${p.nombre || ''} ¬∑ DNI ${p.dni || '‚Äî'}`.replace(/^\s*,\s*/,'') : '‚Äî';
  if (Drawer.encabezado) Drawer.encabezado.textContent = enc;
  if (Drawer.hcLink){
    if (p?.historia_clinica){
      Drawer.hcLink.href = p.historia_clinica;
      Drawer.hcLink.style.display = '';
    } else {
      Drawer.hcLink.removeAttribute('href');
      Drawer.hcLink.style.display = 'none';
    }
  }

  if (Drawer.dni)  Drawer.dni.value  = p?.dni || '';
  if (Drawer.ape)  Drawer.ape.value  = p?.apellido || '';
  if (Drawer.nom)  Drawer.nom.value  = p?.nombre || '';
  if (Drawer.nac)  Drawer.nac.value  = p?.fecha_nacimiento || '';
  if (Drawer.tel)  Drawer.tel.value  = p?.telefono || '';
  if (Drawer.mail) Drawer.mail.value = p?.email || '';

  if (Drawer.btnOpenFull){
    Drawer.btnOpenFull.onclick = ()=>{
      const fichaUrl = `ficha_paciente.html?turno_id=${encodeURIComponent(turnoId)}`;
      window.location.href = fichaUrl; // abre ficha completa en esta pesta√±a
    };
  }

  if (Drawer.status) Drawer.status.textContent = 'Listo';
}

/* ===== Finalizar desde el drawer (solo m√©dico) ===== */
if (Drawer.btnFin){
  Drawer.btnFin.onclick = async ()=>{
    if (userRole !== 'medico'){ alert('Solo los m√©dicos pueden finalizar.'); return; }
    const turnoId = localStorage.getItem('current_turno_id');
    if (!turnoId) return;
    if (!confirm('¬øFinalizar atenci√≥n?')) return;
    const { error } = await supabase.from('turnos').update({ estado: EST.FINALIZADO, hora_fin: nowHHMMSS() }).eq('id', turnoId);
    if (error){ alert('No se pudo finalizar.'); return; }
    hideDrawer();
    await refreshAll();
  };
}

/* ===== Acciones varias ===== */
async function volverASalaEspera(turnoId){
  await supabase.from('turnos').update({estado:EST.EN_ESPERA}).eq('id', turnoId);
  await refreshAll();
}
async function finalizarAtencion(turnoId){
  if(!confirm('¬øFinalizar atenci√≥n?')) return;
  await supabase.from('turnos').update({estado:EST.FINALIZADO, hora_fin: nowHHMMSS()}).eq('id', turnoId);
  await refreshAll();
}
async function marcarLlegadaYCopago(turnoId){
  const { data: t } = await supabase
    .from('turnos')
    .select('id, pacientes(obra_social)')
    .eq('id', turnoId)
    .single();

  let copago=null, obra=t?.pacientes?.obra_social||null;
  if (obra){
    const { data: os } = await supabase
      .from('obras_sociales')
      .select('condicion_copago, valor_copago')
      .eq('obra_social', obra)
      .maybeSingle();
    if (os && os.condicion_copago===true && os.valor_copago!=null) copago=os.valor_copago;
  }
  await supabase.from('turnos').update({ estado: EST.EN_ESPERA, hora_arribo: nowHHMMSS(), copago }).eq('id', turnoId);
  await refreshAll();
}
function abrirTurnosParaReprogramar(turnoId){
  localStorage.setItem('reprogram_turno_intent', JSON.stringify({
    turno_id: turnoId, fecha: currentFechaISO, profesional_id: currentProfesional, centro_id: currentCentroId
  })); window.location.href='turnos.html';
}
async function anularTurno(turnoId){
  if(!confirm('¬øAnular este turno?')) return;
  await supabase.from('turnos').update({estado:EST.CANCELADO}).eq('id', turnoId);
  await refreshAll();
}
async function pasarAEnAtencion(turnoId, ev) {
  if (ev) ev.preventDefault();
  const role = localStorage.getItem('user_role');
  if (role !== 'medico') { alert('Solo los m√©dicos pueden atender pacientes.'); return; }
  const { error } = await supabase.from('turnos').update({ estado: EST.EN_ATENCION }).eq('id', turnoId);
  if (error) { alert('No se pudo pasar a "En atenci√≥n".'); return; }
  openFicha(turnoId); // <-- abre el drawer despu√©s de actualizar estado
}

/* ===== KPIs ===== */
function computeHorasDisponibles(agenda, turnos){
  const totalAgendaMin=(agenda||[]).reduce((acc,b)=>acc+Math.max(0, minutesDiff(toHM(b.hora_inicio), toHM(b.hora_fin))),0);
  const ocupadosMin=(turnos||[]).filter(t=>t.estado!==EST.CANCELADO)
    .reduce((acc,t)=>acc+Math.max(0, t.hora_fin?minutesDiff(toHM(t.hora_inicio), toHM(t.hora_fin)):0),0);
  const libresMin=Math.max(0,totalAgendaMin-ocupadosMin);
  return { horas:(libresMin/60).toFixed(1), libresMin, totalAgendaMin };
}
function renderKPIs({pendientes, presentes, atencion, agenda, turnos}){
  UI.kpiPend.textContent=pendientes.length;
  UI.kpiEsp.textContent=presentes.length;
  UI.kpiAtencion.textContent=atencion.length;
  const free=computeHorasDisponibles(agenda, turnos);
  UI.kpiFree.textContent=`${free.horas} h`;
  UI.kpiSub.textContent = `${currentCentroNombre || ''} ¬∑ ${UI.profSelect.options[UI.profSelect.selectedIndex]?.textContent || ''} ¬∑ ${currentFechaISO}`;
}

/* ===== Refresh & Init ===== */
async function refreshAll(){
  if(!currentProfesional){
    UI.tblPend.innerHTML=''; UI.tblEsp.innerHTML=''; UI.tblAtencion.innerHTML='';
    UI.kpiSub.textContent=`${currentCentroNombre||''} ¬∑ ${currentFechaISO}`; return;
  }
  const data = await fetchDiaData();
  renderPendientes(data.pendientes);
  renderPresentes(data.presentes);
  renderAtencion(data.atencion);
  renderKPIs(data);
}
async function initInicio(){
  currentCentroId = localStorage.getItem('centro_medico_id');
  currentCentroNombre = localStorage.getItem('centro_medico_nombre') || (await fetchCentroById(currentCentroId));
  renderCentroChip();
  await loadProfesionales();
  currentFechaISO = UI.fecha.value || todayISO();
  try { localStorage.setItem('inicio_url', location.href); } catch {}
  await refreshAll();
  startCentroWatcher();
}
await initInicio();
</script>
</body>
</html>
